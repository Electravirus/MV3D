{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///external \"fs\"","webpack:///external \"path\"","webpack:///./src/util.js","webpack:///./src/mod_babylon.js","webpack:///./src/mv3d.js","webpack:///./src/mod_mv.js","webpack:///./src/parameters.js","webpack:///./src/blenders.js","webpack:///./src/input.js","webpack:///./src/configuration.js","webpack:///./src/plugin_commands.js","webpack:///./src/tileData.js","webpack:///./src/MapCellBuilder.js","webpack:///./src/mapCell.js","webpack:///./src/loadMap.js","webpack:///./src/assets.js","webpack:///./src/characters.js","webpack:///./src/movement.js","webpack:///./src/parallax.js","webpack:///./src/serializer.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","Vector2","Vector3","Color3","Color4","window","BABYLON","makeColor","color","g","b","a","toColor4","canvas","document","createElement","width","height","context","getContext","fillStyle","fillRect","bytes","getImageData","data","relativeNumber","current","relative","test","substr","Number","isNaN","Boolean","falseString","String","S","toUpperCase","values","includes","ms","Promise","resolve","setTimeout","degtorad","deg","Math","PI","radtodeg","rad","tileSize","tileWidth","Game_Map","tileHeight","XAxis","YAxis","ZAxis","Scene","Engine","FreeCamera","HemisphericLight","DirectionalLight","SpotLight","PointLight","ShadowGenerator","Vector4","Plane","Node","TransformNode","Texture","StandardMaterial","Mesh","VertexData","MeshBuilder","AssetsManager","SceneSerializer","FRONTSIDE","BACKSIDE","DOUBLESIDE","PERSPECTIVE_CAMERA","ORTHOGRAPHIC_CAMERA","Camera","FOGMODE_NONE","FOGMODE_EXP","FOGMODE_EXP2","FOGMODE_LINEAR","WORLDSPACE","Space","WORLD","LOCALSPACE","LOCAL","BONE","crop","x","y","w","h","this","getBaseSize","EDGE_FIX","uScale","vScale","uOffset","vOffset","defineProperties","position","undefined","v","z","pitch","rotation","yaw","roll","_order","_scene","sortMeshes","meshSorter","m1","m2","meshes","sort","_addMesh","addMesh","mesh","apply","arguments","_removeMesh","removeMesh","toNumber","mv3d","setupParameters","Effect","ShadersStore","shadowMapPixelShader","replace","ALPHA_CUTOFF","texture","PIXI","fromCanvas","engine","ANTIALIASING","scene","clearColor","set","cameraStick","cameraNode","parent","camera","fov","FOV","orthoLeft","Graphics","orthoRight","orthoTop","orthoBottom","minZ","maxZ","RENDER_DIST","DYNAMIC_SHADOWS","sunNode","sunlight","shadowGenerator","DYNAMIC_SHADOW_RES","bias","normalBias","usePercentageCloserFiltering","shadowFrustumSize","DYNAMIC_SHADOW_DIST","frustumEdgeFalloff","DYNAMIC_SHADOW_FALLOFF","shadowMinZ","shadowMaxZ","ambientColor","fogMode","map","cells","characters","setupBlenders","setupInput","setupSpriteMeshes","_width","_height","render","update","lastMapUpdate","performance","now","mapUpdating","updateMap","updateAnimations","updateCharacters","updateBlenders","copyFrom","KEYBOARD_TURN","is1stPerson","Input","isTriggered","blendCameraYaw","setValue","targetValue","playerFaceYaw","KEYBOARD_PITCH","isPressed","blendCameraPitch","min","max","updateSerializer","loadData","dfault","$gameVariables","console","warn","cameraMode","startsWith","CAMERA_MODE","saveData","useCurrent","k","getCameraTarget","$gamePlayer","blendCameraTransition","blendCameraDist","blendPanX","blendPanY","$gameMap","isLoopHorizontal","mapWidth","ox","mod","isLoopVertical","mapHeight","oy","dir","floor","setDirection","currentValue","reverse","_graphics_createCanvas","_createCanvas","setup","updateCanvas","_graphics_updateAllElements","_updateAllElements","_graphics_render","_sceneMap_update","Scene_Map","ShaderTilemap","renderWebGL","renderer","_createTilemap","Spriteset_Map","createTilemap","_tilemap","visible","_baseSprite","addChild","Sprite","_sprite_char_setchar","Sprite_Character","setCharacter","character","configurable","_performTransfer","Game_Player","performTransfer","newmap","_newMapId","mapId","clearMap","_onMapLoaded","onMapLoaded","mapLoaded","mapReady","loadMap","_map_isReady","isReady","ready","_title_start","Scene_Title","start","clearCameraTarget","parameters","PluginManager","assign","ORTHOGRAPHIC_DIST","MV3D_FOLDER","ANIM_DELAY","animDelay","alphatest","edgefix","antialiasing","WALL_HEIGHT","wallHeight","TABLE_HEIGHT","tableHeight","FRINGE_HEIGHT","fringeHeight","CEILING_HEIGHT","ceilingHeight","LAYER_DIST","layerDist","CELL_SIZE","cellSize","CELL_DIST","cellDist","renderDist","MIPMAP","mipmap","STAIR_THRESH","stairThresh","FOG_COLOR","fogColor","FOG_NEAR","fogNear","FOG_FAR","fogFar","AMBIENT_COLOR","LIGHT_HEIGHT","LIGHT_DECAY","LIGHT_DIST","LIGHT_ANGLE","FLASHLIGHT_EXTRA_ANGLE","dynShadowEnabled","dynShadowDist","dynShadowRes","dynShadowFalloff","CHARACTER_SHADOWS","characterShadows","SHADOW_SCALE","shadowScale","SHADOW_DIST","shadowDist","keyboardPitch","keyboardTurn","KEYBOARD_STRAFE","keyboardStrafe","REGION_DATA","TTAG_DATA","EVENT_HEIGHT","eventHeight","VEHICLE_BUSH","vehicleBush","BOAT_SETTINGS","JSON","parse","boatSettings","SHIP_SETTINGS","shipSettings","AIRSHIP_SETTINGS","airshipSettings","entry","regions","regionData","readConfigurationFunctions","conf","tilesetConfigurationFunctions","regionId","ttags","terrainTag","scale","zoff","big","bushLanding","EVENT_SHAPE","configurationShapes","eventShape","cameraTargets","char","time","unshift","length","getTargetString","setCameraTarget","target","targetChar","blendFogColor","ColorBlender","blendFogNear","blendFogFar","cycle","blendCameraHeight","blendAmbientColor","blendSunlightColor","blendSunlightIntensity","reorient","updateCameraMode","char1","isInVehicle","vehicle","char2","_realX","_realY","mv3d_sprite","translate","fogStart","fogEnd","copyFromFloats","speed","Infinity","diff","saveValue","abs","sign","loadValue","storage","storageLocation","ret","getInputDescriptor","menumode","p3mode","p1mode","assignedValue","SceneManager","keyMapper","81","69","87","65","83","68","descriptors","left","rotleft","right","rotright","37","39","getInputDirection","dir4","transformDirectionYaw","_player_updateMove","updateMove","isMoving","_player_move_straight","moveStraight","isMovementSucceeded","raycastPredicate","isEnabled","isVisible","isPickable","isFollower","isPlayer","processMapTouch","TouchInput","_touchCount","intersection","pick","hit","point","pickedPoint","pickedMesh","$gameTemp","setDestination","round","_player_findDirectionTo","findDirectionTo","dirToYaw","ConfigurationFunction","func","groups","match","labels","slice","splice","split","trim","rawparams","gi","params","_gi","exec","foundMatch","grouploop","_i","TextureConfigurator","extraParams","group1","img","constructTileId","Rectangle","animx","animy","animX","animY","alpha","glow","tilesetConfigurations","mapConfigurations","lines","readConfigurationBlocks","tileset","note","readLines","range1","range2","kx","ky","tileId","mapconf","$dataMap","mapConfigurationFunctions","fog","near","far","light","cameraDist","cameraHeight","cameraPitch","cameraYaw","bottom_id","getMapConfig","findBlocks","contents","findTags","line","functionset","configurationFunctions","readConfigurations","toLowerCase","run","configurationSides","front","back","double","FLAT","TREE","SPRITE","FENCE","CROSS","XCROSS","depth","fringe","float","top","side","inside","bottom","shape","transparent","eventConfigurationFunctions","rot","bool","bush","shadow","pos","lamp","intensity","range","distance","flashlight","angle","flashlightYaw","flashlightPitch","lightHeight","lightOffset","dirfix","dist","ceiling","edge","_event_setupPage","Game_Event","setupPage","mv3d_needsConfigure","eventConfigure","_event_init","initialize","createCharacterFor","event","config","readConfigurationTags","locate","mv3d_blenders","lampColor_r","lampColor_g","lampColor_b","lampIntensity","lampDistance","flashlightColor_r","flashlightColor_g","flashlightColor_b","flashlightIntensity","flashlightDistance","flashlightAngle","_pluginCommand","Game_Interpreter","pluginCommand","command","args","pc","PluginCommand","INTERPRETER","FULL_COMMAND","join","filter","CHAR","_eventId","firstChar","TARGET_CHAR","shift","com","_TIME","cameramode","_cameraTarget","pan","_RELATIVE_BLEND","log","rotationMode","pitchMode","Vehicle","booleanString","_VEHICLE","_fogColor","_fogNear","_fogFar","_lightColor","AWAIT_CHAR","setupLamp","_lampColor","_lampIntensity","_lampDistance","blendLampColor","blendLampIntensity","blendLampDistance","setupFlashlight","_flashlightColor","_flashlightIntensity","_flashlightDistance","_flashlightAngle","_flashlightYaw","_flashlightPitch","blendFlashlightColor","blendFlashlightIntensity","blendFlashlightDistance","blendFlashlightAngle","blendFlashlightPitch","flashlightTargetYaw","blender","ERROR_CHAR","sleep","self","id","followers","_data","Game_Follower","_followers","indexOf","Game_Vehicle","_vehicles","_spriteset","getSetNumber","Tilemap","isAutotile","isTileA1","isTileA2","isTileA3","isTileA5","getTerrainTag","tilesetFlags","options","tileConf","animData","kind","getAutotileKind","ttag","ts_conf","normalizeAutotileId","region","getTileConfig","tileRange","tilemap","getTilemap","hasInsideConf","inside_offset","rectInside","hasBottomConf","bottom_offset","rectBottom","top_id","top_offset","side_id","side_offset","inside_id","isTileEmpty","_isHigherTile","tileData","getTileData","isWallTile","_isTableTile","isSpecialShape","layerId","getTileHeight","rx","ry","getStackHeight","ignorePits","rects","isTable","_drawTile","addRect","sheetId","sx","sy","dx","dy","push","setN","ty","isWall","isTileA4","shapes","TILE_ID_A1","submeshBuilders","submeshBuildersArray","submeshes","builder","build","MergeMeshes","material","tx","tw","th","getBuilder","uvRect","getUvRect","diffuseTexture","addWallFace","flip","addFloorFace","positions","indices","normals","uvs","vdata","applyToMesh","uvr","xf","cos","zf","sin","ww","hh","x1","y1","x2","y2","pushNewData","f","tsTexture","pow","cx","cy","toString","super","loopPos","loopCoords","cellWidth","cellHeight","getCeilingConfig","cull","nlnowall","getTileTextureOffsets","realId","isFringeTile","loadTile","loadWalls","loadFence","loadCross","alphaIndex","receiveShadows","addShadowCaster","configRect","bottom_rect","top_rect","getTileRects","tsMaterial","getCachedTilesetMaterialForTile","rect","isFringe","ni","neighborPositions","np","neededHeight","texture_side","getFringeHeight","getCullingHeight","tileHasPit","inside_rect","side_rect","wallPos","atan2","builderOptions","npl","npr","leftHeight","rightHeight","bx","by","getAutotileCorner","wallParts","partHeight","sw","sh","isTableTile","ax","az","hasLeftEdge","hasRightEdge","isWaterfallTile","edges","rightSide","irot","trans","meshCache","textureCache","dispose","materialCache","animatedTextures","resetCameraTarget","getShadowMap","renderList","loadMapSettings","createCharacters","rememberCameraTarget","bounds","cellsToLoad","ix","iy","ceil","cameraCellPos","DistanceSquared","cellpos","loadMapCell","cell","load","tsName","tilesetNames","getErrorTexture","hasAlpha","onLoadObservable","addOnce","updateSamplingMode","frameData","reject","getCachedTileTexture","errorTexture","isError","bushAlphaTexture","getAlphaFromRGB","processMaterialOptions","getExtraBit","getCachedTilesetTexture","opacityTexture","alphaCutOff","emissiveColor","specularColor","getCachedTilesetMaterial","getMaterialOptions","getTileAnimationData","getCachedTilesetMaterialAsync","alph","extra","lastAnimUpdate","animXFrame","animYFrame","animDirection","events","vehicles","order","sprite","Meshes","CreatePlane","sideOrientation","rotate","clone","SHADOW","shadowTexture","shadowMaterial","spriteOrigin","src","disposeMaterial","bitmap","_texture","onTextureLoaded","_character","charName","charIndex","updateCharacter","updateShape","isVehicle","isBoat","isShip","isAirship","isEvent","elevation","lightOrigin","setupLights","_tileId","textureSrc","setMaterial","updateFrame","updateScale","_tilesetId","tilesetId","_characterName","characterName","_characterIndex","characterIndex","_isBigCharacter","ImageManager","isBigCharacter","setTileMaterial","setEnabled","px","characterPatternX","py","characterPatternY","isTextureReady","pw","patternWidth","ph","patternHeight","characterBlockX","characterBlockY","setFrame","getConfig","isObjectCharacter","direction","configScale","settings","_type","xscale","yscale","scaling","settings_event","settings_event_page","page","comments","list","code","setupEventLights","lampConfig","flashlightConfig","excludedMeshes","makeColorBlender","makeBlender","Zero","updateFlashlightExp","diffuse","targetComponents","flashlightOrigin","blendFlashlightYaw","updateFlashlightDirection","setupMesh","exponent","flashlightOffset","tan","currentComponents","clazz","isTile","newshape","getShape","geometry","_erased","mv_sprite","disabled","isTransparent","_isEnabled","isImageChanged","patternChanged","updateNormal","updateEmpty","visibility","updateAlpha","getWalkHeight","updatePosition","updateElevation","updateShadow","updateLights","hasConfig","opacity","bushDepth","hasBush","getBushAlphaTexture","useAlphaFromDiffuseTexture","billboardOffset","multiplyByFloats","newElevation","getFloatHeight","_driving","ascentSpeed","vehicleObstructed","descentSpeed","_altitude","maxAltitude","isJumping","jumpProgress","_jumpCount","_jumpPeak","jumpHeight","jumpDiff","mv3d_jumpHeightEnd","mv3d_jumpHeightStart","_priorityType","shadowVisible","myIndex","other","shadowBase","shadowFadeDist","shadowStrength","setAll","isAnInstance","methodName","_characterBase_canPass","Game_CharacterBase","canPass","vehicleNotObstructed","strict","isDebugThrough","altitude","posZ","tileHeight2","roundXWithDirection","roundYWithDirection","obstructed","isThrough","tileHeight1","_airship_land_ok","isAirshipLandOk","airship","checkPassage","_player_updateVehicleGetOn","updateVehicleGetOn","_moveSpeed","setMoveSpeed","_charBase_jump","jump","xPlus","yPlus","gameMap_parallaxOx","parallaxOx","_parallaxLoopX","gameMap_parallaxOy","parallaxOy","_parallaxLoopY","setDisplayPos","scrollUp","scrollDown","scrollLeft","scrollRight","updateScroll","_displayX","_displayY","isNearTheScreen","_onBoot","Scene_Boot","setupSerializer","isPlaytest","Utils","isOptionValid","_mv3d_data","DataManager","_databaseFiles","mv3d_data_handler","Proxy","_dirty","writing_mv3d_data","mv3d_data","saveFile","stringify","vectors","assetsManager","vector","vector2","addMeshTask","padZero","meshdata","SerializeMesh","fileName","$gameMessage","setChoices","setChoicePositionType","setChoiceCallback","choice","async","fileData","fs","path","filePath","global","__dirname","ensureDirectory","dirname","writeFile","err","dirName","mkdir","recursive"],"mappings":"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","file":"mv3d-babylon.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 2);\n","module.exports = require(\"fs\");","module.exports = require(\"path\");","\r\nconst {Vector2,Vector3,Color3,Color4} = window.BABYLON;\r\n\r\nexport const makeColor = color=>{\r\n\tif (typeof color === 'number'){\r\n\t\treturn {\r\n\t\t\tr: (color>>16)/255,\r\n\t\t\tg: (color>>8&255)/255,\r\n\t\t\tb: (color&255)/255,\r\n\t\t\ta: 1,\r\n\t\t};\r\n\t}else if(color instanceof Color3){\r\n\t\treturn color.toColor4();\r\n\t}else if(color instanceof Color4){\r\n\t\treturn color;\r\n\t}else{\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width=1; canvas.height=1;\r\n\t\tconst context = canvas.getContext('2d');\r\n\t\tcontext.fillStyle = color; context.fillRect(0,0,1,1);\r\n\t\tconst bytes = context.getImageData(0,0,1,1).data;\r\n\t\treturn new Color4(bytes[0]/255,bytes[1]/255,bytes[2]/255,bytes[3]/255);\r\n\t}\r\n}\r\n\r\n\r\nexport const hexNumber=n=>{\r\n\tn=String(n);\r\n\tif(n.startsWith('#')){\r\n\t\tn=n.substr(1);\r\n\t}\r\n\treturn Number.parseInt(n,16);\r\n};\r\n\r\nexport const relativeNumber=(current,n)=>{\r\n\tif(n===''){ return +current; }\r\n\tconst relative = /^[+]/.test(n);\r\n\tif(relative){n=n.substr(1);}\r\n\tn=Number(n);\r\n\tif(Number.isNaN(n)){ return +current; }\r\n\tif(relative){\r\n\t\treturn +current+n;\r\n\t}else{\r\n\t\treturn +n;\r\n\t}\r\n};\r\n\r\nexport const booleanString=s=>{\r\n\treturn Boolean(falseString(s));\r\n}\r\nexport const falseString=s=>{\r\n\tif(!s){ return false; }\r\n\tif(typeof s !=='string'){ s=String(s); }\r\n\tconst S=s.toUpperCase();\r\n\tif(falseString.values.includes(S)){\r\n\t\treturn false;\r\n\t}\r\n\treturn s;\r\n}\r\nfalseString.values=['OFF','FALSE','UNDEFINED','NULL','DISABLE','DISABLED'];\r\n\r\nlet lastSnooze=0;\r\nexport const snooze=async()=>{\r\n\tif(performance.now()-lastSnooze>16){\r\n\t\tawait sleep(0);\r\n\t\tlastSnooze=performance.now();\r\n\t}\r\n}\r\nexport const sleep=(ms=0)=>new Promise(resolve=>setTimeout(resolve,ms));\r\nexport const degtorad=deg=>deg*Math.PI/180;\r\nexport const radtodeg=rad=>rad*180/Math.PI;\r\n\r\nexport const tileSize=()=>tileWidth();\r\nexport const tileWidth=()=>Game_Map.prototype.tileWidth();\r\nexport const tileHeight=()=>Game_Map.prototype.tileHeight();\r\n\r\n// useful consts\r\nexport const XAxis = new Vector3(1,0,0);\r\nexport const YAxis = new Vector3(0,1,0);\r\nexport const ZAxis = new Vector3(0,0,1);\r\nexport const v2origin = new Vector2(0,0);\r\nexport const v3origin = new Vector3(0,0,0);","const BABYLON = window.BABYLON;\r\nexport const {\r\n\tScene,\r\n\tEngine,\r\n\tFreeCamera,\r\n\tHemisphericLight,\r\n\tDirectionalLight,\r\n\tSpotLight,\r\n\tPointLight,\r\n\tShadowGenerator,\r\n\tVector2,\r\n\tVector3,\r\n\tVector4,\r\n\tColor3,\r\n\tColor4,\r\n\tPlane,\r\n\tNode,\r\n\tTransformNode,\r\n\tTexture,\r\n\tStandardMaterial,\r\n\tMesh,\r\n\tVertexData,\r\n\tMeshBuilder,\r\n\tAssetsManager,\r\n\tSceneSerializer,\r\n} = BABYLON;\r\n\r\nexport const {\r\n\tFRONTSIDE,BACKSIDE,DOUBLESIDE,\r\n} = Mesh;\r\n\r\nexport const {\r\n\tPERSPECTIVE_CAMERA,\r\n\tORTHOGRAPHIC_CAMERA,\r\n} = BABYLON.Camera;\r\n\r\nexport const{\r\n\tFOGMODE_NONE,\r\n\tFOGMODE_EXP,\r\n\tFOGMODE_EXP2,\r\n\tFOGMODE_LINEAR,\r\n} = Scene;\r\n\r\nexport const WORLDSPACE = BABYLON.Space.WORLD,\r\n             LOCALSPACE = BABYLON.Space.LOCAL,\r\n              BONESPACE = BABYLON.Space.BONE;\r\n\r\nimport mv3d from './mv3d.js';\r\nimport { radtodeg, degtorad } from './util.js';\r\n\r\nTexture.prototype.crop=function(x=0,y=0,w=0,h=0){\r\n\tconst { width, height } = this.getBaseSize();\r\n\tif(!w)w=width-x;\r\n\tif(!h)h=height-y;\r\n\tif(mv3d.EDGE_FIX){ x+=mv3d.EDGE_FIX;y+=mv3d.EDGE_FIX;w-=mv3d.EDGE_FIX*2;h-=mv3d.EDGE_FIX*2; }\r\n\tthis.uScale=w/width;\r\n\tthis.vScale=h/height;\r\n\tthis.uOffset=x/width;\r\n\tthis.vOffset=1-y/height-this.vScale;\r\n}\r\n\r\nObject.defineProperties(Node.prototype,{\r\n\tx:{\r\n\t\tget(){ return this.position?this.position.x:undefined; },\r\n\t\tset(v){ if(this.position){ this.position.x=v; } },\r\n\t},\r\n\ty:{\r\n\t\tget(){ return this.position?-this.position.z:undefined; },\r\n\t\tset(v){ if(this.position){ this.position.z=-v; } },\r\n\t},\r\n\tz:{\r\n\t\tget(){ return this.position?this.position.y:undefined; },\r\n\t\tset(v){ if(this.position){ this.position.y=v; } },\r\n\t},\r\n\r\n\tpitch:{\r\n\t\tget(){ return this.rotation?-radtodeg(this.rotation.x):undefined; },\r\n\t\tset(v){ if(this.rotation){ this.rotation.x=-degtorad(v); } },\r\n\t},\r\n\tyaw:{\r\n\t\tget(){ return this.rotation?-radtodeg(this.rotation.y):undefined; },\r\n\t\tset(v){  if(this.rotation){ this.rotation.y=-degtorad(v); } },\r\n\t},\r\n\troll:{\r\n\t\tget(){ return this.rotation?-radtodeg(this.rotation.z):undefined; },\r\n\t\tset(v){  if(this.rotation){ this.rotation.z=-degtorad(v); } },\r\n\t},\r\n});\r\n\r\n// mesh sorting\r\n\r\nObject.defineProperty(Mesh.prototype,'order',{\r\n\tget(){ return this._order; },\r\n\tset(v){ this._order=v; this._scene.sortMeshes(); }\r\n});\r\nconst meshSorter=(m1,m2)=>(m1._order|0)-(m2._order|0);\r\nScene.prototype.sortMeshes=function(){\r\n\tthis.meshes.sort(meshSorter);\r\n}\r\nconst _addMesh = Scene.prototype.addMesh;\r\nScene.prototype.addMesh=function(mesh){\r\n\t_addMesh.apply(this,arguments);\r\n\tif(typeof mesh._order==='number'){\r\n\t\tthis.sortMeshes();\r\n\t}\r\n}\r\nconst _removeMesh = Scene.prototype.removeMesh;\r\nScene.prototype.removeMesh=function(mesh){\r\n\t_removeMesh.apply(this,arguments);\r\n\tthis.sortMeshes();\r\n}\r\n\r\n// color\r\nColor3.prototype.toNumber=Color4.prototype.toNumber=function(){return this.r*255<<16|this.g*255<<8|this.b*255;}\r\n\r\n// hack babylon\r\nexport function setupBabylonMods(){\r\n\tBABYLON.Effect.ShadersStore.shadowMapPixelShader=BABYLON.Effect.ShadersStore.shadowMapPixelShader.replace(\r\n\t\t'if (texture2D(diffuseSampler,vUV).a<0.4)',\r\n\t\t`if (texture2D(diffuseSampler,vUV).a<${mv3d.ALPHA_CUTOFF})`,\r\n\t);\r\n};","import { Engine, Scene, HemisphericLight, TransformNode, FreeCamera, Node, Vector2, Vector3, Color3, FOGMODE_LINEAR, DirectionalLight, ShadowGenerator, ORTHOGRAPHIC_CAMERA, PERSPECTIVE_CAMERA, setupBabylonMods } from \"./mod_babylon.js\";\r\nimport { v3origin, degtorad, tileSize } from \"./util.js\";\r\n\r\n\r\nconst mv3d = {\r\n\r\n\tsetup(){\r\n\t\tthis.setupParameters();\r\n\t\tsetupBabylonMods();\r\n\r\n\t\tthis.canvas = document.createElement('canvas');\r\n\t\tthis.texture = PIXI.Texture.fromCanvas(this.canvas);\r\n\t\tthis.engine = new Engine(this.canvas,this.ANTIALIASING);\r\n\t\tthis.scene = new Scene(this.engine);\r\n\t\t//this.scene.clearColor.a=0;\r\n\t\tthis.scene.clearColor.set(0,0,0,0);\r\n\r\n\t\tthis.cameraStick = new TransformNode(\"cameraStick\",this.scene);\r\n\t\tthis.cameraNode = new TransformNode(\"cameraNode\",this.scene);\r\n\t\tthis.cameraNode.parent=this.cameraStick;\r\n\t\tthis.camera = new FreeCamera(\"camera\",new Vector3(0,0,0),this.scene);\r\n\t\tthis.camera.parent=this.cameraNode;\r\n\t\tthis.camera.fov=degtorad(mv3d.FOV);\r\n\t\tthis.camera.orthoLeft=-Graphics.width/2/tileSize();\r\n\t\tthis.camera.orthoRight=Graphics.width/2/tileSize();\r\n\t\tthis.camera.orthoTop=Graphics.height/2/tileSize();\r\n\t\tthis.camera.orthoBottom=-Graphics.height/2/tileSize();\r\n\t\tthis.camera.minZ=0.1;\r\n\t\tthis.camera.maxZ=this.RENDER_DIST;\r\n\r\n\t\tif(this.DYNAMIC_SHADOWS){\r\n\t\t\tthis.sunNode = new TransformNode(\"sunNode\",this.scene);\r\n\t\t\tthis.sunlight = new DirectionalLight('sunlight', new Vector3(0,-1,0), this.scene);\r\n\t\t\tthis.sunlight.parent=this.sunNode;\r\n\t\t\tthis.shadowGenerator = new ShadowGenerator(this.DYNAMIC_SHADOW_RES,this.sunlight);\r\n\t\t\t//this.shadowGenerator.bias=0.0013;\r\n\t\t\tthis.shadowGenerator.bias=0.0006;\r\n\t\t\tthis.shadowGenerator.normalBias=0.01;\r\n\t\t\t//this.shadowGenerator.forceBackFacesOnly=true;\r\n\t\t\t//this.shadowGenerator.useCloseExponentialShadowMap=true;\r\n\t\t\tthis.shadowGenerator.usePercentageCloserFiltering=true;\r\n\t\t\t//this.shadowGenerator.usePoissonSampling=true;\r\n\t\t\tthis.sunlight.shadowFrustumSize=this.DYNAMIC_SHADOW_DIST;\r\n\t\t\tthis.shadowGenerator.frustumEdgeFalloff=this.DYNAMIC_SHADOW_FALLOFF;\r\n\t\t\tthis.sunlight.shadowMinZ=-this.RENDER_DIST;\r\n\t\t\tthis.sunlight.shadowMaxZ=this.RENDER_DIST;\r\n\t\t\tthis.sunNode.pitch=45;\r\n\t\t\tthis.sunNode.yaw=45;\r\n\t\t}\r\n\r\n\t\tthis.scene.ambientColor = new Color3(1,1,1);\r\n\t\tthis.scene.fogMode=FOGMODE_LINEAR;\r\n\r\n\t\tthis.map = new Node(\"map\",this.scene);\r\n\t\tthis.cells={};\r\n\t\tthis.characters=[];\r\n\r\n\t\tthis.setupBlenders();\r\n\t\t//this.updateBlenders(true);\r\n\t\tthis.setupInput();\r\n\r\n\t\tthis.setupSpriteMeshes();\r\n\t},\r\n\r\n\tupdateCanvas(){\r\n\t\tthis.canvas.width = Graphics._width;\r\n\t\tthis.canvas.height = Graphics._height;\r\n\t},\r\n\r\n\trender(){\r\n\t\tthis.scene.render();\r\n\t\tthis.texture.update();\r\n\t},\r\n\r\n\tlastMapUpdate:0,\r\n\tupdate(){\r\n\t\tif( performance.now()-this.lastMapUpdate > 1000 && !this.mapUpdating ){\r\n\t\t\tthis.updateMap();\r\n\t\t\tthis.lastMapUpdate=performance.now();\r\n\t\t}\r\n\r\n\t\tthis.updateAnimations();\r\n\r\n\t\tthis.updateCharacters();\r\n\r\n\t\tthis.updateBlenders();\r\n\r\n\t\t// update sunlight\r\n\t\tif(this.sunlight){\r\n\t\t\t//this.sunNode.x=this.cameraStick.x;\r\n\t\t\t//this.sunNode.y=this.cameraStick.y;\r\n\t\t\tthis.sunNode.position.copyFrom(this.cameraStick.position);\r\n\t\t}\r\n\r\n\t\t// input\r\n\t\tif( mv3d.KEYBOARD_TURN || this.is1stPerson() ){\r\n\t\t\tif(Input.isTriggered('rotleft')){\r\n\t\t\t\tthis.blendCameraYaw.setValue(this.blendCameraYaw.targetValue()+90,0.5);\r\n\t\t\t}else if(Input.isTriggered('rotright')){\r\n\t\t\t\tthis.blendCameraYaw.setValue(this.blendCameraYaw.targetValue()-90,0.5);\r\n\t\t\t}\r\n\t\t\tif(this.is1stPerson()&&(Input.isTriggered('rotleft')||Input.isTriggered('rotright'))){\r\n\t\t\t\tthis.playerFaceYaw();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif( mv3d.KEYBOARD_PITCH ){\r\n\t\t\tif(Input.isPressed('pageup')&&Input.isPressed('pagedown')){\r\n\t\t\t\t// do nothing\r\n\t\t\t}else if(Input.isPressed('pageup')){\r\n\t\t\t\tthis.blendCameraPitch.setValue(Math.min(180,this.blendCameraPitch.targetValue()+1.5),0.1);\r\n\t\t\t}else if(Input.isPressed('pagedown')){\r\n\t\t\t\tthis.blendCameraPitch.setValue(Math.max(0,this.blendCameraPitch.targetValue()-1.5),0.1);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (const key in this.cells){\r\n\t\t\tthis.cells[key].update();\r\n\t\t}\r\n\r\n\t\tthis.updateSerializer();\r\n\t},\r\n\r\n\tloadData(key,dfault){\r\n\t\tif(!$gameVariables || !$gameVariables.mv3d || !(key in $gameVariables.mv3d)){ return dfault; }\r\n\t\treturn $gameVariables.mv3d[key];\r\n\t},\r\n\tsaveData(key,value){\r\n\t\tif(!$gameVariables){ return console.warn(`MV3D: Couldn't save data ${key}:${value}`); }\r\n\t\tif(!$gameVariables.mv3d){ $gameVariables.mv3d={}; }\r\n\t\t$gameVariables.mv3d[key]=value;\r\n\t},\r\n\r\n\tupdateCameraMode(){\r\n\t\tconst mode = this.cameraMode;\r\n\t\tif(mode.startsWith('O')){\r\n\t\t\tif(this.camera.mode!==ORTHOGRAPHIC_CAMERA){ this.camera.mode=ORTHOGRAPHIC_CAMERA; }\r\n\t\t}else{\r\n\t\t\tif(this.camera.mode!==PERSPECTIVE_CAMERA){ this.camera.mode=PERSPECTIVE_CAMERA; }\r\n\t\t}\r\n\t},\r\n\tget cameraMode(){\r\n\t\treturn this.loadData('cameraMode',this.CAMERA_MODE).toUpperCase();\r\n\t},\r\n\tset cameraMode(v){\r\n\t\tv = String(v).toUpperCase().startsWith('O') ? 'ORTHOGRAPHIC' : 'PERSPECTIVE' ;\r\n\t\tthis.saveData('cameraMode',v);\r\n\t\tthis.updateBlenders(true);\r\n\t},\r\n\r\n\tis1stPerson(useCurrent){\r\n\t\tconst k = useCurrent?'currentValue':'targetValue';\r\n\t\treturn this.getCameraTarget()===$gamePlayer && this.blendCameraTransition[k]()<=0\r\n\t\t&& this.blendCameraDist[k]()<=0 && this.blendPanX[k]()===0 && this.blendPanY[k]()===0;\r\n\t},\r\n\r\n\tloopCoords(x,y){\r\n\t\tif($gameMap.isLoopHorizontal()){\r\n\t\t\tconst mapWidth=$gameMap.width();\r\n\t\t\tconst ox = this.cameraStick.x - mapWidth/2;\r\n\t\t\tx=(x-ox).mod(mapWidth)+ox;\r\n\t\t}\r\n\t\tif($gameMap.isLoopVertical()){\r\n\t\t\tconst mapHeight=$gameMap.height();\r\n\t\t\tconst oy = this.cameraStick.y - mapHeight/2;\r\n\t\t\ty=(y-oy).mod(mapHeight)+oy;\r\n\t\t}\r\n\t\treturn new Vector2(x,y);\r\n\t},\r\n\t\r\n\tplayerFaceYaw(){\r\n\t\tlet dir = Math.floor((-mv3d.blendCameraYaw.targetValue()+45)/90).mod(4);\r\n\t\tif(dir>1){ dir+=(dir+1)%2*2-1; }\r\n\t\tdir=10-(dir*2+2);\r\n\t\t$gamePlayer.setDirection(dir);\r\n\t},\r\n\r\n\tdirToYaw(dir){\r\n\t\tlet yaw = dir/2-1;\r\n\t\tif(yaw>1){ yaw+=(yaw+1)%2*2-1; }\r\n\t\tyaw=yaw*-90+180;\r\n\t\treturn yaw;\r\n\t},\r\n\t\r\n\ttransformDirectionYaw(dir,yaw=this.blendCameraYaw.currentValue(),reverse=false){\r\n\t\tif(dir==0){ return 0; }\r\n\t\tdir = dir/2-1;\r\n\t\tif(dir>1){ dir+=(dir+1)%2*2-1; }\r\n\t\tconst c = Math.floor((yaw+45)/90);\r\n\t\tif(reverse){\r\n\t\t\tdir=(dir-c).mod(4);\r\n\t\t}else{\r\n\t\t\tdir=(dir+c).mod(4);\r\n\t\t}\r\n\t\tif(dir>1){ dir+=(dir+1)%2*2-1; }\r\n\t\treturn dir*2+2;\r\n\t},\r\n\r\n}\r\nwindow.mv3d=mv3d;\r\nexport default mv3d;","import mv3d from './mv3d.js';\r\n\r\nconst _graphics_createCanvas=Graphics._createCanvas;\r\nGraphics._createCanvas = function() {\r\n\tmv3d.setup();\r\n\tmv3d.updateCanvas();\r\n\t_graphics_createCanvas.apply(this,arguments);\r\n};\r\n\r\nconst _graphics_updateAllElements=Graphics._updateAllElements;\r\nGraphics._updateAllElements = function() {\r\n\t_graphics_updateAllElements.apply(this,arguments);\r\n\tmv3d.updateCanvas();\r\n};\r\n\r\nconst _graphics_render=Graphics.render;\r\nGraphics.render=function(){\r\n\tmv3d.render();\r\n\t_graphics_render.apply(this,arguments);\r\n};\r\n\r\nconst _sceneMap_update=Scene_Map.prototype.update;\r\nScene_Map.prototype.update = function(){\r\n\t_sceneMap_update.apply(this,arguments);\r\n\tmv3d.update();\r\n}\r\n\r\nShaderTilemap.prototype.renderWebGL = function(renderer) {};\r\n\r\nconst _createTilemap=Spriteset_Map.prototype.createTilemap;\r\nSpriteset_Map.prototype.createTilemap=function(){\r\n\t_createTilemap.apply(this,arguments);\r\n\tthis._tilemap.visible=false;\r\n\tthis._baseSprite.addChild( new PIXI.Sprite(mv3d.texture) );\r\n};\r\n\r\nconst _sprite_char_setchar = Sprite_Character.prototype.setCharacter;\r\nSprite_Character.prototype.setCharacter = function(character) {\r\n\t_sprite_char_setchar.apply(this,arguments);\r\n\tObject.defineProperty(character,'mv_sprite',{\r\n\t\tvalue:this,\r\n\t\tconfigurable:true,\r\n\t});\r\n};\r\n\r\n// Player Transfer\r\n\r\nconst _performTransfer=Game_Player.prototype.performTransfer;\r\nGame_Player.prototype.performTransfer = function() {\r\n\tconst newmap = this._newMapId !== $gameMap.mapId();\r\n\tif(newmap){\r\n\t\tmv3d.clearMap();\r\n\t}\r\n\t_performTransfer.apply(this,arguments);\r\n};\r\n\r\n// On Map Load\r\n\r\nconst _onMapLoaded=Scene_Map.prototype.onMapLoaded;\r\nScene_Map.prototype.onMapLoaded=function(){\r\n\t_onMapLoaded.apply(this,arguments);\r\n\tif(!mv3d.mapLoaded){\r\n\t\tmv3d.mapReady=false;\r\n\t\t//mv3d.mapReady=true;\r\n\t\tmv3d.loadMap();\r\n\t}\r\n\tmv3d.updateBlenders(true);\r\n};\r\n\r\nconst _map_isReady = Scene_Map.prototype.isReady;\r\nScene_Map.prototype.isReady = function() {\r\n\tlet ready = _map_isReady.apply(this,arguments);\r\n\treturn ready && mv3d.mapReady;\r\n};\r\n\r\n// Title\r\n\r\nconst _title_start=Scene_Title.prototype.start;\r\nScene_Title.prototype.start = function() {\r\n\t_title_start.apply(this,arguments);\r\n\tmv3d.clearMap();\r\n\tmv3d.clearCameraTarget();\r\n};","import mv3d from './mv3d.js';\r\nimport { hexNumber,booleanString,falseString, makeColor } from './util.js';\r\nimport { Vector2, Texture } from './mod_babylon.js';\r\n\r\nconst parameters = PluginManager.parameters('mv3d-babylon');\r\nexport default parameters;\r\n\r\nObject.assign(mv3d,{\r\n\tCAMERA_MODE:\"PERSPECTIVE\",\r\n\tORTHOGRAPHIC_DIST:100,\r\n\tMV3D_FOLDER:\"img/MV3D\",\r\n\r\n\tANIM_DELAY:Number(parameters.animDelay),\r\n\tALPHA_CUTOFF:Math.max(0.01,parameters.alphatest),\r\n\r\n\tEDGE_FIX: Number(parameters.edgefix),\r\n\tANTIALIASING: booleanString(parameters.antialiasing),\r\n\tFOV:Number(parameters.fov),\r\n\r\n\tWALL_HEIGHT:Number(parameters.wallHeight),\r\n\tTABLE_HEIGHT:Number(parameters.tableHeight),\r\n\tFRINGE_HEIGHT:Number(parameters.fringeHeight),\r\n\tCEILING_HEIGHT:Number(parameters.ceilingHeight),\r\n\tLAYER_DIST:Number(parameters.layerDist),\r\n\r\n\tCELL_SIZE: Number(parameters.cellSize),\r\n\tCELL_DIST: Number(parameters.cellDist),\r\n\tRENDER_DIST: Number(parameters.renderDist),\r\n\tMIPMAP:booleanString(parameters.mipmap),\r\n\r\n\tSTAIR_THRESH: Number(parameters.stairThresh),\r\n\r\n\tFOG_COLOR: makeColor(parameters.fogColor).toNumber(),\r\n\tFOG_NEAR: Number(parameters.fogNear),\r\n\tFOG_FAR: Number(parameters.fogFar), \r\n\tAMBIENT_COLOR: makeColor(parameters.ambientColor).toNumber(),\r\n\r\n\r\n\tLIGHT_HEIGHT: 0.5,\r\n\tLIGHT_DECAY: 1,\r\n\tLIGHT_DIST: 3,\r\n\tLIGHT_ANGLE: 45,\r\n\tFLASHLIGHT_EXTRA_ANGLE: 10,\r\n\r\n\tDYNAMIC_SHADOWS:booleanString(parameters.dynShadowEnabled),\r\n\tDYNAMIC_SHADOW_DIST:Number(parameters.dynShadowDist),\r\n\tDYNAMIC_SHADOW_RES:Number(parameters.dynShadowRes),\r\n\tDYNAMIC_SHADOW_FALLOFF:Number(parameters.dynShadowFalloff),\r\n\tCHARACTER_SHADOWS:booleanString(parameters.characterShadows),\r\n\tSHADOW_SCALE:Number(parameters.shadowScale),\r\n\tSHADOW_DIST:Number(parameters.shadowDist),\r\n\r\n\tKEYBOARD_PITCH: booleanString(parameters.keyboardPitch),\r\n\tKEYBOARD_TURN: booleanString(parameters.keyboardTurn),\r\n\tKEYBOARD_STRAFE: booleanString(parameters.keyboardStrafe),\r\n\r\n\tREGION_DATA:{},\r\n\tTTAG_DATA:{},\r\n\r\n\tEVENT_HEIGHT:Number(parameters.eventHeight),\r\n\tVEHICLE_BUSH:booleanString(parameters.vehicleBush),\r\n\tBOAT_SETTINGS:JSON.parse(parameters.boatSettings),\r\n\tSHIP_SETTINGS:JSON.parse(parameters.shipSettings),\r\n\tAIRSHIP_SETTINGS:JSON.parse(parameters.airshipSettings),\r\n\r\n\r\n\tsetupParameters(){\r\n\t\tfor (let entry of JSON.parse(parameters.regions)){\r\n\t\t\tentry=JSON.parse(entry);\r\n\t\t\tconst regionData = this.readConfigurationFunctions(entry.conf,this.tilesetConfigurationFunctions)\r\n\t\t\tthis.REGION_DATA[entry.regionId]=regionData;\r\n\t\t\t/*\r\n\t\t\tif ('height' in regionData){\r\n\t\t\t\tregionData.region_height = regionData.height;\r\n\t\t\t\tdelete regionData.height;\r\n\t\t\t}\r\n\t\t\tif ('depth' in regionData){\r\n\t\t\t\tregionData.region_depth = regionData.depth;\r\n\t\t\t\tdelete regionData.depth;\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\t\r\n\t\t}\r\n\t\tfor (let entry of JSON.parse(parameters.ttags)){\r\n\t\t\tentry=JSON.parse(entry);\r\n\t\t\tthis.TTAG_DATA[entry.terrainTag]=this.readConfigurationFunctions(entry.conf,this.tilesetConfigurationFunctions);\r\n\t\t}\r\n\r\n\t\tthis.BOAT_SETTINGS.scale=Number(this.BOAT_SETTINGS.scale);\r\n\t\tthis.BOAT_SETTINGS.zoff=Number(this.BOAT_SETTINGS.zoff);\r\n\t\tthis.BOAT_SETTINGS.big=booleanString(this.BOAT_SETTINGS.big);\r\n\t\tthis.SHIP_SETTINGS.scale=Number(this.SHIP_SETTINGS.scale);\r\n\t\tthis.SHIP_SETTINGS.zoff=Number(this.SHIP_SETTINGS.zoff);\r\n\t\tthis.SHIP_SETTINGS.big=booleanString(this.SHIP_SETTINGS.big);\r\n\t\tthis.AIRSHIP_SETTINGS.scale=Number(this.AIRSHIP_SETTINGS.scale);\r\n\t\tthis.AIRSHIP_SETTINGS.height=Number(this.AIRSHIP_SETTINGS.height);\r\n\t\tthis.AIRSHIP_SETTINGS.shadowScale=Number(this.AIRSHIP_SETTINGS.shadowScale);\r\n\t\tthis.AIRSHIP_SETTINGS.shadowDist=Number(this.AIRSHIP_SETTINGS.shadowDist);\r\n\t\tthis.AIRSHIP_SETTINGS.big=booleanString(this.AIRSHIP_SETTINGS.big);\r\n\t\tthis.AIRSHIP_SETTINGS.bushLanding=booleanString(this.AIRSHIP_SETTINGS.bushLanding);\r\n\r\n\r\n\t\tthis.EVENT_SHAPE=this.configurationShapes[parameters.eventShape.toUpperCase()];\r\n\r\n\t\t//Texture.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=0;\r\n\t},\r\n});","import mv3d from './mv3d.js';\r\nimport { hexNumber, ZAxis } from \"./util.js\";\r\nimport parameters from './parameters.js';\r\nimport { ORTHOGRAPHIC_CAMERA, LOCALSPACE } from './mod_babylon.js';\r\n\r\nObject.assign(mv3d,{\r\n\r\n\tcameraTargets:[],\r\n\tgetCameraTarget(){\r\n\t\treturn this.cameraTargets[0];\r\n\t},\r\n\tsetCameraTarget(char,time){\r\n\t\tif(!char){ this.cameraTargets.length=0; return; }\r\n\t\tthis.cameraTargets.unshift(char);\r\n\t\tif(this.cameraTargets.length>2){ this.cameraTargets.length=2; }\r\n\t\tthis.saveData('cameraTarget',this.getTargetString(char));\r\n\t\tthis.blendCameraTransition.value=1;\r\n\t\tthis.blendCameraTransition.setValue(0,time);\r\n\t},\r\n\tclearCameraTarget(){\r\n\t\tthis.cameraTargets.length=0;\r\n\t},\r\n\tresetCameraTarget(){\r\n\t\tthis.clearCameraTarget();\r\n\t\tthis.setCameraTarget($gamePlayer,0);\r\n\t},\r\n\trememberCameraTarget(){\r\n\t\tconst target = this.loadData('cameraTarget');\r\n\t\tif(target){\r\n\t\t\tthis.setCameraTarget(this.targetChar(target),0);\r\n\t\t}\r\n\t},\r\n\r\n\tsetupBlenders(){\r\n\t\tthis.blendFogColor = new ColorBlender('fogColor',this.FOG_COLOR);\r\n\t\tthis.blendFogNear = new Blender('fogNear',this.FOG_NEAR);\r\n\t\tthis.blendFogFar = new Blender('fogFar',this.FOG_FAR);\r\n\t\tthis.blendCameraYaw = new Blender('cameraYaw',0);\r\n\t\tthis.blendCameraYaw.cycle=360;\r\n\t\tthis.blendCameraPitch = new Blender('cameraPitch',60);\r\n\t\tthis.blendCameraPitch.min=0;\r\n\t\tthis.blendCameraPitch.max=180;\r\n\t\tthis.blendCameraDist = new Blender('cameraDist',10);\r\n\t\tthis.blendCameraHeight = new Blender('cameraHeight',0.7);\r\n\t\tthis.blendAmbientColor = new ColorBlender('ambientColor',this.AMBIENT_COLOR);\r\n\t\tthis.blendSunlightColor = new ColorBlender('light_color',0xffffff);\r\n\t\tthis.blendSunlightIntensity = new Blender('light_intensity',1);\r\n\t\tthis.blendPanX = new Blender('panX',0);\r\n\t\tthis.blendPanY = new Blender('panY',0);\r\n\t\tthis.blendCameraTransition = new Blender('cameraTransition',0);\r\n\t},\r\n\r\n    updateBlenders(reorient){\r\n\t\tthis.updateCameraMode();\r\n\t\t// camera target & pan\r\n\t\tif(!this.cameraTargets.length){\r\n\t\t\tif($gamePlayer){\r\n\t\t\t\tthis.cameraTargets[0]=$gamePlayer;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(this.blendCameraTransition.update() && this.cameraTargets.length>=2){\r\n\t\t\tconst t = this.blendCameraTransition.currentValue();\r\n\t\t\tlet char1=this.cameraTargets[0];\r\n\t\t\tif(char1===$gamePlayer&&$gamePlayer.isInVehicle()){ char1=$gamePlayer.vehicle(); }\r\n\t\t\tlet char2=this.cameraTargets[1];\r\n\t\t\tif(char2===$gamePlayer&&$gamePlayer.isInVehicle()){ char2=$gamePlayer.vehicle(); }\r\n\t\t\tthis.cameraStick.x = char1._realX*(1-t) + char2._realX*t;\r\n\t\t\tthis.cameraStick.y = char1._realY*(1-t) + char2._realY*t;\r\n\t\t\tif(char1.mv3d_sprite&&char2.mv3d_sprite){\r\n\t\t\t\tthis.cameraStick.z = char1.mv3d_sprite.z*(1-t) + char2.mv3d_sprite.z*t;\r\n\t\t\t}else if(char1.mv3d_sprite){\r\n\t\t\t\tthis.cameraStick.z=char1.mv3d_sprite.z;\r\n\t\t\t}\r\n\t\t}else if(this.cameraTargets.length){\r\n\t\t\tlet char = this.getCameraTarget();\r\n\t\t\tif(char===$gamePlayer&&$gamePlayer.isInVehicle()){ char=$gamePlayer.vehicle(); }\r\n\t\t\tthis.cameraStick.x=char._realX;\r\n\t\t\tthis.cameraStick.y=char._realY;\r\n\t\t\tif(char.mv3d_sprite){\r\n\t\t\t\tthis.cameraStick.z=char.mv3d_sprite.z;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.blendPanX.update();\r\n\t\tthis.blendPanY.update();\r\n\t\tthis.cameraStick.x+=this.blendPanX.currentValue();\r\n\t\tthis.cameraStick.y+=this.blendPanY.currentValue();\r\n\r\n\t\t// camera yaw, pitch, dist & height\r\n\t\tif(reorient|this.blendCameraPitch.update()|this.blendCameraYaw.update()\r\n\t\t|this.blendCameraDist.update()|this.blendCameraHeight.update()){\r\n\t\t\tthis.cameraNode.pitch = this.blendCameraPitch.currentValue()-90;\r\n\t\t\tthis.cameraNode.yaw = this.blendCameraYaw.currentValue();\r\n\t\t\tthis.cameraNode.position.set(0,0,0);\r\n\t\t\tthis.cameraNode.translate(ZAxis,-this.blendCameraDist.currentValue(),LOCALSPACE);\r\n\t\t\tif(this.camera.mode===ORTHOGRAPHIC_CAMERA){\r\n\t\t\t\t//this.camera.zoom=10/this.blendCameraDist.currentValue();\r\n\t\t\t\t//this.camera.updateProjectionMatrix();\r\n\t\t\t\tthis.camera.maxZ=this.RENDER_DIST;\r\n\t\t\t\tthis.camera.minZ=-this.RENDER_DIST;\r\n\t\t\t}else{\r\n\t\t\t\t\r\n\t\t\t\tif(this.cameraNode.z<0){ this.cameraNode.z=0; }\r\n\t\t\t\tthis.camera.maxZ=this.RENDER_DIST;\r\n\t\t\t\tthis.camera.minZ=0.1;\r\n\t\t\t}\r\n\t\t\tthis.cameraNode.z += this.blendCameraHeight.currentValue();\r\n\t\t}\r\n\r\n\t\t//fog\r\n\t\tif(reorient|this.blendFogColor.update()|this.blendFogNear.update()|this.blendFogFar.update()){\r\n\t\t\tthis.scene.fogStart=this.blendFogNear.currentValue();\r\n\t\t\tthis.scene.fogEnd=this.blendFogFar.currentValue();\r\n\t\t\tthis.scene.fogColor.copyFromFloats(\r\n\t\t\t\tthis.blendFogColor.r.currentValue()/255,\r\n\t\t\t\tthis.blendFogColor.g.currentValue()/255,\r\n\t\t\t\tthis.blendFogColor.b.currentValue()/255,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\t//light\r\n\t\tif(reorient|this.blendAmbientColor.update()){\r\n\t\t\tthis.scene.ambientColor.copyFromFloats(\r\n\t\t\t\tthis.blendAmbientColor.r.currentValue()/255,\r\n\t\t\t\tthis.blendAmbientColor.g.currentValue()/255,\r\n\t\t\t\tthis.blendAmbientColor.b.currentValue()/255,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t},\r\n\r\n});\r\n\r\n\r\nexport class Blender{\r\n\tconstructor(key,dfault){\r\n\t\tthis.key=key;\r\n\t\tthis.dfault=mv3d.loadData(key,dfault);\r\n\t\tthis.value=dfault;\r\n\t\tthis.speed=1;\r\n\t\tthis.max=Infinity;\r\n\t\tthis.min=-Infinity;\r\n\t\tthis.cycle=false;\r\n\t}\r\n\tsetValue(target,time=0){\r\n\t\ttarget = Math.min(this.max,Math.max(this.min,target));\r\n\t\tlet diff = target - this.value;\r\n\t\tif(!diff){ return; }\r\n\t\tthis.saveValue(this.key,target);\r\n\t\tif(this.cycle){\r\n\t\t\twhile ( Math.abs(diff)>this.cycle/2 ){\r\n\t\t\t\tthis.value += Math.sign(diff)*this.cycle;\r\n\t\t\t\tdiff = target - this.value;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.speed = Math.abs(diff)/(60*time);\r\n\t}\r\n\tcurrentValue(){ return this.value; }\r\n\ttargetValue(){ return this.loadValue(this.key); }\r\n\tdefaultValue(){ return this.dfault; }\r\n\tupdate(){\r\n\t\tconst target = this.targetValue();\r\n\t\tif(this.value===target){ return false; }\r\n\t\tconst diff = target - this.value;\r\n\t\tif(this.speed > Math.abs(diff)){\r\n\t\t\tthis.value=target;\r\n\t\t}else{\r\n\t\t\tthis.value+=this.speed*Math.sign(diff);\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\tstorageLocation(){\r\n\t\tif(!$gameVariables){\r\n\t\t\tconsole.warn(`MV3D: Couldn't get Blend storage location.`);\r\n\t\t\treturn {};\r\n\t\t}\r\n\t\tif(!$gameVariables.mv3d){ $gameVariables.mv3d = {}; }\r\n\t\treturn $gameVariables.mv3d;\r\n\t}\r\n\tloadValue(key){\r\n\t\tconst storage = this.storageLocation();\r\n\t\tif(!(key in storage)){ return this.dfault; }\r\n\t\treturn storage[key];\r\n\t}\r\n\tsaveValue(key,value){\r\n\t\tconst storage = this.storageLocation();\r\n\t\tstorage[key]=value;\r\n\t}\r\n}\r\n\r\nexport class ColorBlender{\r\n\tconstructor(key,dfault){\r\n\t\tthis.dfault=dfault;\r\n\t\tthis.r=new Blender(`${key}_r`,dfault>>16);\r\n\t\tthis.g=new Blender(`${key}_g`,dfault>>8&0xff);\r\n\t\tthis.b=new Blender(`${key}_b`,dfault&0xff);\r\n\t}\r\n\tsetValue(color,time){\r\n\t\tthis.r.setValue(color>>16,time);\r\n\t\tthis.g.setValue(color>>8&0xff,time);\r\n\t\tthis.b.setValue(color&0xff,time);\r\n\t}\r\n\tcurrentValue(){\r\n\t\treturn this.r.value<<16|this.g.value<<8|this.b.value;\r\n\t}\r\n\ttargetValue(){\r\n\t\treturn this.r.targetValue()<<16|this.g.targetValue()<<8|this.b.targetValue();\r\n\t}\r\n\tdefaultValue(){ return this.dfault; }\r\n\tupdate(){\r\n\t\tlet ret=0;\r\n\t\tret|=this.r.update();\r\n\t\tret|=this.g.update();\r\n\t\tret|=this.b.update();\r\n\t\treturn Boolean(ret);\r\n\t}\r\n\tget storageLocation(){ return this.r.storageLocation; }\r\n\tset storageLocation(v){\r\n\t\tthis.r.storageLocation=v;\r\n\t\tthis.g.storageLocation=v;\r\n\t\tthis.b.storageLocation=v;\r\n\t}\r\n\tcurrentComponents(){\r\n\t\treturn [this.r.currentValue()/255,this.g.currentValue()/255,this.b.currentValue()/255];\r\n\t}\r\n\ttargetComponents(){\r\n\t\treturn [this.r.targetValue()/255,this.g.targetValue()/255,this.b.targetValue()/255];\r\n\t}\r\n}","import mv3d from './mv3d.js';\r\n\r\nObject.assign(Input.keyMapper,{\r\n\t81:'rotleft',  // Q\r\n\t69:'rotright', // E\r\n\t87:'up',       // W\r\n\t65:'left',     // A\r\n\t83:'down',     // S\r\n\t68:'right',    // D\r\n});\r\n\r\nmv3d.setupInput=function(){\r\n\tconst descriptors={\r\n\t\tleft:getInputDescriptor('left','left','rotleft'),\r\n\t\trotleft:getInputDescriptor('pageup','rotleft', mv3d.KEYBOARD_STRAFE?'left':undefined),\r\n\t\tright:getInputDescriptor('right','right','rotright'),\r\n\t\trotright:getInputDescriptor('pagedown','rotright', mv3d.KEYBOARD_STRAFE?'right':undefined),\r\n\t}\r\n\tObject.defineProperties(Input.keyMapper,{\r\n\t\t37:descriptors.left, // left arrow\r\n\t\t39:descriptors.right,// right arrow\r\n\t\t81:descriptors.rotleft, //Q\r\n\t\t69:descriptors.rotright,//E\r\n\t\t65:descriptors.left, //A\r\n\t\t68:descriptors.right,//D\r\n\t});\r\n}\r\n\r\nfunction getInputDescriptor(menumode,p3mode,p1mode){\r\n\tlet assignedValue=undefined;\r\n\treturn {\r\n\t\tconfigurable:true,\r\n\t\tget(){\r\n\t\t\tif(assignedValue!=undefined){ return assignedValue; }\r\n\t\t\tif(!(SceneManager._scene instanceof Scene_Map)){ return menumode; }\r\n\t\t\tif(mv3d.is1stPerson()){ return p1mode; }\r\n\t\t\treturn p3mode;\r\n\t\t},\r\n\t\tset(v){ assignedValue=v; },\r\n\t};\r\n}\r\n\r\nGame_Player.prototype.getInputDirection = function() {\r\n\tlet dir = Input.dir4;\r\n\treturn mv3d.transformDirectionYaw(dir,mv3d.blendCameraYaw.currentValue(),true);\r\n};\r\n\r\nconst _player_updateMove = Game_Player.prototype.updateMove;\r\nGame_Player.prototype.updateMove = function() {\r\n\t_player_updateMove.apply(this,arguments);\r\n\tif ( !this.isMoving() && mv3d.is1stPerson() ) {\r\n\t\tmv3d.playerFaceYaw();\r\n\t}\r\n};\r\nconst _player_move_straight=Game_Player.prototype.moveStraight;\r\nGame_Player.prototype.moveStraight = function(d) {\r\n\t_player_move_straight.apply(this,arguments);\r\n\tif(!this.isMovementSucceeded()&&mv3d.is1stPerson()){\r\n\t\tmv3d.playerFaceYaw();\r\n\t}\r\n};\r\n\r\nconst raycastPredicate=mesh=>{\r\n\tif(!mesh.isEnabled() || !mesh.isVisible || !mesh.isPickable){ return false; }\r\n\tif(mesh.character){\r\n\t\tif(mesh.character.isFollower||mesh.character.isPlayer){ return false; }\r\n\t}\r\n\treturn true;\r\n}\r\n\r\nScene_Map.prototype.processMapTouch = function() {\r\n\tif (TouchInput.isTriggered() || this._touchCount > 0) {\r\n\t\tif (TouchInput.isPressed()) {\r\n\t\t\tif (this._touchCount === 0 || this._touchCount >= 15) {\r\n\t\t\t\t\r\n\t\t\t\tconst intersection = mv3d.scene.pick(TouchInput.x,TouchInput.y,raycastPredicate);\r\n\t\t\t\tif(intersection.hit){\r\n\t\t\t\t\tconst point = {x:intersection.pickedPoint.x, y:-intersection.pickedPoint.z};\r\n\t\t\t\t\tconst mesh = intersection.pickedMesh;\r\n\t\t\t\t\tif(mesh.character){\r\n\t\t\t\t\t\tpoint.x=mesh.character.x;\r\n\t\t\t\t\t\tpoint.y=mesh.character.y;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t$gameTemp.setDestination(Math.round(point.x), Math.round(point.y));\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\tthis._touchCount++;\r\n\t\t} else {\r\n\t\t\tthis._touchCount = 0;\r\n\t\t}\r\n\t}\r\n};\r\n\r\nconst _player_findDirectionTo=Game_Player.prototype.findDirectionTo;\r\nGame_Player.prototype.findDirectionTo=function(){\r\n\tconst dir = _player_findDirectionTo.apply(this,arguments);\r\n\tif(mv3d.is1stPerson() && dir){\r\n\t\tlet yaw = mv3d.dirToYaw(dir);\r\n\r\n\t\tmv3d.blendCameraYaw.setValue(yaw,0.25);\r\n\t}\r\n\treturn dir;\r\n}","import mv3d from './mv3d.js';\r\nimport { FRONTSIDE, BACKSIDE, DOUBLESIDE, Vector2 } from './mod_babylon.js';\r\nimport { makeColor, relativeNumber, booleanString, falseString } from './util.js';\r\n\r\nclass ConfigurationFunction{\r\n\tconstructor(parameters,func){\r\n\t\tthis.groups = parameters.match(/\\[?[^[\\]|]+\\]?/g);\r\n\t\tthis.labels={};\r\n\t\tfor(let i=0;i<this.groups.length;++i){\r\n\t\t\twhile(this.groups[i]&&this.groups[i][0]==='['){\r\n\t\t\t\tthis.labels[this.groups[i].slice(1,-1)]=i;\r\n\t\t\t\tthis.groups.splice(i,1);\r\n\t\t\t}\r\n\t\t\tif( i > this.groups.length ){ break; }\r\n\t\t\tthis.groups[i]=this.groups[i].split(',').map(s=>s.trim());\r\n\t\t}\r\n\t\tthis.func=func;\r\n\t}\r\n\trun(conf,rawparams){\r\n\t\tconst r=/([,|])?(?:(\\w+):)?([^,|\\r\\n]+)/g\r\n\t\tlet match;\r\n\t\tlet i=0;\r\n\t\tlet gi=0;\r\n\t\tconst params={};\r\n\t\tfor(let _gi=0;_gi<this.groups.length;++_gi){\r\n\t\t\tparams[`group${_gi+1}`]=[];\r\n\t\t}\r\n\t\twhile(match=r.exec(rawparams)){\r\n\t\t\tif(match[1]==='|'||i>=this.groups[gi].length){\r\n\t\t\t\ti=0; ++gi;\r\n\t\t\t}\r\n\t\t\tif(match[2]){\r\n\t\t\t\tif(match[2] in this.labels){\r\n\t\t\t\t\tgi=this.labels[match[2]];\r\n\t\t\t\t}else{\r\n\t\t\t\t\tlet foundMatch=false;\r\n\t\t\t\t\tgrouploop:for(let _gi=0;_gi<this.groups.length;++_gi) for(let _i=0;_i<this.groups[_gi].length;++_i){\r\n\t\t\t\t\t\tif(this.groups[_gi][_i]===match[2]){\r\n\t\t\t\t\t\t\tfoundMatch=true;\r\n\t\t\t\t\t\t\tgi=_gi; i=_i;\r\n\t\t\t\t\t\t\tbreak grouploop;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(!foundMatch){ break; }\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(gi>this.groups.length){ break; }\r\n\t\t\tparams[this.groups[gi][i]]=params[`group${gi+1}`][i]=match[3].trim();\r\n\t\t\t++i;\r\n\t\t}\r\n\t\tthis.func(conf,params);\r\n\t}\r\n}\r\n\r\nfunction TextureConfigurator(name,extraParams=''){\r\n\tconst paramlist = `img,x,y,w,h|${extraParams}|alpha|glow[anim]animx,animy`;\r\n\treturn new ConfigurationFunction(paramlist,function(conf,params){\r\n\t\tif(params.group1.length===5){\r\n\t\t\tconst [img,x,y,w,h] = params.group1;\r\n\t\t\tconf[`${name}_id`] = mv3d.constructTileId(img,0,0);\r\n\t\t\tconf[`${name}_rect`] = new PIXI.Rectangle(x,y,w,h);\r\n\t\t}else if(params.group1.length===3){\r\n\t\t\tconst [img,x,y] = params.group1;\r\n\t\t\tconf[`${name}_id`] = mv3d.constructTileId(img,x,y);\r\n\t\t}else if(params.group1.length===2){\r\n\t\t\tconst [x,y] = params.group1;\r\n\t\t\tconf[`${name}_offset`] = new Vector2(Number(x),Number(y));\r\n\t\t}\r\n\t\tif(params.animx&&params.animy){\r\n\t\t\tconf[`${name}_animData`]={ animX:Number(params.animx), animY:Number(params.animy) };\r\n\t\t}\r\n\t\tif(params.height){\r\n\t\t\tconf[`${name}_height`]=Number(params.height);\r\n\t\t}\r\n\t\tif(params.alpha){\r\n\t\t\tconf[`${name}_alpha`]=Number(params.alpha);\r\n\t\t}\r\n\t\tif(params.glow){\r\n\t\t\tconf[`${name}_glow`]=Number(params.glow);\r\n\t\t}\r\n\t});\r\n}\r\n\r\nObject.assign(mv3d,{\r\n\ttilesetConfigurations:{},\r\n\tmapConfigurations:{},\r\n\tloadMapSettings(){\r\n\t\t//tileset\r\n\t\tthis.tilesetConfigurations={};\r\n\t\tconst lines = this.readConfigurationBlocks($gameMap.tileset().note);\r\n\t\t//const readLines = /^\\s*([abcde]\\d?\\s*,\\s*\\d+\\s*,\\s*\\d+)\\s*:(.*)$/gmi;\r\n\t\tconst readLines = /^\\s*([abcde]\\d?)\\s*,\\s*(\\d+(?:-\\d+)?)\\s*,\\s*(\\d+(?:-\\d+)?)\\s*:(.*)$/gmi;\r\n\t\tlet match;\r\n\t\twhile(match = readLines.exec(lines)){\r\n\t\t\tconst conf = this.readConfigurationFunctions(match[4],this.tilesetConfigurationFunctions);\r\n\t\t\tconst range1 = match[2].split('-').map(s=>Number(s));\r\n\t\t\tconst range2 = match[3].split('-').map(s=>Number(s));\r\n\t\t\tfor(let kx=range1[0];kx<=range1[range1.length-1];++kx)\r\n\t\t\tfor(let ky=range2[0];ky<=range2[range2.length-1];++ky){\r\n\t\t\t\tconst key = `${match[1]},${kx},${ky}`;\r\n\t\t\t\tconst tileId=this.constructTileId(...key.split(','));\r\n\t\t\t\tif(!(tileId in this.tilesetConfigurations)){\r\n\t\t\t\t\tthis.tilesetConfigurations[tileId]={};\r\n\t\t\t\t}\r\n\t\t\t\tObject.assign(this.tilesetConfigurations[tileId],conf);\r\n\t\t\t}\r\n\r\n\t\t}\r\n\t\t//map\r\n\t\tconst mapconf=this.mapConfigurations={};\r\n\t\tthis.readConfigurationFunctions(\r\n\t\t\tthis.readConfigurationBlocks($dataMap.note),\r\n\t\t\tthis.mapConfigurationFunctions,\r\n\t\t\tmapconf,\r\n        );\r\n        \r\n\t\tif('fog' in mapconf){\r\n\t\t\tconst fog = mapconf.fog;\r\n\t\t\tif('color' in fog){ this.blendFogColor.setValue(fog.color,0); }\r\n\t\t\tif('near' in fog){ this.blendFogNear.setValue(fog.near,0); }\r\n\t\t\tif('far' in fog){ this.blendFogFar.setValue(fog.far,0); }\r\n\t\t}\r\n\t\tif('light' in mapconf){\r\n\t\t\tthis.blendAmbientColor.setValue(mapconf.light.color,0);\r\n\t\t\t//this.blendLightIntensity.setValue(mapconf.light.intensity,0);\r\n\t\t}\r\n\t\tif('cameraDist' in mapconf){\r\n\t\t\tthis.blendCameraDist.setValue(mapconf.cameraDist,0);\r\n\t\t}\r\n\t\tif ('cameraHeight' in mapconf){\r\n\t\t\tthis.blendCameraHeight.setValue(mapconf.cameraHeight,0);\r\n\t\t}\r\n\t\tif('cameraMode' in mapconf){\r\n\t\t\tthis.cameraMode=mapconf.cameraMode;\r\n\t\t}\r\n\t\tif('cameraPitch' in mapconf){\r\n\t\t\tthis.blendCameraPitch.setValue(mapconf.cameraPitch,0);\r\n\t\t}\r\n\t\tif('cameraYaw' in mapconf){\r\n\t\t\tthis.blendCameraYaw.setValue(mapconf.cameraYaw,0);\r\n\t\t}\r\n    },\r\n    \r\n\r\n\tgetMapConfig(key,dfault){\r\n\t\tif(key in this.mapConfigurations){\r\n\t\t\treturn this.mapConfigurations[key];\r\n\t\t}\r\n\t\treturn dfault;\r\n\t},\r\n\r\n\tgetCeilingConfig(){\r\n\t\tlet conf={};\r\n\t\tfor (const key in this.mapConfigurations){\r\n\t\t\tif(key.startsWith('ceiling_')){\r\n\t\t\t\tconf[key.replace('ceiling_','bottom_')]=this.mapConfigurations[key];\r\n\t\t\t}\r\n\t\t}\r\n\t\tconf.bottom_id = this.getMapConfig('ceiling_id',0);\r\n\t\tconf.height = this.getMapConfig('ceiling_height',this.CEILING_HEIGHT);\r\n\t\treturn conf;\r\n\t},\r\n\r\n\treadConfigurationBlocks(note){\r\n\t\tconst findBlocks = /<MV3D>([\\s\\S]*?)<\\/MV3D>/gi;\r\n\t\tlet contents = '';\r\n\t\tlet match;\r\n\t\twhile(match = findBlocks.exec(note)){\r\n\t\t\tcontents += match[1]+'\\n';\r\n\t\t}\r\n\t\treturn contents;\r\n\t},\r\n\r\n\treadConfigurationTags(note){\r\n\t\tconst findTags = /<MV3D:([\\s\\S]*?)>/gi;\r\n\t\tlet contents='';\r\n\t\tlet match;\r\n\t\twhile(match = findTags.exec(note)){\r\n\t\t\tcontents+=match[1]+'\\n';\r\n\t\t}\r\n\t\treturn contents;\r\n\t},\r\n\r\n\treadConfigurationFunctions(line,functionset=mv3d.configurationFunctions,conf={}){\r\n\t\tconst readConfigurations = /(\\w+)\\((.*?)\\)/g\r\n\t\tlet match;\r\n\t\twhile(match = readConfigurations.exec(line)){\r\n\t\t\tconst key = match[1].toLowerCase();\r\n\t\t\tif(key in functionset){\r\n\t\t\t\t//functionset[key](conf, ...match[2].split('|').map(s=>s?s.split(','):[]) );\r\n\t\t\t\tif(functionset[key] instanceof ConfigurationFunction){\r\n\t\t\t\t\tfunctionset[key].run(conf,match[2]);\r\n\t\t\t\t}else{\r\n\t\t\t\t\tfunctionset[key](conf, ...match[2].split(','));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn conf;\r\n\t},\r\n\r\n\tconfigurationSides:{\r\n\t\tfront:FRONTSIDE,\r\n\t\tback:BACKSIDE,\r\n\t\tdouble:DOUBLESIDE,\r\n\t},\r\n\tconfigurationShapes:{\r\n\t\tFLAT:1,\r\n\t\tTREE:2,\r\n\t\tSPRITE:3,\r\n\t\tFENCE:4,\r\n\t\tCROSS:5,\r\n\t\tXCROSS:6,\r\n    },\r\n    \r\n\r\n\ttilesetConfigurationFunctions:{\r\n\t\theight(conf,n){ conf.height=Number(n); },\r\n\t\tdepth(conf,n){ conf.depth=Number(n); },\r\n\t\tfringe(conf,n){ conf.fringe=Number(n); },\r\n\t\tfloat(conf,n){ conf.float=Number(n); },\r\n\t\ttop:TextureConfigurator('top'),\r\n\t\tside:TextureConfigurator('side'),\r\n\t\tinside:TextureConfigurator('inside'),\r\n\t\tbottom:TextureConfigurator('bottom'),\r\n\t\ttexture:Object.assign(TextureConfigurator('hybrid'),{\r\n\t\t\tfunc(conf,params){\r\n\t\t\t\tmv3d.tilesetConfigurationFunctions.top.func(conf,params);\r\n\t\t\t\tmv3d.tilesetConfigurationFunctions.side.func(conf,params);\r\n\t\t\t}\r\n\t\t}),\r\n\t\tshape(conf,name){\r\n\t\t\tconf.shape=mv3d.configurationShapes[name.toUpperCase()];\r\n\t\t},\r\n\t\talpha(conf,n){\r\n\t\t\tconf.transparent=true;\r\n\t\t\tconf.alpha=Number(n);\r\n\t\t},\r\n\t\tglow(conf,n){ conf.glow=Number(n); },\r\n\t},\r\n\teventConfigurationFunctions:{\r\n\t\theight(conf,n){ conf.height=Number(n); },\r\n\t\tz(conf,n){ conf.z=Number(n); },\r\n\t\tx(conf,n){ conf.x=Number(n); },\r\n\t\ty(conf,n){ conf.y=Number(n); },\r\n\t\tscale(conf,x,y){ conf.scale = new Vector2(Number(x),Number(y)); },\r\n\t\trot(conf,n){ conf.rot=Number(n); },\r\n\t\tbush(conf,bool){ conf.bush = booleanString(bool); },\r\n\t\tshadow(conf,n){ conf.shadow = Number(falseString(n)); },\r\n\t\tshape(conf,name){\r\n\t\t\tconf.shape=mv3d.configurationShapes[name.toUpperCase()];\r\n\t\t},\r\n\t\tpos(conf,x,y){\r\n\t\t\tconf.pos={x:x,y:y};\r\n\t\t},\r\n\t\tlamp:new ConfigurationFunction('color,intensity,range',function(conf,params){\r\n\t\t\tconst {color='white',intensity=1,range=mv3d.LIGHT_DIST} = params;\r\n\t\t\tconf.lamp={color:makeColor(color).toNumber(),intensity:Number(intensity),distance:Number(range)};\r\n\t\t}),\r\n\t\tflashlight:new ConfigurationFunction('color,intensity,range,angle|yaw,pitch',function(conf,params){\r\n\t\t\tconst {color='white',intensity=1,range=mv3d.LIGHT_DIST,angle=mv3d.LIGHT_ANGLE} = params;\r\n\t\t\tconf.flashlight={color:makeColor(color).toNumber(),intensity:Number(intensity),distance:Number(range),angle:Number(angle)};\r\n\t\t\tif(params.yaw){ conf.flashlightYaw=params.yaw; }\r\n\t\t\tif(params.pitch){ conf.flashlightPitch=Number(params.pitch); }\r\n\t\t}),\r\n\t\tflashlightpitch(conf,deg='90'){ conf.flashlightPitch=Number(deg); },\r\n\t\tflashlightyaw(conf,deg='+0'){ conf.flashlightYaw=deg; },\r\n\t\tlightheight(conf,n=1){ conf.lightHeight = Number(n); },\r\n\t\tlightoffset(conf,x=0,y=0){ conf.lightOffset = {x:+x,y:+y}; },\r\n\t\talpha(conf,n){\r\n\t\t\tconf.alpha=Number(n);\r\n\t\t},\r\n\t\tdirfix(conf,b){\r\n\t\t\tconf.dirfix=booleanString(b);\r\n\t\t}\r\n\t},\r\n\tmapConfigurationFunctions:{\r\n\t\tlight(conf,color){\r\n\t\t\tconf.light={color:makeColor(color).toNumber()};\r\n\t\t},\r\n\t\tfog:new ConfigurationFunction('color|near,far',function(conf,params){\r\n\t\t\tconst {color,near,far} = params;\r\n\t\t\tif(!conf.fog){ conf.fog={}; }\r\n\t\t\tif(color){ conf.fog.color=makeColor(color).toNumber(); }\r\n\t\t\tif(near){ conf.fog.near=Number(near); }\r\n\t\t\tif(far){ conf.fog.far=Number(far); }\r\n\t\t}),\r\n\t\tcamera:new ConfigurationFunction('yaw,pitch|dist|height|mode',function(conf,params){\r\n\t\t\tconst {yaw,pitch,dist,height,mode}=params;\r\n\t\t\tif(yaw){ conf.cameraYaw=Number(yaw); }\r\n\t\t\tif(pitch){ conf.cameraPitch=Number(pitch) }\r\n\t\t\tif(dist){ conf.cameraDist=Number(dist); }\r\n\t\t\tif(height){ conf.cameraHeight=Number(height); }\r\n\t\t\tif(mode){ conf.cameraMode=mode; }\r\n\t\t}),\r\n\t\tceiling:TextureConfigurator('ceiling','height'),\r\n\t\tedge(conf,b){\r\n\t\t\tconf.edge=booleanString(b);\r\n\t\t},\r\n\t\tdisable(conf,b){\r\n\t\t\tconf.mv3d=booleanString(b);\r\n\t\t}\r\n\t},\r\n\r\n});\r\n\r\n// event config\r\nconst _event_setupPage = Game_Event.prototype.setupPage;\r\nGame_Event.prototype.setupPage = function() {\r\n\t_event_setupPage.apply(this,arguments);\r\n\tif(this.mv3d_sprite){\r\n\t\tthis.mv3d_needsConfigure=true;\r\n\t\tthis.mv3d_sprite.eventConfigure();\r\n\t}\r\n};\r\n\r\nconst _event_init = Game_Event.prototype.initialize;\r\nGame_Event.prototype.initialize = function() {\r\n\t_event_init.apply(this,arguments);\r\n\tif(mv3d.mapLoaded){\r\n\t\tmv3d.createCharacterFor(this);\r\n\t}\r\n\tconst event = this.event();\r\n\tlet config = {};\r\n\tmv3d.readConfigurationFunctions(\r\n\t\tmv3d.readConfigurationTags(event.note),\r\n\t\tmv3d.eventConfigurationFunctions,\r\n\t\tconfig,\r\n\t);\r\n\tif('pos' in config){\r\n\t\tthis.locate(\r\n\t\t\trelativeNumber(event.x,config.pos.x),\r\n\t\t\trelativeNumber(event.y,config.pos.y),\r\n\t\t);\r\n\t}\r\n\tif(!this.mv3d_blenders){\r\n\t\tthis.mv3d_blenders={};\r\n\t}\r\n\tif('lamp' in config){\r\n\t\tthis.mv3d_blenders.lampColor_r=config.lamp.color>>16;\r\n\t\tthis.mv3d_blenders.lampColor_g=config.lamp.color>>8&0xff;\r\n\t\tthis.mv3d_blenders.lampColor_b=config.lamp.color&0xff;\r\n\t\tthis.mv3d_blenders.lampIntensity=config.lamp.intensity;\r\n\t\tthis.mv3d_blenders.lampDistance=config.lamp.distance\r\n\t}\r\n\tif('flashlight' in config){\r\n\t\tthis.mv3d_blenders.flashlightColor_r=config.flashlight.color>>16;\r\n\t\tthis.mv3d_blenders.flashlightColor_g=config.flashlight.color>>8&0xff;\r\n\t\tthis.mv3d_blenders.flashlightColor_b=config.flashlight.color&0xff;\r\n\t\tthis.mv3d_blenders.flashlightIntensity=config.flashlight.intensity;\r\n\t\tthis.mv3d_blenders.flashlightDistance=config.flashlight.distance;\r\n\t\tthis.mv3d_blenders.flashlightAngle=config.flashlight.angle;\r\n\t}\r\n\tif('flashlightPitch' in config){\r\n\t\tthis.mv3d_blenders.flashlightPitch=Number(config.flashlightPitch);\r\n\t}\r\n\tif('flashlightYaw' in config){\r\n\t\tthis.mv3d_blenders.flashlightYaw=config.flashlightYaw;\r\n\t}\r\n\tthis.mv3d_needsConfigure=true;\r\n};","import mv3d from './mv3d.js';\r\nimport { makeColor, relativeNumber } from './util.js';\r\n\r\nconst _pluginCommand = Game_Interpreter.prototype.pluginCommand;\r\nGame_Interpreter.prototype.pluginCommand = function(command, args) {\r\n\tif(command.toLowerCase() !== 'mv3d'){\r\n\t\treturn _pluginCommand.apply(this,arguments);\r\n\t}\r\n\tconst pc = new mv3d.PluginCommand();\r\n\tpc.INTERPRETER=this;\r\n\tpc.FULL_COMMAND=[command,...args].join(' ');\r\n\targs=args.filter(v=>v);\r\n\tpc.CHAR=$gameMap.event(this._eventId);\r\n\tif(args[0]){\r\n\t\tconst firstChar = args[0][0];\r\n\t\tif(firstChar==='@'||firstChar===''){\r\n\t\t\tpc.CHAR = pc.TARGET_CHAR(args.shift());\r\n\t\t}\r\n\t}\r\n\r\n\tconst com = args.shift().toLowerCase();\r\n\tif(com in pc){\r\n\t\tpc[com](...args);\r\n\t}\r\n};\r\n\r\n\r\nmv3d.PluginCommand=class{\r\n\tasync camera(...a){\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'pitch'    : this.pitch (a[1],time); return;\r\n\t\t\tcase 'yaw'      : this.yaw   (a[1],time); return;\r\n\t\t\tcase 'dist'     :\r\n\t\t\tcase 'distance' : this.dist  (a[1],time); return;\r\n\t\t\tcase 'height'   : this.height(a[1],time); return;\r\n\t\t\tcase 'mode'     : this.cameramode(a[1]); return;\r\n\t\t\tcase 'target': this._cameraTarget(a[1],time); return;\r\n\t\t\tcase 'pan': this.pan(a[1],a[2],a[3]); return;\r\n\t\t}\r\n\t}\r\n\tyaw(deg,time=1){\r\n\t\tthis._RELATIVE_BLEND(mv3d.blendCameraYaw,deg,time);\r\n\t\tif ( mv3d.is1stPerson() ) { mv3d.playerFaceYaw(); }\r\n\t}\r\n\tpitch(deg,time=1){ this._RELATIVE_BLEND(mv3d.blendCameraPitch,deg,time); }\r\n\tdist(n,time=1){ this._RELATIVE_BLEND(mv3d.blendCameraDist,n,time); }\r\n\theight(n,time=1){ this._RELATIVE_BLEND(mv3d.blendCameraHeight,n,time); }\r\n\t_cameraTarget(target,time){\r\n\t\tmv3d.setCameraTarget(this.TARGET_CHAR(target), time);\r\n\t}\r\n\tpan(x,y,time=1){\r\n\t\tconsole.log(x,y,time);\r\n\t\ttime=this._TIME(time);\r\n\t\tthis._RELATIVE_BLEND(mv3d.blendPanX,x,time);\r\n\t\tthis._RELATIVE_BLEND(mv3d.blendPanY,y,time);\r\n\t}\r\n\r\n\trotationmode(mode){ mv3d.rotationMode=mode; }\r\n\tpitchmode(mode){ mv3d.pitchMode=mode; }\r\n\r\n\t_VEHICLE(vehicle,data,value){\r\n\t\tdata=data.toLowerCase();\r\n\t\tconst key = `${Vehicle}_${data}`;\r\n\t\tif(data==='big'){ value=booleanString(value); }\r\n\t\telse{ value=relativeNumber(mv3d.loadData(key,0),value); }\r\n\t\tmv3d.saveData(key,value);\r\n\t}\r\n\tboat(d,v){ this._VEHICLE('boat',d,v); }\r\n\tship(d,v){ this._VEHICLE('ship',d,v); }\r\n\tairship(d,v){ this._VEHICLE('airship',d,v); }\r\n\tcameramode(mode){ mv3d.cameraMode=mode; }\r\n\tfog(...a){\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'color': this._fogColor(a[1],time); return;\r\n\t\t\tcase 'near': this._fogNear(a[1],time); return;\r\n\t\t\tcase 'far': this._fogFar(a[1],time); return;\r\n\t\t\tcase 'dist': case 'distance':\r\n\t\t\t\ttime=this._TIME(a[3]);\r\n\t\t\t\tthis._fogNear(a[1],time);\r\n\t\t\t\tthis._fogFar(a[2],time);\r\n\t\t\t\treturn;\r\n\t\t}\r\n\t\ttime=this._TIME(a[3]);\r\n\t\tthis._fogColor(a[0],time);\r\n\t\tthis._fogNear(a[1],time);\r\n\t\tthis._fogFar(a[2],time);\r\n\t}\r\n\t_fogColor(color,time){ mv3d.blendFogColor.setValue(makeColor(color).toNumber(),time); }\r\n\t_fogNear(n,time){ this._RELATIVE_BLEND(mv3d.blendFogNear,n,time); }\r\n\t_fogFar(n,time){ this._RELATIVE_BLEND(mv3d.blendFogFar,n,time); }\r\n\tlight(...a){\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'color'    : this._lightColor    (a[1],time); return;\r\n\t\t\t//case 'intensity': this._lightIntensity(a[1],time); return;\r\n\t\t}\r\n\t\ttime=this._TIME(a[1]);\r\n\t\tthis._lightColor(a[0],time);\r\n\t\t//this._lightintensity(a[0],time);\r\n\t}\r\n\t_lightColor(color,time=1){ mv3d.blendAmbientColor.setValue(makeColor(color).toNumber(),time); }\r\n\t//_lightIntensity(n,time=1){ this._RELATIVE_BLEND(mv3d.blendLightIntensity,n,time); }\r\n\tasync lamp(...a){\r\n\t\tconst char = await this.AWAIT_CHAR(this.CHAR);\r\n\t\tchar.setupLamp();\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'color'    : this._lampColor    (char,a[1],time); return;\r\n\t\t\tcase 'intensity': this._lampIntensity(char,a[1],time); return;\r\n\t\t\tcase 'dist'     :\r\n\t\t\tcase 'distance' : this._lampDistance (char,a[1],time); return;\r\n\t\t}\r\n\t\ttime=this._TIME(a[3]);\r\n\t\tthis._lampColor(char,a[0],time);\r\n\t\tthis._lampIntensity(char,a[1],time);\r\n\t\tthis._lampDistance(char,a[2],time);\r\n\t}\r\n\t_lampColor(char,color,time=1){ char.blendLampColor.setValue(makeColor(color).toNumber(),time); }\r\n\t_lampIntensity(char,n,time=1){ this._RELATIVE_BLEND(char.blendLampIntensity,n,time); }\r\n\t_lampDistance(char,n,time=1){ this._RELATIVE_BLEND(char.blendLampDistance,n,time); }\r\n\tasync flashlight(...a){\r\n\t\tconst char = await this.AWAIT_CHAR(this.CHAR);\r\n\t\tchar.setupFlashlight();\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'color'    : this._flashlightColor    (char,a[1],time); return;\r\n\t\t\tcase 'intensity': this._flashlightIntensity(char,a[1],time); return;\r\n\t\t\tcase 'dist'     :\r\n\t\t\tcase 'distance' : this._flashlightDistance (char,a[1],time); return;\r\n\t\t\tcase 'angle'    : this._flashlightAngle    (char,a[1],time); return;\r\n\t\t\tcase 'yaw'      : this._flashlightYaw      (char,a[1],time); return;\r\n\t\t\tcase 'pitch'    : this._flashlightPitch    (char,a[1],time); return;\r\n\t\t}\r\n\t\ttime=this._TIME(a[4]);\r\n\t\tthis._flashlightColor(char,a[0],time);\r\n\t\tthis._flashlightIntensity(char,a[1],time);\r\n\t\tthis._flashlightDistance(char,a[2],time);\r\n\t\tthis._flashlightAngle(char,a[3],time);\r\n\t}\r\n\t_flashlightColor(char,color,time){ char.blendFlashlightColor.setValue(makeColor(color).toNumber(),time); }\r\n\t_flashlightIntensity(char,n,time){ this._RELATIVE_BLEND(char.blendFlashlightIntensity,n,time); }\r\n\t_flashlightDistance(char,n,time){ this._RELATIVE_BLEND(char.blendFlashlightDistance,n,time); }\r\n\t_flashlightAngle(char,n,time){ this._RELATIVE_BLEND(char.blendFlashlightAngle,n,time); }\r\n\t_flashlightPitch(char,n,time){ this._RELATIVE_BLEND(char.blendFlashlightPitch,n,time); }\r\n\t_flashlightYaw(char,yaw,time){ char.flashlightTargetYaw=yaw; }\r\n\t_RELATIVE_BLEND(blender,n,time){ blender.setValue(relativeNumber(blender.targetValue(),n),Number(time)); }\r\n\t_TIME(time){\r\n\t\tif(typeof time==='number'){ return time; }\r\n\t\ttime=Number(time);\r\n\t\tif(Number.isNaN(time)){ return 1; }\r\n\t\treturn time;\r\n\t}\r\n\tERROR_CHAR(){\r\n\t\tconsole.warn(`MV3D: Plugin command \\`${this.FULL_COMMAND}\\` failed because target character was invalid.`);\r\n\t\t//console.log(this.CHAR);\r\n\t}\r\n\tasync AWAIT_CHAR(char){\r\n\t\tif(!char){ return this.ERROR_CHAR(); }\r\n\t\tlet w=0;\r\n\t\twhile(!char.mv3d_sprite){\r\n\t\t\tawait sleep(100);\r\n\t\t\tif(++w>10){ return this.ERROR_CHAR(); }\r\n\t\t}\r\n\t\treturn char.mv3d_sprite;\r\n\t}\r\n\tTARGET_CHAR(target){\r\n\t\treturn mv3d.targetChar(target,$gameMap.event(this.INTERPRETER._eventId),this.CHAR);\r\n\t}\r\n};\r\n\r\nmv3d.targetChar=function(target,self=null,dfault=null){\r\n\tif(!target){ return dfault; }\r\n\tlet m=target.toLowerCase().match(/[a-z]+/);\r\n\tconst mode=m?m[0]:'e';\r\n\tm=target.match(/\\d+/);\r\n\tconst id=m?Number(m[0]):0;\r\n\tswitch(mode[0]){\r\n\t\tcase 's': return self;\r\n\t\tcase 'p': return $gamePlayer;\r\n\t\tcase 'e':\r\n\t\t\tif(!id){ return self; }\r\n\t\t\treturn $gameMap.event(id);\r\n\t\tcase 'v':\r\n\t\t\treturn $gameMap.vehicle(id);\r\n\t\tcase 'f':\r\n\t\t\treturn $gamePlayer.followers()._data[id];\r\n\t}\r\n\treturn char;\r\n}\r\nmv3d.getTargetString=function(char){\r\n\tif( char instanceof Game_Player){\r\n\t\treturn `@p`;\r\n\t}\r\n\tif( char instanceof Game_Event ){\r\n\t\treturn `@e${char._eventId}`;\r\n\t}\r\n\tif( char instanceof Game_Follower){\r\n\t\treturn `@f${$gamePlayer._followers._data.indexOf(char)}`;\r\n\t}\r\n\tif( char instanceof Game_Vehicle){\r\n\t\treturn `@v${$gameMap._vehicles.indexOf(char)}`;\r\n\t}\r\n}","import mv3d from './mv3d.js';\r\nimport { v2origin, tileSize } from './util.js';\r\n\r\nObject.assign(mv3d,{\r\n\r\n\t_tilemap:null,\r\n\tgetTilemap(){\r\n\t\tif(SceneManager._scene&&SceneManager._scene._spriteset){\r\n\t\t\tthis._tilemap = SceneManager._scene._spriteset._tilemap;\r\n\t\t}\r\n\t\treturn this._tilemap;\r\n\t},\r\n\r\n\tgetSetNumber(id){\r\n\t\tif(Tilemap.isAutotile(id)){\r\n\t\t\treturn Tilemap.isTileA1(id)?0\r\n\t\t\t\t: Tilemap.isTileA2(id)?1 : Tilemap.isTileA3(id)?2 : 3;\r\n\t\t}else{\r\n\t\t\treturn Tilemap.isTileA5(id)?4:5+Math.floor(id/256);\r\n\t\t}\r\n\t},\r\n\r\n\tgetTerrainTag(tileId){\r\n\t\treturn $gameMap.tilesetFlags()[tileId]>>12;\r\n\t},\r\n\r\n\tgetMaterialOptions(conf,side){\r\n\t\tconst options={};\r\n\t\tif ('alpha' in conf){ options.alpha=conf.alpha; }\r\n\t\tif ('glow' in conf){ options.glow=conf.glow; }\r\n\t\tif(side){\r\n\t\t\tif(`${side}_alpha` in conf){ options.alpha=conf[`${side}_alpha`]; }\r\n\t\t\tif(`${side}_glow` in conf){ options.glow=conf[`${side}_glow`]; }\r\n\t\t}\r\n\t\tif('alpha' in options){ options.transparent=true; }\r\n\t\treturn options;\r\n\t},\r\n\r\n\tgetTileAnimationData(tileConf,side){\r\n\t\tconst tileId=tileConf[`${side}_id`];\r\n\t\tif(`${side}_animData` in tileConf){\r\n\t\t\treturn tileConf[`${side}_animData`];\r\n\t\t}\r\n\t\tconst animData={animX:0,animY:0};\r\n\t\tif(Tilemap.isTileA1(tileId)){\r\n\t\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\t\tanimData.animX=kind<=1?2:kind<=3?0:kind%2?0:2;\r\n\t\t\tanimData.animY=kind<=3?0:kind%2?1:0; \r\n\t\t}\r\n\t\treturn animData;\r\n\t},\r\n\r\n\tgetTileConfig(tileId,x,y,l){\r\n\t\tconst conf = {};\r\n\t\tconst ttag = this.getTerrainTag(tileId);\r\n\t\tif(ttag && ttag in this.TTAG_DATA){\r\n\t\t\tObject.assign(conf,this.TTAG_DATA[ttag]);\r\n\t\t}\r\n\t\tconst ts_conf = this.tilesetConfigurations[this.normalizeAutotileId(tileId)];\r\n\t\tif(ts_conf){\r\n\t\t\tObject.assign(conf,ts_conf);\r\n\t\t}\r\n\t\tif(l===0){\r\n\t\t\tconst region = $gameMap.regionId(x,y);\r\n\t\t\tif(region && region in mv3d.REGION_DATA){\r\n\t\t\t\tObject.assign(conf,this.REGION_DATA[region]);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn conf;\r\n\t},\r\n\r\n\tgetTileTextureOffsets(tileId,x,y,l){\r\n\t\tconst conf = this.getTileConfig(tileId,x,y,l);\r\n\t\tconst tileRange = Tilemap.isAutotile(tileId)?48:1;\r\n\t\tconst tilemap = this.getTilemap();\r\n\t\tconf.hasInsideConf=Boolean(conf.inside_offset||conf.rectInside||('inside_id' in conf));\r\n\t\tconf.hasBottomConf=Boolean(conf.bottom_offset||conf.rectBottom||('bottom_id' in conf));\r\n\t\tif(conf.top_id==null){ \r\n\t\t\tconf.top_id=tileId;\r\n\t\t\tif(conf.top_offset){\r\n\t\t\t\tconf.top_id = tileId+conf.top_offset.x*tileRange+conf.top_offset.y*tileRange*8;\r\n\t\t\t}\r\n\t\t }\r\n\t\tif(conf.side_id==null){\r\n\t\t\tconf.side_id=tileId;\r\n\t\t\tif(conf.side_offset){\r\n\t\t\t\tconf.side_id = tileId+conf.side_offset.x*tileRange+conf.side_offset.y*tileRange*8;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(conf.inside_id==null){ \r\n\t\t\tconf.inside_id=conf.side_id;\r\n\t\t\tif(conf.inside_offset){\r\n\t\t\t\tconf.inside_id=tileId+conf.inside_offset.x*tileRange+conf.inside_offset.y*tileRange*8;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(conf.bottom_id==null){\r\n\t\t\tconf.bottom_id=conf.top_id;\r\n\t\t\tif(conf.bottom_offset){\r\n\t\t\t\tconf.bottom_id=tileId+conf.bottom_offset.x*tileRange+conf.bottom_offset.y*tileRange*8;\r\n\t\t\t}\r\n\t\t}\r\n\t\tconf.fringeHeight=conf.height||0;\r\n\t\tif(conf.fringe==null){\r\n\t\t\tconf.fringe = !this.isTileEmpty(tileId)&&tilemap&&tilemap._isHigherTile(tileId)?this.FRINGE_HEIGHT:0;\r\n\t\t}\r\n\t\treturn conf;\r\n\t},\r\n\r\n\tgetTileData(x,y){\r\n\t\tif(!$dataMap || !$dataMap.data){ return [0,0,0,0]; }\r\n\t\tconst data = $dataMap.data;\r\n\t\tconst width = $dataMap.width;\r\n\t\tconst height = $dataMap.height;\r\n\t\tif($gameMap.isLoopHorizontal()){\r\n\t\t\tx=x.mod(width);\r\n\t\t}\r\n\t\tif($gameMap.isLoopVertical()){\r\n\t\t\ty=y.mod(height);\r\n\t\t}\r\n\t\tif(x<0||x>=width||y<0||y>=height){ return [0,0,0,0]; }\r\n\t\tconst tileData=[];\r\n\t\tfor (let z=0;z<4;++z){//4 tile layers. Ignore shadow bits.\r\n\t\t\ttileData[z] = data[(z * height + y) * width + x] || 0;\r\n\t\t}\r\n\t\treturn tileData;\r\n\t},\r\n\r\n\r\n\tgetTileHeight(x,y,l=0){\r\n\t\tif(!$dataMap){ return 0; }\r\n\r\n\t\tif($gameMap.isLoopHorizontal()){ x=x.mod($dataMap.width); }\r\n\t\tif($gameMap.isLoopVertical()){ y=y.mod($dataMap.height); }\r\n\r\n\t\tconst tileId=this.getTileData(x,y)[l];\r\n\t\tif(this.isTileEmpty(tileId)&&l>0){ return 0; }\r\n\t\t// finge tiles don't stack normally. fringeHeight property should be used when drawing them.\r\n\t\tconst tilemap=this.getTilemap();\r\n\t\tif(tilemap&&tilemap._isHigherTile(tileId)){ return 0; }\r\n\r\n\t\tconst conf =this.getTileConfig(tileId,x,y,l);\r\n\t\tlet height = 0;\r\n\t\tif('height' in conf){\r\n\t\t\theight = conf.height;\r\n\t\t}else if(this.isWallTile(tileId)){\r\n\t\t\theight = this.WALL_HEIGHT;\r\n\t\t}else if(tilemap&&tilemap._isTableTile(tileId)){\r\n\t\t\theight = this.TABLE_HEIGHT;\r\n\t\t}else if(this.isSpecialShape(conf.shape)){\r\n\t\t\theight = 1;\r\n\t\t}\r\n\t\tif('depth' in conf){\r\n\t\t\theight -= conf.depth;\r\n\t\t}\r\n\t\treturn height;\r\n\t},\r\n\r\n\tgetStackHeight(x,y,layerId=3){\r\n\t\tlet height=0;\r\n\t\tfor(let l=0; l<=layerId; ++l){\r\n\t\t\theight+=this.getTileHeight(x,y,l);\r\n\t\t}\r\n\t\treturn height;\r\n\t},\r\n\r\n\tgetWalkHeight(x,y){\r\n\t\t// get the height of characters for given x,y coord. Uses float coords. Should support ramps.\r\n\t\tconst rx=Math.round(x), ry=Math.round(y);\r\n\t\tconst tileData=this.getTileData(rx,ry);\r\n\t\tlet height=0;\r\n\t\tlet tileHeight=0;\r\n\t\tfor(let l=0; l<=3; ++l){\r\n\t\t\tconst tileId=tileData[l];\r\n\t\t\tif(this.isTileEmpty(tileId)&&l>0){ continue; }\r\n\t\t\theight += tileHeight;\r\n\t\t\ttileHeight = this.getTileHeight(rx,ry,l);\r\n\t\t\tconst data = this.getTileConfig(tileId,rx,ry,l);\r\n\t\t\tconst shape = data.shape;\r\n\t\t\tif(!this.isSpecialShape(shape)){\r\n\t\t\t\theight+=tileHeight;\r\n\t\t\t\ttileHeight=0;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn height;\r\n\t\t\r\n\t},\r\n\r\n\tgetFloatHeight(x,y){\r\n\t\tconst tileData=this.getTileData(x,y);\r\n\t\tlet float=0;\r\n\t\tfor(let l=0; l<=3; ++l){\r\n\t\t\tconst tileId=tileData[l];\r\n\t\t\tif(this.isTileEmpty(tileId)){ continue; }\r\n\t\t\tconst conf = this.getTileConfig(tileId,x,y,l);\r\n\t\t\tif(conf && 'float' in conf){\r\n\t\t\t\tfloat += conf.float;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn float;\r\n\t},\r\n\r\n\tgetFringeHeight(x,y,l=3){\r\n\t\tlet height = this.getStackHeight(x,y,l-1);\r\n\t\tconst tileId=this.getTileData(x,y)[l];\r\n\t\tconst conf = this.getTileConfig(tileId,x,y,l);\r\n\t\tif(conf && this.getTilemap()._isHigherTile(tileId)){\r\n\t\t\treturn height + (conf.fringe||this.FRINGE_HEIGHT) + (conf.height||0);\r\n\t\t}\r\n\t\treturn 0;\r\n\t},\r\n\r\n\tgetCullingHeight(x,y,layerId=3,ignorePits=false){\r\n\t\tconst tileData=this.getTileData(x,y);\r\n\t\tlet height=0;\r\n\t\tfor(let l=0; l<=layerId; ++l){\r\n\t\t\tconst tileId=tileData[l];\r\n\t\t\tconst data = this.getTileConfig(tileId,x,y,l);\r\n\t\t\tconst shape = data.shape;\r\n\t\t\tif(this.isSpecialShape(shape)){\r\n\t\t\t\treturn height;\r\n\t\t\t}\r\n\t\t\tif(ignorePits&&data.depth>0){\r\n\t\t\t\theight+=data.depth;\r\n\t\t\t}\r\n\t\t\theight+=this.getTileHeight(x,y,l);\r\n\t\t}\r\n\t\treturn height;\r\n\t},\r\n\r\n\ttileHasPit(x,y,layerId=3){\r\n\t\tconst tileData=this.getTileData(x,y);\r\n\t\tfor(let l=0; l<=layerId; ++l){\r\n\t\t\tconst tileId=tileData[l];\r\n\t\t\tconst conf = this.getTileConfig(tileId,x,y,l);\r\n\t\t\tif(conf.depth>0){ return true; }\r\n\t\t}\r\n\t\treturn false;\r\n\t},\r\n\r\n\tisTilePit(x,y,l){\r\n\t\tconst tileId=this.getTileData(x,y)[l];\r\n\t\tconst conf = this.getTileConfig(tileId,x,y,l);\r\n\t\treturn conf.depth>0;\r\n\t},\r\n\r\n\tgetTileRects(tileId){\r\n\t\tconst rects = [];\r\n\t\tconst tilemap=this.getTilemap();\r\n\t\tconst isTable=tilemap._isTableTile(tileId);\r\n\t\ttilemap._drawTile({addRect:(sheetId,sx,sy,dx,dy,width,height,animX,animY)=>{\r\n\t\t\trects.push({setN:sheetId,x:sx,y:sy,width:width,height:height,ox:dx,oy:dy});\r\n\t\t}}, tileId, 0,0);\r\n\t\tif (isTable) for (let i=rects.length-1;i>=0;--i){\r\n\t\t\tif(rects[i].oy>tileSize()/2){\r\n\t\t\t\trects[i-1].y+=tileSize()*2/3;\r\n\t\t\t\trects.splice(i,1);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn rects;\r\n\t},\r\n\r\n\tisTileEmpty(tileId){\r\n\t\treturn !tileId||tileId===1544;\r\n\t},\r\n\r\n\tisWallTile(tileId){\r\n\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\tconst ty = Math.floor(kind / 8);\r\n\t\tconst isWall = Tilemap.isTileA3(tileId) || Tilemap.isTileA4(tileId);\r\n\t\tif (isWall && ty%2){ return 2; }\r\n\t\treturn isWall;\r\n\t},\r\n\r\n\tisTableTile(tileId){\r\n\t\treturn Boolean(this.getTilemap()._isTableTile(tileId));\r\n\t},\r\n\r\n\tisFringeTile(tileId){\r\n\t\treturn Boolean(this.getTilemap()._isHigherTile(tileId));\r\n\t},\r\n\r\n\tisWaterfallTile(tileId){\r\n\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\treturn Tilemap.isTileA1(tileId)&&kind>=4&&kind%2;\r\n\t},\r\n\r\n\tisSpecialShape(shape){\r\n\t\tconst shapes = mv3d.configurationShapes;\r\n\t\treturn shape===shapes.FENCE||shape===shapes.CROSS||shape===shapes.XCROSS;\r\n\t},\r\n\r\n\tconstructTileId(img,x,y){\r\n\t\tconst key = `TILE_ID_${img.toUpperCase()}`\r\n\t\tlet tileId = key in Tilemap ? Tilemap[key] : 0;\r\n\t\tconst tileRange = Tilemap.isAutotile(tileId) ? 48 : 1;\r\n\t\ttileId += Number(x)*tileRange + Number(y)*tileRange*8;\r\n\t\treturn tileId;\r\n\t},\r\n\tnormalizeAutotileId(tileId){\r\n\t\tif(!Tilemap.isAutotile(tileId)){ return tileId; }\r\n\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\treturn Tilemap.TILE_ID_A1 + kind*48;\r\n\t},\r\n\r\n});","import mv3d from \"./mv3d.js\";\r\nimport { Mesh, VertexData } from \"./mod_babylon.js\";\r\n\r\nexport class CellMeshBuilder{\r\n\tconstructor(){\r\n\t\tthis.submeshBuilders={};\r\n\t}\r\n\tbuild(){\r\n\t\tconst submeshBuildersArray=Object.values(this.submeshBuilders);\r\n\t\tif(!submeshBuildersArray.length){ return null; }\r\n\t\tconst submeshes = submeshBuildersArray.map(builder=>builder.build());\r\n\t\tconst mesh = Mesh.MergeMeshes(submeshes,true,undefined,undefined,false,true);\r\n\t\treturn mesh;\r\n\t}\r\n\tgetBuilder(material){\r\n\t\tif(!(material.name in this.submeshBuilders)){\r\n\t\t\tthis.submeshBuilders[material.name] = new SubMeshBuilder(material);\r\n\t\t}\r\n\t\treturn this.submeshBuilders[material.name];\r\n\t}\r\n\taddWallFace(material,tx,ty,tw,th,x,y,z,w,h,rot,options={}){\r\n\t\tconst builder = this.getBuilder(material);\r\n\t\tconst uvRect = SubMeshBuilder.getUvRect(material.diffuseTexture,tx,ty,tw,th);\r\n\t\tbuilder.addWallFace(x,y,z,w,h,rot,uvRect,options);\r\n\t\tif(options.double){\r\n\t\t\toptions.flip=!options.flip;\r\n\t\t\tbuilder.addWallFace(x,y,z,w,h,rot,uvRect,options);\r\n\t\t}\r\n\t}\r\n\taddFloorFace(material,tx,ty,tw,th,x,y,z,w,h,flip){\r\n\t\tconst builder = this.getBuilder(material);\r\n\t\tconst uvRect = SubMeshBuilder.getUvRect(material.diffuseTexture,tx,ty,tw,th);\r\n\t\tbuilder.addFloorFace(x,y,z,w,h,flip,uvRect);\r\n\t}\r\n}\r\n\r\nclass SubMeshBuilder{\r\n\tconstructor(material){\r\n\t\tthis.material=material;\r\n\t\tthis.positions=[];\r\n\t\tthis.indices=[];\r\n\t\tthis.normals=[];\r\n\t\tthis.uvs=[];\r\n\t}\r\n\tbuild(){\r\n\t\tconst mesh = new Mesh('cell mesh', mv3d.scene);\r\n\t\t//VertexData.ComputeNormals(this.positions,this.indices,this.normals);\r\n\t\tconst vdata = new VertexData();\r\n\t\tvdata.positions=this.positions;\r\n\t\tvdata.indices=this.indices;\r\n\t\tvdata.normals=this.normals;\r\n\t\tvdata.uvs=this.uvs;\r\n\t\tvdata.applyToMesh(mesh);\r\n\t\tmesh.material=this.material;\r\n\t\treturn mesh;\r\n\t}\r\n\taddWallFace(x,z,y,w,h,rot,uvr,options){\r\n\t\tz=-z;y=y;\r\n\t\tconst xf=Math.round(Math.cos(rot)*1000)/1000;\r\n\t\tconst zf=Math.round(Math.sin(rot)*1000)/1000;\r\n\t\tconst ww=w/2, hh=h/2;\r\n\t\tconst positions = [\r\n\t\t\tx-ww*xf, y+hh, z+ww*zf,\r\n\t\t\tx+ww*xf, y+hh, z-ww*zf,\r\n\t\t\tx-ww*xf, y-hh, z+ww*zf,\r\n\t\t\tx+ww*xf, y-hh, z-ww*zf,\r\n\t\t];\r\n\t\tconst normals=[ -zf,0,-xf, -zf,0,-xf, -zf,0,-xf, -zf,0,-xf ];\r\n\t\tconst uvs = [\r\n\t\t\tuvr.x1,uvr.y1,\r\n\t\t\tuvr.x2,uvr.y1,\r\n\t\t\tuvr.x1,uvr.y2,\r\n\t\t\tuvr.x2,uvr.y2,\r\n\t\t];\r\n\t\tconst indices=[1,0,2,1,2,3];\r\n\t\tif(options.flip){\r\n\t\t\tindices.reverse();\r\n\t\t\tfor(let i=0;i<normals.length;++i){ normals[i]*=-1; }\r\n\t\t}\r\n\t\tthis.pushNewData(positions,indices,normals,uvs);\r\n\t}\r\n\taddFloorFace(x,z,y,w,h,flip,uvr){\r\n\t\tz=-z;y=y;\r\n\t\tconst f=flip*-2+1;\r\n\t\tconst ww=f*w/2, hh=h/2;\r\n\t\tconst positions = [\r\n\t\t\tx-ww, y, z+hh,\r\n\t\t\tx+ww, y, z+hh,\r\n\t\t\tx-ww, y, z-hh,\r\n\t\t\tx+ww, y, z-hh,\r\n\t\t];\r\n\t\tconst normals=[ 0,f,0, 0,f,0, 0,f,0, 0,f,0 ];\r\n\t\tconst uvs = [\r\n\t\t\tuvr.x1,uvr.y1,\r\n\t\t\tuvr.x2,uvr.y1,\r\n\t\t\tuvr.x1,uvr.y2,\r\n\t\t\tuvr.x2,uvr.y2,\r\n\t\t];\r\n\t\tconst indices=[1,0,2,1,2,3];\r\n\t\tif(flip){\r\n\t\t\tfor(let i=0;i<normals.length;++i){ normals[i]*=-1; }\r\n\t\t}\r\n\t\tthis.pushNewData(positions,indices,normals,uvs);\r\n\t}\r\n\tpushNewData(positions,indices,normals,uvs){\r\n\t\tthis.indices.push(...indices.map(i=>i+this.positions.length/3));\r\n\t\tthis.positions.push(...positions);\r\n\t\tthis.normals.push(...normals);\r\n\t\tthis.uvs.push(...uvs);\r\n\t}\r\n\tstatic getUvRect(tsTexture,x,y,w,h){\r\n\t\tconst { width, height } = tsTexture.getBaseSize();\r\n\t\tif(mv3d.EDGE_FIX){ x+=mv3d.EDGE_FIX;y+=mv3d.EDGE_FIX;w-=mv3d.EDGE_FIX*2;h-=mv3d.EDGE_FIX*2; }\r\n\t\treturn {\r\n\t\t\tx1:x/width,\r\n\t\t\ty1:(height-y)/height,\r\n\t\t\tx2:(x+w)/width,\r\n\t\t\ty2:(height-y-h)/height,\r\n\t\t};\r\n\t}\r\n}","import mv3d from './mv3d.js';\r\nimport { TransformNode, Mesh, MeshBuilder, Vector3, Vector2, FRONTSIDE, BACKSIDE, WORLDSPACE, LOCALSPACE, DOUBLESIDE, Plane } from \"./mod_babylon.js\";\r\nimport { tileSize, XAxis, YAxis, tileWidth, tileHeight, sleep, snooze } from './util.js';\r\nimport { CellMeshBuilder } from './MapCellBuilder.js';\r\n\r\nconst SOURCEPLANE_GROUND = new Plane(0, 1, -Math.pow(0.1,100), 0);\r\nconst SOURCEPLANE_WALL = new Plane(0,0,-1,0);\r\n\r\nexport class MapCell extends TransformNode{\r\n\tconstructor(cx,cy){\r\n\t\tconst key = [cx,cy].toString();\r\n\t\tsuper(`MapCell[${key}]`,mv3d.scene);\r\n\t\tthis.parent=mv3d.map;\r\n\t\t//mv3d.cells[key]=this;\r\n\t\tthis.cx=cx; this.cy=cy;\r\n\t\tthis.ox=cx*mv3d.CELL_SIZE; this.oy=cy*mv3d.CELL_SIZE;\r\n\t\tthis.x=this.ox; this.y=this.oy;\r\n\t\tthis.key=key;\r\n\r\n\t\t//this.load();\r\n\t}\r\n\tupdate(){\r\n\t\tconst loopPos = mv3d.loopCoords((this.cx+0.5)*mv3d.CELL_SIZE,(this.cy+0.5)*mv3d.CELL_SIZE);\r\n\t\tthis.x=loopPos.x-mv3d.CELL_SIZE/2;\r\n\t\tthis.y=loopPos.y-mv3d.CELL_SIZE/2;\r\n\t}\r\n\tasync load(){\r\n\t\tconst shapes = mv3d.configurationShapes;\r\n\t\tthis.builder = new CellMeshBuilder();\r\n\t\t// load all tiles in mesh\r\n\t\tconst cellWidth = Math.min(mv3d.CELL_SIZE,$gameMap.width()-this.cx*mv3d.CELL_SIZE);\r\n\t\tconst cellHeight = Math.min(mv3d.CELL_SIZE,$gameMap.height()-this.cy*mv3d.CELL_SIZE);\r\n\t\tconst ceiling = mv3d.getCeilingConfig();\r\n\t\tfor (let y=0; y<cellHeight; ++y)\r\n\t\tfor (let x=0; x<cellWidth; ++x){\r\n\t\t\tceiling.cull=false;\r\n\t\t\tlet nlnowall = 0; // the number of layers in a row that haven't had walls.\r\n\t\t\tconst tileData = mv3d.getTileData(this.ox+x,this.oy+y);\r\n\t\t\tfor (let l=0; l<4; ++l){\r\n\t\t\t\tif(mv3d.isTileEmpty(tileData[l])){ ++nlnowall; continue; }\r\n\t\t\t\tlet z = mv3d.getStackHeight(this.ox+x,this.oy+y,l);\r\n\t\t\t\tconst tileConf = mv3d.getTileTextureOffsets(tileData[l],this.ox+x,this.oy+y,l);\r\n\t\t\t\tconst shape = tileConf.shape;\r\n\t\t\t\ttileConf.realId = tileData[l];\r\n\t\t\t\t//tileConf.isAutotile = Tilemap.isAutotile(tileData[l]);\r\n\t\t\t\t//tileConf.isFringe = mv3d.isFringeTile(tileData[l]);\r\n\t\t\t\t//tileConf.isTable = mv3d.isTableTile(tileData[l]);\r\n\t\t\t\tconst wallHeight = mv3d.getTileHeight(this.ox+x,this.oy+y,l)||tileConf.height||0;\r\n\t\t\t\tz+=tileConf.fringe;\r\n\t\t\t\tif(mv3d.isFringeTile(tileData[l])){ z+=tileConf.fringeHeight; }\r\n\t\t\t\tif(!shape||shape===shapes.FLAT){\r\n\t\t\t\t\tawait this.loadTile(tileConf,x,y,z,l);\r\n\t\t\t\t\t//decide if we need to draw bottom of tile\r\n\t\t\t\t\tif(tileConf.hasBottomConf||tileConf.height>0&&(l>0||tileConf.fringe>0)){\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//decide whether to draw walls\r\n\t\t\t\t\tif(wallHeight||l===0){\r\n\t\t\t\t\t\tawait this.loadWalls(tileConf,x,y,z,l,wallHeight + nlnowall*mv3d.LAYER_DIST);\r\n\t\t\t\t\t\tnlnowall=0;\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\t++nlnowall;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(z>=ceiling.height){ ceiling.cull=true; }\r\n\t\t\t\t}else{ nlnowall=0; }\r\n\t\t\t\tif(shape===shapes.FENCE){\r\n\t\t\t\t\tawait this.loadFence(tileConf,x,y,z,l,wallHeight);\r\n\t\t\t\t}else if(shape===shapes.CROSS||shape===shapes.XCROSS){\r\n\t\t\t\t\tawait this.loadCross(tileConf,x,y,z,l,wallHeight);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(!mv3d.isTileEmpty(ceiling.bottom_id) && !ceiling.cull){\r\n\t\t\t\tawait this.loadTile(ceiling,x,y,ceiling.height,0,true);\r\n\t\t\t}\r\n\r\n\t\t\t//if(mv3d.mapReady){ await sleep(); }\r\n\t\t\t//if(!mv3d.mapLoaded){ this.earlyExit(); return; }\r\n\t\t}\r\n\t\t\r\n\t\tthis.mesh=this.builder.build();\r\n\t\tif(this.mesh){\r\n\t\t\tthis.mesh.parent=this;\r\n\t\t\tthis.mesh.alphaIndex=0;\r\n\t\t\tif(mv3d.DYNAMIC_SHADOWS){\r\n\t\t\t\tthis.mesh.receiveShadows=true;\r\n\t\t\t\t//mv3d.shadowGenerator.getShadowMap().renderList.push(this.mesh);\r\n\t\t\t\tmv3d.shadowGenerator.addShadowCaster(this.mesh);\r\n\t\t\t}\r\n\t\t}\r\n\t\tdelete this.builder\r\n\t}\r\n\tasync loadTile(tileConf,x,y,z,l,ceiling=false){\r\n\t\tconst tileId = ceiling?tileConf.bottom_id:tileConf.top_id;\r\n\t\tif(mv3d.isTileEmpty(tileId)){ return; }\r\n\t\tconst configRect = ceiling?tileConf.bottom_rect:tileConf.top_rect;\r\n\t\tconst isAutotile = Tilemap.isAutotile(tileId)&&!configRect;\r\n\t\tlet rects;\r\n\t\tif(configRect){\r\n\t\t\trects=[configRect];\r\n\t\t}else{\r\n\t\t\trects = mv3d.getTileRects(tileId);\r\n\t\t}\r\n\t\tconst tsMaterial = await mv3d.getCachedTilesetMaterialForTile(tileConf,ceiling?'bottom':'top');\r\n\t\tfor (const rect of rects){\r\n\t\t\tthis.builder.addFloorFace(tsMaterial,rect.x,rect.y,rect.width,rect.height,\r\n\t\t\t\tx + (rect.ox|0)/tileSize() - 0.25*isAutotile,\r\n\t\t\t\ty + (rect.oy|0)/tileSize() - 0.25*isAutotile,\r\n\t\t\t\tz + l*mv3d.LAYER_DIST,\r\n\t\t\t\t1-isAutotile/2, 1-isAutotile/2, ceiling\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\tasync loadWalls(tileConf,x,y,z,l,wallHeight){\r\n\t\tconst isFringe = mv3d.isFringeTile(tileConf.realId);\r\n\t\tfor (let ni=0; ni<MapCell.neighborPositions.length; ++ni){\r\n\t\t\tconst np = MapCell.neighborPositions[ni];\r\n\r\n\t\t\t// don't render walls on edge of map (unless it loops)\r\n\t\t\tif( !mv3d.getMapConfig('edge',true) )\r\n\t\t\tif((this.ox+x+np.x>=$dataMap.width||this.ox+x+np.x<0)&&!$gameMap.isLoopHorizontal()\r\n\t\t\t||(this.oy+y+np.y>=$dataMap.height||this.oy+y+np.y<0)&&!$gameMap.isLoopVertical()){\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tlet neededHeight=wallHeight;\r\n\t\t\tlet tileId=tileConf.side_id,configRect,texture_side='side';\r\n\t\t\tif(mv3d.isTileEmpty(tileId)){ continue; }\r\n\t\t\tif(isFringe){\r\n\t\t\t\tconst neighborHeight = mv3d.getFringeHeight(this.ox+x+np.x,this.oy+y+np.y,l);\r\n\t\t\t\tif(neighborHeight===z){ continue; }\r\n\t\t\t}else{\r\n\t\t\t\tconst neighborHeight = mv3d.getCullingHeight(this.ox+x+np.x,this.oy+y+np.y,tileConf.depth>0?3:l,!(tileConf.depth>0));\r\n\t\t\t\tneededHeight = z-neighborHeight;\r\n\t\t\t\tif(neededHeight>0&&l>0){ neededHeight=Math.min(wallHeight,neededHeight); }\r\n\t\t\t}\r\n\t\t\tif(tileConf.depth>0&&neededHeight<0){\r\n\t\t\t\tif(mv3d.tileHasPit(this.ox+x+np.x,this.oy+y+np.y,l)){ continue; }\r\n\t\t\t\t//if(mv3d.isTilePit(this.ox+x+np.x,this.oy+y+np.y,l)){ continue; }\r\n\t\t\t\tneededHeight = Math.max(neededHeight,-tileConf.depth);\r\n\t\t\t\tif(tileConf.hasInsideConf){\r\n\t\t\t\t\ttexture_side='inside';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if(neededHeight<=0){ continue; }\r\n\r\n\t\t\tif(texture_side==='inside'){\r\n\t\t\t\ttileId=tileConf.inside_id;\r\n\t\t\t\tif(tileConf.inside_rect){ configRect = tileConf.inside_rect; }\r\n\t\t\t}else{\r\n\t\t\t\tif(tileConf.side_rect){ configRect = tileConf.side_rect; }\r\n\t\t\t}\r\n\r\n\t\t\tconst tsMaterial = await mv3d.getCachedTilesetMaterialForTile(tileConf,texture_side);\r\n\r\n\t\t\tconst wallPos = new Vector3( x+np.x/2, y+np.y/2, z );\r\n\t\t\tconst rot = -Math.atan2(np.x, np.y);\r\n\t\t\tif(configRect || !Tilemap.isAutotile(tileId)){\r\n\t\t\t\tconst rect = configRect ? configRect : mv3d.getTileRects(tileId)[0];\r\n\t\t\t\tconst builderOptions={};\r\n\t\t\t\tif(neededHeight<0){ builderOptions.flip=true; }\r\n\t\t\t\tthis.builder.addWallFace(tsMaterial,rect.x,rect.y,rect.width,rect.height,\r\n\t\t\t\t\twallPos.x,\r\n\t\t\t\t\twallPos.y,\r\n\t\t\t\t\tz - neededHeight/2,\r\n\t\t\t\t\t1,Math.abs(neededHeight), rot, builderOptions\r\n\t\t\t\t);\r\n\t\t\t}else{ // Autotile\r\n\t\t\t\tconst npl=MapCell.neighborPositions[(+ni-1).mod(4)];\r\n\t\t\t\tconst npr=MapCell.neighborPositions[(+ni+1).mod(4)];\r\n\t\t\t\tconst leftHeight = mv3d.getStackHeight(this.ox+x+npl.x,this.oy+y+npl.y,l);\r\n\t\t\t\tconst rightHeight = mv3d.getStackHeight(this.ox+x+npr.x,this.oy+y+npr.y,l);\r\n\t\t\t\tconst {x:bx,y:by} = this.getAutotileCorner(tileId,tileConf.realId);\r\n\t\t\t\tlet wallParts=Math.max(1,Math.abs(Math.round(neededHeight*2)));\r\n\t\t\t\tlet partHeight=Math.abs(neededHeight/wallParts);\r\n\t\t\t\tlet sw = tileSize()/2;\r\n\t\t\t\tlet sh = tileSize()/2;\r\n\t\t\t\tif(mv3d.isTableTile(tileConf.realId)){\r\n\t\t\t\t\tsh=tileSize()/3;\r\n\t\t\t\t\twallParts=1;\r\n\t\t\t\t\tpartHeight=wallHeight;\r\n\t\t\t\t\t//partHeight=neededHeight;\r\n\t\t\t\t}\r\n\t\t\t\tfor (let ax=-1; ax<=1; ax+=2){\r\n\t\t\t\t\tfor(let az=0;az<wallParts;++az){\r\n\t\t\t\t\t\tlet hasLeftEdge,hasRightEdge;\r\n\t\t\t\t\t\tif(mv3d.isTableTile(tileConf.realId)){\r\n\t\t\t\t\t\t\thasLeftEdge = leftHeight!=z;\r\n\t\t\t\t\t\t\thasRightEdge = rightHeight!=z;\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\thasLeftEdge = leftHeight<z-az*partHeight;\r\n\t\t\t\t\t\t\thasRightEdge = rightHeight<z-az*partHeight;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tlet sx,sy;\r\n\t\t\t\t\t\tsx=bx*tileSize();\r\n\t\t\t\t\t\tsy=by*tileSize();\r\n\t\t\t\t\t\tsx=(bx+(ax>0?0.5+hasRightEdge:1-hasLeftEdge))*tileSize();\r\n\t\t\t\t\t\tif(mv3d.isWaterfallTile(tileId)){\r\n\t\t\t\t\t\t\tsy=(by+az%2/2)*tileSize();\r\n\t\t\t\t\t\t}else if(mv3d.isTableTile(tileId)){\r\n\t\t\t\t\t\t\tsy=(by+5/3)*tileSize();\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tsy=(by+(az===0?0:az===wallParts-1?1.5:1-az%2*0.5))*tileSize();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst builderOptions={};\r\n\t\t\t\t\t\tif(neededHeight<0){ builderOptions.flip=true; }\r\n\t\t\t\t\t\tthis.builder.addWallFace(tsMaterial,sx,sy,sw,sh,\r\n\t\t\t\t\t\t\twallPos.x+0.25*ax*Math.cos(rot),\r\n\t\t\t\t\t\t\twallPos.y+0.25*ax*Math.sin(rot),\r\n\t\t\t\t\t\t\tz - neededHeight*(neededHeight<0) - partHeight/2 - partHeight*az + l*mv3d.LAYER_DIST,\r\n\t\t\t\t\t\t\t0.5,partHeight, rot, builderOptions\r\n\t\t\t\t\t\t);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tasync loadFence(tileConf,x,y,z,l,wallHeight){\r\n\t\tconst tileId = tileConf.side_id;\r\n\t\tif(mv3d.isTileEmpty(tileId)){ return; }\r\n\t\tconst configRect = tileConf.side_rect;\r\n\t\tconst tsMaterial = await mv3d.getCachedTilesetMaterialForTile(tileConf,'side');\r\n\t\tconst isAutotile = Tilemap.isAutotile(tileId);\r\n\t\tconst edges = [];\r\n\t\tfor (let ni=0; ni<MapCell.neighborPositions.length; ++ni){\r\n\t\t\tconst np = MapCell.neighborPositions[ni];\r\n\t\t\tconst neighborHeight = mv3d.getTileHeight(this.ox+x+np.x,this.oy+y+np.y,l);\r\n\t\t\tif(neighborHeight!==wallHeight){ edges.push(ni); }\r\n\t\t}\r\n\t\tfor (let ni=0; ni<MapCell.neighborPositions.length; ++ni){\r\n\t\t\tconst np = MapCell.neighborPositions[ni];\r\n\r\n\t\t\tconst edge = edges.includes(ni);\r\n\t\t\tif(edge&&edges.length<4&&!isAutotile){ continue; }\r\n\r\n\t\t\tconst rightSide = np.x>0||np.y>0;\r\n\t\t\tlet rot = Math.atan2(np.x, np.y)+Math.PI/2;\r\n\t\t\tif(rightSide){\r\n\t\t\t\trot-=Math.PI;\r\n\t\t\t}\r\n\r\n\t\t\tif(isAutotile&&!configRect){\r\n\t\t\t\tconst {x:bx,y:by} = this.getAutotileCorner(tileId,tileConf.realId);\r\n\t\t\t\tfor (let az=0;az<=1;++az){\r\n\t\t\t\t\tthis.builder.addWallFace(tsMaterial,\r\n\t\t\t\t\t\t(edge ? (bx+rightSide*1.5) : (bx+1-rightSide*0.5) )*tileWidth(),\r\n\t\t\t\t\t\t(by+az*1.5)*tileHeight(),\r\n\t\t\t\t\t\ttileWidth()/2, tileHeight()/2,\r\n\t\t\t\t\t\tx+np.x/4,\r\n\t\t\t\t\t\ty+np.y/4,\r\n\t\t\t\t\t\tz-wallHeight/4-az*wallHeight/2,\r\n\t\t\t\t\t\t0.5,wallHeight/2, -rot, {double:true}\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\tconst rect = configRect ? configRect : mv3d.getTileRects(tileId)[0];\r\n\t\t\t\tthis.builder.addWallFace(tsMaterial,\r\n\t\t\t\t\trect.x+rect.width/2*rightSide,\r\n\t\t\t\t\trect.y,\r\n\t\t\t\t\trect.width/2, rect.height,\r\n\t\t\t\t\tx+np.x/4,\r\n\t\t\t\t\ty+np.y/4,\r\n\t\t\t\t\tz-wallHeight/2,\r\n\t\t\t\t\t0.5,wallHeight, rot, {double:true}\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tasync loadCross(tileConf,x,y,z,l,wallHeight){\r\n\t\tconst tileId = tileConf.side_id;\r\n\t\tif(mv3d.isTileEmpty(tileId)){ return; }\r\n\t\tconst configRect = tileConf.side_rect;\r\n\t\tconst tsMaterial = await mv3d.getCachedTilesetMaterialForTile(tileConf,'side');\r\n\t\tconst isAutotile = Tilemap.isAutotile(tileId);\r\n\t\tlet rects;\r\n\t\tif(configRect){\r\n\t\t\trects=[configRect];\r\n\t\t}else{\r\n\t\t\trects = mv3d.getTileRects(tileId);\r\n\t\t}\r\n\t\tconst rot = tileConf.shape===mv3d.configurationShapes.XCROSS ? Math.PI/4 : 0;\r\n\t\tconst partHeight = isAutotile ? wallHeight/2 : wallHeight;\r\n\t\tfor (let i=0; i<=1; ++i){\r\n\t\t\tfor (const rect of rects){\r\n\t\t\t\tconst irot = -Math.PI/2*i+rot;\r\n\t\t\t\tconst trans= -0.25*isAutotile+(rect.ox|0)/tileWidth();\r\n\t\t\t\tthis.builder.addWallFace(tsMaterial,\r\n\t\t\t\t\trect.x,rect.y,rect.width,rect.height,\r\n\t\t\t\t\tx+trans*Math.cos(irot),\r\n\t\t\t\t\ty+trans*Math.sin(irot),\r\n\t\t\t\t\tz - (rect.oy|0)/tileHeight()*wallHeight - partHeight/2,\r\n\t\t\t\t\t1-isAutotile/2,partHeight, irot, {double:true}\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tgetAutotileCorner(tileId,realId=tileId){\r\n\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\tlet tx = kind%8;\r\n\t\tlet ty = Math.floor(kind / 8);\r\n\t\tif(tileId===realId && mv3d.isWallTile(tileId)==1){ ++ty; }\r\n\t\tvar bx,by;\r\n\t\tbx=tx*2;\r\n\t\tby=ty;\r\n\t\tif(Tilemap.isTileA1(tileId)){\r\n\t\t\tif(kind<4){\r\n\t\t\t\tby=3*(kind%2)+1;\r\n\t\t\t\tbx=6*Math.floor(kind/2);\r\n\t\t\t}else{\r\n\t\t\t\tbx=8*Math.floor(tx/4) + (kind%2)*6;\r\n\t\t\t\tby=ty*6 + Math.floor(tx%4/2)*3 + 1-(tx%2);\r\n\t\t\t}\r\n\t\t}else if(Tilemap.isTileA2(tileId)){\r\n\t\t\tby=(ty-2)*3+1;\r\n\t\t}else if (Tilemap.isTileA3(tileId)){\r\n\t\t\tby=(ty-6)*2;\r\n\t\t}else if (Tilemap.isTileA4(tileId)){\r\n\t\t\tby=(ty-10)*2.5+(ty%2?0.5:0);\r\n\t\t}\r\n\t\treturn {x:bx,y:by};\r\n\t}\r\n}\r\nMapCell.neighborPositions = [\r\n\tnew Vector2( 0, 1),\r\n\tnew Vector2( 1, 0),\r\n\tnew Vector2( 0,-1),\r\n\tnew Vector2(-1, 0),\r\n];\r\nMapCell.meshCache={};\r\n\r\nclass MapCellFinalized {\r\n\t\r\n}\r\n\r\nclass MapCellBuilder {\r\n\r\n}\r\n\r\n\r\n","import mv3d from './mv3d.js';\r\nimport { MapCell } from './mapCell.js';\r\nimport { sleep, snooze } from './util.js';\r\nimport { Vector2 } from './mod_babylon.js';\r\n\r\nObject.assign(mv3d,{\r\n\r\n\tmapLoaded: false,\r\n\tmapReady: false,\r\n\tclearMap(){\r\n\t\tthis.mapLoaded=false;\r\n\t\t// clear materials and textures\r\n\t\tfor (const key in this.textureCache){\r\n\t\t\tthis.textureCache[key].dispose();\r\n\t\t}\r\n\t\tfor (const key in this.materialCache){\r\n\t\t\tthis.materialCache[key].dispose();\r\n\t\t}\r\n\t\tthis.animatedTextures.length=0;\r\n\t\tthis.textureCache={};\r\n\t\tthis.materialCache={};\r\n\t\t// clear map cells\r\n\t\tfor (const key in this.cells){\r\n\t\t\tthis.cells[key].dispose(false,true);\r\n\t\t}\r\n\t\tthis.cells={};\r\n\t\tfor (const char of this.characters){\r\n\t\t\tchar.dispose(false,true);\r\n\t\t}\r\n\t\tthis.characters.length=0;\r\n\t\tthis.resetCameraTarget();\r\n\r\n\t\tif(this.DYNAMIC_SHADOWS){\r\n\t\t\tthis.shadowGenerator.getShadowMap().renderList.splice(0,Infinity);\r\n\t\t}\r\n\t},\r\n\r\n\tloadMap(){\r\n\t\tthis.loadMapSettings();\r\n\t\t//this.cameraStick.x=$gamePlayer._realX;\r\n\t\t//this.cameraStick.y=$gamePlayer._realY;\r\n\t\tthis.updateBlenders();\r\n\t\tthis.updateMap();\r\n\t\tthis.createCharacters();\r\n\t\tthis.rememberCameraTarget();\r\n\t},\r\n\r\n\tasync updateMap(){\r\n\t\tif(this.mapUpdating){ return; }\r\n\t\tthis.mapLoaded=true;\r\n\t\tthis.mapUpdating=true;\r\n\t\t// unload Far cells? implement if needed.\r\n\t\t// get range of cells based on render distance\r\n\t\tconst bounds = {\r\n\t\t\tleft:Math.floor((this.cameraStick.x-this.CELL_DIST)/this.CELL_SIZE),\r\n\t\t\tright:Math.floor((this.cameraStick.x+this.CELL_DIST)/this.CELL_SIZE),\r\n\t\t\ttop:Math.floor((this.cameraStick.y-this.CELL_DIST)/this.CELL_SIZE),\r\n\t\t\tbottom:Math.floor((this.cameraStick.y+this.CELL_DIST)/this.CELL_SIZE),\r\n\t\t}\r\n\t\t//clamp cell range to map\r\n\t\tif(!$gameMap.isLoopHorizontal()){\r\n\t\t\tbounds.left=Math.max(0,bounds.left);\r\n\t\t\tbounds.right=Math.min(bounds.right,Math.floor($gameMap.width()/mv3d.CELL_SIZE));\r\n\t\t}\r\n\t\tif(!$gameMap.isLoopVertical()){\r\n\t\t\tbounds.top=Math.max(0,bounds.top);\r\n\t\t\tbounds.bottom=Math.min(bounds.bottom,Math.floor($gameMap.height()/mv3d.CELL_SIZE));\r\n\t\t}\r\n\t\tconst cellsToLoad=[];\r\n\t\tfor (let ix=bounds.left;ix<=bounds.right;++ix)\r\n\t\tfor (let iy=bounds.top;iy<=bounds.bottom;++iy){\r\n\t\t\tlet cx=ix, cy=iy;\r\n\t\t\tif($gameMap.isLoopHorizontal()){ cx = cx.mod(Math.ceil($gameMap.width()/mv3d.CELL_SIZE)); }\r\n\t\t\tif($gameMap.isLoopVertical()){ cy = cy.mod(Math.ceil($gameMap.height()/mv3d.CELL_SIZE)); }\r\n\t\t\tconst key = [cx,cy].toString();\r\n\t\t\tif(!(key in this.cells)){\r\n\t\t\t\tcellsToLoad.push(new Vector2(cx,cy));\r\n\t\t\t}\r\n\t\t}\r\n\t\tconst cameraCellPos = new Vector2(Math.round(this.cameraStick.x/this.CELL_SIZE-0.5),Math.round(this.cameraStick.y/this.CELL_SIZE-0.5));\r\n\t\tcellsToLoad.sort((a,b)=>Vector2.DistanceSquared(a,cameraCellPos)-Vector2.DistanceSquared(b,cameraCellPos));\r\n\t\tif(this.mapReady){\r\n\t\t\tcellsToLoad.length=Math.min(25,cellsToLoad.length);\r\n\t\t}\r\n\t\tfor (const cellpos of cellsToLoad){\r\n\t\t\tlet {x:cx,y:cy} = cellpos;\r\n\t\t\tawait this.loadMapCell(cx,cy);\r\n\t\t\tif(this.mapReady){ await sleep(); }\r\n\t\t\tif(!this.mapLoaded){ this.mapUpdating=false; return; }\r\n\t\t}\r\n\t\tthis.mapUpdating=false;\r\n\t\tthis.mapReady=true;\r\n\t},\r\n\r\n\tasync loadMapCell(cx,cy){\r\n\t\tconst key = [cx,cy].toString();\r\n\t\tif(key in this.cells){ return; }\r\n\t\tconst cell = new MapCell(cx,cy);\r\n\t\tthis.cells[key]=cell;\r\n\t\tawait cell.load();\r\n\t},\r\n\r\n});","import mv3d from './mv3d.js';\r\nimport { Texture, StandardMaterial, Color3 } from './mod_babylon.js';\r\nimport { tileWidth, tileHeight } from './util.js';\r\n\r\nObject.assign(mv3d,{\r\n\r\n\tanimatedTextures:[],\r\n\ttextureCache:{},\r\n\tmaterialCache:{},\r\n\r\n\tgetCachedTilesetTexture(setN,animX=0,animY=0){\r\n\t\tconst key = `TS:${setN}|${animX},${animY}`;\r\n\t\tif(key in this.textureCache){\r\n\t\t\treturn this.textureCache[key];\r\n\t\t}\r\n\t\tconst tsName = $gameMap.tileset().tilesetNames[setN];\r\n\t\tif(!tsName){\r\n\t\t\treturn this.getErrorTexture();\r\n\t\t}\r\n\t\tconst textureSrc=`img/tilesets/${tsName}.png`;\r\n\t\tconst texture = new Texture(textureSrc,this.scene,!mv3d.MIPMAP);\r\n\t\ttexture.hasAlpha=true;\r\n\t\ttexture.onLoadObservable.addOnce(()=>{\r\n\t\t\tif(this.textureCache[key]!==texture){ return; }\r\n\t\t\ttexture.updateSamplingMode(1);\r\n\t\t\tif(animX||animY){\r\n\t\t\t\tconst { width, height } = texture.getBaseSize();\r\n\t\t\t\ttexture.frameData={x:0,y:0,w:width,h:height};\r\n\t\t\t\ttexture.animX = animX;\r\n\t\t\t\ttexture.animY = animY;\r\n\t\t\t\tthis.animatedTextures.push(texture);\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.textureCache[key]=texture;\r\n\t\treturn texture;\r\n\t},\r\n\tgetCachedTilesetTextureAsync(setN,animX=0,animY=0){return new Promise((resolve,reject)=>{\r\n\t\tconst texture = this.getCachedTileTexture(setN,animX,animY);\r\n\t\t//if(texture.isError){ return void reject(); }\r\n\t\tif(texture.isReady()){\r\n\t\t\tresolve(texture);\r\n\t\t}else{\r\n\t\t\ttexture.onLoadObservable.addOnce(()=>{ resolve(texture); });\r\n\t\t}\r\n\t})},\r\n\r\n\tgetErrorTexture(){\r\n\t\tif(this.errorTexture){ return this.errorTexture; }\r\n\t\tthis.errorTexture = new Texture(`${mv3d.MV3D_FOLDER}/errorTexture.png`,this.scene);\r\n\t\tthis.errorTexture.isError=true;\r\n\t\treturn this.errorTexture;\r\n\t},\r\n\r\n\tgetBushAlphaTexture(){\r\n\t\tif(this.bushAlphaTexture){ return this.bushAlphaTexture; }\r\n\t\tthis.bushAlphaTexture = new Texture(`${mv3d.MV3D_FOLDER}/bushAlpha.png`,this.scene);\r\n\t\tthis.bushAlphaTexture.getAlphaFromRGB=true;\r\n\t\treturn this.bushAlphaTexture;\r\n\t},\r\n\r\n\tgetCachedTilesetMaterial(setN,animX=0,animY=0,options={}){\r\n\t\tthis.processMaterialOptions(options);\r\n\t\tconst key = `TS:${setN}|${animX},${animY}|${this.getExtraBit(options)}`;\r\n\t\tif(key in this.materialCache){\r\n\t\t\treturn this.materialCache[key];\r\n\t\t}\r\n\t\tconst texture = this.getCachedTilesetTexture(setN,animX,animY);\r\n\t\tconst material = new StandardMaterial(key, this.scene);\r\n\t\tmaterial.diffuseTexture=texture;\r\n\t\tif(options.transparent){\r\n\t\t\tmaterial.opacityTexture=texture;\r\n\t\t\tmaterial.alpha=options.alpha;\r\n\t\t}\r\n\t\tmaterial.alphaCutOff = mv3d.ALPHA_CUTOFF;\r\n\t\tmaterial.ambientColor.set(1,1,1);\r\n\t\tmaterial.emissiveColor.set(options.glow,options.glow,options.glow);\r\n\t\tmaterial.specularColor.set(0,0,0);\r\n\t\tthis.materialCache[key]=material;\r\n\t\treturn material;\r\n\t},\r\n\r\n\tgetCachedTilesetMaterialAsync(setN,animX=0,animY=0,options={}){return new Promise((resolve,reject)=>{\r\n\t\tconst material = this.getCachedTilesetMaterial(setN,animX,animY,options);\r\n\t\tconst texture = material.diffuseTexture;\r\n\t\tif(texture.isReady()){\r\n\t\t\tresolve(material);\r\n\t\t}else{\r\n\t\t\ttexture.onLoadObservable.addOnce(()=>{ resolve(material); });\r\n\t\t}\r\n\t})},\r\n\r\n\tasync getCachedTilesetMaterialForTile(tileConf,side){\r\n\t\tconst setN = mv3d.getSetNumber(tileConf[`${side}_id`]);\r\n\t\tconst options = mv3d.getMaterialOptions(tileConf,side);\r\n\t\tconst animData = mv3d.getTileAnimationData(tileConf,side);\r\n\t\t//console.log(options);\r\n\t\treturn await mv3d.getCachedTilesetMaterialAsync(setN,animData.animX,animData.animY,options);\r\n\t},\r\n\r\n\tprocessMaterialOptions(options){\r\n\t\tif('alpha' in options){\r\n\t\t\toptions.alpha = Math.round(options.alpha*7)/7;\r\n\t\t\tif(options.alph<1){\r\n\t\t\t\toptions.transparent=true;\r\n\t\t\t}\r\n\t\t}else{ options.alpha=1; }\r\n\t\tif('glow' in options){\r\n\t\t\toptions.glow = Math.round(options.glow*7)/7;\r\n\t\t}else{ options.glow=0; }\r\n\t},\r\n\r\n\tgetExtraBit(options){\r\n\t\tlet extra = 0;\r\n\t\textra|=Boolean(options.transparent)<<0;\r\n\t\textra|=7-options.alpha*7<<1;\r\n\t\textra|=options.glow*7<<1;\r\n\t\treturn extra.toString(36);\r\n\t},\r\n\r\n\t// animations\r\n\r\n\tlastAnimUpdate:0,\r\n\tanimXFrame:0,\r\n\tanimYFrame:0,\r\n\tanimDirection:1,\r\n\tupdateAnimations(){\r\n\t\tif( performance.now()-this.lastAnimUpdate <= this.ANIM_DELAY){ return; }\r\n\t\tthis.lastAnimUpdate=performance.now();\r\n\r\n\t\tif(this.animXFrame<=0){\r\n\t\t\tthis.animDirection=1;\r\n\t\t}else if(this.animXFrame>=2){\r\n\t\t\tthis.animDirection=-1;\r\n\t\t}\r\n\t\tthis.animXFrame += this.animDirection;\r\n\t\tthis.animYFrame=(this.animYFrame+1)%3;\r\n\t\tfor (const texture of this.animatedTextures){\r\n\t\t\ttexture.crop(\r\n\t\t\t\ttexture.frameData.x+texture.animX*this.animXFrame*tileWidth(),\r\n\t\t\t\ttexture.frameData.y+texture.animY*this.animYFrame*tileHeight(),\r\n\t\t\t\ttexture.frameData.w,\r\n\t\t\t\ttexture.frameData.h,\r\n\t\t\t);\r\n\t\t}\r\n\t},\r\n\r\n});","import mv3d from './mv3d.js';\r\nimport { TransformNode, MeshBuilder, FRONTSIDE, Texture, StandardMaterial, Color3, Mesh, WORLDSPACE, Vector2, SpotLight, Vector3, PointLight, LOCALSPACE, DOUBLESIDE, Plane } from \"./mod_babylon.js\";\r\nimport { relativeNumber, ZAxis, YAxis, tileSize, degtorad, XAxis } from './util.js';\r\nimport { ColorBlender, Blender } from './blenders.js';\r\n\r\nObject.assign(mv3d,{\r\n\tcreateCharacters(){\r\n\t\tconst events = $gameMap.events();\r\n\t\tfor (const event of events){\r\n\t\t\tthis.createCharacterFor(event,0);\r\n\t\t}\r\n\t\tconst vehicles = $gameMap.vehicles();\r\n\t\tfor (const vehicle of vehicles){\r\n\t\t\tthis.createCharacterFor(vehicle,1);\r\n\t\t}\r\n\t\tconst followers = $gamePlayer.followers()._data;\r\n\t\tfor (let f=followers.length-1; f>=0; --f){\r\n\t\t\tthis.createCharacterFor(followers[f],29-f);\r\n\t\t}\r\n\t\tthis.createCharacterFor($gamePlayer,30);\r\n\t},\r\n\r\n\tcreateCharacterFor(char,order){\r\n\t\tif(!char.mv3d_sprite){\r\n\t\t\tconst sprite = new Character(char,order);\r\n\t\t\tObject.defineProperty(char,'mv3d_sprite',{\r\n\t\t\t\tvalue:sprite,\r\n\t\t\t\tconfigurable:true,\r\n\t\t\t});\r\n\t\t\tthis.characters.push(sprite);\r\n\t\t\treturn sprite;\r\n\t\t}\r\n\t\treturn char.mv3d_sprite;\r\n\t},\r\n\r\n\tupdateCharacters(){\r\n\t\tfor(const char of this.characters){\r\n\t\t\tchar.update();\r\n\t\t}\r\n\t},\r\n\r\n\tsetupSpriteMeshes(){\r\n\t\tSprite.Meshes = {};\r\n\t\tSprite.Meshes.FLAT=Mesh.MergeMeshes([MeshBuilder.CreatePlane('sprite mesh',{ sideOrientation: DOUBLESIDE},mv3d.scene).rotate(XAxis,Math.PI/2,WORLDSPACE)]);\r\n\t\tSprite.Meshes.SPRITE=Mesh.MergeMeshes([MeshBuilder.CreatePlane('sprite mesh',{sideOrientation: DOUBLESIDE},mv3d.scene).translate(YAxis,0.5,WORLDSPACE)]);\r\n\t\tSprite.Meshes.CROSS=Mesh.MergeMeshes([\r\n\t\t\tSprite.Meshes.SPRITE.clone(),\r\n\t\t\tSprite.Meshes.SPRITE.clone().rotate(YAxis,Math.PI/2,WORLDSPACE),\r\n\t\t]);\r\n\r\n\t\tSprite.Meshes.SHADOW=Sprite.Meshes.FLAT.clone('shadow mesh');\r\n\t\tconst shadowTexture = new Texture(`${mv3d.MV3D_FOLDER}/shadow.png`);\r\n\t\tconst shadowMaterial = new StandardMaterial('shadow material', mv3d.scene);\r\n\t\tshadowMaterial.diffuseTexture=shadowTexture;\r\n\t\tshadowMaterial.opacityTexture=shadowTexture;\r\n\t\tshadowMaterial.specularColor.set(0,0,0);\r\n\t\tSprite.Meshes.SHADOW.material=shadowMaterial;\r\n\t\t\r\n\t\tfor (const key in Sprite.Meshes){\r\n\t\t\tmv3d.scene.removeMesh(Sprite.Meshes[key]);\r\n\t\t}\r\n\t},\r\n});\r\n\r\n\r\nclass Sprite extends TransformNode{\r\n\tconstructor(){\r\n\t\tsuper('sprite',mv3d.scene);\r\n\t\tthis.spriteOrigin = new TransformNode('sprite origin',mv3d.scene);\r\n\t\tthis.spriteOrigin.parent=this;\r\n\t\tthis.mesh = Sprite.Meshes.FLAT.clone();\r\n\t\tthis.mesh.parent = this.spriteOrigin;\r\n\t}\r\n\tsetMaterial(src){\r\n\t\tthis.disposeMaterial();\r\n\t\tthis.texture = new Texture(src,mv3d.scene);\r\n\t\tthis.bitmap = this.texture._texture;\r\n\t\tthis.texture.hasAlpha=true;\r\n\t\tthis.texture.onLoadObservable.addOnce(()=>this.onTextureLoaded());\r\n\t\tthis.material = new StandardMaterial('sprite material',mv3d.scene);\r\n\t\tthis.material.diffuseTexture=this.texture;\r\n\t\tthis.material.alphaCutOff = mv3d.ALPHA_CUTOFF;\r\n\t\tthis.material.ambientColor.set(1,1,1);\r\n\t\tthis.material.specularColor.set(0,0,0);\r\n\t\tthis.mesh.material=this.material;\r\n\t}\r\n\tonTextureLoaded(){\r\n\t\tthis.texture.updateSamplingMode(1);\r\n\t}\r\n\tdisposeMaterial(){\r\n\t\tif(this.material){\r\n\t\t\tthis.material.dispose();\r\n\t\t\tthis.texture.dispose();\r\n\t\t\tthis.material=null;\r\n\t\t\tthis.texture=null;\r\n\t\t\tthis.bitmap=null;\r\n\t\t}\r\n\t}\r\n\tdispose(...args){\r\n\t\tthis.disposeMaterial();\r\n\t\tsuper.dispose(...args);\r\n\t}\r\n}\r\n\r\nclass Character extends Sprite{\r\n\tconstructor(char,order){\r\n\t\tsuper();\r\n\t\tthis.order=order;\r\n\t\tthis.mesh.order=this.order;\r\n\t\tthis.mesh.character=this;\r\n\t\tthis._character=this.char=char;\r\n\t\tthis.charName='';\r\n\t\tthis.charIndex=0;\r\n\r\n\t\tthis.updateCharacter();\r\n\t\tthis.updateShape();\r\n\r\n\t\tthis.isVehicle = this.char instanceof Game_Vehicle;\r\n\t\tthis.isBoat = this.isVehicle && this.char.isBoat();\r\n\t\tthis.isShip = this.isVehicle && this.char.isShip();\r\n\t\tthis.isAirship = this.isVehicle && this.char.isAirship();\r\n\t\tthis.isEvent = this.char instanceof Game_Event;\r\n\t\tthis.isPlayer = this.char instanceof Game_Player;\r\n\t\tthis.isFollower = this.char instanceof Game_Follower;\r\n\r\n\t\tthis.elevation = 0;\r\n\r\n\t\tif(!this.char.mv3d_blenders){ this.char.mv3d_blenders={}; }\r\n\r\n\t\tif(mv3d.CHARACTER_SHADOWS){\r\n\t\t\t//this.shadow = Sprite.Meshes.SHADOW.createInstance();\r\n\t\t\tthis.shadow = Sprite.Meshes.SHADOW.clone();\r\n\t\t\tthis.shadow.parent=this.spriteOrigin;\r\n\t\t}\r\n\r\n\t\tthis.lightOrigin = new TransformNode('light origin',mv3d.scene);\r\n\t\tthis.lightOrigin.parent=this;\r\n\t\tthis.setupLights();\r\n\t\t\r\n\t\tif(this.isEvent){\r\n\t\t\tthis.eventConfigure();\r\n\t\t}\r\n\t}\r\n\r\n\tisTextureReady(){\r\n\t\treturn Boolean(this.texture && this.texture.isReady());\r\n\t}\r\n\r\n\tsetTileMaterial(){\r\n\t\tconst setN = mv3d.getSetNumber(this._tileId);\r\n\t\tconst tsName = $gameMap.tileset().tilesetNames[setN];\r\n\t\tif(tsName){\r\n\t\t\tconst textureSrc=`img/tilesets/${tsName}.png`;\r\n\t\t\tthis.setMaterial(textureSrc);\r\n\t\t}else{\r\n\t\t\tthis.setMaterial(\"MV3D/errorTexture.png\");\r\n\t\t}\r\n\t}\r\n\r\n\tonTextureLoaded(){\r\n\t\tsuper.onTextureLoaded();\r\n\t\tthis.updateFrame();\r\n\t\tthis.updateScale();\r\n\t}\r\n\r\n\tupdateCharacter(){\r\n\t\tthis._tilesetId = $gameMap.tilesetId();\r\n\t\tthis._tileId = this._character.tileId();\r\n\t\tthis._characterName = this._character.characterName();\r\n\t\tthis._characterIndex = this._character.characterIndex();\r\n\t\tthis._isBigCharacter = ImageManager.isBigCharacter(this._characterName);\r\n\t\tif(this._tileId>0){\r\n\t\t\tthis.setTileMaterial(this._tileId);\r\n\t\t}else if(this._characterName){\r\n\t\t\tthis.setMaterial(`img/characters/${this._characterName}.png`);\r\n\t\t}else{\r\n\t\t\tthis.setEnabled(false);\r\n\t\t}\r\n\t}\r\n\tupdateCharacterFrame(){\r\n\t\tthis.px=this.characterPatternX();\r\n\t\tthis.py=this.characterPatternY();\r\n\t\tif(!this.isTextureReady()){ return; }\r\n\t\tconst pw = this.patternWidth();\r\n\t\tconst ph = this.patternHeight();\r\n\t\tconst sx = (this.characterBlockX() + this.px) * pw;\r\n\t\tconst sy = (this.characterBlockY() + this.py) * ph;\r\n\t\tthis.setFrame(sx,sy,pw,ph);\r\n\t}\r\n\tpatternChanged(){\r\n\t\treturn this.px!==this.characterPatternX() || this.py!==this.characterPatternY();\r\n\t}\r\n\tcharacterPatternY(){\r\n\t\tconst dirfix = this.getConfig('dirfix', this.isEvent && this.char.isObjectCharacter());\r\n\t\tif(dirfix){\r\n\t\t\treturn this.char.direction()/2-1;\r\n\t\t}\r\n\t\tlet dir = mv3d.transformDirectionYaw(this.char.direction());\r\n\t\treturn dir/2-1;\r\n\t}\r\n\r\n\tsetFrame(x,y,w,h){\r\n\t\tif(!this.isTextureReady()){ return; }\r\n\t\tthis.texture.crop(x,y,w,h);\r\n\t}\r\n\r\n\tupdateScale(){\r\n\t\tif(!this.isTextureReady()){ return; }\r\n\t\tconst configScale = this.getConfig('scale',new Vector2(1,1));\r\n\t\tlet scale = 1;\r\n\t\tif(this.isVehicle){\r\n\t\t\tconst settings = mv3d[`${this.char._type.toUpperCase()}_SETTINGS`];\r\n\t\t\tscale = mv3d.loadData( `${this.char._type}_scale`, settings.scale );\r\n\t\t}\r\n\t\tconst xscale = this.patternWidth()/tileSize() * configScale.x * scale;\r\n\t\tconst yscale = this.patternHeight()/tileSize() * configScale.y * scale;\r\n\t\tthis.mesh.scaling.set(xscale,yscale,yscale);\r\n\t}\r\n\r\n\tgetConfig(key,dfault=undefined){\r\n\t\tif(!this.settings_event){ return dfault; }\r\n\t\tif(key in this.settings_event_page){\r\n\t\t\treturn this.settings_event_page[key];\r\n\t\t}else if(key in this.settings_event){\r\n\t\t\treturn this.settings_event[key];\r\n\t\t}\r\n\t\treturn dfault;\r\n\t}\r\n\thasConfig(key){\r\n\t\tif(!this.settings_event){ return false; }\r\n\t\treturn key in this.settings_event_page || key in this.settings_event;\r\n\t}\r\n\r\n\teventConfigure(){\r\n\t\tif(!this.settings_event){\r\n\t\t\tthis.settings_event={};\r\n\t\t\tconst note = this.char.event().note;\r\n\t\t\tmv3d.readConfigurationFunctions(\r\n\t\t\t\tmv3d.readConfigurationTags(note),\r\n\t\t\t\tmv3d.eventConfigurationFunctions,\r\n\t\t\t\tthis.settings_event,\r\n\t\t\t);\r\n\t\t}\r\n\t\tthis.settings_event_page={};\r\n\t\tconst page = this.char.page();\r\n\t\tif(!page){ return; }\r\n\t\tlet comments = '';\r\n\t\tfor (const command of page.list){\r\n\t\t\tif(command.code===108||command.code===408){\r\n\t\t\t\tcomments+=command.parameters[0];\r\n\t\t\t}\r\n\t\t}\r\n\t\tmv3d.readConfigurationFunctions(\r\n\t\t\tmv3d.readConfigurationTags(comments),\r\n\t\t\tmv3d.eventConfigurationFunctions,\r\n\t\t\tthis.settings_event_page,\r\n\t\t);\r\n\t\tthis.updateScale();\r\n\t\tthis.updateShape();\r\n\r\n\t\tif(this.char.mv3d_needsConfigure){\r\n\t\t\tthis.char.mv3d_needsConfigure=false;\r\n\t\t}else{ return; }\r\n\r\n\t\tif('pos' in this.settings_event_page){\r\n\t\t\tconst event=this.char.event();\r\n\t\t\tconst pos = this.settings_event_page.pos;\r\n\t\t\tthis.char.locate(\r\n\t\t\t\trelativeNumber(event.x,pos.x),\r\n\t\t\t\trelativeNumber(event.y,pos.y),\r\n\t\t\t);\r\n\t\t}\r\n\t\tthis.setupEventLights();\r\n\r\n\t\tif('lamp' in this.settings_event_page){\r\n\t\t\tconst lampConfig = this.getConfig('lamp');\r\n\t\t\tthis.blendLampColor.setValue(lampConfig.color,0.5);\r\n\t\t\tthis.blendLampIntensity.setValue(lampConfig.intensity,0.5);\r\n\t\t\tthis.blendLampDistance.setValue(lampConfig.distance,0.5);\r\n\t\t}\r\n\t\tif('flashlight' in this.settings_event_page){\r\n\t\t\tconst flashlightConfig = this.getConfig('flashlight');\r\n\t\t\tthis.blendFlashlightColor.setValue(flashlightConfig.color,0.5);\r\n\t\t\tthis.blendFlashlightIntensity.setValue(flashlightConfig.intensity,0.5);\r\n\t\t\tthis.blendFlashlightDistance.setValue(flashlightConfig.distance,0.5);\r\n\t\t\tthis.blendFlashlightAngle.setValue(flashlightConfig.angle,0.5);\r\n\t\t\tthis.blendFlashlightPitch.setValue(this.getConfig('flashlightPitch',90),0.25);\r\n\t\t\tthis.flashlightTargetYaw=this.getConfig('flashlightYaw','+0');\r\n\t\t}\r\n\t}\r\n\r\n\tsetupMesh(){\r\n\t\tthis.mesh.parent = this.spriteOrigin;\r\n\t\tthis.mesh.character=this;\r\n\t\tthis.mesh.order=this.order;\r\n\t\tif(this.material){\r\n\t\t\tthis.mesh.material=this.material;\r\n\t\t}\r\n\t\tif(this.flashlight){\r\n\t\t\tthis.flashlight.excludedMeshes.splice(0,Infinity);\r\n\t\t\tthis.flashlight.excludedMeshes.push(this.mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tsetupEventLights(){\r\n\t\tconst flashlightConfig = this.getConfig('flashlight');\r\n\t\tconst lampConfig = this.getConfig('lamp');\r\n\t\tif(flashlightConfig && !this.flashlight){\r\n\t\t\tthis.setupFlashlight();\r\n\t\t}\r\n\t\tif(lampConfig && !this.lamp){\r\n\t\t\tthis.setupLamp();\r\n\t\t}\r\n\t}\r\n\tsetupLights(){\r\n\t\tif('flashlightColor' in this.char.mv3d_blenders){\r\n\t\t\tthis.setupFlashlight();\r\n\t\t}\r\n\t\tif('lampColor' in this.char.mv3d_blenders){\r\n\t\t\tthis.setupLamp();\r\n\t\t}\r\n\t}\r\n\r\n\tsetupFlashlight(){\r\n\t\tif(this.flashlight){ return; }\r\n\t\tconst config = this.getConfig('flashlight',{\r\n\t\t\tcolor:0xffffff,\r\n\t\t\tintensity:1,\r\n\t\t\tdistance:mv3d.LIGHT_DIST,\r\n\t\t\tangle:mv3d.LIGHT_ANGLE,\r\n\t\t});\r\n\t\tthis.blendFlashlightColor = this.makeColorBlender('flashlightColor',config.color);\r\n\t\tthis.blendFlashlightIntensity = this.makeBlender('flashlightIntensity',config.intensity);\r\n\t\tthis.blendFlashlightDistance = this.makeBlender('flashlightDistance',config.distance);\r\n\t\tthis.blendFlashlightAngle = this.makeBlender('flashlightAngle',config.angle);\r\n\t\tthis.flashlight = new SpotLight('flashlight',Vector3.Zero(),Vector3.Zero(),\r\n\t\t\tdegtorad(this.blendFlashlightAngle.targetValue()+mv3d.FLASHLIGHT_EXTRA_ANGLE),0,mv3d.scene);\r\n\t\tthis.updateFlashlightExp();\r\n\t\tthis.flashlight.range = this.blendFlashlightDistance.targetValue();\r\n\t\tthis.flashlight.intensity=this.blendFlashlightIntensity.targetValue();\r\n\t\tthis.flashlight.diffuse.set(...this.blendFlashlightColor.targetComponents());\r\n\t\t//this.flashlight.projectionTexture = mv3d.getFlashlightTexture();\r\n\t\tthis.flashlight.direction.y=-1;\r\n\t\tthis.flashlightOrigin=new TransformNode('flashlight origin',mv3d.scene);\r\n\t\tthis.flashlightOrigin.parent=this.lightOrigin;\r\n\t\tthis.flashlight.parent=this.flashlightOrigin;\r\n\t\tthis.blendFlashlightPitch = this.makeBlender('flashlightPitch',70);\r\n\t\tthis.blendFlashlightYaw = this.makeBlender('flashlightYaw', 0);\r\n\t\tthis.blendFlashlightYaw.cycle=360;\r\n\t\tthis.flashlightTargetYaw=this.getConfig('flashlightYaw','+0');\r\n\t\tthis.updateFlashlightDirection();\r\n\t\tthis.setupMesh();\r\n\t}\r\n\r\n\tupdateFlashlightExp(){\r\n\t\tthis.flashlight.exponent = 64800*Math.pow(this.blendFlashlightAngle.targetValue(),-2);\r\n\t}\r\n\r\n\tsetupLamp(){\r\n\t\tif(this.lamp){ return; }\r\n\t\tconst config = this.getConfig('lamp',{\r\n\t\t\tcolor:0xffffff,\r\n\t\t\tintensity:1,\r\n\t\t\tdistance:mv3d.LIGHT_DIST,\r\n\t\t});\r\n\t\tthis.blendLampColor = this.makeColorBlender('lampColor',config.color);\r\n\t\tthis.blendLampIntensity = this.makeBlender('lampIntensity',config.intensity);\r\n\t\tthis.blendLampDistance = this.makeBlender('lampDistance',config.distance);\r\n\t\tthis.lamp = new PointLight('lamp',Vector3.Zero(),mv3d.scene);\r\n\t\tthis.lamp.diffuse.set(...this.blendLampColor.targetComponents());\r\n\t\tthis.lamp.intensity=this.blendLampIntensity.targetValue();\r\n\t\tthis.lamp.range=this.blendLampDistance.targetValue();\r\n\t\tthis.lamp.parent=this.lightOrigin;\r\n\t}\r\n\r\n\tupdateFlashlightDirection(){\r\n\t\tthis.flashlightOrigin.yaw=this.blendFlashlightYaw.currentValue();\r\n\t\tthis.flashlightOrigin.pitch=-this.blendFlashlightPitch.currentValue();\r\n\t\tthis.flashlightOrigin.position.set(0,0,0);\r\n\t\tlet flashlightOffset = Math.tan(degtorad(90-this.blendFlashlightAngle.currentValue()-Math.max(90,this.blendFlashlightPitch.currentValue())+90))*mv3d.LIGHT_HEIGHT;\r\n\t\tflashlightOffset = Math.max(0,Math.min(1,flashlightOffset));\r\n\t\tthis.flashlight.range+=flashlightOffset;\r\n\t\tthis.flashlightOrigin.translate(YAxis,flashlightOffset,LOCALSPACE);\r\n\t}\r\n\r\n\tupdateLights(){\r\n\t\tif(this.flashlight){\r\n\t\t\tconst flashlightYaw = 180+relativeNumber( mv3d.dirToYaw( this.char.direction() ), this.flashlightTargetYaw);\r\n\t\t\tif(flashlightYaw !== this.blendFlashlightYaw.targetValue()){\r\n\t\t\t\tthis.blendFlashlightYaw.setValue(flashlightYaw,0.25);\r\n\t\t\t}\r\n\t\t\tif(this.blendFlashlightColor.update()|this.blendFlashlightIntensity.update()\r\n\t\t\t|this.blendFlashlightDistance.update()|this.blendFlashlightAngle.update()\r\n\t\t\t|this.blendFlashlightYaw.update()|this.blendFlashlightPitch.update()){\r\n\t\t\t\tthis.flashlight.diffuse.set(...this.blendFlashlightColor.currentComponents());\r\n\t\t\t\tthis.flashlight.intensity=this.blendFlashlightIntensity.currentValue();\r\n\t\t\t\tthis.flashlight.range=this.blendFlashlightDistance.currentValue();\r\n\t\t\t\tthis.flashlight.angle=degtorad(this.blendFlashlightAngle.currentValue()+mv3d.FLASHLIGHT_EXTRA_ANGLE);\r\n\t\t\t\tthis.updateFlashlightExp();\r\n\t\t\t\tthis.updateFlashlightDirection();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(this.lamp){\r\n\t\t\tif(this.blendLampColor.update()|this.blendLampIntensity.update()|this.blendLampDistance.update()){\r\n\t\t\t\tthis.lamp.diffuse.set(...this.blendLampColor.currentComponents());\r\n\t\t\t\tthis.lamp.intensity=this.blendLampIntensity.currentValue();\r\n\t\t\t\tthis.lamp.range=this.blendLampDistance.currentValue();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tmakeBlender(key,dfault,clazz=Blender){\r\n\t\tif(key in this.char.mv3d_blenders){\r\n\t\t\tdfault = this.char.mv3d_blenders[key];\r\n\t\t}else{\r\n\t\t\tthis.char.mv3d_blenders[key]=dfault;\r\n\t\t}\r\n\t\tconst blender=new clazz(key,dfault);\r\n\t\tblender.storageLocation=()=>this.char.mv3d_blenders;\r\n\t\treturn blender;\r\n\t}\r\n\tmakeColorBlender(key,dfault){\r\n\t\treturn this.makeBlender(key,dfault,ColorBlender);\r\n\t}\r\n\r\n\thasBush(){\r\n\t\tif(this.isEvent){\r\n\t\t\treturn this.getConfig('bush',!this._tileId);\r\n\t\t}\r\n\t\tif(this.isVehicle){\r\n\t\t\treturn mv3d.VEHICLE_BUSH;\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\r\n\tgetShape(){\r\n\t\treturn this.getConfig('shape',\r\n\t\t\tthis.char.isTile() ? mv3d.configurationShapes.FLAT : mv3d.EVENT_SHAPE\r\n\t\t);\r\n\t}\r\n\tupdateShape(){\r\n\t\tconst newshape = this.getShape();\r\n\t\tif(this.shape === newshape){ return; }\r\n\t\tthis.shape=newshape;\r\n\t\t//let backfaceCulling=true;\r\n\t\tlet geometry = Sprite.Meshes.SPRITE;\r\n\t\tconst shapes = mv3d.configurationShapes;\r\n\t\tswitch(this.shape){\r\n\t\tcase shapes.FLAT:\r\n\t\t\tgeometry = Sprite.Meshes.FLAT;\r\n\t\t\t//if(this.char._priorityType===2||this.hasConfig('height')||this.hasConfig('z')){\r\n\t\t\t//\tbackfaceCulling=false;\r\n\t\t\t//}\r\n\t\t\tbreak;\r\n\t\tcase shapes.XCROSS:\r\n\t\tcase shapes.CROSS:\r\n\t\t\tgeometry = Sprite.Meshes.CROSS;\r\n\t\t\t//backfaceCulling=false;\r\n\t\t\tbreak;\r\n\t\tcase shapes.FENCE:\r\n\t\t\t//backfaceCulling=false;\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\tthis.mesh.dispose();\r\n\t\tthis.mesh=geometry.clone();\r\n\t\t//this.material.backfaceCulling=backfaceCulling;\r\n\t\tthis.setupMesh();\r\n\t}\r\n\r\n\tupdate(){\r\n\t\tif(this.char._erased){\r\n\t\t\tthis.dispose();\r\n\t\t}\r\n\r\n\r\n\t\tthis.visible=this.char.mv_sprite.visible;\r\n\t\tif(typeof this.char.isVisible === 'function'){\r\n\t\t\tthis.visible=this.visible&&this.char.isVisible();\r\n\t\t}\r\n\t\tthis.disabled=!this.visible;\r\n\t\tif(this.char.isTransparent() || !this._characterName&&!this._tileId){\r\n\t\t\tthis.visible=false;\r\n\t\t}\r\n\t\tif(!this._isEnabled){\r\n\t\t\tif(this.visible){ this.setEnabled(true); }\r\n\t\t}else{\r\n\t\t\tif(!this.visible){ this.setEnabled(false); }\r\n\t\t}\r\n\r\n\r\n\t\tif(this.isImageChanged()){\r\n\t\t\tthis.updateCharacter();\r\n\t\t}\r\n\t\tif(this.patternChanged()){\r\n\t\t\tthis.updateFrame();\r\n\t\t}\r\n\r\n\t\tif(this.material){\r\n\t\t\tthis.updateNormal();\r\n\t\t}else{\r\n\t\t\tthis.updateEmpty();\r\n\t\t}\r\n\t\t//this.mesh.renderOutline=true;\r\n\t\t//this.mesh.outlineWidth=1;\r\n\r\n\t}\r\n\r\n\tupdateNormal(){\r\n\t\tconst shapes = mv3d.configurationShapes;\r\n\t\tif(this.shape===shapes.SPRITE){\r\n\t\t\tthis.mesh.pitch = mv3d.blendCameraPitch.currentValue()-90;\r\n\t\t\tthis.mesh.yaw = mv3d.blendCameraYaw.currentValue();\r\n\t\t}else if(this.shape===shapes.TREE){\r\n\t\t\tthis.mesh.pitch=0;\r\n\t\t\tthis.mesh.yaw = mv3d.blendCameraYaw.currentValue();\r\n\t\t}else{\r\n\t\t\tthis.mesh.pitch=0;\r\n\t\t\tthis.mesh.yaw=this.getConfig('rot',0);\r\n\t\t\tif(this.shape===shapes.XCROSS){this.mesh.yaw+=45;}\r\n\t\t}\r\n\r\n\t\tif(this.char===$gamePlayer){\r\n\t\t\tthis.mesh.visibility = +!mv3d.is1stPerson(true);\r\n\t\t}\r\n\r\n\t\tthis.updateAlpha();\r\n\r\n\t\tthis.tileHeight = mv3d.getWalkHeight(this.char._realX,this.char._realY);\r\n\r\n\t\tthis.updatePosition();\r\n\t\tthis.updateElevation();\r\n\t\tif(this.shadow){ this.updateShadow(); }\r\n\t\tthis.updateLights();\r\n\t}\r\n\r\n\tupdateEmpty(){\r\n\t\tthis.tileHeight = mv3d.getWalkHeight(this.char._realX,this.char._realY);\r\n\t\tthis.updatePosition();\r\n\t\tthis.updateElevation();\r\n\t\tthis.updateLights();\r\n\t}\r\n\r\n\tupdateAlpha(){\r\n\t\tlet hasAlpha=this.hasConfig('alpha')||this.char.opacity()<255;\r\n\t\tthis.bush = Boolean(this.char.bushDepth());\r\n\t\tif(this.bush && this.hasBush()){\r\n\t\t\thasAlpha=true;\r\n\t\t\tif(!this.material.opacityTexture){\r\n\t\t\t\tthis.material.opacityTexture=mv3d.getBushAlphaTexture();\r\n\t\t\t\tthis.material.useAlphaFromDiffuseTexture=true;\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\tif(this.material.opacityTexture){\r\n\t\t\t\tthis.material.opacityTexture=null;\r\n\t\t\t\tthis.material.useAlphaFromDiffuseTexture=false;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(hasAlpha){\r\n\t\t\tthis.material.useAlphaFromDiffuseTexture=true;\r\n\t\t\tthis.material.alpha=this.getConfig('alpha',1)*this.char.opacity()/255;\r\n\t\t}else{\r\n\t\t\tthis.material.useAlphaFromDiffuseTexture=false;\r\n\t\t\tthis.material.alpha=1;\r\n\t\t}\r\n\t}\r\n\r\n\tupdatePosition(){\r\n\t\tconst loopPos = mv3d.loopCoords(this.char._realX,this.char._realY);\r\n\t\tthis.x = loopPos.x;\r\n\t\tthis.y = loopPos.y;\r\n\r\n\t\tthis.spriteOrigin.position.set(0,0,0);\r\n\t\tthis.lightOrigin.position.set(0,0,0);\r\n\t\tthis.spriteOrigin.z = mv3d.LAYER_DIST*4;\r\n\t\tthis.lightOrigin.z = this.getConfig('lightHeight',mv3d.LIGHT_HEIGHT);\r\n\r\n\t\tconst billboardOffset = new Vector2(Math.sin(-mv3d.cameraNode.rotation.y),Math.cos(mv3d.cameraNode.rotation.y)).multiplyByFloats(0.45,0.45);\r\n\t\tconst lightOffset = this.getConfig('lightOffset',null);\r\n\t\tif(this.shape===mv3d.configurationShapes.SPRITE){\r\n\t\t\tthis.spriteOrigin.x=billboardOffset.x;\r\n\t\t\tthis.spriteOrigin.y=billboardOffset.y;\r\n\t\t\tthis.lightOrigin.x=billboardOffset.x;\r\n\t\t\tthis.lightOrigin.y=billboardOffset.y;\r\n\t\t}else if(!lightOffset){\r\n\t\t\tthis.lightOrigin.x=billboardOffset.x/2;\r\n\t\t\tthis.lightOrigin.y=billboardOffset.y/2;\r\n\t\t}\r\n\t\tif(lightOffset){\r\n\t\t\tthis.lightOrigin.x+=lightOffset.x;\r\n\t\t\tthis.lightOrigin.y+=lightOffset.y;\r\n\t\t}\r\n\r\n\t\tthis.spriteOrigin.x += this.getConfig('x',0);\r\n\t\tthis.spriteOrigin.y += this.getConfig('y',0);\r\n\t}\r\n\r\n\tupdateElevation(){\r\n\t\tlet newElevation = this.tileHeight;\r\n\t\tif(this.isVehicle || (this.isPlayer||this.isFollower)&&$gamePlayer.vehicle()){\r\n\t\t\tnewElevation += mv3d.getFloatHeight(Math.round(this.char._realX),Math.round(this.char._realY));\r\n\t\t\tif(this.char===$gameMap.vehicle('boat')){\r\n\t\t\t\tnewElevation += mv3d.BOAT_SETTINGS.zoff;\r\n\t\t\t}else if(this.char===$gameMap.vehicle('ship')){\r\n\t\t\t\tnewElevation += mv3d.SHIP_SETTINGS.zoff;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif(this.isAirship && $gamePlayer.vehicle()===this.char){\r\n\t\t\tif(!this.char._driving){\r\n\t\t\t\tthis.elevation += (newElevation-this.elevation)/10;\r\n\t\t\t}if(newElevation>=this.elevation){\r\n\t\t\t\tconst ascentSpeed = 100/Math.pow(1.5,mv3d.loadData('airship_ascentspeed',4));\r\n\t\t\t\tthis.elevation += (newElevation-this.elevation)/ascentSpeed;\r\n\t\t\t}else{\r\n\t\t\t\tif(!mv3d.vehicleObstructed(this.char,this.char.x,this.char.y,true)){\r\n\t\t\t\t\tconst descentSpeed = 100/Math.pow(1.5,mv3d.loadData('airship_descentspeed',2));\r\n\t\t\t\t\tthis.elevation += (newElevation-this.elevation)/descentSpeed;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.z = this.elevation;\r\n\t\t\tthis.z += mv3d.loadData('airship_height',mv3d.AIRSHIP_SETTINGS.height)*this.char._altitude/this.char.maxAltitude();\r\n\t\t}else if(this.char.isJumping()){\r\n\t\t\tlet jumpProgress = 1-(this.char._jumpCount/(this.char._jumpPeak*2));\r\n\t\t\tlet jumpHeight = Math.pow(jumpProgress-0.5,2)*-4+1;\r\n\t\t\tlet jumpDiff = Math.abs(this.char.mv3d_jumpHeightEnd - this.char.mv3d_jumpHeightStart);\r\n\t\t\tthis.z = this.char.mv3d_jumpHeightStart*(1-jumpProgress)\r\n\t\t\t+ this.char.mv3d_jumpHeightEnd*jumpProgress + jumpHeight*jumpDiff/2\r\n\t\t\t+this.char.jumpHeight()/tileSize();\r\n\t\t}else{\r\n\t\t\tthis.elevation=newElevation;\r\n\t\t\tthis.z=this.elevation+mv3d.LAYER_DIST*5;\r\n\t\t}\r\n\r\n\t\tif(this.isEvent){\r\n\t\t\tthis.z += this.getConfig('height',this.char._priorityType===2?mv3d.EVENT_HEIGHT:0);\r\n\t\t\tif(this.hasConfig('z')){\r\n\t\t\t\tthis.z=this.getConfig('z',0);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tupdateShadow(){\r\n\t\tlet shadowVisible = Boolean(this.getConfig('shadow', this.shape!=mv3d.configurationShapes.FLAT ));\r\n\r\n\t\tif(shadowVisible&&(this.isPlayer||this.isFollower)){\r\n\t\t\tconst myIndex = mv3d.characters.indexOf(this);\r\n\t\t\tif(myIndex>=0)\r\n\t\t\tfor (let i=myIndex+1; i<mv3d.characters.length; ++i){\r\n\t\t\t\tconst other = mv3d.characters[i];\r\n\t\t\t\tif(!other.shadow||!other.visible){ continue; }\r\n\t\t\t\tif(other.char._realX===this.char._realX&&other.char._realY===this.char._realY){\r\n\t\t\t\t\tshadowVisible=false;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(!this.shadow._isEnabled){\r\n\t\t\tif(shadowVisible){ this.shadow.setEnabled(true); }\r\n\t\t}else{\r\n\t\t\tif(!shadowVisible){ this.shadow.setEnabled(false); }\r\n\t\t}\r\n\t\tif(!shadowVisible){ return; }\r\n\r\n\t\tconst shadowBase = Math.min(0,this.getConfig('height',0));\r\n\t\tconst shadowDist = Math.max(this.z - this.tileHeight, shadowBase);\r\n\t\tconst shadowFadeDist = this.isAirship? mv3d.AIRSHIP_SETTINGS.shadowDist : mv3d.SHADOW_DIST;\r\n\t\tconst shadowStrength = Math.max(0,1-Math.abs(shadowDist)/shadowFadeDist);\r\n\t\tthis.shadow.z = -shadowDist;\r\n\t\tconst shadowScale = this.isAirship? mv3d.AIRSHIP_SETTINGS.shadowScale : this.getConfig('shadow',mv3d.SHADOW_SCALE);\r\n\t\tthis.shadow.scaling.setAll(shadowScale*shadowStrength);\r\n\t\tif(!this.shadow.isAnInstance){\r\n\t\t\tthis.shadow.visibility=shadowStrength-0.5*this.bush;//visibility doesn't work with instancing\r\n\t\t}\r\n\t}\r\n\r\n\tdispose(...args){\r\n\t\tsuper.dispose(...args);\r\n\t\tdelete this.char.mv3d_sprite;\r\n\t}\r\n}\r\n\r\nfor (const methodName of [\r\n\t'characterBlockX','characterBlockY','characterPatternX',\r\n\t'isImageChanged','patternWidth','patternHeight',\r\n\t'updateTileFrame','updateFrame',\r\n]){\r\n\tCharacter.prototype[methodName]=Sprite_Character.prototype[methodName];\r\n}","import mv3d from './mv3d.js';\r\n\r\nObject.assign(mv3d,{\r\n\tvehicleObstructed(vehicle,...args){\r\n\t\treturn vehicleObstructed.apply(vehicle,args);\r\n\t}\r\n});\r\n\r\nconst _characterBase_canPass = Game_CharacterBase.prototype.canPass\r\nGame_CharacterBase.prototype.canPass = function(x, y, d) {\r\n\tif(!_characterBase_canPass.apply(this,arguments)){\r\n\t\treturn false;\r\n\t}\r\n\tconst x2 = $gameMap.roundXWithDirection(x, d);\r\n\tconst y2 = $gameMap.roundYWithDirection(y, d);\r\n\tif(this===$gamePlayer){\r\n\t\tconst vehicle = this.vehicle();\r\n\t\tif(vehicle){\r\n\t\t\tconst obstructed = vehicleObstructed.call(vehicle,x2,y2,false);\r\n\t\t\tif(vehicle.isAirship()){\r\n\t\t\t\treturn !obstructed;\r\n\t\t\t}else if(obstructed){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tif (this.isThrough() || this.isDebugThrough()) {\r\n\t\treturn true;\r\n\t}\r\n\tconst tileHeight1 = mv3d.getWalkHeight(x,y);\r\n\tconst tileHeight2 = mv3d.getWalkHeight(x2,y2);\r\n\tif(Math.abs(tileHeight1-tileHeight2)>mv3d.STAIR_THRESH){ return false; }\r\n\treturn true;\r\n};\r\n\r\n// vehicles\r\n\r\nfunction vehicleNotObstructed(x, y, strict=true){\r\n\tif(!(this instanceof Game_Vehicle)){ throw \"This isn't a vehicle.\"; }\r\n\tif(!this.mv3d_sprite){ return true; }\r\n\tif(!this._driving){ return true; }\r\n\tif($gamePlayer.isDebugThrough()){ return true; }\r\n\tconst isAirship=this.isAirship();\r\n\tconst settings = mv3d[`${this._type.toUpperCase()}_SETTINGS`];\r\n\tconst big = mv3d.loadData( `${this._type}_big`, settings.big );\r\n\tlet altitude = 0.5;\r\n\tif(isAirship){\r\n\t\taltitude = mv3d.loadData('airship_height',mv3d.AIRSHIP_SETTINGS.height);\r\n\t}else{\r\n\t\taltitude += mv3d.getFloatHeight(x,y);\r\n\t}\r\n\tconst tileHeight = mv3d.getWalkHeight(x,y);\r\n\tlet posZ = this.mv3d_sprite.z;\r\n\tif('zoff' in settings){\r\n\t\tposZ-=settings.zoff;\r\n\t}\r\n\tif(tileHeight>posZ){ return false; }\r\n\tif(!big){ return true; }\r\n\tfor (let ox=-1;ox<=1;++ox)\r\n\tfor (let oy=-1;oy<=1;++oy){\r\n\t\tif(ox===0&&oy===0 || !strict&&ox&&oy){ continue; }\r\n\t\tconst tileHeight2 = mv3d.getWalkHeight(x+ox,y+oy);\r\n\t\tif(tileHeight2>tileHeight+altitude*!strict&&(strict||tileHeight2>posZ)){\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\treturn true;\r\n}\r\nfunction vehicleObstructed(){\r\n\treturn !vehicleNotObstructed.apply(this,arguments);\r\n}\r\n\r\nconst _airship_land_ok = Game_Map.prototype.isAirshipLandOk;\r\nGame_Map.prototype.isAirshipLandOk = function(x, y) {\r\n\tif(vehicleObstructed.call(this.airship(),x,y,true)){ return false; }\r\n\tif(mv3d.AIRSHIP_SETTINGS.bushLanding){\r\n\t\treturn this.checkPassage(x, y, 0x0f);\r\n\t}else{\r\n\t\treturn _airship_land_ok.apply(this,arguments);\r\n\t}\r\n\r\n};\r\n\r\nconst _player_updateVehicleGetOn = Game_Player.prototype.updateVehicleGetOn;\r\nGame_Player.prototype.updateVehicleGetOn = function() {\r\n\tconst vehicle = this.vehicle();\r\n\tconst speed = mv3d.loadData(`${vehicle._type}_speed`,vehicle._moveSpeed);\r\n\tthis.vehicle().setMoveSpeed(speed);\r\n\t_player_updateVehicleGetOn.apply(this,arguments);\r\n};\r\n\r\n// jump\r\n\r\nconst _charBase_jump = Game_CharacterBase.prototype.jump;\r\nGame_CharacterBase.prototype.jump = function(xPlus, yPlus) {\r\n\tthis.mv3d_jumpHeightStart = mv3d.getWalkHeight(this.x,this.y);\r\n\tthis.mv3d_jumpHeightEnd = mv3d.getWalkHeight(this.x+xPlus,this.y+yPlus);\r\n\t_charBase_jump.apply(this,arguments);\r\n};","import mv3d from './mv3d.js';\r\n\r\nconst gameMap_parallaxOx = Game_Map.prototype.parallaxOx;\r\nGame_Map.prototype.parallaxOx = function() {\r\n\tlet ox = gameMap_parallaxOx.apply(this,arguments);\r\n\tif(this._parallaxLoopX){\r\n\t\treturn ox - mv3d.blendCameraYaw.currentValue()*816/90;\r\n\t}\r\n\treturn ox;\r\n};\r\nconst gameMap_parallaxOy = Game_Map.prototype.parallaxOy;\r\nGame_Map.prototype.parallaxOy = function() {\r\n\tlet oy = gameMap_parallaxOy.apply(this,arguments);\r\n\tif(this._parallaxLoopY){\r\n\t\treturn oy - mv3d.blendCameraPitch.currentValue()*816/90;\r\n\t}\r\n    return oy;\r\n};\r\n\r\nGame_Map.prototype.setDisplayPos = function() { };\r\nGame_Map.prototype.scrollUp = function() { };\r\nGame_Map.prototype.scrollDown = function() { };\r\nGame_Map.prototype.scrollLeft = function() { };\r\nGame_Map.prototype.scrollRight = function() { };\r\nGame_Map.prototype.updateScroll = function() {\r\n    this._displayX = -mv3d.blendCameraYaw.currentValue()*816/3600;\r\n    this._displayY = -mv3d.blendCameraPitch.currentValue()*816/3600;\r\n};\r\n\r\nGame_CharacterBase.prototype.isNearTheScreen = function() {\r\n\treturn Math.abs(this.x - mv3d.cameraStick.x)<=mv3d.RENDER_DIST\r\n\t&& Math.abs(this.y - mv3d.cameraStick.y)<=mv3d.RENDER_DIST;\r\n};\r\n","import mv3d from './mv3d.js';\r\nimport { SceneSerializer, AssetsManager } from './mod_babylon.js';\r\n\r\nconst _onBoot = Scene_Boot.prototype.start;\r\nScene_Boot.prototype.start=function(){\r\n\t_onBoot.apply(this,arguments);\r\n\tmv3d.setupSerializer();\r\n}\r\nconst isPlaytest = Utils.isOptionValid('test');\r\n\r\nDataManager._databaseFiles.push({name:'mv3d_data',src:`../${mv3d.MV3D_FOLDER}/mv3d_data.json`});\r\nlet _mv3d_data;\r\nconst mv3d_data_handler={\r\n\tget(target,key){\r\n\t\tif(target[key]&&typeof target[key]==='object'){\r\n\t\t\treturn new Proxy(target[key],mv3d_data_handler);\r\n\t\t}else{\r\n\t\t\treturn target[key];\r\n\t\t}\r\n\t},\r\n\tset(target,key,value){\r\n\t\t_mv3d_data._dirty=true;\r\n\t\ttarget[key]=value;\r\n\t}\r\n}\r\nlet writing_mv3d_data=false;\r\n\r\nObject.assign(mv3d,{\r\n\tsetupSerializer(){\r\n\t\t_mv3d_data=mv3d_data;\r\n\t\tif(isPlaytest){\r\n\t\t\tmv3d_data=new Proxy(_mv3d_data,mv3d_data_handler);\r\n\t\t}\r\n\t},\r\n\tasync updateSerializer(){\r\n\t\tif(!isPlaytest){ return; }\r\n\t\tif(_mv3d_data._dirty&&!writing_mv3d_data){\r\n\t\t\twriting_mv3d_data=true;\r\n\t\t\t_mv3d_data._dirty=false;\r\n\t\t\tawait saveFile(`${mv3d.MV3D_FOLDER}/mv3d_data.json`,JSON.stringify(_mv3d_data));\r\n\t\t\twriting_mv3d_data=false;\r\n\t\t}\r\n\t},\r\n\r\n\tasync loadFinalizedCells(vectors){\r\n\t\tconst assetsManager = new AssetsManager(this.scene);\r\n\t\tfor (const vector of vectors){\r\n\t\t\tconst key = [vector2.x,vector2.y].toString();\r\n\t\t\tassetsManager.addMeshTask(key,'','./',`${mv3d.MV3D_FOLDER}/finalizedMaps/${$gameMap.mapId().padZero(3)}/${key}.babylon`);\r\n\t\t}\r\n\t\tassetsManager.load();\r\n\t},\r\n\r\n\tasync finalizeCell(cell){\r\n\t\tconst meshdata = SceneSerializer.SerializeMesh(cell.mesh);\r\n\t\tconst fileName = `${mv3d.MV3D_FOLDER}/finalizedMaps/${$gameMap.mapId().padZero(3)}/${[cell.cx,cell.cy]}.babylon`;\r\n\t\tawait saveFile(fileName,JSON.stringify(meshdata));\r\n\t},\r\n\r\n\topenMenu(){\r\n\t\tconst choices = [\r\n\t\t\t\"Finalize this cell\",\r\n\t\t\t\"Definalize this cell\",\r\n\t\t\t\"Finalize all loaded cells\",\r\n\t\t\t\"Definalize all cells\",\r\n\t\t];\r\n\t\t$gameMessage.setChoices(choices, 0);\r\n\t\t$gameMessage.setChoicePositionType(1);\r\n\t\t$gameMessage.setChoiceCallback(choice=>{\r\n\t\r\n\t\t});\r\n\t},\r\n\r\n});\r\n\r\nconst saveFile=async(fileName,fileData)=>{\r\n\tconst fs=require('fs');\r\n\tconst path=require('path');\r\n\tconst filePath = path.resolve(global.__dirname,fileName);\r\n\tawait ensureDirectory(path.dirname(filePath));\r\n\tawait new Promise((resolve,reject)=>{\r\n\t\tfs.writeFile(filePath,fileData,err=>{\r\n\t\t\tif(err){ reject(err); return; }\r\n\t\t\tresolve();\r\n\t\t});\r\n\t});\r\n}\r\n\r\nconst ensureDirectory=(dirName)=>new Promise((resolve,reject)=>{\r\n\tconst fs=require('fs');\r\n\tconst path=require('path');\r\n\tfs.mkdir(path.resolve(global.__dirname,dirName),{recursive:true},err=>{\r\n\t\tif(err&&err.code!=='EEXIST'){ reject(err); return; }\r\n\t\tresolve();\r\n\t});\r\n});\r\n"],"sourceRoot":""}