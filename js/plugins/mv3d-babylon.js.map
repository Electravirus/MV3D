{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/util.js","webpack:///./src/mod_babylon.js","webpack:///./src/mv3d.js","webpack:///./src/mod_mv.js","webpack:///./src/parameters.js","webpack:///./src/blenders.js","webpack:///./src/input.js","webpack:///./src/configuration.js","webpack:///./src/plugin_commands.js","webpack:///./src/tileData.js","webpack:///./src/mapCell.js","webpack:///./src/loadMap.js","webpack:///./src/assets.js","webpack:///./src/characters.js","webpack:///./src/movement.js","webpack:///./src/parallax.js"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","Vector2","Vector3","Color3","Color4","window","BABYLON","makeColor","color","g","b","a","toColor4","canvas","document","createElement","width","height","context","getContext","fillStyle","fillRect","bytes","getImageData","data","relativeNumber","current","relative","test","substr","Number","isNaN","Boolean","falseString","String","S","toUpperCase","values","includes","lastSnooze","snooze","async","performance","now","ms","Promise","resolve","setTimeout","degtorad","deg","Math","PI","radtodeg","rad","tileSize","tileWidth","Game_Map","tileHeight","XAxis","YAxis","ZAxis","v2origin","Scene","Engine","FreeCamera","HemisphericLight","DirectionalLight","SpotLight","PointLight","ShadowGenerator","Vector4","Plane","Node","TransformNode","Texture","StandardMaterial","Mesh","MeshBuilder","FRONTSIDE","BACKSIDE","DOUBLESIDE","PERSPECTIVE_CAMERA","ORTHOGRAPHIC_CAMERA","Camera","FOGMODE_NONE","FOGMODE_EXP","FOGMODE_EXP2","FOGMODE_LINEAR","WORLDSPACE","Space","WORLD","LOCALSPACE","LOCAL","BONE","crop","x","y","w","h","this","getBaseSize","EDGE_FIX","uScale","vScale","uOffset","vOffset","defineProperties","position","undefined","v","z","pitch","rotation","yaw","roll","_order","_scene","sortMeshes","meshSorter","m1","m2","meshes","sort","_addMesh","addMesh","mesh","apply","arguments","_removeMesh","removeMesh","toNumber","mv3d","setupParameters","texture","PIXI","fromCanvas","engine","ANTIALIASING","scene","clearColor","set","cameraStick","cameraNode","parent","camera","fov","FOV","orthoLeft","Graphics","orthoRight","orthoTop","orthoBottom","minZ","maxZ","RENDER_DIST","ambientColor","fogMode","map","cells","characters","setupBlenders","setupInput","setupSpriteMeshes","_width","_height","render","update","lastMapUpdate","mapUpdating","updateMap","updateAnimations","updateBlenders","updateCharacters","KEYBOARD_TURN","is1stPerson","Input","isTriggered","blendCameraYaw","setValue","targetValue","playerFaceYaw","KEYBOARD_PITCH","isPressed","blendCameraPitch","min","max","loadData","dfault","$gameVariables","console","warn","cameraMode","startsWith","CAMERA_MODE","saveData","useCurrent","k","getCameraTarget","$gamePlayer","blendCameraTransition","blendCameraDist","blendPanX","blendPanY","$gameMap","isLoopHorizontal","mapWidth","ox","mod","isLoopVertical","mapHeight","oy","dir","floor","setDirection","currentValue","reverse","_graphics_createCanvas","_createCanvas","setup","updateCanvas","_graphics_updateAllElements","_updateAllElements","_graphics_render","_sceneMap_update","Scene_Map","ShaderTilemap","renderWebGL","renderer","_createTilemap","Spriteset_Map","createTilemap","_tilemap","visible","_baseSprite","addChild","Sprite","_sprite_char_setchar","Sprite_Character","setCharacter","character","configurable","_performTransfer","Game_Player","performTransfer","newmap","_newMapId","mapId","clearMap","_onMapLoaded","onMapLoaded","mapLoaded","loadMap","parameters","PluginManager","assign","ORTHOGRAPHIC_DIST","ANIM_DELAY","animDelay","ALPHA_CUTOFF","alphatest","edgefix","antialiasing","WALL_HEIGHT","wallHeight","TABLE_HEIGHT","tableHeight","FRINGE_HEIGHT","fringeHeight","CEILING_HEIGHT","ceilingHeight","LAYER_DIST","layerDist","CELL_SIZE","renderDist","FOG_COLOR","fogColor","FOG_NEAR","fogNear","FOG_FAR","fogFar","AMBIENT_COLOR","LIGHT_HEIGHT","LIGHT_DECAY","LIGHT_DIST","LIGHT_ANGLE","CHARACTER_SHADOWS","characterShadows","SHADOW_SCALE","shadowScale","SHADOW_DIST","shadowDist","keyboardPitch","keyboardTurn","KEYBOARD_STRAFE","keyboardStrafe","REGION_DATA","TTAG_DATA","EVENT_HEIGHT","eventHeight","VEHICLE_BUSH","vehicleBush","BOAT_SETTINGS","JSON","parse","boatSettings","SHIP_SETTINGS","shipSettings","AIRSHIP_SETTINGS","airshipSettings","entry","regions","regionId","ttags","terrainTag","offsetTop","topOffsetX","topOffsetY","offsetSide","sideOffsetX","sideOffsetY","shape","configurationShapes","scale","zoff","big","bushLanding","EVENT_SHAPE","eventShape","cameraTargets","char","time","unshift","length","getTargetString","clearCameraTarget","setCameraTarget","target","targetChar","blendFogColor","ColorBlender","blendFogNear","blendFogFar","cycle","blendCameraHeight","blendAmbientColor","blendSunlightColor","blendSunlightIntensity","reorient","updateCameraMode","char1","isInVehicle","vehicle","char2","_realX","_realY","mv3d_sprite","translate","fogStart","fogEnd","copyFromFloats","speed","Infinity","diff","saveValue","abs","sign","loadValue","storage","storageLocation","ret","getInputDescriptor","menumode","p3mode","p1mode","assignedValue","SceneManager","keyMapper","81","69","87","65","83","68","descriptors","left","rotleft","right","rotright","37","39","getInputDirection","dir4","transformDirectionYaw","_player_updateMove","updateMove","isMoving","_player_move_straight","moveStraight","isMovementSucceeded","raycastPredicate","isEnabled","isVisible","isPickable","isFollower","isPlayer","processMapTouch","TouchInput","_touchCount","intersection","pick","hit","point","pickedPoint","pickedMesh","$gameTemp","setDestination","round","_player_findDirectionTo","findDirectionTo","dirToYaw","tilesetConfigurations","mapConfigurations","lines","readConfigurationBlocks","tileset","note","readLines","match","exec","conf","readConfigurationFunctions","tilesetConfigurationFunctions","tileId","constructTileId","split","mapconf","$dataMap","mapConfigurationFunctions","fog","near","far","light","cameraDist","cameraHeight","cameraPitch","cameraYaw","findBlocks","contents","findTags","line","functionset","configurationFunctions","readConfigurations","toLowerCase","configurationSides","front","back","double","FLAT","TREE","SPRITE","FENCE","CROSS","XCROSS","fringe","float","img","sideId","topId","insideId","offsetInside","recttop","rectside","rectTop","Rectangle","setN","getSetNumber","rectSide","rectInside","transparent","alpha","glow","eventConfigurationFunctions","side","rot","bool","bush","shadow","pos","lamp","intensity","distance","angle","flashlight","flashlightPitch","flashlightYaw","lightHeight","lightOffset","alphaTest","camerayaw","camerapitch","cameradist","cameraheight","cameramode","edge","ceiling","_event_setupPage","Game_Event","setupPage","mv3d_needsConfigure","eventConfigure","_event_init","initialize","createCharacterFor","event","config","readConfigurationTags","locate","mv3d_blenders","lampColor_r","lampColor_g","lampColor_b","lampIntensity","lampDistance","flashlightColor_r","flashlightColor_g","flashlightColor_b","flashlightIntensity","flashlightDistance","flashlightAngle","_pluginCommand","Game_Interpreter","pluginCommand","command","args","pc","PluginCommand","INTERPRETER","FULL_COMMAND","join","filter","CHAR","_eventId","firstChar","TARGET_CHAR","shift","com","_TIME","dist","_cameraTarget","pan","_RELATIVE_BLEND","log","rotationMode","pitchMode","Vehicle","booleanString","_VEHICLE","_fogColor","_fogNear","_fogFar","_lightColor","AWAIT_CHAR","setupLamp","_lampColor","_lampIntensity","_lampDistance","blendLampColor","blendLampIntensity","blendLampDistance","setupFlashlight","_flashlightColor","_flashlightIntensity","_flashlightDistance","_flashlightAngle","_flashlightYaw","_flashlightPitch","blendFlashlightColor","blendFlashlightIntensity","blendFlashlightDistance","blendFlashlightAngle","blendFlashlightPitch","flashlightTargetYaw","blender","ERROR_CHAR","sleep","self","id","followers","_data","Game_Follower","_followers","indexOf","Game_Vehicle","_vehicles","_spriteset","Tilemap","isAutotile","isTileA1","isTileA2","isTileA3","isTileA5","getTerrainTag","tilesetFlags","options","normalizeAutotileId","offsetBottom","tilemap","getTilemap","bottomId","_isHigherTile","ttag","tagdata","rectBottom","hasInsideConf","hasBottomConf","tileRange","tileData","getTileData","isTileEmpty","defaultHeight","region","isSpecialShape","isWallTile","_isTableTile","layerId","getTileHeight","getTileConfig","getStackHeight","ignorePits","rects","isTable","_drawTile","addRect","sheetId","sx","sy","dx","dy","animX","animY","push","splice","kind","getAutotileKind","ty","isWall","isTileA4","shapes","TILE_ID_A1","SOURCEPLANE_GROUND","pow","SOURCEPLANE_WALL","cx","cy","toString","super","loopPos","loopCoords","meshCache","clone","CreatePlane","sideOrientation","sourcePlane","submeshes","cellWidth","cellHeight","nlnowall","tileConf","realId","isFringeTile","loadTile","loadWalls","loadFence","loadCross","earlyExit","forEach","MergeMeshes","dispose","configRect","getTileRects","rect","getCachedMesh","material","getCachedTileMaterial","getMaterialOptions","realWallHeight","isFringe","ni","neighborPositions","np","getMapConfig","neededHeight","getFringeHeight","neighborHeight","getCullingHeight","wallPos","atan2","scaling","rotate","npl","npr","leftHeight","rightHeight","bx","by","getAutotileCorner","wallParts","partHeight","sw","sh","isTableTile","ax","az","hasLeftEdge","hasRightEdge","isWaterfallTile","edges","rightSide","tx","textureCache","materialCache","animatedTextures","loadMapSettings","createCharacters","bounds","top","bottom","cellsToLoad","ix","iy","ceil","cameraCellPos","DistanceSquared","cellpos","loadMapCell","cell","load","tsName","tilesetNames","getErrorTexture","hasAlpha","onLoadObservable","addOnce","updateSamplingMode","isWaterfall","frameData","errorTexture","bushAlphaTexture","getAlphaFromRGB","processMaterialOptions","getExtraBit","getCachedTileTexture","diffuseTexture","opacityTexture","alphaCutOff","emissiveColor","specularColor","alph","extra","lastAnimUpdate","animXFrame","animYFrame","animDirection","events","vehicles","f","order","sprite","Meshes","SHADOW","shadowTexture","shadowMaterial","spriteOrigin","src","disposeMaterial","bitmap","_texture","onTextureLoaded","_character","charName","charIndex","updateCharacter","updateShape","isVehicle","isBoat","isShip","isAirship","isEvent","elevation","lightOrigin","setupLights","isReady","_tileId","textureSrc","setMaterial","updateFrame","updateScale","_tilesetId","tilesetId","_characterName","characterName","_characterIndex","characterIndex","_isBigCharacter","ImageManager","isBigCharacter","setTileMaterial","px","characterPatternX","py","characterPatternY","isTextureReady","pw","patternWidth","ph","patternHeight","characterBlockX","characterBlockY","setFrame","isObjectCharacter","direction","configScale","getConfig","settings","_type","xscale","yscale","settings_event","settings_event_page","page","comments","list","code","excludedMeshes","makeColorBlender","makeBlender","Zero","exponent","range","diffuse","targetComponents","flashlightOrigin","blendFlashlightYaw","updateFlashlightDirection","setupMesh","flashlightOffset","tan","currentComponents","clazz","isTile","newshape","getShape","geometry","_erased","mv_sprite","_isEnabled","setEnabled","isImageChanged","patternChanged","bushDepth","hasBush","getBushAlphaTexture","useAlphaFromDiffuseTexture","getWalkHeight","updatePosition","updateElevation","updateShadow","updateLights","billboardOffset","sin","cos","multiplyByFloats","newElevation","getFloatHeight","_driving","ascentSpeed","vehicleObstructed","descentSpeed","_altitude","maxAltitude","isJumping","jumpProgress","_jumpCount","_jumpPeak","jumpHeight","jumpDiff","mv3d_jumpHeightEnd","mv3d_jumpHeightStart","_priorityType","hasConfig","shadowVisible","myIndex","other","shadowBase","shadowFadeDist","shadowStrength","setAll","isAnInstance","visibility","methodName","_characterBase_canPass","Game_CharacterBase","canPass","vehicleNotObstructed","strict","isDebugThrough","altitude","posZ","tileHeight2","x2","roundXWithDirection","y2","roundYWithDirection","obstructed","isThrough","tileHeight1","_airship_land_ok","isAirshipLandOk","airship","checkPassage","_player_updateVehicleGetOn","updateVehicleGetOn","_moveSpeed","setMoveSpeed","_charBase_jump","jump","xPlus","yPlus","gameMap_parallaxOx","parallaxOx","_parallaxLoopX","gameMap_parallaxOy","parallaxOy","_parallaxLoopY","setDisplayPos","scrollUp","scrollDown","scrollLeft","scrollRight","updateScroll","_displayX","_displayY","isNearTheScreen"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;eACE,IAAIA,EAAmB,GAGvB,SAASC,EAAoBC,GAG5B,GAAGF,EAAiBE,GACnB,OAAOF,EAAiBE,GAAUC,QAGnC,IAAIC,EAASJ,EAAiBE,GAAY,CACzCG,EAAGH,EACHI,GAAG,EACHH,QAAS,IAUV,OANAI,EAAQL,GAAUM,KAAKJ,EAAOD,QAASC,EAAQA,EAAOD,QAASF,GAG/DG,EAAOE,GAAI,EAGJF,EAAOD,QAKfF,EAAoBQ,EAAIF,EAGxBN,EAAoBS,EAAIV,EAGxBC,EAAoBU,EAAI,SAASR,EAASS,EAAMC,GAC3CZ,EAAoBa,EAAEX,EAASS,IAClCG,OAAOC,eAAeb,EAASS,EAAM,CAAEK,YAAY,EAAMC,IAAKL,KAKhEZ,EAAoBkB,EAAI,SAAShB,GACX,oBAAXiB,QAA0BA,OAAOC,aAC1CN,OAAOC,eAAeb,EAASiB,OAAOC,YAAa,CAAEC,MAAO,WAE7DP,OAAOC,eAAeb,EAAS,aAAc,CAAEmB,OAAO,KAQvDrB,EAAoBsB,EAAI,SAASD,EAAOE,GAEvC,GADU,EAAPA,IAAUF,EAAQrB,EAAoBqB,IAC/B,EAAPE,EAAU,OAAOF,EACpB,GAAW,EAAPE,GAA8B,iBAAVF,GAAsBA,GAASA,EAAMG,WAAY,OAAOH,EAChF,IAAII,EAAKX,OAAOY,OAAO,MAGvB,GAFA1B,EAAoBkB,EAAEO,GACtBX,OAAOC,eAAeU,EAAI,UAAW,CAAET,YAAY,EAAMK,MAAOA,IACtD,EAAPE,GAA4B,iBAATF,EAAmB,IAAI,IAAIM,KAAON,EAAOrB,EAAoBU,EAAEe,EAAIE,EAAK,SAASA,GAAO,OAAON,EAAMM,IAAQC,KAAK,KAAMD,IAC9I,OAAOF,GAIRzB,EAAoB6B,EAAI,SAAS1B,GAChC,IAAIS,EAAST,GAAUA,EAAOqB,WAC7B,WAAwB,OAAOrB,EAAgB,SAC/C,WAA8B,OAAOA,GAEtC,OADAH,EAAoBU,EAAEE,EAAQ,IAAKA,GAC5BA,GAIRZ,EAAoBa,EAAI,SAASiB,EAAQC,GAAY,OAAOjB,OAAOkB,UAAUC,eAAe1B,KAAKuB,EAAQC,IAGzG/B,EAAoBkC,EAAI,GAIjBlC,EAAoBA,EAAoBmC,EAAI,G,sCCjFrD,MAAM,QAACC,EAAO,QAACC,EAAO,OAACC,EAAM,OAACC,GAAUC,OAAOC,QAElCC,EAAYC,IACxB,GAAqB,iBAAVA,EACV,MAAO,CACNzB,GAAIyB,GAAO,IAAI,IACfC,GAAID,GAAO,EAAE,KAAK,IAClBE,GAAU,IAANF,GAAW,IACfG,EAAG,GAEC,GAAGH,aAAiBL,EACzB,OAAOK,EAAMI,WACR,GAAGJ,aAAiBJ,EACzB,OAAOI,EACH,CACJ,MAAMK,EAASC,SAASC,cAAc,UACtCF,EAAOG,MAAM,EAAGH,EAAOI,OAAO,EAC9B,MAAMC,EAAUL,EAAOM,WAAW,MAClCD,EAAQE,UAAYZ,EAAOU,EAAQG,SAAS,EAAE,EAAE,EAAE,GAClD,MAAMC,EAAQJ,EAAQK,aAAa,EAAE,EAAE,EAAE,GAAGC,KAC5C,OAAO,IAAIpB,EAAOkB,EAAM,GAAG,IAAIA,EAAM,GAAG,IAAIA,EAAM,GAAG,IAAIA,EAAM,GAAG,OAavDG,EAAe,CAACC,EAAQhC,KACpC,GAAO,KAAJA,EAAS,OAAQgC,EACpB,MAAMC,EAAW,OAAOC,KAAKlC,GAG7B,OAFGiC,IAAUjC,EAAEA,EAAEmC,OAAO,IACxBnC,EAAEoC,OAAOpC,GACNoC,OAAOC,MAAMrC,IAAagC,EAC1BC,GACMD,EAAQhC,GAERA,GAIG,EAAcM,GACnBgC,QAAQC,EAAYjC,IAEfiC,EAAYjC,IACxB,IAAIA,EAAI,OAAO,EACA,iBAALA,IAAgBA,EAAEkC,OAAOlC,IACnC,MAAMmC,EAAEnC,EAAEoC,cACV,OAAGH,EAAYI,OAAOC,SAASH,IAGxBnC,GAERiC,EAAYI,OAAO,CAAC,MAAM,QAAQ,YAAY,OAAO,UAAU,YAE/D,IAAIE,EAAW,EACR,MAAMC,EAAOC,UAChBC,YAAYC,MAAMJ,EAAW,WACzB,EAAM,GACZA,EAAWG,YAAYC,QAGZ,EAAM,CAACC,EAAG,IAAI,IAAIC,QAAQC,GAASC,WAAWD,EAAQF,IACtDI,EAASC,GAAKA,EAAIC,KAAKC,GAAG,IAC1BC,EAASC,GAAS,IAAJA,EAAQH,KAAKC,GAE3BG,EAAS,IAAIC,IACbA,EAAU,IAAIC,SAAS3D,UAAU0D,YACjC,EAAW,IAAIC,SAAS3D,UAAU4D,aAGlCC,EAAQ,IAAIxD,EAAQ,EAAE,EAAE,GACxByD,EAAQ,IAAIzD,EAAQ,EAAE,EAAE,GACxB0D,EAAQ,IAAI1D,EAAQ,EAAE,EAAE,GACxB2D,EAAW,IAAI5D,EAAQ,EAAE,GChFhCK,GDiFkB,IAAIJ,EAAQ,EAAE,EAAE,GCjFxBG,OAAOC,UACV,MACZwD,EAAK,OACLC,EAAM,WACNC,EAAU,iBACVC,EAAgB,iBAChBC,EAAgB,UAChBC,EAAS,WACTC,EAAU,gBACVC,EACApE,QAAO,EACPC,QAAO,UACPoE,EACAnE,OAAM,EACNC,OAAM,QACNmE,EAAK,KACLC,EAAI,cACJC,EAAa,QACbC,EAAO,iBACPC,EAAgB,KAChBC,EAAI,YACJC,GACGvE,GAES,UACZwE,EAAS,SAACC,EAAQ,WAACC,GAChBJ,GAES,mBACZK,EAAkB,oBAClBC,GACG5E,EAAQ6E,QAEA,aACXC,EAAY,YACZC,EAAW,aACXC,EAAY,eACZC,GACGzB,EAES0B,EAAalF,EAAQmF,MAAMC,MAC3BC,GAAarF,EAAQmF,MAAMG,MACdtF,EAAQmF,MAAMI,KAKxCnB,EAAQ7E,UAAUiG,KAAK,SAASC,EAAE,EAAEC,EAAE,EAAEC,EAAE,EAAEC,EAAE,GAC7C,MAAM,MAAElF,EAAK,OAAEC,GAAWkF,KAAKC,cAC3BH,IAAEA,EAAEjF,EAAM+E,GACVG,IAAEA,EAAEjF,EAAO+E,GACZ,GAAKK,WAAWN,GAAG,GAAKM,SAASL,GAAG,GAAKK,SAASJ,GAAiB,EAAd,GAAKI,SAAWH,GAAiB,EAAd,GAAKG,UAChFF,KAAKG,OAAOL,EAAEjF,EACdmF,KAAKI,OAAOL,EAAEjF,EACdkF,KAAKK,QAAQT,EAAE/E,EACfmF,KAAKM,QAAQ,EAAET,EAAE/E,EAAOkF,KAAKI,QAG9B5H,OAAO+H,iBAAiBlC,EAAK3E,UAAU,CACtCkG,EAAE,CACD,MAAO,OAAOI,KAAKQ,SAASR,KAAKQ,SAASZ,OAAEa,GAC5C,IAAIC,GAAOV,KAAKQ,WAAWR,KAAKQ,SAASZ,EAAEc,KAE5Cb,EAAE,CACD,MAAO,OAAOG,KAAKQ,UAAUR,KAAKQ,SAASG,OAAEF,GAC7C,IAAIC,GAAOV,KAAKQ,WAAWR,KAAKQ,SAASG,GAAGD,KAE7CC,EAAE,CACD,MAAO,OAAOX,KAAKQ,SAASR,KAAKQ,SAASX,OAAEY,GAC5C,IAAIC,GAAOV,KAAKQ,WAAWR,KAAKQ,SAASX,EAAEa,KAG5CE,MAAM,CACL,MAAO,OAAOZ,KAAKa,UAAU5D,EAAS+C,KAAKa,SAASjB,QAAGa,GACvD,IAAIC,GAAOV,KAAKa,WAAWb,KAAKa,SAASjB,GAAG/C,EAAS6D,MAEtDI,IAAI,CACH,MAAO,OAAOd,KAAKa,UAAU5D,EAAS+C,KAAKa,SAAShB,QAAGY,GACvD,IAAIC,GAAQV,KAAKa,WAAWb,KAAKa,SAAShB,GAAGhD,EAAS6D,MAEvDK,KAAK,CACJ,MAAO,OAAOf,KAAKa,UAAU5D,EAAS+C,KAAKa,SAASF,QAAGF,GACvD,IAAIC,GAAQV,KAAKa,WAAWb,KAAKa,SAASF,GAAG9D,EAAS6D,QAMxDlI,OAAOC,eAAegG,EAAK/E,UAAU,QAAQ,CAC5C,MAAO,OAAOsG,KAAKgB,QACnB,IAAIN,GAAIV,KAAKgB,OAAON,EAAGV,KAAKiB,OAAOC,gBAEpC,MAAMC,GAAW,CAACC,EAAGC,KAAgB,EAAVD,EAAGJ,SAAqB,EAAVK,EAAGL,QAC5CrD,EAAMjE,UAAUwH,WAAW,WAC1BlB,KAAKsB,OAAOC,KAAKJ,KAElB,MAAMK,GAAW7D,EAAMjE,UAAU+H,QACjC9D,EAAMjE,UAAU+H,QAAQ,SAASC,GAChCF,GAASG,MAAM3B,KAAK4B,WACI,iBAAdF,EAAKV,QACdhB,KAAKkB,cAGP,MAAMW,GAAclE,EAAMjE,UAAUoI,WACpCnE,EAAMjE,UAAUoI,WAAW,SAASJ,GACnCG,GAAYF,MAAM3B,KAAK4B,WACvB5B,KAAKkB,cAIN,EAAOxH,UAAUqI,SAAS,EAAOrI,UAAUqI,SAAS,WAAW,OAAc,IAAP/B,KAAKpH,GAAO,GAAU,IAAPoH,KAAK1F,GAAO,EAAS,IAAP0F,KAAKzF,GC1GxG,MAAMyH,GAAO,CAEZ,QACChC,KAAKiC,kBAELjC,KAAKtF,OAASC,SAASC,cAAc,UACrCoF,KAAKkC,QAAUC,KAAK5D,QAAQ6D,WAAWpC,KAAKtF,QAC5CsF,KAAKqC,OAAS,IAAIzE,EAAOoC,KAAKtF,OAAOsF,KAAKsC,cAC1CtC,KAAKuC,MAAQ,IAAI5E,EAAMqC,KAAKqC,QAE5BrC,KAAKuC,MAAMC,WAAWC,IAAI,EAAE,EAAE,EAAE,GAEhCzC,KAAK0C,YAAc,IAAIpE,EAAc,cAAc0B,KAAKuC,OACxDvC,KAAK2C,WAAa,IAAIrE,EAAc,aAAa0B,KAAKuC,OACtDvC,KAAK2C,WAAWC,OAAO5C,KAAK0C,YAC5B1C,KAAK6C,OAAS,IAAIhF,EAAW,SAAS,IAAI,EAAQ,EAAE,EAAE,GAAGmC,KAAKuC,OAC9DvC,KAAK6C,OAAOD,OAAO5C,KAAK2C,WACxB3C,KAAK6C,OAAOC,IAAIjG,EAASmF,GAAKe,KAC9B/C,KAAK6C,OAAOG,WAAWC,SAASpI,MAAM,EAAEsC,IACxC6C,KAAK6C,OAAOK,WAAWD,SAASpI,MAAM,EAAEsC,IACxC6C,KAAK6C,OAAOM,SAASF,SAASnI,OAAO,EAAEqC,IACvC6C,KAAK6C,OAAOO,aAAaH,SAASnI,OAAO,EAAEqC,IAC3C6C,KAAK6C,OAAOQ,KAAK,GACjBrD,KAAK6C,OAAOS,KAAKtD,KAAKuD,YAKtBvD,KAAKuC,MAAMiB,aAAe,IAAI,EAAO,EAAE,EAAE,GACzCxD,KAAKuC,MAAMkB,QAAQrE,EAEnBY,KAAK0D,IAAM,IAAIrF,EAAK,MAAM2B,KAAKuC,OAC/BvC,KAAK2D,MAAM,GACX3D,KAAK4D,WAAW,GAEhB5D,KAAK6D,gBAEL7D,KAAK8D,aAEL9D,KAAK+D,qBAGN,eACC/D,KAAKtF,OAAOG,MAAQoI,SAASe,OAC7BhE,KAAKtF,OAAOI,OAASmI,SAASgB,SAG/B,SACCjE,KAAKuC,MAAM2B,SACXlE,KAAKkC,QAAQiC,UAGdC,cAAc,EACd,SACK7H,YAAYC,MAAMwD,KAAKoE,cAAgB,MAASpE,KAAKqE,cACxDrE,KAAKsE,YACLtE,KAAKoE,cAAc7H,YAAYC,OAGhCwD,KAAKuE,mBAELvE,KAAKwE,iBAELxE,KAAKyE,oBAGDzC,GAAK0C,eAAiB1E,KAAK2E,iBAC3BC,MAAMC,YAAY,WACpB7E,KAAK8E,eAAeC,SAAS/E,KAAK8E,eAAeE,cAAc,GAAG,IAC1DJ,MAAMC,YAAY,aAC1B7E,KAAK8E,eAAeC,SAAS/E,KAAK8E,eAAeE,cAAc,GAAG,IAEhEhF,KAAK2E,gBAAgBC,MAAMC,YAAY,YAAYD,MAAMC,YAAY,cACvE7E,KAAKiF,iBAGHjD,GAAKkD,iBACLN,MAAMO,UAAU,WAAWP,MAAMO,UAAU,cAErCP,MAAMO,UAAU,UACxBnF,KAAKoF,iBAAiBL,SAAShI,KAAKsI,IAAI,IAAIrF,KAAKoF,iBAAiBJ,cAAc,KAAK,IAC7EJ,MAAMO,UAAU,aACxBnF,KAAKoF,iBAAiBL,SAAShI,KAAKuI,IAAI,EAAEtF,KAAKoF,iBAAiBJ,cAAc,KAAK,MAIrF,IAAK,MAAM3L,KAAO2G,KAAK2D,MACtB3D,KAAK2D,MAAMtK,GAAK8K,UAIlBoB,SAAQ,CAAClM,EAAImM,IACRC,gBAAmBA,eAAezD,MAAU3I,KAAOoM,eAAezD,KAC/DyD,eAAezD,KAAK3I,GAD0DmM,EAGtF,SAASnM,EAAIN,GACZ,IAAI0M,eAAiB,OAAOC,QAAQC,KAAK,4BAA4BtM,KAAON,KACxE0M,eAAezD,OAAOyD,eAAezD,KAAK,IAC9CyD,eAAezD,KAAK3I,GAAKN,GAG1B,mBACciH,KAAK4F,WACVC,WAAW,KACf7F,KAAK6C,OAAO5J,OAAO8F,IAAsBiB,KAAK6C,OAAO5J,KAAK8F,GAE1DiB,KAAK6C,OAAO5J,OAAO6F,IAAqBkB,KAAK6C,OAAO5J,KAAK6F,IAG9D,iBACC,OAAOkB,KAAKuF,SAAS,aAAavF,KAAK8F,aAAa7J,eAErD,eAAeyE,GACdA,EAAI3E,OAAO2E,GAAGzE,cAAc4J,WAAW,KAAO,eAAiB,cAC/D7F,KAAK+F,SAAS,aAAarF,GAC3BV,KAAKwE,gBAAe,IAGrB,YAAYwB,GACX,MAAMC,EAAID,EAAW,eAAe,cACpC,OAAOhG,KAAKkG,oBAAoBC,aAAenG,KAAKoG,sBAAsBH,MAAM,GAC7EjG,KAAKqG,gBAAgBJ,MAAM,GAA2B,IAAtBjG,KAAKsG,UAAUL,MAAkC,IAAtBjG,KAAKuG,UAAUN,MAG9E,WAAWrG,EAAEC,GACZ,GAAG2G,SAASC,mBAAmB,CAC9B,MAAMC,EAASF,SAAS3L,QAClB8L,EAAK3G,KAAK0C,YAAY9C,EAAI8G,EAAS,EACzC9G,GAAGA,EAAE+G,GAAIC,IAAIF,GAAUC,EAExB,GAAGH,SAASK,iBAAiB,CAC5B,MAAMC,EAAUN,SAAS1L,SACnBiM,EAAK/G,KAAK0C,YAAY7C,EAAIiH,EAAU,EAC1CjH,GAAGA,EAAEkH,GAAIH,IAAIE,GAAWC,EAEzB,OAAO,IAAI,EAAQnH,EAAEC,IAGtB,gBACC,IAAImH,EAAMjK,KAAKkK,OAA0C,GAAlCjF,GAAK8C,eAAeE,eAAkB,IAAI4B,IAAI,GAClEI,EAAI,IAAIA,IAAMA,EAAI,GAAG,EAAE,EAAE,GAC5BA,EAAI,IAAQ,EAAJA,EAAM,GACdb,YAAYe,aAAaF,IAG1B,SAASA,GACR,IAAIlG,EAAMkG,EAAI,EAAE,EAGhB,OAFGlG,EAAI,IAAIA,IAAMA,EAAI,GAAG,EAAE,EAAE,GAC5BA,GAAS,GAALA,EAAQ,KAIb,sBAAsBkG,EAAIlG,EAAId,KAAK8E,eAAeqC,eAAeC,GAAQ,GACxE,GAAQ,GAALJ,EAAS,OAAO,GACnBA,EAAMA,EAAI,EAAE,GACL,IAAIA,IAAMA,EAAI,GAAG,EAAE,EAAE,GAC5B,MAAM7O,EAAI4E,KAAKkK,OAAOnG,EAAI,IAAI,IAO9B,OALCkG,EADEI,GACGJ,EAAI7O,GAAGyO,IAAI,IAEXI,EAAI7O,GAAGyO,IAAI,IAEV,IAAII,IAAMA,EAAI,GAAG,EAAE,EAAE,GACjB,EAAJA,EAAM,IAIf9M,OAAO8H,KAAKA,GACG,UC1Kf,MAAMqF,GAAuBpE,SAASqE,cACtCrE,SAASqE,cAAgB,WACxB,GAAKC,QACL,GAAKC,eACLH,GAAuB1F,MAAM3B,KAAK4B,YAGnC,MAAM6F,GAA4BxE,SAASyE,mBAC3CzE,SAASyE,mBAAqB,WAC7BD,GAA4B9F,MAAM3B,KAAK4B,WACvC,GAAK4F,gBAGN,MAAMG,GAAiB1E,SAASiB,OAChCjB,SAASiB,OAAO,WACf,GAAKA,SACLyD,GAAiBhG,MAAM3B,KAAK4B,YAG7B,MAAMgG,GAAiBC,UAAUnO,UAAUyK,OAC3C0D,UAAUnO,UAAUyK,OAAS,WAC5ByD,GAAiBjG,MAAM3B,KAAK4B,WAC5B,GAAKuC,UAGN2D,cAAcpO,UAAUqO,YAAc,SAASC,KAE/C,MAAMC,GAAeC,cAAcxO,UAAUyO,cAC7CD,cAAcxO,UAAUyO,cAAc,WACrCF,GAAetG,MAAM3B,KAAK4B,WAC1B5B,KAAKoI,SAASC,SAAQ,EACtBrI,KAAKsI,YAAYC,SAAU,IAAIpG,KAAKqG,OAAO,GAAKtG,WAGjD,MAAMuG,GAAuBC,iBAAiBhP,UAAUiP,aACxDD,iBAAiBhP,UAAUiP,aAAe,SAASC,GAClDH,GAAqB9G,MAAM3B,KAAK4B,WAChCpJ,OAAOC,eAAemQ,EAAU,YAAY,CAC3C7P,MAAMiH,KACN6I,cAAa,KAMf,MAAMC,GAAiBC,YAAYrP,UAAUsP,gBAC7CD,YAAYrP,UAAUsP,gBAAkB,WACvC,MAAMC,EAASjJ,KAAKkJ,YAAc1C,SAAS2C,QACxCF,GACF,GAAKG,WAENN,GAAiBnH,MAAM3B,KAAK4B,YAK7B,MAAMyH,GAAaxB,UAAUnO,UAAU4P,YACvCzB,UAAUnO,UAAU4P,YAAY,WAC/BD,GAAa1H,MAAM3B,KAAK4B,WACpB,GAAK2H,WACR,GAAKC,UAEN,GAAKhF,gBAAe,IC5DrB,MAAMiF,GAAaC,cAAcD,WAAW,gBAG5CjR,OAAOmR,OAAO,GAAK,CAClB7D,YAAY,cACZ8D,kBAAkB,IAElBC,WAAWlO,OAAO8N,GAAWK,WAC7BC,aAAahN,KAAKuI,IAAI,IAAKmE,GAAWO,WAEtC9J,SAAUvE,OAAO8N,GAAWQ,SAC5B3H,aAAc,EAAcmH,GAAWS,cACvCnH,IAAIpH,OAAO8N,GAAW3G,KAEtBqH,YAAYxO,OAAO8N,GAAWW,YAC9BC,aAAa1O,OAAO8N,GAAWa,aAC/BC,cAAc5O,OAAO8N,GAAWe,cAChCC,eAAe9O,OAAO8N,GAAWiB,eACjCC,WAAWhP,OAAO8N,GAAWmB,WAE7BC,UAAU,GACVtH,YAAa5H,OAAO8N,GAAWqB,YAE/BC,UAAW3Q,EAAUqP,GAAWuB,UAAUjJ,WAC1CkJ,SAAUtP,OAAO8N,GAAWyB,SAC5BC,QAASxP,OAAO8N,GAAW2B,QAC3BC,cAAejR,EAAUqP,GAAWjG,cAAczB,WAGlDuJ,aAAc,GACdC,YAAa,EACbC,WAAY,EACZC,YAAa,GAEbC,kBAAkB,EAAcjC,GAAWkC,kBAC3CC,aAAajQ,OAAO8N,GAAWoC,aAC/BC,YAAYnQ,OAAO8N,GAAWsC,YAE9B7G,eAAgB,EAAcuE,GAAWuC,eACzCtH,cAAe,EAAc+E,GAAWwC,cACxCC,gBAAiB,EAAczC,GAAW0C,gBAE1CC,YAAY,GACZC,UAAU,GAEVC,aAAa3Q,OAAO8N,GAAW8C,aAC/BC,aAAa,EAAc/C,GAAWgD,aACtCC,cAAcC,KAAKC,MAAMnD,GAAWoD,cACpCC,cAAcH,KAAKC,MAAMnD,GAAWsD,cACpCC,iBAAiBL,KAAKC,MAAMnD,GAAWwD,iBAGvC,kBACC,IAAK,IAAIC,KAASP,KAAKC,MAAMnD,GAAW0D,SACvCD,EAAMP,KAAKC,MAAMM,GACjBlN,KAAKoM,YAAYc,EAAME,UAAU,CAChCtS,OAAQa,OAAOuR,EAAMpS,SAGvB,IAAK,IAAIoS,KAASP,KAAKC,MAAMnD,GAAW4D,OACvCH,EAAMP,KAAKC,MAAMM,GACjBlN,KAAKqM,UAAUa,EAAMI,YAAY,CAChCxS,OAAQa,OAAOuR,EAAMpS,QACrByS,UAAW,IAAI,EAAQ5R,OAAOuR,EAAMM,YAAY7R,OAAOuR,EAAMO,aAC7DC,WAAY,IAAI,EAAQ/R,OAAOuR,EAAMS,aAAahS,OAAOuR,EAAMU,cAC/DC,MAAO7N,KAAK8N,oBAAoBZ,EAAMW,MAAM5R,gBAI9C+D,KAAK0M,cAAcqB,MAAMpS,OAAOqE,KAAK0M,cAAcqB,OACnD/N,KAAK0M,cAAcsB,KAAKrS,OAAOqE,KAAK0M,cAAcsB,MAClDhO,KAAK0M,cAAcuB,IAAI,EAAcjO,KAAK0M,cAAcuB,KACxDjO,KAAK8M,cAAciB,MAAMpS,OAAOqE,KAAK8M,cAAciB,OACnD/N,KAAK8M,cAAckB,KAAKrS,OAAOqE,KAAK8M,cAAckB,MAClDhO,KAAK8M,cAAcmB,IAAI,EAAcjO,KAAK8M,cAAcmB,KACxDjO,KAAKgN,iBAAiBe,MAAMpS,OAAOqE,KAAKgN,iBAAiBe,OACzD/N,KAAKgN,iBAAiBlS,OAAOa,OAAOqE,KAAKgN,iBAAiBlS,QAC1DkF,KAAKgN,iBAAiBnB,YAAYlQ,OAAOqE,KAAKgN,iBAAiBnB,aAC/D7L,KAAKgN,iBAAiBjB,WAAWpQ,OAAOqE,KAAKgN,iBAAiBjB,YAC9D/L,KAAKgN,iBAAiBiB,IAAI,EAAcjO,KAAKgN,iBAAiBiB,KAC9DjO,KAAKgN,iBAAiBkB,YAAY,EAAclO,KAAKgN,iBAAiBkB,aAGtElO,KAAKmO,YAAYnO,KAAK8N,oBAAoBrE,GAAW2E,WAAWnS,kBClFlEzD,OAAOmR,OAAO,GAAK,CAElB0E,cAAc,GACd,kBACC,OAAOrO,KAAKqO,cAAc,IAE3B,gBAAgBC,EAAKC,GAChBD,GACJtO,KAAKqO,cAAcG,QAAQF,GACxBtO,KAAKqO,cAAcI,OAAO,IAAIzO,KAAKqO,cAAcI,OAAO,GAC3DzO,KAAK+F,SAAS,eAAe/F,KAAK0O,gBAAgBJ,IAClDtO,KAAKoG,sBAAsBrN,MAAM,EACjCiH,KAAKoG,sBAAsBrB,SAAS,EAAEwJ,IAL3BvO,KAAKqO,cAAcI,OAAO,GAOtC,oBACCzO,KAAKqO,cAAcI,OAAO,GAE3B,oBACCzO,KAAK2O,oBACL3O,KAAK4O,gBAAgBzI,YAAY,IAElC,uBACC,MAAM0I,EAAS7O,KAAKuF,SAAS,gBAC1BsJ,GACF7O,KAAK4O,gBAAgB5O,KAAK8O,WAAWD,GAAQ,IAI/C,gBACC7O,KAAK+O,cAAgB,IAAIC,aAAa,WAAWhP,KAAK+K,WACtD/K,KAAKiP,aAAe,IAAI,iBAAQ,UAAUjP,KAAKiL,UAC/CjL,KAAKkP,YAAc,IAAI,iBAAQ,SAASlP,KAAKmL,SAC7CnL,KAAK8E,eAAiB,IAAI,iBAAQ,YAAY,GAC9C9E,KAAK8E,eAAeqK,MAAM,IAC1BnP,KAAKoF,iBAAmB,IAAI,iBAAQ,cAAc,IAClDpF,KAAKoF,iBAAiBC,IAAI,EAC1BrF,KAAKoF,iBAAiBE,IAAI,IAC1BtF,KAAKqG,gBAAkB,IAAI,iBAAQ,aAAa,IAChDrG,KAAKoP,kBAAoB,IAAI,iBAAQ,eAAe,IACpDpP,KAAKqP,kBAAoB,IAAIL,aAAa,eAAehP,KAAKqL,eAC9DrL,KAAKsP,mBAAqB,IAAIN,aAAa,cAAc,UACzDhP,KAAKuP,uBAAyB,IAAI,iBAAQ,kBAAkB,GAC5DvP,KAAKsG,UAAY,IAAI,iBAAQ,OAAO,GACpCtG,KAAKuG,UAAY,IAAI,iBAAQ,OAAO,GACpCvG,KAAKoG,sBAAwB,IAAI,iBAAQ,mBAAmB,IAG1D,eAAeoJ,GAQjB,GAPAxP,KAAKyP,mBAEDzP,KAAKqO,cAAcI,QACnBtI,cACFnG,KAAKqO,cAAc,GAAGlI,aAGrBnG,KAAKoG,sBAAsBjC,UAAYnE,KAAKqO,cAAcI,QAAQ,EAAE,CACtE,MAAMzV,EAAIgH,KAAKoG,sBAAsBe,eACrC,IAAIuI,EAAM1P,KAAKqO,cAAc,GAC1BqB,IAAQvJ,aAAaA,YAAYwJ,gBAAgBD,EAAMvJ,YAAYyJ,WACtE,IAAIC,EAAM7P,KAAKqO,cAAc,GAC1BwB,IAAQ1J,aAAaA,YAAYwJ,gBAAgBE,EAAM1J,YAAYyJ,WACtE5P,KAAK0C,YAAY9C,EAAI8P,EAAMI,QAAQ,EAAE9W,GAAK6W,EAAMC,OAAO9W,EACvDgH,KAAK0C,YAAY7C,EAAI6P,EAAMK,QAAQ,EAAE/W,GAAK6W,EAAME,OAAO/W,EACpD0W,EAAMM,aAAaH,EAAMG,YAC3BhQ,KAAK0C,YAAY/B,EAAI+O,EAAMM,YAAYrP,GAAG,EAAE3H,GAAK6W,EAAMG,YAAYrP,EAAE3H,EAC7D0W,EAAMM,cACdhQ,KAAK0C,YAAY/B,EAAE+O,EAAMM,YAAYrP,QAEjC,GAAGX,KAAKqO,cAAcI,OAAO,CAClC,IAAIH,EAAOtO,KAAKkG,kBACboI,IAAOnI,aAAaA,YAAYwJ,gBAAgBrB,EAAKnI,YAAYyJ,WACpE5P,KAAK0C,YAAY9C,EAAE0O,EAAKwB,OACxB9P,KAAK0C,YAAY7C,EAAEyO,EAAKyB,OACrBzB,EAAK0B,cACPhQ,KAAK0C,YAAY/B,EAAE2N,EAAK0B,YAAYrP,GAGtCX,KAAKsG,UAAUnC,SACfnE,KAAKuG,UAAUpC,SACfnE,KAAK0C,YAAY9C,GAAGI,KAAKsG,UAAUa,eACnCnH,KAAK0C,YAAY7C,GAAGG,KAAKuG,UAAUY,eAGhCqI,EAASxP,KAAKoF,iBAAiBjB,SAASnE,KAAK8E,eAAeX,SAC9DnE,KAAKqG,gBAAgBlC,SAASnE,KAAKoP,kBAAkBjL,WACrDnE,KAAK2C,WAAW/B,MAAQZ,KAAKoF,iBAAiB+B,eAAe,GAC7DnH,KAAK2C,WAAW7B,IAAMd,KAAK8E,eAAeqC,eAC1CnH,KAAK2C,WAAWnC,SAASiC,IAAI,EAAE,EAAE,GACjCzC,KAAK2C,WAAWsN,UAAUxS,GAAOuC,KAAKqG,gBAAgBc,eAAe3H,IAClEQ,KAAK6C,OAAO5J,OAAO8F,GAGrBiB,KAAK6C,OAAOS,KAAKtD,KAAKuD,YACtBvD,KAAK6C,OAAOQ,MAAMrD,KAAKuD,cAGpBvD,KAAK2C,WAAWhC,EAAE,IAAIX,KAAK2C,WAAWhC,EAAE,GAC3CX,KAAK6C,OAAOS,KAAKtD,KAAKuD,YACtBvD,KAAK6C,OAAOQ,KAAK,IAElBrD,KAAK2C,WAAWhC,GAAKX,KAAKoP,kBAAkBjI,gBAI1CqI,EAASxP,KAAK+O,cAAc5K,SAASnE,KAAKiP,aAAa9K,SAASnE,KAAKkP,YAAY/K,WACnFnE,KAAKuC,MAAM2N,SAASlQ,KAAKiP,aAAa9H,eACtCnH,KAAKuC,MAAM4N,OAAOnQ,KAAKkP,YAAY/H,eACnCnH,KAAKuC,MAAMyI,SAASoF,eACnBpQ,KAAK+O,cAAcnW,EAAEuO,eAAe,IACpCnH,KAAK+O,cAAczU,EAAE6M,eAAe,IACpCnH,KAAK+O,cAAcxU,EAAE4M,eAAe,MAKnCqI,EAASxP,KAAKqP,kBAAkBlL,UAClCnE,KAAKuC,MAAMiB,aAAa4M,eACvBpQ,KAAKqP,kBAAkBzW,EAAEuO,eAAe,IACxCnH,KAAKqP,kBAAkB/U,EAAE6M,eAAe,IACxCnH,KAAKqP,kBAAkB9U,EAAE4M,eAAe,QASrC,MAAM,iBACZ,YAAY9N,EAAImM,GACfxF,KAAK3G,IAAIA,EACT2G,KAAKwF,OAAO,GAAKD,SAASlM,EAAImM,GAC9BxF,KAAKjH,MAAMyM,EACXxF,KAAKqQ,MAAM,EACXrQ,KAAKsF,IAAIgL,IACTtQ,KAAKqF,KAAKiL,IACVtQ,KAAKmP,OAAM,EAEZ,SAASN,EAAON,EAAK,GAEpB,IAAIgC,GADJ1B,EAAS9R,KAAKsI,IAAIrF,KAAKsF,IAAIvI,KAAKuI,IAAItF,KAAKqF,IAAIwJ,KACzB7O,KAAKjH,MACzB,GAAIwX,EAAJ,CAEA,GADAvQ,KAAKwQ,UAAUxQ,KAAK3G,IAAIwV,GACrB7O,KAAKmP,MACP,KAAQpS,KAAK0T,IAAIF,GAAMvQ,KAAKmP,MAAM,GACjCnP,KAAKjH,OAASgE,KAAK2T,KAAKH,GAAMvQ,KAAKmP,MACnCoB,EAAO1B,EAAS7O,KAAKjH,MAGvBiH,KAAKqQ,MAAQtT,KAAK0T,IAAIF,IAAO,GAAGhC,IAEjC,eAAgB,OAAOvO,KAAKjH,MAC5B,cAAe,OAAOiH,KAAK2Q,UAAU3Q,KAAK3G,KAC1C,eAAgB,OAAO2G,KAAKwF,OAC5B,SACC,MAAMqJ,EAAS7O,KAAKgF,cACpB,GAAGhF,KAAKjH,QAAQ8V,EAAS,OAAO,EAChC,MAAM0B,EAAO1B,EAAS7O,KAAKjH,MAM3B,OALGiH,KAAKqQ,MAAQtT,KAAK0T,IAAIF,GACxBvQ,KAAKjH,MAAM8V,EAEX7O,KAAKjH,OAAOiH,KAAKqQ,MAAMtT,KAAK2T,KAAKH,IAE3B,EAER,kBACC,OAAI9K,gBAIAA,eAAezD,OAAOyD,eAAezD,KAAO,IACzCyD,eAAezD,OAJrB0D,QAAQC,KAAK,8CACN,IAKT,UAAUtM,GACT,MAAMuX,EAAU5Q,KAAK6Q,kBACrB,OAAKxX,KAAOuX,EACLA,EAAQvX,GADe2G,KAAKwF,OAGpC,UAAUnM,EAAIN,GACGiH,KAAK6Q,kBACbxX,GAAKN,GAIR,MAAMiW,aACZ,YAAY3V,EAAImM,GACfxF,KAAKwF,OAAOA,EACZxF,KAAKpH,EAAE,IAAI,iBAAQ,GAAGS,MAAQmM,GAAQ,IACtCxF,KAAK1F,EAAE,IAAI,iBAAQ,GAAGjB,MAAQmM,GAAQ,EAAE,KACxCxF,KAAKzF,EAAE,IAAI,iBAAQ,GAAGlB,MAAe,IAAPmM,GAE/B,SAASnL,EAAMkU,GACdvO,KAAKpH,EAAEmM,SAAS1K,GAAO,GAAGkU,GAC1BvO,KAAK1F,EAAEyK,SAAS1K,GAAO,EAAE,IAAKkU,GAC9BvO,KAAKzF,EAAEwK,SAAe,IAAN1K,EAAWkU,GAE5B,eACC,OAAOvO,KAAKpH,EAAEG,OAAO,GAAGiH,KAAK1F,EAAEvB,OAAO,EAAEiH,KAAKzF,EAAExB,MAEhD,cACC,OAAOiH,KAAKpH,EAAEoM,eAAe,GAAGhF,KAAK1F,EAAE0K,eAAe,EAAEhF,KAAKzF,EAAEyK,cAEhE,eAAgB,OAAOhF,KAAKwF,OAC5B,SACC,IAAIsL,EAAI,EAIR,OAHAA,GAAK9Q,KAAKpH,EAAEuL,SACZ2M,GAAK9Q,KAAK1F,EAAE6J,SACZ2M,GAAK9Q,KAAKzF,EAAE4J,SACLtI,QAAQiV,GAEhB,sBAAuB,OAAO9Q,KAAKpH,EAAEiY,gBACrC,oBAAoBnQ,GACnBV,KAAKpH,EAAEiY,gBAAgBnQ,EACvBV,KAAK1F,EAAEuW,gBAAgBnQ,EACvBV,KAAKzF,EAAEsW,gBAAgBnQ,EAExB,oBACC,MAAO,CAACV,KAAKpH,EAAEuO,eAAe,IAAInH,KAAK1F,EAAE6M,eAAe,IAAInH,KAAKzF,EAAE4M,eAAe,KAEnF,mBACC,MAAO,CAACnH,KAAKpH,EAAEoM,cAAc,IAAIhF,KAAK1F,EAAE0K,cAAc,IAAIhF,KAAKzF,EAAEyK,cAAc,MCrMjF,SAAS+L,GAAmBC,EAASC,EAAOC,GAC3C,IAAIC,OAAc1Q,EAClB,MAAO,CACNoI,cAAa,EACblQ,IAAG,IACgB8H,MAAf0Q,EAAkCA,EAChCC,aAAanQ,kBAAkB4G,UACjC,GAAKlD,cAAuBuM,EACxBD,EAFiDD,EAIzD,IAAItQ,GAAIyQ,EAAczQ,IApCxBlI,OAAOmR,OAAO/E,MAAMyM,UAAU,CAC7BC,GAAG,UACHC,GAAG,WACHC,GAAG,KACHC,GAAG,OACHC,GAAG,OACHC,GAAG,UAGJ,GAAK7N,WAAW,WACf,MAAM8N,EAAY,CACjBC,KAAKd,GAAmB,OAAO,OAAO,WACtCe,QAAQf,GAAmB,SAAS,UAAW,GAAK7E,gBAAgB,YAAOzL,GAC3EsR,MAAMhB,GAAmB,QAAQ,QAAQ,YACzCiB,SAASjB,GAAmB,WAAW,WAAY,GAAK7E,gBAAgB,aAAQzL,IAEjFjI,OAAO+H,iBAAiBqE,MAAMyM,UAAU,CACvCY,GAAGL,EAAYC,KACfK,GAAGN,EAAYG,MACfT,GAAGM,EAAYE,QACfP,GAAGK,EAAYI,SACfP,GAAGG,EAAYC,KACfF,GAAGC,EAAYG,SAkBjBhJ,YAAYrP,UAAUyY,kBAAoB,WACzC,IAAInL,EAAMpC,MAAMwN,KAChB,OAAO,GAAKC,sBAAsBrL,EAAI,GAAKlC,eAAeqC,gBAAe,IAG1E,MAAMmL,GAAqBvJ,YAAYrP,UAAU6Y,WACjDxJ,YAAYrP,UAAU6Y,WAAa,WAClCD,GAAmB3Q,MAAM3B,KAAK4B,YACxB5B,KAAKwS,YAAc,GAAK7N,eAC7B,GAAKM,iBAGP,MAAMwN,GAAsB1J,YAAYrP,UAAUgZ,aAClD3J,YAAYrP,UAAUgZ,aAAe,SAASta,GAC7Cqa,GAAsB9Q,MAAM3B,KAAK4B,YAC7B5B,KAAK2S,uBAAuB,GAAKhO,eACpC,GAAKM,iBAIP,MAAM2N,GAAiBlR,MAClBA,EAAKmR,aAAgBnR,EAAKoR,WAAcpR,EAAKqR,eAC9CrR,EAAKkH,YACJlH,EAAKkH,UAAUoK,aAAYtR,EAAKkH,UAAUqK,UAK/CpL,UAAUnO,UAAUwZ,gBAAkB,WACrC,GAAIC,WAAWtO,eAAiB7E,KAAKoT,YAAc,EAClD,GAAID,WAAWhO,YAAa,CAC3B,GAAyB,IAArBnF,KAAKoT,aAAqBpT,KAAKoT,aAAe,GAAI,CAErD,MAAMC,EAAe,GAAK9Q,MAAM+Q,KAAKH,WAAWvT,EAAEuT,WAAWtT,EAAE+S,IAC/D,GAAGS,EAAaE,IAAI,CACnB,MAAMC,EAAQ,CAAC5T,EAAEyT,EAAaI,YAAY7T,EAAGC,GAAGwT,EAAaI,YAAY9S,GACnEe,EAAO2R,EAAaK,WACvBhS,EAAKkH,YACP4K,EAAM5T,EAAE8B,EAAKkH,UAAUhJ,EACvB4T,EAAM3T,EAAE6B,EAAKkH,UAAU/I,GAExB8T,UAAUC,eAAe7W,KAAK8W,MAAML,EAAM5T,GAAI7C,KAAK8W,MAAML,EAAM3T,KAIjEG,KAAKoT,mBAELpT,KAAKoT,YAAc,GAKtB,MAAMU,GAAwB/K,YAAYrP,UAAUqa,gBACpDhL,YAAYrP,UAAUqa,gBAAgB,WACrC,MAAM/M,EAAM8M,GAAwBnS,MAAM3B,KAAK4B,WAC/C,GAAG,GAAK+C,eAAiBqC,EAAI,CAC5B,IAAIlG,EAAM,GAAKkT,SAAShN,GAExB,GAAKlC,eAAeC,SAASjE,EAAI,KAElC,OAAOkG,GClGRxO,OAAOmR,OAAO,GAAK,CAClBsK,sBAAsB,GACtBC,kBAAkB,GAClB,kBAEClU,KAAKiU,sBAAsB,GAC3B,MAAME,EAAQnU,KAAKoU,wBAAwB5N,SAAS6N,UAAUC,MACxDC,EAAY,mDAClB,IAAIC,EACJ,KAAMA,EAAQD,EAAUE,KAAKN,IAAO,CACnC,MAAM9a,EAAMmb,EAAM,GACZE,EAAO1U,KAAK2U,2BAA2BH,EAAM,GAAGxU,KAAK4U,+BACrDC,EAAO7U,KAAK8U,mBAAmBzb,EAAI0b,MAAM,MAC5CF,KAAU7U,KAAKiU,sBACjBzb,OAAOmR,OAAO3J,KAAKiU,sBAAsBY,GAAQH,GAEjD1U,KAAKiU,sBAAsBY,GAAQH,EAIrC,MAAMM,EAAQhV,KAAKkU,kBAAkB,GAOrC,GANAlU,KAAK2U,2BACJ3U,KAAKoU,wBAAwBa,SAASX,MACtCtU,KAAKkV,0BACLF,GAGE,QAASA,EAAQ,CACnB,MAAMG,EAAMH,EAAQG,IACjB,UAAWA,GAAMnV,KAAK+O,cAAchK,SAASoQ,EAAI9a,MAAM,GACvD,SAAU8a,GAAMnV,KAAKiP,aAAalK,SAASoQ,EAAIC,KAAK,GACpD,QAASD,GAAMnV,KAAKkP,YAAYnK,SAASoQ,EAAIE,IAAI,GAElD,UAAWL,GACbhV,KAAKqP,kBAAkBtK,SAASiQ,EAAQM,MAAMjb,MAAM,GAGlD,eAAgB2a,GAClBhV,KAAKqG,gBAAgBtB,SAASiQ,EAAQO,WAAW,GAE9C,iBAAkBP,GACrBhV,KAAKoP,kBAAkBrK,SAASiQ,EAAQQ,aAAa,GAEnD,eAAgBR,IAClBhV,KAAK4F,WAAWoP,EAAQpP,YAEtB,gBAAiBoP,GACnBhV,KAAKoF,iBAAiBL,SAASiQ,EAAQS,YAAY,GAEjD,cAAeT,GACjBhV,KAAK8E,eAAeC,SAASiQ,EAAQU,UAAU,IAKjD,aAAarc,EAAImM,GAChB,OAAGnM,KAAO2G,KAAKkU,kBACPlU,KAAKkU,kBAAkB7a,GAExBmM,GAGR,wBAAwB8O,GACvB,MAAMqB,EAAa,6BACnB,IACInB,EADAoB,EAAW,GAEf,KAAMpB,EAAQmB,EAAWlB,KAAKH,IAC7BsB,GAAYpB,EAAM,GAAG,KAEtB,OAAOoB,GAGR,sBAAsBtB,GACrB,MAAMuB,EAAW,sBACjB,IACIrB,EADAoB,EAAS,GAEb,KAAMpB,EAAQqB,EAASpB,KAAKH,IAC3BsB,GAAUpB,EAAM,GAAG,KAEpB,OAAOoB,GAGR,2BAA2BE,EAAKC,EAAY,GAAKC,uBAAuBtB,EAAK,IAC5E,MAAMuB,EAAqB,kBAC3B,IAAIzB,EACJ,KAAMA,EAAQyB,EAAmBxB,KAAKqB,IAAM,CAC3C,MAAMzc,EAAMmb,EAAM,GAAG0B,cAClB7c,KAAO0c,GACTA,EAAY1c,GAAKqb,KAAQF,EAAM,GAAGO,MAAM,MAG1C,OAAOL,GAGRyB,mBAAmB,CAClBC,MAAMzX,EACN0X,KAAKzX,EACL0X,OAAOzX,GAERiP,oBAAoB,CACnByI,KAAK,EACLC,KAAK,EACLC,OAAO,EACPC,MAAM,EACNC,MAAM,EACNC,OAAO,GAIRhC,8BAA8B,CAC7B,OAAOF,EAAKnb,GAAImb,EAAK5Z,OAAOa,OAAOpC,IACnC,OAAOmb,EAAKnb,GAAImb,EAAKmC,OAAOlb,OAAOpC,IACnC,MAAMmb,EAAKnb,GAAImb,EAAKoC,MAAMnb,OAAOpC,IACjC,QAAQmb,EAAKqC,EAAInX,EAAEC,GAClB,MAAMgV,EAAS,GAAKC,gBAAgBiC,EAAInX,EAAEC,GAC1C6U,EAAKsC,OAAStC,EAAKuC,MAAQpC,GAE5B,IAAIH,EAAKqC,EAAInX,EAAEC,GAAI6U,EAAKuC,MAAM,GAAKnC,gBAAgBiC,EAAInX,EAAEC,IACzD,KAAK6U,EAAKqC,EAAInX,EAAEC,GAAI6U,EAAKsC,OAAO,GAAKlC,gBAAgBiC,EAAInX,EAAEC,IAC3D,OAAO6U,EAAKqC,EAAInX,EAAEC,GAAI6U,EAAKwC,SAAS,GAAKpC,gBAAgBiC,EAAInX,EAAEC,IAC/D,OAAO6U,EAAK9U,EAAEC,GACb6U,EAAKhH,WAAagH,EAAKnH,UAAY,IAAI,EAAQ5R,OAAOiE,GAAGjE,OAAOkE,KAEjE,UAAU6U,EAAK9U,EAAEC,GAChB6U,EAAKnH,UAAY,IAAI,EAAQ5R,OAAOiE,GAAGjE,OAAOkE,KAE/C,WAAW6U,EAAK9U,EAAEC,GACjB6U,EAAKhH,WAAa,IAAI,EAAQ/R,OAAOiE,GAAGjE,OAAOkE,KAEhD,aAAa6U,EAAK9U,EAAEC,GACnB6U,EAAKyC,aAAe,IAAI,EAAQxb,OAAOiE,GAAGjE,OAAOkE,KAElD,KAAK6U,EAAKqC,EAAInX,EAAEC,EAAEC,EAAEC,GACnBC,KAAKoX,QAAQ1C,EAAKqC,EAAInX,EAAEC,EAAEC,EAAEC,GAC5BC,KAAKqX,SAAS3C,EAAKqC,EAAInX,EAAEC,EAAEC,EAAEC,IAE9B,QAAQ2U,EAAKqC,EAAInX,EAAEC,EAAEC,EAAEC,GACtB2U,EAAKuC,MAAQ,GAAKnC,gBAAgBiC,EAAI,EAAE,GACxCrC,EAAK4C,QAAU,IAAInV,KAAKoV,UAAU3X,EAAEC,EAAEC,EAAEC,GACxC2U,EAAK4C,QAAQE,KAAO,GAAKC,aAAa/C,EAAKuC,QAE5C,SAASvC,EAAKqC,EAAInX,EAAEC,EAAEC,EAAEC,GACvB2U,EAAKsC,OAAS,GAAKlC,gBAAgBiC,EAAI,EAAE,GACzCrC,EAAKgD,SAAW,IAAIvV,KAAKoV,UAAU3X,EAAEC,EAAEC,EAAEC,GACzC2U,EAAKgD,SAASF,KAAO,GAAKC,aAAa/C,EAAKsC,SAE7C,WAAWtC,EAAKqC,EAAInX,EAAEC,EAAEC,EAAEC,GACzB2U,EAAKwC,SAAW,GAAKpC,gBAAgBiC,EAAI,EAAE,GAC3CrC,EAAKiD,WAAa,IAAIxV,KAAKoV,UAAU3X,EAAEC,EAAEC,EAAEC,GAC3C2U,EAAKiD,WAAWH,KAAO,GAAKC,aAAa/C,EAAKwC,WAE/C,MAAMxC,EAAKrc,GACVqc,EAAK7G,MAAM,GAAKC,oBAAoBzV,EAAK4D,gBAE1C,MAAMyY,EAAKnb,GACVmb,EAAKkD,aAAY,EACjBlD,EAAKmD,MAAMlc,OAAOpC,IAEnB,KAAKmb,EAAKnb,GAAImb,EAAKoD,KAAKnc,OAAOpC,KAEhCwe,4BAA4B,CAC3B,OAAOrD,EAAKnb,GACXmb,EAAK5Z,OAAOa,OAAOpC,IAEpB,EAAEmb,EAAKnb,GAAImb,EAAK/T,EAAEhF,OAAOpC,IACzB,EAAEmb,EAAKnb,GAAImb,EAAK9U,EAAEjE,OAAOpC,IACzB,EAAEmb,EAAKnb,GAAImb,EAAK7U,EAAElE,OAAOpC,IACzB,KAAKmb,EAAKrc,GAAOqc,EAAKsD,KAAK,GAAK7B,mBAAmB9d,EAAK6d,gBACxD,MAAMxB,EAAK9U,EAAEC,GAAI6U,EAAK3G,MAAQ,IAAI,EAAQpS,OAAOiE,GAAGjE,OAAOkE,KAC3D,IAAI6U,EAAKnb,GAAImb,EAAKuD,IAAItc,OAAOpC,IAC7B,KAAKmb,EAAKwD,GAAOxD,EAAKyD,KAA2B,QAApBD,EAAKhC,eAClC,OAAOxB,EAAKwD,GAAOxD,EAAK0D,OAA6B,QAApBF,EAAKhC,eACtC,YAAYxB,EAAKnb,GAAImb,EAAK7I,YAAclQ,OAAOpC,IAC/C,MAAMmb,EAAKrc,GACVqc,EAAK7G,MAAM,GAAKC,oBAAoBzV,EAAK4D,gBAE1C,IAAIyY,EAAK9U,EAAEC,GACV6U,EAAK2D,IAAI,CAACzY,EAAEA,EAAEC,EAAEA,IAEjB,QAASG,KAAKsY,QAAQ1W,YACtB,KAAK8S,EAAKra,EAAM,SAASke,EAAU,EAAEC,EAAS,GAAKhN,YAClDkJ,EAAK4D,KAAK,CAACje,MAAMD,EAAUC,GAAO0H,WAAWwW,UAAU5c,OAAO4c,GAAWC,SAAS7c,OAAO6c,KAE1F,WAAW9D,EAAKra,EAAM,SAASke,EAAU,EAAEC,EAAS,GAAKhN,WAAWiN,EAAM,GAAKhN,aAC9EiJ,EAAKgE,WAAW,CAACre,MAAMD,EAAUC,GAAO0H,WAAWwW,UAAU5c,OAAO4c,GAAWC,SAAS7c,OAAO6c,GAAUC,MAAM9c,OAAO8c,KAEvH,gBAAgB/D,EAAK5X,EAAI,MAAO4X,EAAKiE,gBAAgBhd,OAAOmB,IAC5D,cAAc4X,EAAK5X,EAAI,MAAO4X,EAAKkE,cAAc9b,GACjD,YAAY4X,EAAKnb,EAAE,GAAImb,EAAKmE,YAAcld,OAAOpC,IACjD,YAAYmb,EAAK9U,EAAE,EAAEC,EAAE,GAAI6U,EAAKoE,YAAc,CAAClZ,GAAGA,EAAEC,GAAGA,IACvD,UAAU6U,EAAKnb,EAAE,GAAImb,EAAKqE,UAAYpd,OAAOpC,KAE9C2b,0BAA0B,CACzB,MAAMR,EAAKra,GACVqa,EAAKY,MAAM,CAACjb,MAAMD,EAAUC,GAAO0H,aAEpC,IAAI2S,EAAKra,EAAM+a,EAAKC,GACfX,EAAKS,MAAMT,EAAKS,IAAI,IACxB9a,EAAMD,EAAUC,GAAO0H,WAAYqT,EAAKzZ,OAAOyZ,GAAOC,EAAI1Z,OAAO0Z,GAC7D1Z,OAAOC,MAAMvB,KAASqa,EAAKS,IAAI9a,MAAMA,GACrCsB,OAAOC,MAAMwZ,KAAQV,EAAKS,IAAIC,KAAKA,GACnCzZ,OAAOC,MAAMyZ,KAAOX,EAAKS,IAAIE,IAAIA,IAEtC,IAAIX,EAAKnb,GAAGyG,KAAKgZ,UAAUtE,EAAKnb,IAChC,MAAMmb,EAAKnb,GAAGyG,KAAKiZ,YAAYvE,EAAKnb,IACpC,UAAUmb,EAAKnb,GAAImb,EAAKgB,UAAU/Z,OAAOpC,IACzC,YAAYmb,EAAKnb,GAAImb,EAAKe,YAAY9Z,OAAOpC,IAC7C,KAAKmb,EAAKnb,GAAIyG,KAAKkZ,WAAWxE,EAAKnb,IACnC,WAAWmb,EAAKnb,GAAImb,EAAKa,WAAW5Z,OAAOpC,IAC3C,OAAOmb,EAAKnb,GAAIyG,KAAKmZ,aAAazE,EAAKnb,IACvC,aAAamb,EAAKnb,GAAImb,EAAKc,aAAa7Z,OAAOpC,IAC/C,KAAKmb,EAAKzb,GAAO+G,KAAKoZ,WAAW1E,EAAKzb,IACtC,WAAWyb,EAAKzb,GAAOyb,EAAK9O,WAAW3M,GACvC,KAAKyb,EAAKwD,GAAOxD,EAAK2E,KAAO,EAAcnB,IAC3C,QAAQxD,EAAKqC,EAAInX,EAAEC,EAAE/E,EAAO,GAAK2P,gBAChCiK,EAAK4E,QAAU,GAAKxE,gBAAgBiC,EAAInX,EAAEC,GAC1C6U,EAAKhK,cAAgB5P,MAOxB,MAAMye,GAAmBC,WAAW9f,UAAU+f,UAC9CD,WAAW9f,UAAU+f,UAAY,WAChCF,GAAiB5X,MAAM3B,KAAK4B,WACzB5B,KAAKgQ,cACPhQ,KAAK0Z,qBAAoB,EACzB1Z,KAAKgQ,YAAY2J,mBAInB,MAAMC,GAAcJ,WAAW9f,UAAUmgB,WACzCL,WAAW9f,UAAUmgB,WAAa,WACjCD,GAAYjY,MAAM3B,KAAK4B,WACpB,GAAK2H,WACP,GAAKuQ,mBAAmB9Z,MAEzB,MAAM+Z,EAAQ/Z,KAAK+Z,QACnB,IAAIC,EAAS,GACb,GAAKrF,2BACJ,GAAKsF,sBAAsBF,EAAMzF,MACjC,GAAKyD,4BACLiC,GAEE,QAASA,GACXha,KAAKka,OACJ5e,EAAeye,EAAMna,EAAEoa,EAAO3B,IAAIzY,GAClCtE,EAAeye,EAAMla,EAAEma,EAAO3B,IAAIxY,IAGhCG,KAAKma,gBACRna,KAAKma,cAAc,IAEjB,SAAUH,IACZha,KAAKma,cAAcC,YAAYJ,EAAO1B,KAAKje,OAAO,GAClD2F,KAAKma,cAAcE,YAAYL,EAAO1B,KAAKje,OAAO,EAAE,IACpD2F,KAAKma,cAAcG,YAA8B,IAAlBN,EAAO1B,KAAKje,MAC3C2F,KAAKma,cAAcI,cAAcP,EAAO1B,KAAKC,UAC7CvY,KAAKma,cAAcK,aAAaR,EAAO1B,KAAKE,UAE1C,eAAgBwB,IAClBha,KAAKma,cAAcM,kBAAkBT,EAAOtB,WAAWre,OAAO,GAC9D2F,KAAKma,cAAcO,kBAAkBV,EAAOtB,WAAWre,OAAO,EAAE,IAChE2F,KAAKma,cAAcQ,kBAA0C,IAAxBX,EAAOtB,WAAWre,MACvD2F,KAAKma,cAAcS,oBAAoBZ,EAAOtB,WAAWH,UACzDvY,KAAKma,cAAcU,mBAAmBb,EAAOtB,WAAWF,SACxDxY,KAAKma,cAAcW,gBAAgBd,EAAOtB,WAAWD,OAEnD,oBAAqBuB,IACvBha,KAAKma,cAAcxB,gBAAgBhd,OAAOqe,EAAOrB,kBAE/C,kBAAmBqB,IACrBha,KAAKma,cAAcvB,cAAcoB,EAAOpB,eAEzC5Y,KAAK0Z,qBAAoB,GCpR1B,MAAMqB,GAAiBC,iBAAiBthB,UAAUuhB,cAClDD,iBAAiBthB,UAAUuhB,cAAgB,SAASC,EAASC,GAC5D,GAA6B,SAA1BD,EAAQhF,cACV,OAAO6E,GAAepZ,MAAM3B,KAAK4B,WAElC,MAAMwZ,EAAK,IAAI,GAAKC,cAKpB,GAJAD,EAAGE,YAAYtb,KACfob,EAAGG,aAAa,CAACL,KAAWC,GAAMK,KAAK,KACvCL,EAAKA,EAAKM,OAAO/a,GAAGA,GACpB0a,EAAGM,KAAKlV,SAASuT,MAAM/Z,KAAK2b,UACzBR,EAAK,GAAG,CACV,MAAMS,EAAYT,EAAK,GAAG,GACX,MAAZS,GAA6B,MAAZA,IACnBR,EAAGM,KAAON,EAAGS,YAAYV,EAAKW,UAIhC,MAAMC,EAAMZ,EAAKW,QAAQ5F,cACtB6F,KAAOX,GACTA,EAAGW,MAAQZ,IAKb,GAAKE,cAAc,MAClB,gBAAgB7gB,GACf,IAAI+T,EAAKvO,KAAKgc,MAAMxhB,EAAE,IACtB,OAAOA,EAAE,GAAG0b,eACX,IAAK,QAAqC,YAAxBlW,KAAKY,MAAOpG,EAAE,GAAG+T,GACnC,IAAK,MAAqC,YAAxBvO,KAAKc,IAAOtG,EAAE,GAAG+T,GACnC,IAAK,OACL,IAAK,WAAqC,YAAxBvO,KAAKic,KAAOzhB,EAAE,GAAG+T,GACnC,IAAK,SAAqC,YAAxBvO,KAAKlF,OAAON,EAAE,GAAG+T,GACnC,IAAK,OAAoC,YAAvBvO,KAAKoZ,WAAW5e,EAAE,IACpC,IAAK,SAAyC,YAA/BwF,KAAKkc,cAAc1hB,EAAE,GAAG+T,GACvC,IAAK,MAAiC,YAA1BvO,KAAKmc,IAAI3hB,EAAE,GAAGA,EAAE,GAAGA,EAAE,KAGnC,IAAIsC,EAAIyR,EAAK,GACZvO,KAAKoc,gBAAgB,GAAKtX,eAAehI,EAAIyR,GACxC,GAAK5J,eAAkB,GAAKM,gBAElC,MAAMnI,EAAIyR,EAAK,GAAIvO,KAAKoc,gBAAgB,GAAKhX,iBAAiBtI,EAAIyR,GAClE,KAAKhV,EAAEgV,EAAK,GAAIvO,KAAKoc,gBAAgB,GAAK/V,gBAAgB9M,EAAEgV,GAC5D,OAAOhV,EAAEgV,EAAK,GAAIvO,KAAKoc,gBAAgB,GAAKhN,kBAAkB7V,EAAEgV,GAChE,cAAcM,EAAON,GACpB,GAAKK,gBAAgB5O,KAAK6b,YAAYhN,GAASN,GAEhD,IAAI3O,EAAEC,EAAE0O,EAAK,GACZ7I,QAAQ2W,IAAIzc,EAAEC,EAAE0O,GAChBA,EAAKvO,KAAKgc,MAAMzN,GAChBvO,KAAKoc,gBAAgB,GAAK9V,UAAU1G,EAAE2O,GACtCvO,KAAKoc,gBAAgB,GAAK7V,UAAU1G,EAAE0O,GAGvC,aAAatV,GAAO,GAAKqjB,aAAarjB,EACtC,UAAUA,GAAO,GAAKsjB,UAAUtjB,EAEhC,SAAS2W,EAAQvU,EAAKtC,GACrBsC,EAAKA,EAAK6a,cACV,MAAM7c,EAAM,GAAGmjB,WAAWnhB,IACRtC,EAAR,QAAPsC,EAAqBohB,cAAc1jB,GAC1BuC,EAAe,GAAKiK,SAASlM,EAAI,GAAGN,GAChD,GAAKgN,SAAS1M,EAAIN,GAEnB,KAAKX,EAAEsI,GAAIV,KAAK0c,SAAS,OAAOtkB,EAAEsI,GAClC,KAAKtI,EAAEsI,GAAIV,KAAK0c,SAAS,OAAOtkB,EAAEsI,GAClC,QAAQtI,EAAEsI,GAAIV,KAAK0c,SAAS,UAAUtkB,EAAEsI,GACxC,WAAWzH,GAAO,GAAK2M,WAAW3M,EAClC,OAAOuB,GACN,IAAI+T,EAAKvO,KAAKgc,MAAMxhB,EAAE,IACtB,OAAOA,EAAE,GAAG0b,eACX,IAAK,QAAoC,YAA3BlW,KAAK2c,UAAUniB,EAAE,GAAG+T,GAClC,IAAK,OAAkC,YAA1BvO,KAAK4c,SAASpiB,EAAE,GAAG+T,GAChC,IAAK,MAAgC,YAAzBvO,KAAK6c,QAAQriB,EAAE,GAAG+T,GAC9B,IAAK,OAAQ,IAAK,WAIjB,OAHAA,EAAKvO,KAAKgc,MAAMxhB,EAAE,IAClBwF,KAAK4c,SAASpiB,EAAE,GAAG+T,QACnBvO,KAAK6c,QAAQriB,EAAE,GAAG+T,GAGpBA,EAAKvO,KAAKgc,MAAMxhB,EAAE,IAClBwF,KAAK2c,UAAUniB,EAAE,GAAG+T,GACpBvO,KAAK4c,SAASpiB,EAAE,GAAG+T,GACnBvO,KAAK6c,QAAQriB,EAAE,GAAG+T,GAEnB,UAAUlU,EAAMkU,GAAO,GAAKQ,cAAchK,SAAS3K,EAAUC,GAAO0H,WAAWwM,GAC/E,SAAShV,EAAEgV,GAAOvO,KAAKoc,gBAAgB,GAAKnN,aAAa1V,EAAEgV,GAC3D,QAAQhV,EAAEgV,GAAOvO,KAAKoc,gBAAgB,GAAKlN,YAAY3V,EAAEgV,GACzD,SAAS/T,GACR,IAAI+T,EAAKvO,KAAKgc,MAAMxhB,EAAE,IACtB,OAAOA,EAAE,GAAG0b,eACX,IAAK,QAA8C,YAAjClW,KAAK8c,YAAgBtiB,EAAE,GAAG+T,GAG7CA,EAAKvO,KAAKgc,MAAMxhB,EAAE,IAClBwF,KAAK8c,YAAYtiB,EAAE,GAAG+T,GAGvB,YAAYlU,EAAMkU,EAAK,GAAI,GAAKc,kBAAkBtK,SAAS3K,EAAUC,GAAO0H,WAAWwM,GAEvF,cAAc/T,GACb,MAAM8T,QAAatO,KAAK+c,WAAW/c,KAAK0b,MACxCpN,EAAK0O,YACL,IAAIzO,EAAKvO,KAAKgc,MAAMxhB,EAAE,IACtB,OAAOA,EAAE,GAAG0b,eACX,IAAK,QAAkD,YAArClW,KAAKid,WAAe3O,EAAK9T,EAAE,GAAG+T,GAChD,IAAK,YAAkD,YAArCvO,KAAKkd,eAAe5O,EAAK9T,EAAE,GAAG+T,GAChD,IAAK,OACL,IAAK,WAAkD,YAArCvO,KAAKmd,cAAe7O,EAAK9T,EAAE,GAAG+T,GAEjDA,EAAKvO,KAAKgc,MAAMxhB,EAAE,IAClBwF,KAAKid,WAAW3O,EAAK9T,EAAE,GAAG+T,GAC1BvO,KAAKkd,eAAe5O,EAAK9T,EAAE,GAAG+T,GAC9BvO,KAAKmd,cAAc7O,EAAK9T,EAAE,GAAG+T,GAE9B,WAAWD,EAAKjU,EAAMkU,EAAK,GAAID,EAAK8O,eAAerY,SAAS3K,EAAUC,GAAO0H,WAAWwM,GACxF,eAAeD,EAAK/U,EAAEgV,EAAK,GAAIvO,KAAKoc,gBAAgB9N,EAAK+O,mBAAmB9jB,EAAEgV,GAC9E,cAAcD,EAAK/U,EAAEgV,EAAK,GAAIvO,KAAKoc,gBAAgB9N,EAAKgP,kBAAkB/jB,EAAEgV,GAC5E,oBAAoB/T,GACnB,MAAM8T,QAAatO,KAAK+c,WAAW/c,KAAK0b,MACxCpN,EAAKiP,kBACL,IAAIhP,EAAKvO,KAAKgc,MAAMxhB,EAAE,IACtB,OAAOA,EAAE,GAAG0b,eACX,IAAK,QAAwD,YAA3ClW,KAAKwd,iBAAqBlP,EAAK9T,EAAE,GAAG+T,GACtD,IAAK,YAAwD,YAA3CvO,KAAKyd,qBAAqBnP,EAAK9T,EAAE,GAAG+T,GACtD,IAAK,OACL,IAAK,WAAwD,YAA3CvO,KAAK0d,oBAAqBpP,EAAK9T,EAAE,GAAG+T,GACtD,IAAK,QAAwD,YAA3CvO,KAAK2d,iBAAqBrP,EAAK9T,EAAE,GAAG+T,GACtD,IAAK,MAAwD,YAA3CvO,KAAK4d,eAAqBtP,EAAK9T,EAAE,GAAG+T,GACtD,IAAK,QAAwD,YAA3CvO,KAAK6d,iBAAqBvP,EAAK9T,EAAE,GAAG+T,GAEvDA,EAAKvO,KAAKgc,MAAMxhB,EAAE,IAClBwF,KAAKwd,iBAAiBlP,EAAK9T,EAAE,GAAG+T,GAChCvO,KAAKyd,qBAAqBnP,EAAK9T,EAAE,GAAG+T,GACpCvO,KAAK0d,oBAAoBpP,EAAK9T,EAAE,GAAG+T,GACnCvO,KAAK2d,iBAAiBrP,EAAK9T,EAAE,GAAG+T,GAEjC,iBAAiBD,EAAKjU,EAAMkU,GAAOD,EAAKwP,qBAAqB/Y,SAAS3K,EAAUC,GAAO0H,WAAWwM,GAClG,qBAAqBD,EAAK/U,EAAEgV,GAAOvO,KAAKoc,gBAAgB9N,EAAKyP,yBAAyBxkB,EAAEgV,GACxF,oBAAoBD,EAAK/U,EAAEgV,GAAOvO,KAAKoc,gBAAgB9N,EAAK0P,wBAAwBzkB,EAAEgV,GACtF,iBAAiBD,EAAK/U,EAAEgV,GAAOvO,KAAKoc,gBAAgB9N,EAAK2P,qBAAqB1kB,EAAEgV,GAChF,iBAAiBD,EAAK/U,EAAEgV,GAAOvO,KAAKoc,gBAAgB9N,EAAK4P,qBAAqB3kB,EAAEgV,GAChF,eAAeD,EAAKxN,EAAIyN,GAAOD,EAAK6P,oBAAoBrd,EACxD,gBAAgBsd,EAAQ7kB,EAAEgV,GAAO6P,EAAQrZ,SAASzJ,EAAe8iB,EAAQpZ,cAAczL,GAAGoC,OAAO4S,IACjG,MAAMA,GACL,MAAiB,iBAAPA,EAAyBA,GACnCA,EAAK5S,OAAO4S,GACT5S,OAAOC,MAAM2S,GAAe,EACxBA,GAER,aACC7I,QAAQC,KAAK,0BAA0B3F,KAAKub,+DAG7C,iBAAiBjN,GAChB,IAAIA,EAAO,OAAOtO,KAAKqe,aACvB,IAAIve,EAAE,EACN,MAAOwO,EAAK0B,aAEX,SADMsO,MAAM,OACPxe,EAAE,GAAK,OAAOE,KAAKqe,aAEzB,OAAO/P,EAAK0B,YAEb,YAAYnB,GACX,OAAO,GAAKC,WAAWD,EAAOrI,SAASuT,MAAM/Z,KAAKsb,YAAYK,UAAU3b,KAAK0b,QAI/E,GAAK5M,WAAW,SAASD,EAAO0P,EAAK,KAAK/Y,EAAO,MAChD,IAAIqJ,EAAS,OAAOrJ,EACpB,IAAItN,EAAE2W,EAAOqH,cAAc1B,MAAM,UACjC,MAAMvb,EAAKf,EAAEA,EAAE,GAAG,IAEZsmB,GADNtmB,EAAE2W,EAAO2F,MAAM,QACJ7Y,OAAOzD,EAAE,IAAI,EACxB,OAAOe,EAAK,IACX,IAAK,IAAK,OAAOslB,EACjB,IAAK,IAAK,OAAOpY,YACjB,IAAK,IACJ,OAAIqY,EACGhY,SAASuT,MAAMyE,GADND,EAEjB,IAAK,IACJ,OAAO/X,SAASoJ,QAAQ4O,GACzB,IAAK,IACJ,OAAOrY,YAAYsY,YAAYC,MAAMF,GAEvC,OAAOlQ,MAER,GAAKI,gBAAgB,SAASJ,GAC7B,OAAIA,aAAgBvF,YACZ,KAEJuF,aAAgBkL,WACZ,KAAKlL,EAAKqN,WAEdrN,aAAgBqQ,cACZ,KAAKxY,YAAYyY,WAAWF,MAAMG,QAAQvQ,KAE9CA,aAAgBwQ,aACZ,KAAKtY,SAASuY,UAAUF,QAAQvQ,UADxC,GCtMD9V,OAAOmR,OAAO,GAAK,CAElBvB,SAAS,KACT,aAIC,OAHGgJ,aAAanQ,QAAQmQ,aAAanQ,OAAO+d,aAC3Chf,KAAKoI,SAAWgJ,aAAanQ,OAAO+d,WAAW5W,UAEzCpI,KAAKoI,UAGbqP,aAAa+G,GACTS,QAAQC,WAAWV,GACdS,QAAQE,SAASX,GAAI,EACzBS,QAAQG,SAASZ,GAAI,EAAIS,QAAQI,SAASb,GAAI,EAAI,EAE9CS,QAAQK,SAASd,GAAI,EAAE,EAAEzhB,KAAKkK,MAAMuX,EAAG,KAIhDe,cAAc1K,GACNrO,SAASgZ,eAAe3K,IAAS,GAGzC,mBAAmBA,GAClB,MAAM4K,EAAQ,GAOR/K,EAAO1U,KAAKiU,sBAAsBjU,KAAK0f,oBAAoB7K,IAMjE,OALGH,IACE,UAAWA,IAAO+K,EAAQ5H,MAAMnD,EAAKmD,OACrC,gBAAiBnD,IAAO+K,EAAQ7H,YAAYlD,EAAKkD,aACjD,SAAUlD,IAAO+K,EAAQ3H,KAAKpD,EAAKoD,OAEjC2H,GAGR,cAAc5K,GAEb,IAAItH,EAAY7P,EACZgQ,EAAahQ,EACbyZ,EAAe,KACfwI,EAAe,KACnB,MAAMC,EAAQ5f,KAAK6f,aACb/O,EAAM,CACXmG,MAAM,KACND,OAAO,KACPE,SAAS,KACT4I,SAAS,KACTjJ,OAAO+I,GAASA,EAAQG,cAAclL,GAAQ7U,KAAKuK,cAAc,EACjEC,aAAa,GAERwV,EAAOhgB,KAAKuf,cAAc1K,GAChC,GAAGmL,GAAQA,KAAQhgB,KAAKqM,UAAU,CACjC,MAAM4T,EAAUjgB,KAAKqM,UAAU2T,GAC/BzS,EAAY0S,EAAQ1S,UACpBG,EAAauS,EAAQvS,WACrBoD,EAAIhW,OAAOmlB,EAAQnlB,OACnBgW,EAAItG,aAAayV,EAAQnlB,OACzBgW,EAAIjD,MAAMoS,EAAQpS,MAEnB,MAAM6G,EAAO1U,KAAKiU,sBAAsBjU,KAAK0f,oBAAoB7K,IAC9DH,IACCA,EAAKnH,YAAYA,EAAUmH,EAAKnH,WAChCmH,EAAKhH,aAAaA,EAAWgH,EAAKhH,YAClCgH,EAAKyC,eAAeA,EAAazC,EAAKyC,cACtCzC,EAAKiL,eAAeA,EAAajL,EAAKiL,cACtC,UAAWjL,IAAO5D,EAAImG,MAAMvC,EAAKuC,OACjC,WAAYvC,IAAO5D,EAAIkG,OAAOtC,EAAKsC,QACnC,aAActC,IAAO5D,EAAIoG,SAASxC,EAAKwC,UACvC,aAAcxC,IAAO5D,EAAIgP,SAASpL,EAAKoL,UACvCpL,EAAK4C,UAAUxG,EAAIwG,QAAQ5C,EAAK4C,SAChC5C,EAAKgD,WAAW5G,EAAI4G,SAAShD,EAAKgD,UAClChD,EAAKiD,aAAa7G,EAAI6G,WAAWjD,EAAKiD,YACtCjD,EAAKwL,aAAapP,EAAIoP,WAAWxL,EAAKwL,YACtC,UAAWxL,IAAO5D,EAAIjD,MAAM6G,EAAK7G,OACjC,WAAY6G,IAAO5D,EAAI+F,OAAOnC,EAAKmC,QACnC,WAAYnC,IACd5D,EAAIhW,OAAO4Z,EAAK5Z,OAChBgW,EAAItG,aAAekK,EAAK5Z,QAGzBgW,EAAIqP,cAActkB,QAAQ6Y,EAAKyC,cAAczC,EAAKiD,YAAa,aAAcjD,GAC7E5D,EAAIsP,cAAcvkB,QAAQ6Y,EAAKiL,cAAcjL,EAAKwL,YAAa,aAAcxL,IAE9E,MAAM2L,EAAYpB,QAAQC,WAAWrK,GAAQ,GAAG,EAehD,OAdc,MAAX/D,EAAImG,QAAcnG,EAAImG,MAAQpC,EAAOtH,EAAU3N,EAAEygB,EAAU9S,EAAU1N,EAAEwgB,EAAU,GACrE,MAAZvP,EAAIkG,SAAelG,EAAIkG,OAASnC,EAAOnH,EAAW9N,EAAEygB,EAAU3S,EAAW7N,EAAEwgB,EAAU,GACvE,MAAdvP,EAAIoG,WACNpG,EAAIoG,SAASpG,EAAIkG,OACdG,IACFrG,EAAIoG,SAASrC,EAAOsC,EAAavX,EAAEygB,EAAUlJ,EAAatX,EAAEwgB,EAAU,IAGvD,MAAdvP,EAAIgP,WACNhP,EAAIgP,SAAShP,EAAImG,MACd0I,IACF7O,EAAIgP,SAASjL,EAAO8K,EAAa/f,EAAEygB,EAAUV,EAAa9f,EAAEwgB,EAAU,IAGjEvP,GAGR,YAAYlR,EAAEC,GACb,IAAIoV,WAAaA,SAAS5Z,KAAO,MAAO,CAAC,EAAE,EAAE,EAAE,GAC/C,MAAMA,EAAO4Z,SAAS5Z,KAChBR,EAAQoa,SAASpa,MACjBC,EAASma,SAASna,OAOxB,GANG0L,SAASC,qBACX7G,EAAEA,EAAEgH,IAAI/L,IAEN2L,SAASK,mBACXhH,EAAEA,EAAE+G,IAAI9L,IAEN8E,EAAE,GAAGA,GAAG/E,GAAOgF,EAAE,GAAGA,GAAG/E,EAAS,MAAO,CAAC,EAAE,EAAE,EAAE,GACjD,MAAMwlB,EAAS,GACf,IAAK,IAAI3f,EAAE,EAAEA,EAAE,IAAIA,EAClB2f,EAAS3f,GAAKtF,GAAMsF,EAAI7F,EAAS+E,GAAKhF,EAAQ+E,IAAM,EAErD,OAAO0gB,GAIR,cAAc1gB,EAAEC,EAAE9H,EAAE,GACnB,IAAIkd,SAAW,OAAO,EAEnBzO,SAASC,qBAAqB7G,EAAEA,EAAEgH,IAAIqO,SAASpa,QAC/C2L,SAASK,mBAAmBhH,EAAEA,EAAE+G,IAAIqO,SAASna,SAEhD,MAAM+Z,EAAO7U,KAAKugB,YAAY3gB,EAAEC,GAAG9H,GACnC,GAAGiI,KAAKwgB,YAAY3L,GAAU,OAAO,EAErC,MAAM+K,EAAQ5f,KAAK6f,aACnB,GAAGD,GAASA,EAAQG,cAAclL,GAAU,OAAO,EAEnD,IAAI4L,EAAgB,EAEpB,MAAM/L,EAAO1U,KAAKiU,sBAAsBjU,KAAK0f,oBAAoB7K,IAC3D6L,EAASla,SAAS4G,SAASxN,EAAEC,GACnC,GAAO,IAAJ9H,GAAS2oB,GAAUA,KAAU,GAAKtU,YAAY,CAChD,IAAItR,EAASkF,KAAKoM,YAAYsU,GAAQ5lB,OAItC,OAHG4Z,GAAM,WAAYA,GAAMA,EAAK5Z,OAAO,IACtCA,GAAQ4Z,EAAK5Z,QAEPA,EAER,GAAG4Z,EAAK,CACP,GAAG,WAAYA,EACd,OAAOA,EAAK5Z,OAEVkF,KAAK2gB,eAAejM,EAAK7G,SAC3B4S,EAAc,GAGhB,MAAMT,EAAKhgB,KAAKuf,cAAc1K,GAC9B,OAAGmL,GAAQA,KAAQhgB,KAAKqM,UAChBrM,KAAKqM,UAAU2T,GAAMllB,OAE1BkF,KAAK4gB,WAAW/L,GACX7U,KAAKmK,YAEVyV,GAASA,EAAQiB,aAAahM,GACzB7U,KAAKqK,aAENoW,GAGR,eAAe7gB,EAAEC,EAAEihB,EAAQ,GAC1B,IAAIhmB,EAAO,EACX,IAAI,IAAI/C,EAAE,EAAGA,GAAG+oB,IAAW/oB,EAC1B+C,GAAQkF,KAAK+gB,cAAcnhB,EAAEC,EAAE9H,GAEhC,OAAO+C,GAGR,cAAc8E,EAAEC,GAEf,MAAMygB,EAAStgB,KAAKugB,YAAYxjB,KAAK8W,MAAMjU,GAAG7C,KAAK8W,MAAMhU,IACzD,IAAI/E,EAAO,EACPwC,EAAW,EACf,IAAI,IAAIvF,EAAE,EAAGA,GAAG,IAAKA,EAAE,CACtB,MAAM8c,EAAOyL,EAASvoB,GACtB,GAAGiI,KAAKwgB,YAAY3L,GAAU,SAC9B/Z,GAAUwC,EACVA,EAAa0C,KAAK+gB,cAAchkB,KAAK8W,MAAMjU,GAAG7C,KAAK8W,MAAMhU,GAAG9H,GAC5D,MACM8V,EADO7N,KAAKghB,cAAcnM,GACbhH,MACf7N,KAAK2gB,eAAe9S,KACvB/S,GAAQwC,EACRA,EAAW,GAGb,OAAOxC,GAIR,eAAe8E,EAAEC,GAChB,MAAMygB,EAAStgB,KAAKugB,YAAY3gB,EAAEC,GAClC,IAAIiX,EAAM,EACV,IAAI,IAAI/e,EAAE,EAAGA,GAAG,IAAKA,EAAE,CACtB,MAAM8c,EAAOyL,EAASvoB,GACtB,GAAGiI,KAAKwgB,YAAY3L,GAAU,SAC9B,MAAMH,EAAO1U,KAAKiU,sBAAsBjU,KAAK0f,oBAAoB7K,IAC9DH,GAAQ,UAAWA,IACrBoC,GAASpC,EAAKoC,OAGhB,OAAOA,GAGR,gBAAgBlX,EAAEC,EAAEihB,EAAQ,GAC3B,IAAIhmB,EAASkF,KAAKihB,eAAerhB,EAAEC,EAAEihB,EAAQ,GAC7C,MAAMjM,EAAO7U,KAAKugB,YAAY3gB,EAAEC,GAAGihB,GAC7BpM,EAAO1U,KAAKiU,sBAAsBjU,KAAK0f,oBAAoB7K,IACjE,OAAGH,GAAQ1U,KAAK6f,aAAaE,cAAclL,GACnC/Z,GAAU4Z,EAAKmC,QAAQ7W,KAAKuK,gBAAkBmK,EAAK5Z,QAAQ,GAE5D,GAGR,iBAAiB8E,EAAEC,EAAEihB,EAAQ,EAAEI,GAAW,GACzC,MAAMZ,EAAStgB,KAAKugB,YAAY3gB,EAAEC,GAClC,IAAI/E,EAAO,EACX,IAAI,IAAI/C,EAAE,EAAGA,GAAG+oB,IAAW/oB,EAAE,CAC5B,MAAM8c,EAAOyL,EAASvoB,GAChBsD,EAAO2E,KAAKghB,cAAcnM,GAC1BhH,EAAQxS,EAAKwS,MACnB,GAAG7N,KAAK2gB,eAAe9S,GACtB,OAAO/S,EAELomB,GAAY7lB,EAAKP,OAAO,IAC1BA,GAAQO,EAAKP,QAEdA,GAAQkF,KAAK+gB,cAAcnhB,EAAEC,EAAE9H,GAEhC,OAAO+C,GAGR,aAAa+Z,GACZ,MAAMsM,EAAQ,GACRvB,EAAQ5f,KAAK6f,aACbuB,EAAQxB,EAAQiB,aAAahM,GAInC,GAHA+K,EAAQyB,UAAU,CAACC,QAAQ,CAACC,EAAQC,EAAGC,EAAGC,EAAGC,EAAG9mB,EAAMC,EAAO8mB,EAAMC,KAClEV,EAAMW,KAAK,CAACtK,KAAK+J,EAAQ3hB,EAAE4hB,EAAG3hB,EAAE4hB,EAAG5mB,MAAMA,EAAMC,OAAOA,EAAO6L,GAAG+a,EAAG3a,GAAG4a,MACnE9M,EAAQ,EAAE,GACVuM,EAAS,IAAK,IAAItpB,EAAEqpB,EAAM1S,OAAO,EAAE3W,GAAG,IAAIA,EAC1CqpB,EAAMrpB,GAAGiP,GAAG5J,IAAW,IACzBgkB,EAAMrpB,EAAE,GAAG+H,GAAc,EAAX1C,IAAa,EAC3BgkB,EAAMY,OAAOjqB,EAAE,IAGjB,OAAOqpB,GAGRX,YAAY3L,IACHA,GAAiB,OAATA,EAGjB,WAAWA,GACV,MAAMmN,EAAO/C,QAAQgD,gBAAgBpN,GAC/BqN,EAAKnlB,KAAKkK,MAAM+a,EAAO,GACvBG,EAASlD,QAAQI,SAASxK,IAAWoK,QAAQmD,SAASvN,GAC5D,OAAIsN,GAAUD,EAAG,EAAW,EACrBC,GAGR,YAAYtN,GACX,OAAOhZ,QAAQmE,KAAK6f,aAAagB,aAAahM,KAG/C,aAAaA,GACZ,OAAOhZ,QAAQmE,KAAK6f,aAAaE,cAAclL,KAGhD,gBAAgBA,GACf,MAAMmN,EAAO/C,QAAQgD,gBAAgBpN,GACrC,OAAOoK,QAAQE,SAAStK,IAASmN,GAAM,GAAGA,EAAK,GAGhD,eAAenU,GACd,MAAMwU,EAAS,GAAKvU,oBACpB,OAAOD,IAAQwU,EAAO3L,OAAO7I,IAAQwU,EAAO1L,OAAO9I,IAAQwU,EAAOzL,QAGnE,gBAAgBG,EAAInX,EAAEC,GACrB,MAAMxG,EAAM,WAAW0d,EAAI9a,gBAC3B,IAAI4Y,EAASxb,KAAO4lB,QAAUA,QAAQ5lB,GAAO,EAC7C,MAAMgnB,EAAYpB,QAAQC,WAAWrK,GAAU,GAAK,EAEpD,OADAA,GAAUlZ,OAAOiE,GAAGygB,EAAY1kB,OAAOkE,GAAGwgB,EAAU,GAGrD,oBAAoBxL,GACnB,IAAIoK,QAAQC,WAAWrK,GAAU,OAAOA,EACxC,MAAMmN,EAAO/C,QAAQgD,gBAAgBpN,GACrC,OAAOoK,QAAQqD,WAAkB,GAALN,KCxS9B,MAAMO,GAAqB,IAAInkB,EAAM,EAAG,GAAIrB,KAAKylB,IAAI,GAAI,KAAM,GACzDC,GAAmB,IAAIrkB,EAAM,EAAE,GAAG,EAAE,GAEnC,MAAM,wBAAgBE,EAC5B,YAAYokB,EAAGC,GACd,MAAMtpB,EAAM,CAACqpB,EAAGC,GAAIC,WACpBC,MAAM,WAAWxpB,KAAO,GAAKkJ,OAC7BvC,KAAK4C,OAAO,GAAKc,IAEjB1D,KAAK0iB,GAAGA,EAAI1iB,KAAK2iB,GAAGA,EACpB3iB,KAAK2G,GAAG+b,EAAG,GAAK7X,UAAW7K,KAAK+G,GAAG4b,EAAG,GAAK9X,UAC3C7K,KAAKJ,EAAEI,KAAK2G,GAAI3G,KAAKH,EAAEG,KAAK+G,GAC5B/G,KAAK3G,IAAIA,EAIV,SACC,MAAMypB,EAAU,GAAKC,YAAY/iB,KAAK0iB,GAAG,IAAK,GAAK7X,WAAW7K,KAAK2iB,GAAG,IAAK,GAAK9X,WAChF7K,KAAKJ,EAAEkjB,EAAQljB,EAAE,GAAKiL,UAAU,EAChC7K,KAAKH,EAAEijB,EAAQjjB,EAAE,GAAKgL,UAAU,EAEjC,cAAchQ,EAAM,EAAEC,EAAO,EAAEkd,EAAKrZ,EAAUwjB,GAAO,GACpD,MAAM9oB,EAAM,GAAGwB,KAASC,KAAUkd,MAASmK,IAC3C,IAAIzgB,EAgBJ,OAfGrI,KAAO,gBAAQ2pB,UACjBthB,EAAK,gBAAQshB,UAAU3pB,GAAK4pB,SAE5BvhB,EAAOhD,EAAYwkB,YAAY,OAAO,CACrCC,gBAAiBnL,EACjBnd,MAAMA,EAAOC,OAAOA,EAEpBsoB,YAAajB,EAASM,GAAmBF,IACxC,GAAKhgB,OACP,gBAAQygB,UAAU3pB,GAAKqI,EACvB,GAAKa,MAAMT,WAAWJ,GACtBA,EAAKA,EAAKuhB,SAEXjjB,KAAKqjB,UAAUvB,KAAKpgB,GACpBA,EAAKkB,OAAO5C,KACL0B,EAER,WAAW7G,EAAM,EAAEC,EAAO,EAAEkd,EAAKrZ,EAAWwjB,GAAO,GAClD,MAAMzgB,EAAOhD,EAAYwkB,YAAY,OAAO,CAC3CC,gBAAiBnL,EACjBnd,MAAMA,EAAOC,OAAOA,EAEpBsoB,YAAajB,EAASM,GAAmBF,IACxC,GAAKhgB,OAGP,OAFAvC,KAAKqjB,UAAUvB,KAAKpgB,GACpBA,EAAKkB,OAAO5C,KACL0B,EAER,aACC,MAAM2gB,EAAS,GAAKvU,oBACpB9N,KAAKqjB,UAAU,GAEf,MAAMC,EAAYvmB,KAAKsI,IAAI,GAAKwF,UAAUrE,SAAS3L,QAAQmF,KAAK0iB,GAAG,GAAK7X,WAClE0Y,EAAaxmB,KAAKsI,IAAI,GAAKwF,UAAUrE,SAAS1L,SAASkF,KAAK2iB,GAAG,GAAK9X,WAC1E,IAAK,IAAIhL,EAAE,EAAGA,EAAE0jB,IAAc1jB,EAC9B,IAAK,IAAID,EAAE,EAAGA,EAAE0jB,IAAa1jB,EAAE,CAC9B,IAAI4jB,EAAW,EACf,MAAMlD,EAAW,GAAKC,YAAYvgB,KAAK2G,GAAG/G,EAAEI,KAAK+G,GAAGlH,GACpD,IAAK,IAAI9H,EAAE,EAAGA,EAAE,IAAKA,EAAE,CACtB,IAAI4I,EAAI,GAAKsgB,eAAejhB,KAAK2G,GAAG/G,EAAEI,KAAK+G,GAAGlH,EAAE9H,GAChD,MAAM0rB,EAAW,GAAKzC,cAAcV,EAASvoB,IACvC8V,EAAQ4V,EAAS5V,MACvB4V,EAASC,OAASpD,EAASvoB,GAI3B,MAAMqS,EAAa,GAAK2W,cAAc/gB,KAAK2G,GAAG/G,EAAEI,KAAK+G,GAAGlH,EAAE9H,IAAI0rB,EAAS3oB,QAAQ,EAC/E6F,GAAG8iB,EAAS5M,OACT,GAAK8M,aAAarD,EAASvoB,MAAM4I,GAAG8iB,EAASjZ,cAC5CqD,GAAOA,IAAQwU,EAAO9L,KAanBiN,EAAS,GAZfxjB,KAAK4jB,SAASH,EAAS7jB,EAAEC,EAAEc,EAAE5I,GAE1B0rB,EAASrD,eAAeqD,EAAS3oB,OAAO,IAAI/C,EAAE,GAAG0rB,EAAS5M,QAI1DzM,GACFpK,KAAK6jB,UAAUJ,EAAS7jB,EAAEC,EAAEc,EAAE5I,EAAEqS,EAAaoZ,EAAS,GAAK7Y,YAC3D6Y,EAAS,KAEPA,GAGD3V,IAAQwU,EAAO3L,MACjB1W,KAAK8jB,UAAUL,EAAS7jB,EAAEC,EAAEc,EAAE5I,EAAEqS,GACxByD,IAAQwU,EAAO1L,OAAO9I,IAAQwU,EAAOzL,QAC7C5W,KAAK+jB,UAAUN,EAAS7jB,EAAEC,EAAEc,EAAE5I,EAAEqS,GAIlC,SADM/N,KACF,GAAKkN,UAA8B,YAAlBvJ,KAAKgkB,YAGxBhkB,KAAKqjB,UAAU5U,QACjBzO,KAAKqjB,UAAUY,QAAQviB,GAAMA,EAAKkB,OAAO,MACzC5C,KAAK0B,KAAKjD,EAAKylB,YAAYlkB,KAAKqjB,WAAU,OAAK5iB,OAAUA,GAAU,GAAM,KAEzEiF,QAAQC,KAAK,iCACb3F,KAAK0B,KAAO,IAAIjD,EAAK,aAAa,GAAK8D,QAExCvC,KAAK0B,KAAKkB,OAAO5C,YACVA,KAAKqjB,UAEb,YAEC,GADA3d,QAAQC,KAAK,iCAAiC3F,KAAK0iB,MAAM1iB,KAAK2iB,yBAC3D3iB,KAAKqjB,UAAU,CACjB,IAAK,MAAM3hB,KAAQ1B,KAAKqjB,UACvB3hB,EAAKyiB,UAENnkB,KAAKqjB,UAAU5U,OAAO,GAIxB,SAASgV,EAAS7jB,EAAEC,EAAEc,EAAE5I,EAAEuhB,GAAQ,GACjC,MAAMzE,EAASyE,EAAQmK,EAAS3D,SAAS2D,EAASxM,MAC5CmN,EAAa9K,EAAQmK,EAASnM,QAAQmM,EAASvD,WAC/ChB,EAAaD,QAAQC,WAAWrK,GAChC2C,EAAO,GAAKC,aAAa5C,GAC/B,IAAIsM,EAEHA,EADEiD,EACI,CAACA,GAEC,GAAKC,aAAaxP,GAE3B,IAAK,MAAMyP,KAAQnD,EAAM,CACxB,MAAMzf,EAAO1B,KAAKukB,cAAc,EAAErF,EAAW,EAAE,EAAEA,EAAW,EAAE5F,EAAQ1a,EAASD,GAC/E+C,EAAK8iB,SAAW,GAAKC,sBAAsBjN,EAAK8M,EAAK1kB,EAAE0kB,EAAKzkB,EAAEykB,EAAKzpB,MAAMypB,EAAKxpB,OAAQ,GAAK4pB,mBAAmB7P,IAC9GnT,EAAK9B,EAAIA,GAAa,EAAR0kB,EAAK3d,IAAMxJ,IAAa,IAAK+hB,EAC3Cxd,EAAK7B,EAAIA,GAAa,EAARykB,EAAKvd,IAAM5J,IAAa,IAAK+hB,EAC3Cxd,EAAKf,EAAIA,EAAI5I,EAAE,GAAK4S,YAGtB,UAAU8Y,EAAS7jB,EAAEC,EAAEc,EAAE5I,EAAEqS,GAC1B,MAAMua,EAAiBva,EACjBwa,EAAW,GAAKjB,aAAaF,EAASC,QAC5C,IAAK,IAAImB,EAAG,EAAGA,EAAG,gBAAQC,kBAAkBrW,SAAUoW,EAAG,CACxD,MAAME,EAAK,gBAAQD,kBAAkBD,GAErC,IAAK,GAAKG,aAAa,QAAO,MAC1BhlB,KAAK2G,GAAG/G,EAAEmlB,EAAGnlB,GAAGqV,SAASpa,OAAOmF,KAAK2G,GAAG/G,EAAEmlB,EAAGnlB,EAAE,KAAK4G,SAASC,qBAC9DzG,KAAK+G,GAAGlH,EAAEklB,EAAGllB,GAAGoV,SAASna,QAAQkF,KAAK+G,GAAGlH,EAAEklB,EAAGllB,EAAE,KAAK2G,SAASK,kBAChE,SAGAuD,EADEqZ,EAAS3oB,OAAO,GAAK6F,EAAE,GAAKsgB,eAAejhB,KAAK2G,GAAG/G,EAAEmlB,EAAGnlB,EAAEI,KAAK+G,GAAGlH,EAAEklB,EAAGllB,EAAE9H,GAChE0rB,EAAS3oB,OAET6pB,EAEZ,IACIP,EADAvP,EAAO4O,EAASzM,OAEjB5M,EAAW,GAAKqZ,EAAStD,eAC3BtL,EAAO4O,EAASvM,SACbuM,EAAS9L,aAAayM,EAAaX,EAAS9L,aAE5C8L,EAAS/L,WAAW0M,EAAaX,EAAS/L,UAE9C,MAAMF,EAAO,GAAKC,aAAa5C,GAE/B,IAAIoQ,EAAa7a,EACjB,GAAGwa,EAAS,CAEX,GADuB,GAAKM,gBAAgBllB,KAAK2G,GAAG/G,EAAEmlB,EAAGnlB,EAAEI,KAAK+G,GAAGlH,EAAEklB,EAAGllB,EAAE9H,KACtD4I,EAAI,aACpB,CACJ,MAAMwkB,EAAiB,GAAKC,iBAAiBplB,KAAK2G,GAAG/G,EAAEmlB,EAAGnlB,EAAEI,KAAK+G,GAAGlH,EAAEklB,EAAGllB,EAAE9H,IAAI0rB,EAAS3oB,OAAO,IAC/F,GAAGsP,EAAW,GAAG+a,GAAgBxkB,GAC/ByJ,EAAW,GAAG+a,GAAgBxkB,EAAI,SACpCskB,EAAeloB,KAAKsI,IAAItI,KAAK0T,IAAIrG,GAAarN,KAAK0T,IAAI9P,EAAEwkB,IAAiBpoB,KAAK2T,KAAKtG,GAErF,MAAMib,EAAU,IAAI,EAASzlB,EAAEmlB,EAAGnlB,EAAE,EAAGC,EAAEklB,EAAGllB,EAAE,EAAGc,GAC3CsX,EAAMlb,KAAKuoB,MAAMP,EAAGnlB,EAAGmlB,EAAGllB,GAChC,GAAGukB,IAAenF,QAAQC,WAAWrK,GAAQ,CAC5C,MAAMyP,EAAOF,GAA0B,GAAKC,aAAaxP,GAAQ,GAC3DnT,EAAO1B,KAAKukB,cAAc,EAAEU,EAAatmB,GAAU,GACtDsmB,EAAa,IAAIvjB,EAAK6jB,QAAQ1lB,IAAI,GACrC6B,EAAK8iB,SAAW,GAAKC,sBAAsBjN,EAAK8M,EAAK1kB,EAAE0kB,EAAKzkB,EAAEykB,EAAKzpB,MAAMypB,EAAKxpB,OAAQ,GAAK4pB,mBAAmB7P,IAE9GnT,EAAK8jB,OAAOhoB,GAAOya,EAAI5Y,GACvBqC,EAAK9B,EAAEylB,EAAQzlB,EACf8B,EAAK7B,EAAEwlB,EAAQxlB,EACf6B,EAAKf,EAAGA,EAAIskB,EAAa,MACrB,CACJ,MAAMQ,EAAI,gBAAQX,oBAAoBD,EAAG,GAAGje,IAAI,IAC1C8e,EAAI,gBAAQZ,oBAAoBD,EAAG,GAAGje,IAAI,IAC1C+e,EAAa,GAAK1E,eAAejhB,KAAK2G,GAAG/G,EAAE6lB,EAAI7lB,EAAEI,KAAK+G,GAAGlH,EAAE4lB,EAAI5lB,EAAE9H,GACjE6tB,EAAc,GAAK3E,eAAejhB,KAAK2G,GAAG/G,EAAE8lB,EAAI9lB,EAAEI,KAAK+G,GAAGlH,EAAE6lB,EAAI7lB,EAAE9H,IACjE6H,EAAEimB,EAAGhmB,EAAEimB,GAAM9lB,KAAK+lB,kBAAkBlR,EAAO4O,EAASC,QAC3D,IAAIsC,EAAUjpB,KAAK0T,IAAI1T,KAAK8W,MAAmB,EAAboR,IAC9BgB,EAAWlpB,KAAK0T,IAAIwU,EAAae,GACjCE,EAAK/oB,IAAW,EAChBgpB,EAAKhpB,IAAW,EACjB,GAAKipB,YAAY3C,EAASC,UAC5ByC,EAAGhpB,IAAW,EACd6oB,EAAU,EACVC,EAAW7b,GAGZ,IAAK,IAAIic,GAAI,EAAGA,GAAI,EAAGA,GAAI,EAC1B,IAAI,IAAIC,EAAG,EAAEA,EAAGN,IAAYM,EAAG,CAC9B,IAAIC,EAAYC,EAQZhF,EAAGC,EAPJ,GAAK2E,YAAY3C,EAASC,SAC5B6C,EAAcZ,GAAYhlB,EAC1B6lB,EAAeZ,GAAajlB,IAE5B4lB,EAAcZ,EAAWhlB,EAAE2lB,EAAGL,EAC9BO,EAAeZ,EAAYjlB,EAAE2lB,EAAGL,GAGjCzE,EAAGqE,EAAG1oB,IACNskB,EAAGqE,EAAG3oB,IACNqkB,GAAIqE,GAAIQ,EAAG,EAAE,GAAIG,EAAa,EAAED,IAAcppB,IAC3C8nB,EAAa,IACfzD,GAAIqE,GAAIQ,EAAG,EAAE,EAAEE,EAAY,IAAIC,IAAerpB,KAG9CskB,EADE,GAAKgF,gBAAgB5R,IACnBiR,EAAGQ,EAAG,EAAE,GAAGnpB,IACP,GAAKipB,YAAYvR,IACrBiR,EAAG,EAAE,GAAG3oB,KAER2oB,GAAS,IAALQ,EAAO,EAAEA,IAAKN,EAAU,EAAE,IAAI,EAAEM,EAAG,EAAE,KAAMnpB,IAEpD,MAAMuE,EAAO1B,KAAKukB,cAAc,GAAI0B,EAAWtnB,GAAU,GAEzD+C,EAAK8jB,OAAOhoB,GAAOya,EAAI5Y,GACvBqC,EAAK9B,EAAEylB,EAAQzlB,EACf8B,EAAK7B,EAAEwlB,EAAQxlB,EACf6B,EAAKf,EAAGA,EAAIslB,EAAW,EAAIA,EAAWK,EAAKvuB,EAAE,GAAK4S,WAClDjJ,EAAKuO,UAAU1S,EAAM,IAAK8oB,EAAG7mB,IAC7BkC,EAAK8iB,SAAW,GAAKC,sBAAsBjN,EAAKgK,EAAGC,EAAGyE,EAAGC,EAAI,GAAKzB,mBAAmB7P,OAM1F,UAAU4O,EAAS7jB,EAAEC,EAAEc,EAAE5I,EAAEqS,GAC1B,MAAMyK,EAAS4O,EAASzM,OAClBoN,EAAaX,EAAS/L,SACtBF,EAAO,GAAKC,aAAa5C,GACzBqK,EAAaD,QAAQC,WAAWrK,GAChC6R,EAAQ,GACd,IAAK,IAAI7B,EAAG,EAAGA,EAAG,gBAAQC,kBAAkBrW,SAAUoW,EAAG,CACxD,MAAME,EAAK,gBAAQD,kBAAkBD,GACd,GAAK9D,cAAc/gB,KAAK2G,GAAG/G,EAAEmlB,EAAGnlB,EAAEI,KAAK+G,GAAGlH,EAAEklB,EAAGllB,EAAE9H,KACpDqS,GAAasc,EAAM5E,KAAK+C,GAE7C,IAAK,IAAIA,EAAG,EAAGA,EAAG,gBAAQC,kBAAkBrW,SAAUoW,EAAG,CACxD,MAAME,EAAK,gBAAQD,kBAAkBD,GAE/BxL,EAAOqN,EAAMvqB,SAAS0oB,GAC5B,GAAGxL,GAAMqN,EAAMjY,OAAO,IAAIyQ,EAAa,SAEvC,MAAMyH,EAAY5B,EAAGnlB,EAAE,GAAGmlB,EAAGllB,EAAE,EAC/B,IAAIoY,EAAMlb,KAAKuoB,MAAMP,EAAGnlB,EAAGmlB,EAAGllB,GAAG9C,KAAKC,GAAG,EAKzC,GAJG2pB,IACF1O,GAAKlb,KAAKC,IAGRkiB,IAAakF,EAAW,CAC1B,MAAOxkB,EAAEimB,EAAGhmB,EAAEimB,GAAM9lB,KAAK+lB,kBAAkBlR,EAAO4O,EAASC,QAC3D,IAAK,IAAI4C,EAAG,EAAEA,GAAI,IAAIA,EAAG,CACxB,MAAM5kB,EAAO1B,KAAKukB,cAAc,GAAIna,EAAW,EAAEvL,GAAW,GAE5D6C,EAAK8jB,OAAOhoB,GAAOya,EAAI5Y,GACvBqC,EAAK8iB,SAAW,GAAKC,sBAAsBjN,GACzC6B,EAAQwM,EAAa,IAAVc,EAAkBd,EAAG,EAAY,GAAVc,GAAiBvpB,KACnD0oB,EAAM,IAAHQ,GAAQ,IACZlpB,IAAY,EACZ,IAAa,EACb,GAAKsnB,mBAAmB7P,IACzBnT,EAAK9B,EAAEA,EAAEmlB,EAAGnlB,EAAE,EACd8B,EAAK7B,EAAEA,EAAEklB,EAAGllB,EAAE,EACd6B,EAAKf,EAAEA,EAAEyJ,EAAW,EAAEkc,EAAGlc,EAAW,OAEjC,CACJ,MAAMka,EAAOF,GAA0B,GAAKC,aAAaxP,GAAQ,GAC3DnT,EAAO1B,KAAKukB,cAAc,GAAIna,EAAWvL,GAAW,GAE1D6C,EAAK8jB,OAAOhoB,GAAOya,EAAI5Y,GACvBqC,EAAK8iB,SAAW,GAAKC,sBAAsBjN,EAC1C8M,EAAK1kB,EAAE0kB,EAAKzpB,MAAM,EAAE8rB,EACpBrC,EAAKzkB,EACLykB,EAAKzpB,MAAM,EACXypB,EAAKxpB,OACL,GAAK4pB,mBAAmB7P,IACxBnT,EAAK9B,EAAEA,EAAEmlB,EAAGnlB,EAAE,EACd8B,EAAK7B,EAAEA,EAAEklB,EAAGllB,EAAE,EACd6B,EAAKf,EAAEA,EAAEyJ,EAAW,IAIxB,UAAUqZ,EAAS7jB,EAAEC,EAAEc,EAAE5I,EAAEqS,GAC1B,MAAMyK,EAAS4O,EAASzM,OAClBoN,EAAaX,EAAS/L,SACtBF,EAAO,GAAKC,aAAa5C,GACzBqK,EAAaD,QAAQC,WAAWrK,GACtC,IAAIsM,EAEHA,EADEiD,EACI,CAACA,GAEC,GAAKC,aAAaxP,GAE3B,MAAMoD,EAAMwL,EAAS5V,QAAQ,GAAKC,oBAAoB8I,OAAS7Z,KAAKC,GAAG,EAAI,EACrEipB,EAAa/G,EAAa9U,EAAW,EAAIA,EAC/C,IAAK,IAAItS,EAAE,EAAGA,GAAG,IAAKA,EACrB,IAAK,MAAMwsB,KAAQnD,EAAM,CACxB,MAAMzf,EAAO1B,KAAKukB,cAAc,EAAErF,EAAW,EAAE+G,EAAWpnB,GAAW,GACrE6C,EAAK9B,EAAIA,EACT8B,EAAK7B,EAAIA,EACT6B,EAAKf,EAAIA,GAAa,EAAR2jB,EAAKvd,IAAM,IAAaqD,EAAa6b,EAAW,EAC9DvkB,EAAK8jB,OAAOhoB,GAAOT,KAAKC,GAAG,EAAElF,EAAEmgB,EAAI5Y,GACnCqC,EAAKuO,UAAU1S,GAAO,IAAK2hB,GAAoB,EAARoF,EAAK3d,IAAMvJ,IAAYoC,IAC9DkC,EAAK8iB,SAAW,GAAKC,sBAAsBjN,EAAK8M,EAAK1kB,EAAE0kB,EAAKzkB,EAAEykB,EAAKzpB,MAAMypB,EAAKxpB,OAAQ,GAAK4pB,mBAAmB7P,KAIjH,kBAAkBA,EAAO6O,EAAO7O,GAC/B,MAAMmN,EAAO/C,QAAQgD,gBAAgBpN,GACrC,IAAI+R,EAAK5E,EAAK,EACVE,EAAKnlB,KAAKkK,MAAM+a,EAAO,GAE3B,IAAI6D,EAAGC,EAkBP,OAnBGjR,IAAS6O,GAAmC,GAAzB,GAAK9C,WAAW/L,MAAeqN,EAErD2D,EAAM,EAAHe,EACHd,EAAG5D,EACAjD,QAAQE,SAAStK,GAChBmN,EAAK,GACP8D,EAAM9D,EAAK,EAAR,EAAW,EACd6D,EAAG,EAAE9oB,KAAKkK,MAAM+a,EAAK,KAErB6D,EAAG,EAAE9oB,KAAKkK,MAAM2f,EAAG,GAAM5E,EAAK,EAAG,EACjC8D,EAAM,EAAH5D,EAA0B,EAAnBnlB,KAAKkK,MAAM2f,EAAG,EAAE,GAAO,EAAGA,EAAG,GAEhC3H,QAAQG,SAASvK,GACzBiR,EAAU,GAAN5D,EAAG,GAAK,EACHjD,QAAQI,SAASxK,GAC1BiR,EAAU,GAAN5D,EAAG,GACEjD,QAAQmD,SAASvN,KAC1BiR,EAAW,KAAP5D,EAAG,KAASA,EAAG,EAAE,GAAI,IAEnB,CAACtiB,EAAEimB,EAAGhmB,EAAEimB,IAGjB,gBAAQhB,kBAAoB,CAC3B,IAAI,EAAS,EAAG,GAChB,IAAI,EAAS,EAAG,GAChB,IAAI,EAAS,GAAG,GAChB,IAAI,GAAS,EAAG,IAEjB,gBAAQ9B,UAAU,GC7VlBxqB,OAAOmR,OAAO,GAAK,CAEfJ,WAAW,EACd,WACCvJ,KAAKuJ,WAAU,EAEf,IAAK,MAAMlQ,KAAO2G,KAAK6mB,aACtB7mB,KAAK6mB,aAAaxtB,GAAK8qB,UAExB,IAAK,MAAM9qB,KAAO2G,KAAK8mB,cACtB9mB,KAAK8mB,cAAcztB,GAAK8qB,UAEzBnkB,KAAK+mB,iBAAiBtY,OAAO,EAC7BzO,KAAK6mB,aAAa,GAClB7mB,KAAK8mB,cAAc,GAEnB,IAAK,MAAMztB,KAAO2G,KAAK2D,MACtB3D,KAAK2D,MAAMtK,GAAK8qB,SAAQ,GAAM,GAE/BnkB,KAAK2D,MAAM,GACX,IAAK,MAAM2K,KAAQtO,KAAK4D,WACvB0K,EAAK6V,SAAQ,GAAM,GAEpBnkB,KAAK4D,WAAW6K,OAAO,GAGxB,UACCzO,KAAKgnB,kBAGLhnB,KAAKwE,iBACLxE,KAAKsE,YACLtE,KAAKinB,oBAGN,kBACC,GAAGjnB,KAAKqE,YAAc,OACtBrE,KAAKuJ,WAAU,EACfvJ,KAAKqE,aAAY,EAGjB,MAAM6iB,EAAS,CACdrV,KAAK9U,KAAKkK,OAAOjH,KAAK0C,YAAY9C,EAAEI,KAAKuD,aAAavD,KAAK6K,WAC3DkH,MAAMhV,KAAKkK,OAAOjH,KAAK0C,YAAY9C,EAAEI,KAAKuD,aAAavD,KAAK6K,WAC5Dsc,IAAIpqB,KAAKkK,OAAOjH,KAAK0C,YAAY7C,EAAEG,KAAKuD,aAAavD,KAAK6K,WAC1Duc,OAAOrqB,KAAKkK,OAAOjH,KAAK0C,YAAY7C,EAAEG,KAAKuD,aAAavD,KAAK6K,YAG1DrE,SAASC,qBACZygB,EAAOrV,KAAK9U,KAAKuI,IAAI,EAAE4hB,EAAOrV,MAC9BqV,EAAOnV,MAAMhV,KAAKsI,IAAI6hB,EAAOnV,MAAMhV,KAAKkK,MAAMT,SAAS3L,QAAQ,GAAKgQ,aAEjErE,SAASK,mBACZqgB,EAAOC,IAAIpqB,KAAKuI,IAAI,EAAE4hB,EAAOC,KAC7BD,EAAOE,OAAOrqB,KAAKsI,IAAI6hB,EAAOE,OAAOrqB,KAAKkK,MAAMT,SAAS1L,SAAS,GAAK+P,aAExE,MAAMwc,EAAY,GAClB,IAAK,IAAIC,EAAGJ,EAAOrV,KAAKyV,GAAIJ,EAAOnV,QAAQuV,EAC3C,IAAK,IAAIC,EAAGL,EAAOC,IAAII,GAAIL,EAAOE,SAASG,EAAG,CAC7C,IAAI7E,EAAG4E,EAAI3E,EAAG4E,EACX/gB,SAASC,qBAAqBic,EAAKA,EAAG9b,IAAI7J,KAAKyqB,KAAKhhB,SAAS3L,QAAQ,GAAKgQ,aAC1ErE,SAASK,mBAAmB8b,EAAKA,EAAG/b,IAAI7J,KAAKyqB,KAAKhhB,SAAS1L,SAAS,GAAK+P,aAC5Ewc,EAAYvF,KAAK,IAAI,EAAQY,EAAGC,IAEjC,MAAM8E,EAAgB,IAAI,EAAQ1qB,KAAK8W,MAAM7T,KAAK0C,YAAY9C,EAAEI,KAAK6K,UAAU,IAAK9N,KAAK8W,MAAM7T,KAAK0C,YAAY7C,EAAEG,KAAK6K,UAAU,KACjIwc,EAAY9lB,KAAK,CAAC/G,EAAED,IAAI,EAAQmtB,gBAAgBltB,EAAEitB,GAAe,EAAQC,gBAAgBntB,EAAEktB,IAC3F,IAAK,MAAME,KAAWN,EAAY,CACjC,IAAKznB,EAAE8iB,EAAG7iB,EAAE8iB,GAAMgF,EAGlB,SAFM3nB,KAAK4nB,YAAYlF,EAAGC,SACpBtmB,KACF2D,KAAKuJ,UAAoC,YAAxBvJ,KAAKqE,aAAY,GAEvCrE,KAAKqE,aAAY,GAGlB,kBAAkBqe,EAAGC,GACpB,MAAMtpB,EAAM,CAACqpB,EAAGC,GAAIC,WACpB,GAAGvpB,KAAO2G,KAAK2D,MAAQ,OACvB,MAAMkkB,EAAO,IAAI,gBAAQnF,EAAGC,GAC5B3iB,KAAK2D,MAAMtK,GAAKwuB,QACVA,EAAKC,UCjFbtvB,OAAOmR,OAAO,GAAK,CAElBod,iBAAiB,GACjBF,aAAa,GACbC,cAAc,GAEd,qBAAqBtP,EAAK5X,EAAEC,EAAEC,EAAEC,GAC/B,MAAM1G,EAAM,GAAGme,KAAQ5X,KAAKC,KAAKC,KAAKC,IACtC,GAAG1G,KAAO2G,KAAK6mB,aACd,OAAO7mB,KAAK6mB,aAAaxtB,GAE1B,MAAM0uB,EAASvhB,SAAS6N,UAAU2T,aAAaxQ,GAC/C,IAAIuQ,EACH,OAAO/nB,KAAKioB,kBAEb,MACM/lB,EAAU,IAAI3D,EADH,gBAAgBwpB,QACM/nB,KAAKuC,OAqB5C,OApBAL,EAAQgmB,UAAS,EACjBhmB,EAAQimB,iBAAiBC,QAAQ,KAChC,GAAGpoB,KAAK6mB,aAAaxtB,KAAO6I,IAC5BA,EAAQvC,KAAKC,EAAEC,EAAEC,EAAEC,GACnBmC,EAAQmmB,mBAAmB,GAGjB,IAAP7Q,GAAS,CACX,MAAMoP,EAAKhnB,EAAExC,IACP8kB,EAAKriB,EAAE,IACb,GAAG+mB,EAAG,GAAGA,GAAI,GAAG1E,GAAI,EAAE,CACrB,MAAMoG,EAAc1B,GAAI,GAAGA,EAAG,GAAGA,GAAI,GACrC1kB,EAAQ0f,MAAQ0G,EAAc,EAAI,EAClCpmB,EAAQ2f,MAAQyG,EAAc,EAAI,EAClCpmB,EAAQqmB,UAAU,CAAC3oB,EAAEA,EAAEC,EAAEA,EAAEC,EAAEA,EAAEC,EAAEA,GACjCC,KAAK+mB,iBAAiBjF,KAAK5f,OAI9BlC,KAAK6mB,aAAaxtB,GAAK6I,EAChBA,GAGR,kBACC,OAAGlC,KAAKwoB,aAAsBxoB,KAAKwoB,cACnCxoB,KAAKwoB,aAAe,IAAIjqB,EAAQ,wBAAwByB,KAAKuC,OACtDvC,KAAKwoB,eAGb,sBACC,OAAGxoB,KAAKyoB,iBAA0BzoB,KAAKyoB,kBACvCzoB,KAAKyoB,iBAAmB,IAAIlqB,EAAQ,qBAAqByB,KAAKuC,OAC9DvC,KAAKyoB,iBAAiBC,iBAAgB,EAC/B1oB,KAAKyoB,mBAGb,sBAAsBjR,EAAK5X,EAAEC,EAAEC,EAAEC,EAAE0f,EAAQ,IAC1Czf,KAAK2oB,uBAAuBlJ,GAC5B,MAAMpmB,EAAM,GAAGme,KAAQ5X,KAAKC,KAAKC,KAAKC,KAAKC,KAAK4oB,YAAYnJ,KAC5D,GAAGpmB,KAAO2G,KAAK8mB,cACd,OAAO9mB,KAAK8mB,cAAcztB,GAE3B,MAAM6I,EAAUlC,KAAK6oB,qBAAqBrR,EAAK5X,EAAEC,EAAEC,EAAEC,GAC/CykB,EAAW,IAAIhmB,EAAiBnF,EAAK2G,KAAKuC,OAYhD,OAXAiiB,EAASsE,eAAe5mB,EACrBud,EAAQ7H,cAEV4M,EAASuE,eAAe7mB,EACxBsiB,EAAS3M,MAAM4H,EAAQ5H,OAExB2M,EAASwE,YAAc,GAAKjf,aAC5Bya,EAAShhB,aAAaf,IAAI,EAAE,EAAE,GAC9B+hB,EAASyE,cAAcxmB,IAAIgd,EAAQ3H,KAAK2H,EAAQ3H,KAAK2H,EAAQ3H,MAC7D0M,EAAS0E,cAAczmB,IAAI,EAAE,EAAE,GAC/BzC,KAAK8mB,cAAcztB,GAAKmrB,EACjBA,GAGR,uBAAuB/E,GACnB,UAAWA,GACbA,EAAQ5H,MAAQ9a,KAAK8W,MAAoB,EAAd4L,EAAQ5H,OAAS,EACzC4H,EAAQ0J,KAAK,IACf1J,EAAQ7H,aAAY,IAEf6H,EAAQ5H,MAAM,EAEpB4H,EAAQ3H,KADN,SAAU2H,EACG1iB,KAAK8W,MAAmB,EAAb4L,EAAQ3H,MAAQ,EACvB,GAGrB,YAAY2H,GACX,IAAI2J,EAAQ,EAIZ,OAHAA,GAAOvtB,QAAQ4jB,EAAQ7H,cAAc,EACrCwR,GAAO,EAAgB,EAAd3J,EAAQ5H,OAAS,GAC1BuR,GAAoB,EAAb3J,EAAQ3H,MAAQ,GACV8K,SAAS,KAKvByG,eAAe,EACfC,WAAW,EACXC,WAAW,EACXC,cAAc,EACd,mBACC,KAAIjtB,YAAYC,MAAMwD,KAAKqpB,gBAAkBrpB,KAAK6J,YAAlD,CACA7J,KAAKqpB,eAAe9sB,YAAYC,MAE7BwD,KAAKspB,YAAY,EACnBtpB,KAAKwpB,cAAc,EACXxpB,KAAKspB,YAAY,IACzBtpB,KAAKwpB,eAAe,GAErBxpB,KAAKspB,YAActpB,KAAKwpB,cACxBxpB,KAAKupB,YAAYvpB,KAAKupB,WAAW,GAAG,EACpC,IAAK,MAAMrnB,KAAWlC,KAAK+mB,iBAC1B7kB,EAAQvC,KACPuC,EAAQqmB,UAAU3oB,EAAEsC,EAAQ0f,MAAM5hB,KAAKspB,WAAWlsB,IAClD8E,EAAQqmB,UAAU1oB,EAAEqC,EAAQ2f,MAAM7hB,KAAKupB,WAAW,IAClDrnB,EAAQqmB,UAAUzoB,EAClBoC,EAAQqmB,UAAUxoB,OCpHtBvH,OAAOmR,OAAO,GAAK,CAClB,mBACC,MAAM8f,EAASjjB,SAASijB,SACxB,IAAK,MAAM1P,KAAS0P,EACnBzpB,KAAK8Z,mBAAmBC,EAAM,GAE/B,MAAM2P,EAAWljB,SAASkjB,WAC1B,IAAK,MAAM9Z,KAAW8Z,EACrB1pB,KAAK8Z,mBAAmBlK,EAAQ,GAEjC,MAAM6O,EAAYtY,YAAYsY,YAAYC,MAC1C,IAAK,IAAIiL,EAAElL,EAAUhQ,OAAO,EAAGkb,GAAG,IAAKA,EACtC3pB,KAAK8Z,mBAAmB2E,EAAUkL,GAAG,GAAGA,GAEzC3pB,KAAK8Z,mBAAmB3T,YAAY,KAGrC,mBAAmBmI,EAAKsb,GACvB,IAAItb,EAAK0B,YAAY,CACpB,MAAM6Z,EAAS,IAAI,qBAAUvb,EAAKsb,GAMlC,OALApxB,OAAOC,eAAe6V,EAAK,cAAc,CACxCvV,MAAM8wB,EACNhhB,cAAa,IAEd7I,KAAK4D,WAAWke,KAAK+H,GACdA,EAER,OAAOvb,EAAK0B,aAGb,mBACC,IAAI,MAAM1B,KAAQtO,KAAK4D,WACtB0K,EAAKnK,UAIP,oBACC,kBAAO2lB,OAAS,GAChB,kBAAOA,OAAOvT,KAAK9X,EAAKylB,YAAY,CAACxlB,EAAYwkB,YAAY,cAAc,CAAEC,gBAAiBtkB,GAAY,GAAK0D,OAAOijB,OAAOjoB,EAAMR,KAAKC,GAAG,EAAEqC,KAC7I,kBAAOyqB,OAAOrT,OAAOhY,EAAKylB,YAAY,CAACxlB,EAAYwkB,YAAY,cAAc,CAACC,gBAAiBtkB,GAAY,GAAK0D,OAAO0N,UAAUzS,EAAM,GAAI6B,KAC3I,kBAAOyqB,OAAOnT,MAAMlY,EAAKylB,YAAY,CACpC,kBAAO4F,OAAOrT,OAAOwM,QACrB,kBAAO6G,OAAOrT,OAAOwM,QAAQuC,OAAOhoB,EAAMT,KAAKC,GAAG,EAAEqC,KAGrD,kBAAOyqB,OAAOC,OAAO,kBAAOD,OAAOvT,KAAK0M,MAAM,eAC9C,MAAM+G,EAAgB,IAAIzrB,EAAQ,mBAC5B0rB,EAAiB,IAAIzrB,EAAiB,kBAAmB,GAAK+D,OACpE0nB,EAAenB,eAAekB,EAC9BC,EAAelB,eAAeiB,EAC9B,kBAAOF,OAAOC,OAAOvF,SAASyF,EAE9B,IAAK,MAAM5wB,KAAO,kBAAOywB,OACxB,GAAKvnB,MAAMT,WAAW,kBAAOgoB,OAAOzwB,OAMvC,MAAM,0BAAeiF,EACpB,cACCukB,MAAM,SAAS,GAAKtgB,OACpBvC,KAAKkqB,aAAe,IAAI5rB,EAAc,gBAAgB,GAAKiE,OAC3DvC,KAAKkqB,aAAatnB,OAAO5C,KACzBA,KAAK0B,KAAO,kBAAOooB,OAAOvT,KAAK0M,QAC/BjjB,KAAK0B,KAAKkB,OAAS5C,KAAKkqB,aAEzB,YAAYC,GACXnqB,KAAKoqB,kBACLpqB,KAAKkC,QAAU,IAAI3D,EAAQ4rB,EAAI,GAAK5nB,OACpCvC,KAAKqqB,OAASrqB,KAAKkC,QAAQooB,SAC3BtqB,KAAKkC,QAAQgmB,UAAS,EACtBloB,KAAKkC,QAAQimB,iBAAiBC,QAAQ,IAAIpoB,KAAKuqB,mBAC/CvqB,KAAKwkB,SAAW,IAAIhmB,EAAiB,kBAAkB,GAAK+D,OAC5DvC,KAAKwkB,SAASsE,eAAe9oB,KAAKkC,QAClClC,KAAKwkB,SAASwE,YAAc,GAAKjf,aACjC/J,KAAKwkB,SAAShhB,aAAaf,IAAI,EAAE,EAAE,GACnCzC,KAAKwkB,SAAS0E,cAAczmB,IAAI,EAAE,EAAE,GACpCzC,KAAK0B,KAAK8iB,SAASxkB,KAAKwkB,SAEzB,kBACCxkB,KAAKkC,QAAQmmB,mBAAmB,GAEjC,kBACIroB,KAAKwkB,WACPxkB,KAAKwkB,SAASL,SAAQ,GAAK,GAC3BnkB,KAAKwkB,SAAS,KACdxkB,KAAKkC,QAAQ,KACblC,KAAKqqB,OAAO,MAGd,WAAWlP,GACVnb,KAAKoqB,kBACLvH,MAAMsB,WAAWhJ,IAInB,MAAM,6BAAkB,kBACvB,YAAY7M,EAAKsb,GAChB/G,QACA7iB,KAAK4pB,MAAMA,EACX5pB,KAAK0B,KAAKkoB,MAAM5pB,KAAK4pB,MACrB5pB,KAAK0B,KAAKkH,UAAU5I,KACpBA,KAAKwqB,WAAWxqB,KAAKsO,KAAKA,EAC1BtO,KAAKyqB,SAAS,GACdzqB,KAAK0qB,UAAU,EAEf1qB,KAAK2qB,kBACL3qB,KAAK4qB,cAEL5qB,KAAK6qB,UAAY7qB,KAAKsO,gBAAgBwQ,aACtC9e,KAAK8qB,OAAS9qB,KAAK6qB,WAAa7qB,KAAKsO,KAAKwc,SAC1C9qB,KAAK+qB,OAAS/qB,KAAK6qB,WAAa7qB,KAAKsO,KAAKyc,SAC1C/qB,KAAKgrB,UAAYhrB,KAAK6qB,WAAa7qB,KAAKsO,KAAK0c,YAC7ChrB,KAAKirB,QAAUjrB,KAAKsO,gBAAgBkL,WACpCxZ,KAAKiT,SAAWjT,KAAKsO,gBAAgBvF,YACrC/I,KAAKgT,WAAahT,KAAKsO,gBAAgBqQ,cAEpC3e,KAAKirB,SACPjrB,KAAK2Z,iBAGN3Z,KAAKkrB,UAAY,EAEblrB,KAAKsO,KAAK6L,gBAAgBna,KAAKsO,KAAK6L,cAAc,IAEnD,GAAKzO,oBAEP1L,KAAKoY,OAAS,kBAAO0R,OAAOC,OAAO9G,QACnCjjB,KAAKoY,OAAOxV,OAAO5C,KAAKkqB,cAGzBlqB,KAAKmrB,YAAc,IAAI7sB,EAAc,eAAe,GAAKiE,OACzDvC,KAAKmrB,YAAYvoB,OAAO5C,KACxBA,KAAKorB,cAGN,iBACC,OAAOvvB,QAAQmE,KAAKkC,SAAWlC,KAAKkC,QAAQmpB,WAG7C,kBACC,MAAM7T,EAAO,GAAKC,aAAazX,KAAKsrB,SAC9BvD,EAASvhB,SAAS6N,UAAU2T,aAAaxQ,GAC/C,GAAGuQ,EAAO,CACT,MAAMwD,EAAW,gBAAgBxD,QACjC/nB,KAAKwrB,YAAYD,QAEjBvrB,KAAKwrB,YAAY,yBAInB,kBACC3I,MAAM0H,kBACNvqB,KAAKyrB,cACLzrB,KAAK0rB,cAGN,kBACC1rB,KAAK2rB,WAAanlB,SAASolB,YAC3B5rB,KAAKsrB,QAAUtrB,KAAKwqB,WAAW3V,SAC/B7U,KAAK6rB,eAAiB7rB,KAAKwqB,WAAWsB,gBACtC9rB,KAAK+rB,gBAAkB/rB,KAAKwqB,WAAWwB,iBACvChsB,KAAKisB,gBAAkBC,aAAaC,eAAensB,KAAK6rB,gBACrD7rB,KAAKsrB,QAAQ,EACftrB,KAAKosB,gBAAgBpsB,KAAKsrB,SAClBtrB,KAAK6rB,gBACb7rB,KAAKwrB,YAAY,kBAAkBxrB,KAAK6rB,sBAG1C,uBAGC,GAFA7rB,KAAKqsB,GAAGrsB,KAAKssB,oBACbtsB,KAAKusB,GAAGvsB,KAAKwsB,qBACTxsB,KAAKysB,iBAAmB,OAC5B,MAAMC,EAAK1sB,KAAK2sB,eACVC,EAAK5sB,KAAK6sB,gBACVrL,GAAMxhB,KAAK8sB,kBAAoB9sB,KAAKqsB,IAAMK,EAC1CjL,GAAMzhB,KAAK+sB,kBAAoB/sB,KAAKusB,IAAMK,EAChD5sB,KAAKgtB,SAASxL,EAAGC,EAAGiL,EAAGE,GAExB,iBACC,OAAO5sB,KAAKqsB,KAAKrsB,KAAKssB,qBAAuBtsB,KAAKusB,KAAKvsB,KAAKwsB,oBAE7D,oBACC,GAAGxsB,KAAKirB,SAAWjrB,KAAKsO,KAAK2e,oBAC5B,OAAOjtB,KAAKsO,KAAK4e,YAAY,EAAE,EAGhC,OADU,GAAK7a,sBAAsBrS,KAAKsO,KAAK4e,aACpC,EAAE,EAGd,SAASttB,EAAEC,EAAEC,EAAEC,GACVC,KAAKysB,kBACTzsB,KAAKkC,QAAQvC,KAAKC,EAAEC,EAAEC,EAAEC,GAGzB,cACC,IAAIC,KAAKysB,iBAAmB,OAC5B,MAAMU,EAAcntB,KAAKotB,UAAU,QAAQ,IAAI,EAAQ,EAAE,IACzD,IAAIrf,EAAQ,EACZ,GAAG/N,KAAK6qB,UAAU,CACjB,MAAMwC,EAAW,GAAK,GAAGrtB,KAAKsO,KAAKgf,MAAMrxB,0BACzC8R,EAAQ,GAAKxI,SAAU,GAAGvF,KAAKsO,KAAKgf,cAAeD,EAAStf,OAE7D,MAAMwf,EAASvtB,KAAK2sB,eAAexvB,IAAagwB,EAAYvtB,EAAImO,EAC1Dyf,EAASxtB,KAAK6sB,gBAAgB1vB,IAAagwB,EAAYttB,EAAIkO,EACjE/N,KAAK0B,KAAK6jB,QAAQ9iB,IAAI8qB,EAAOC,EAAOA,GAGrC,UAAUn0B,EAAImM,GACb,OAAIxF,KAAKytB,eACNp0B,KAAO2G,KAAK0tB,oBACP1tB,KAAK0tB,oBAAoBr0B,GACxBA,KAAO2G,KAAKytB,eACbztB,KAAKytB,eAAep0B,GAErBmM,EAN0BA,EAQlC,UAAUnM,GACT,QAAI2G,KAAKytB,iBACFp0B,KAAO2G,KAAK0tB,qBAAuBr0B,KAAO2G,KAAKytB,gBAGvD,iBACC,IAAIztB,KAAKytB,eAAe,CACvBztB,KAAKytB,eAAe,GACpB,MAAMnZ,EAAOtU,KAAKsO,KAAKyL,QAAQzF,KAC/B,GAAKK,2BACJ,GAAKsF,sBAAsB3F,GAC3B,GAAKyD,4BACL/X,KAAKytB,gBAGPztB,KAAK0tB,oBAAoB,GACzB,MAAMC,EAAO3tB,KAAKsO,KAAKqf,OACvB,IAAIA,EAAO,OACX,IAAIC,EAAW,GACf,IAAK,MAAM1S,KAAWyS,EAAKE,KACR,MAAf3S,EAAQ4S,MAA2B,MAAf5S,EAAQ4S,OAC9BF,GAAU1S,EAAQzR,WAAW,IAW/B,GARA,GAAKkL,2BACJ,GAAKsF,sBAAsB2T,GAC3B,GAAK7V,4BACL/X,KAAK0tB,qBAEN1tB,KAAK0rB,cACL1rB,KAAK4qB,cAEF5qB,KAAKsO,KAAKoL,sBACZ1Z,KAAKsO,KAAKoL,qBAAoB,EAG5B,QAAS1Z,KAAK0tB,qBAAoB,CACpC,MAAM3T,EAAM/Z,KAAKsO,KAAKyL,QAChB1B,EAAMrY,KAAK0tB,oBAAoBrV,IACrCrY,KAAKsO,KAAK4L,OACT5e,EAAeye,EAAMna,EAAEyY,EAAIzY,GAC3BtE,EAAeye,EAAMla,EAAEwY,EAAIxY,KAwB9B,YACCG,KAAK0B,KAAKkB,OAAS5C,KAAKkqB,aACxBlqB,KAAK0B,KAAKkH,UAAU5I,KACpBA,KAAK0B,KAAKkoB,MAAM5pB,KAAK4pB,MAClB5pB,KAAKwkB,WACPxkB,KAAK0B,KAAK8iB,SAASxkB,KAAKwkB,UAEtBxkB,KAAK0Y,aACP1Y,KAAK0Y,WAAWqV,eAAehM,OAAO,EAAEzR,KACxCtQ,KAAK0Y,WAAWqV,eAAejM,KAAK9hB,KAAK0B,OAI3C,cACI,oBAAqB1B,KAAKsO,KAAK6L,eACjCna,KAAKud,kBAEH,cAAevd,KAAKsO,KAAK6L,eAC3Bna,KAAKgd,YAIP,kBACC,GAAGhd,KAAK0Y,WAAa,OACrB,MAAMsB,EAASha,KAAKotB,UAAU,aAAa,CAC1C/yB,MAAM,SACNke,UAAU,EACVC,SAAS,GAAKhN,WACdiN,MAAM,GAAKhN,cAEZzL,KAAK8d,qBAAuB9d,KAAKguB,iBAAiB,kBAAkBhU,EAAO3f,OAC3E2F,KAAK+d,yBAA2B/d,KAAKiuB,YAAY,sBAAsBjU,EAAOzB,WAC9EvY,KAAKge,wBAA0Bhe,KAAKiuB,YAAY,qBAAqBjU,EAAOxB,UAC5ExY,KAAKie,qBAAuBje,KAAKiuB,YAAY,kBAAkBjU,EAAOvB,OACtEzY,KAAK0Y,WAAa,IAAI1a,EAAU,aAAa,EAAQkwB,OAAO,EAAQA,OACnErxB,EAASmD,KAAKie,qBAAqBjZ,eAAe,EAAE,GAAKzC,OAC1DvC,KAAK0Y,WAAWyV,SAAW,MAAMpxB,KAAKylB,IAAIxiB,KAAKie,qBAAqBjZ,eAAe,GACnFhF,KAAK0Y,WAAW0V,MAAQpuB,KAAKge,wBAAwBhZ,cACrDhF,KAAK0Y,WAAWH,UAAUvY,KAAK+d,yBAAyB/Y,cACxDhF,KAAK0Y,WAAW2V,QAAQ5rB,OAAOzC,KAAK8d,qBAAqBwQ,oBAEzDtuB,KAAK0Y,WAAWwU,UAAUrtB,GAAG,EAC7BG,KAAKuuB,iBAAiB,IAAIjwB,EAAc,oBAAoB,GAAKiE,OACjEvC,KAAKuuB,iBAAiB3rB,OAAO5C,KAAKmrB,YAClCnrB,KAAK0Y,WAAW9V,OAAO5C,KAAKuuB,iBAC5BvuB,KAAKke,qBAAuBle,KAAKiuB,YAAY,kBAAkB,IAC/DjuB,KAAKwuB,mBAAqBxuB,KAAKiuB,YAAY,gBAAiB,GAC5DjuB,KAAKwuB,mBAAmBrf,MAAM,IAC9BnP,KAAKme,oBAAoBne,KAAKotB,UAAU,gBAAgB,MACxDptB,KAAKyuB,4BACLzuB,KAAK0uB,YAGN,YACC,GAAG1uB,KAAKsY,KAAO,OACf,MAAM0B,EAASha,KAAKotB,UAAU,OAAO,CACpC/yB,MAAM,SACNke,UAAU,EACVC,SAAS,GAAKhN,aAEfxL,KAAKod,eAAiBpd,KAAKguB,iBAAiB,YAAYhU,EAAO3f,OAC/D2F,KAAKqd,mBAAqBrd,KAAKiuB,YAAY,gBAAgBjU,EAAOzB,WAClEvY,KAAKsd,kBAAoBtd,KAAKiuB,YAAY,eAAejU,EAAOxB,UAChExY,KAAKsY,KAAO,IAAIra,EAAW,OAAO,EAAQiwB,OAAO,GAAK3rB,OACtDvC,KAAKsY,KAAK+V,QAAQ5rB,OAAOzC,KAAKod,eAAekR,oBAC7CtuB,KAAKsY,KAAKC,UAAUvY,KAAKqd,mBAAmBrY,cAC5ChF,KAAKsY,KAAK8V,MAAMpuB,KAAKsd,kBAAkBtY,cACvChF,KAAKsY,KAAK1V,OAAO5C,KAAKmrB,YAGvB,4BAQCnrB,KAAKuuB,iBAAiBztB,IAAId,KAAKwuB,mBAAmBrnB,eAClDnH,KAAKuuB,iBAAiB3tB,OAAOZ,KAAKke,qBAAqB/W,eACvDnH,KAAKuuB,iBAAiB/tB,SAASiC,IAAI,EAAE,EAAE,GACvC,IAAIksB,EAAmB5xB,KAAK6xB,IAAI/xB,EAAS,GAAGmD,KAAKie,qBAAqB9W,eAAepK,KAAKuI,IAAI,GAAGtF,KAAKke,qBAAqB/W,gBAAgB,KAAK,GAAKmE,aACrJqjB,EAAmB5xB,KAAKuI,IAAI,EAAEvI,KAAKsI,IAAI,EAAEspB,IACzC3uB,KAAK0Y,WAAW0V,OAAOO,EACvB3uB,KAAKuuB,iBAAiBte,UAAUzS,EAAMmxB,EAAiBnvB,IAGxD,eACC,GAAGQ,KAAK0Y,WAAW,CAClB,MAAME,EAAgB,IAAItd,EAAgB,GAAK0Y,SAAUhU,KAAKsO,KAAK4e,aAAeltB,KAAKme,qBACpFvF,IAAkB5Y,KAAKwuB,mBAAmBxpB,eAC5ChF,KAAKwuB,mBAAmBzpB,SAAS6T,EAAc,KAE7C5Y,KAAK8d,qBAAqB3Z,SAASnE,KAAK+d,yBAAyB5Z,SACnEnE,KAAKge,wBAAwB7Z,SAASnE,KAAKie,qBAAqB9Z,SAChEnE,KAAKwuB,mBAAmBrqB,SAASnE,KAAKke,qBAAqB/Z,WAC3DnE,KAAK0Y,WAAW2V,QAAQ5rB,OAAOzC,KAAK8d,qBAAqB+Q,qBACzD7uB,KAAK0Y,WAAWH,UAAUvY,KAAK+d,yBAAyB5W,eACxDnH,KAAK0Y,WAAW0V,MAAMpuB,KAAKge,wBAAwB7W,eACnDnH,KAAK0Y,WAAWD,MAAM5b,EAASmD,KAAKie,qBAAqB9W,gBACzDnH,KAAK0Y,WAAWyV,SAAW,MAAMpxB,KAAKylB,IAAIxiB,KAAKie,qBAAqBjZ,eAAe,GACnFhF,KAAKyuB,6BAGJzuB,KAAKsY,MACJtY,KAAKod,eAAejZ,SAASnE,KAAKqd,mBAAmBlZ,SAASnE,KAAKsd,kBAAkBnZ,WACvFnE,KAAKsY,KAAK+V,QAAQ5rB,OAAOzC,KAAKod,eAAeyR,qBAC7C7uB,KAAKsY,KAAKC,UAAUvY,KAAKqd,mBAAmBlW,eAC5CnH,KAAKsY,KAAK8V,MAAMpuB,KAAKsd,kBAAkBnW,gBAiB1C,YAAY9N,EAAImM,EAAOspB,EAAM,kBACzBz1B,KAAO2G,KAAKsO,KAAK6L,cACnB3U,EAASxF,KAAKsO,KAAK6L,cAAc9gB,GAEjC2G,KAAKsO,KAAK6L,cAAc9gB,GAAKmM,EAE9B,MAAM4Y,EAAQ,IAAI0Q,EAAMz1B,EAAImM,GAE5B,OADA4Y,EAAQvN,gBAAgB,IAAI7Q,KAAKsO,KAAK6L,cAC/BiE,EAER,iBAAiB/kB,EAAImM,GACpB,OAAOxF,KAAKiuB,YAAY50B,EAAImM,EAAOwJ,cAGpC,UACC,OAAGhP,KAAKirB,QACAjrB,KAAKotB,UAAU,QAAQptB,KAAKsrB,UAEjCtrB,KAAK6qB,WACA,GAAKre,aAKd,WACC,OAAOxM,KAAKotB,UAAU,QACrBptB,KAAKsO,KAAKygB,SAAW,GAAKjhB,oBAAoByI,KAAO,GAAKpI,aAG5D,cACC,MAAM6gB,EAAWhvB,KAAKivB,WACtB,GAAGjvB,KAAK6N,QAAUmhB,EAAW,OAC7BhvB,KAAK6N,MAAMmhB,EAEX,IAAIE,EAAW,kBAAOpF,OAAOrT,OAC7B,MAAM4L,EAAS,GAAKvU,oBACpB,OAAO9N,KAAK6N,OACZ,KAAKwU,EAAO9L,KACX2Y,EAAW,kBAAOpF,OAAOvT,KAIzB,MACD,KAAK8L,EAAO1L,MACXuY,EAAW,kBAAOpF,OAAOnT,MAEzB,MACD,KAAK0L,EAAO3L,OAIZ1W,KAAK0B,KAAKyiB,UACVnkB,KAAK0B,KAAKwtB,EAASjM,QAEnBjjB,KAAK0uB,YAGN,SACI1uB,KAAKsO,KAAK6gB,SACZnvB,KAAKmkB,UAGNnkB,KAAKqI,QAAQrI,KAAKsO,KAAK8gB,UAAU/mB,QACC,mBAAxBrI,KAAKsO,KAAKwE,YACnB9S,KAAKqI,QAAQrI,KAAKqI,SAASrI,KAAKsO,KAAKwE,aAElC9S,KAAKwkB,WACRxkB,KAAKqI,SAAQ,GAEVrI,KAAKqvB,WAGJrvB,KAAKqI,SAAUrI,KAAKsvB,YAAW,GAFhCtvB,KAAKqI,SAAUrI,KAAKsvB,YAAW,GAI/BtvB,KAAKqvB,aAENrvB,KAAKuvB,kBACPvvB,KAAK2qB,kBAEH3qB,KAAKwvB,kBACPxvB,KAAKyrB,cAGHzrB,KAAK6N,QAAQ,GAAKC,oBAAoB2I,QACxCzW,KAAK0B,KAAKd,MAAQ,GAAKwE,iBAAiB+B,eAAe,GACvDnH,KAAK0B,KAAKZ,IAAM,GAAKgE,eAAeqC,gBAC5BnH,KAAK6N,QAAQ,GAAKC,oBAAoB0I,MAC9CxW,KAAK0B,KAAKd,MAAM,EAChBZ,KAAK0B,KAAKZ,IAAM,GAAKgE,eAAeqC,iBAEpCnH,KAAK0B,KAAKd,MAAM,EAChBZ,KAAK0B,KAAKZ,IAAId,KAAKotB,UAAU,MAAM,IAKpCptB,KAAKmY,KAAOtc,QAAQmE,KAAKsO,KAAKmhB,aAC3BzvB,KAAKmY,MAAQnY,KAAK0vB,UAChB1vB,KAAKwkB,SAASuE,iBACjB/oB,KAAKwkB,SAASuE,eAAe,GAAK4G,sBAClC3vB,KAAKwkB,SAASoL,4BAA2B,GAGvC5vB,KAAKwkB,SAASuE,iBAChB/oB,KAAKwkB,SAASuE,eAAe,KAC7B/oB,KAAKwkB,SAASoL,4BAA2B,GAI3C5vB,KAAK1C,WAAa,GAAKuyB,cAAc7vB,KAAKsO,KAAKwB,OAAO9P,KAAKsO,KAAKyB,QAEhE/P,KAAK8vB,iBACL9vB,KAAK+vB,kBACF/vB,KAAKoY,QAASpY,KAAKgwB,eACtBhwB,KAAKiwB,gBAIN,iBACC,MAAMnN,EAAU,GAAKC,WAAW/iB,KAAKsO,KAAKwB,OAAO9P,KAAKsO,KAAKyB,QAC3D/P,KAAKJ,EAAIkjB,EAAQljB,EACjBI,KAAKH,EAAIijB,EAAQjjB,EAEjBG,KAAKkqB,aAAa1pB,SAASiC,IAAI,EAAE,EAAE,GACnCzC,KAAKmrB,YAAY3qB,SAASiC,IAAI,EAAE,EAAE,GAClCzC,KAAKkqB,aAAavpB,EAAoB,EAAhB,GAAKgK,WAC3B3K,KAAKmrB,YAAYxqB,EAAIX,KAAKotB,UAAU,cAAc,GAAK9hB,cAEvD,MAAM4kB,EAAkB,IAAI,EAAQnzB,KAAKozB,KAAK,GAAKxtB,WAAW9B,SAAShB,GAAG9C,KAAKqzB,IAAI,GAAKztB,WAAW9B,SAAShB,IAAIwwB,iBAAiB,IAAK,KAChIvX,EAAc9Y,KAAKotB,UAAU,cAAc,MAC9CptB,KAAK6N,QAAQ,GAAKC,oBAAoB2I,QACxCzW,KAAKkqB,aAAatqB,EAAEswB,EAAgBtwB,EACpCI,KAAKkqB,aAAarqB,EAAEqwB,EAAgBrwB,EACpCG,KAAKmrB,YAAYvrB,EAAEswB,EAAgBtwB,EACnCI,KAAKmrB,YAAYtrB,EAAEqwB,EAAgBrwB,GAC1BiZ,IACT9Y,KAAKmrB,YAAYvrB,EAAEswB,EAAgBtwB,EAAE,EACrCI,KAAKmrB,YAAYtrB,EAAEqwB,EAAgBrwB,EAAE,GAEnCiZ,IACF9Y,KAAKmrB,YAAYvrB,GAAGkZ,EAAYlZ,EAChCI,KAAKmrB,YAAYtrB,GAAGiZ,EAAYjZ,GAGjCG,KAAKkqB,aAAatqB,GAAKI,KAAKotB,UAAU,IAAI,GAC1CptB,KAAKkqB,aAAarqB,GAAKG,KAAKotB,UAAU,IAAI,GAG3C,kBACC,IAAIkD,EAAetwB,KAAK1C,WAUxB,IATG0C,KAAK6qB,YAAc7qB,KAAKiT,UAAUjT,KAAKgT,aAAa7M,YAAYyJ,aAClE0gB,GAAgB,GAAKC,eAAexzB,KAAK8W,MAAM7T,KAAKsO,KAAKwB,QAAQ/S,KAAK8W,MAAM7T,KAAKsO,KAAKyB,SACnF/P,KAAKsO,OAAO9H,SAASoJ,QAAQ,QAC/B0gB,GAAgB,GAAK5jB,cAAcsB,KAC3BhO,KAAKsO,OAAO9H,SAASoJ,QAAQ,UACrC0gB,GAAgB,GAAKxjB,cAAckB,OAIlChO,KAAKgrB,WAAa7kB,YAAYyJ,YAAY5P,KAAKsO,KAAK,CAGrD,GAFGtO,KAAKsO,KAAKkiB,WACbxwB,KAAKkrB,YAAcoF,EAAatwB,KAAKkrB,WAAW,IAC7CoF,GAActwB,KAAKkrB,UAAU,CAChC,MAAMuF,EAAc,IAAI1zB,KAAKylB,IAAI,IAAI,GAAKjd,SAAS,sBAAsB,IACzEvF,KAAKkrB,YAAcoF,EAAatwB,KAAKkrB,WAAWuF,OAEhD,IAAI,GAAKC,kBAAkB1wB,KAAKsO,KAAKtO,KAAKsO,KAAK1O,EAAEI,KAAKsO,KAAKzO,GAAE,GAAM,CAClE,MAAM8wB,EAAe,IAAI5zB,KAAKylB,IAAI,IAAI,GAAKjd,SAAS,uBAAuB,IAC3EvF,KAAKkrB,YAAcoF,EAAatwB,KAAKkrB,WAAWyF,EAGlD3wB,KAAKW,EAAIX,KAAKkrB,UACdlrB,KAAKW,GAAK,GAAK4E,SAAS,iBAAiB,GAAKyH,iBAAiBlS,QAAQkF,KAAKsO,KAAKsiB,UAAU5wB,KAAKsO,KAAKuiB,mBAChG,GAAG7wB,KAAKsO,KAAKwiB,YAAY,CAC9B,IAAIC,EAAe,EAAG/wB,KAAKsO,KAAK0iB,YAAgC,EAApBhxB,KAAKsO,KAAK2iB,WAClDC,GAA2C,EAA9Bn0B,KAAKylB,IAAIuO,EAAa,GAAI,GAAM,EAC7CI,EAAWp0B,KAAK0T,IAAIzQ,KAAKsO,KAAK8iB,mBAAqBpxB,KAAKsO,KAAK+iB,sBACjErxB,KAAKW,EAAIX,KAAKsO,KAAK+iB,sBAAsB,EAAEN,GACzC/wB,KAAKsO,KAAK8iB,mBAAmBL,EAAeG,EAAWC,EAAS,EACjEnxB,KAAKsO,KAAK4iB,aAAa/zB,SAExB6C,KAAKkrB,UAAUoF,EACftwB,KAAKW,EAAEX,KAAKkrB,UAGVlrB,KAAKirB,UACPjrB,KAAKW,GAAKX,KAAKotB,UAAU,SAAmC,IAA1BptB,KAAKsO,KAAKgjB,cAAkB,GAAKhlB,aAAa,GAC7EtM,KAAKuxB,UAAU,OACjBvxB,KAAKW,EAAEX,KAAKotB,UAAU,IAAI,KAK7B,eACC,IAAIoE,EAAgBxxB,KAAKotB,UAAU,SAAUptB,KAAK6N,OAAO,GAAKC,oBAAoByI,MAElF,GAAGib,IAAgBxxB,KAAKiT,UAAUjT,KAAKgT,YAAY,CAClD,MAAMye,EAAU,GAAK7tB,WAAWib,QAAQ7e,MACxC,GAAGyxB,GAAS,EACZ,IAAK,IAAI35B,EAAE25B,EAAQ,EAAG35B,EAAE,GAAK8L,WAAW6K,SAAU3W,EAAE,CACnD,MAAM45B,EAAQ,GAAK9tB,WAAW9L,GAC9B,GAAI45B,EAAMtZ,QAASsZ,EAAMrpB,UACtBqpB,EAAMpjB,KAAKwB,SAAS9P,KAAKsO,KAAKwB,QAAQ4hB,EAAMpjB,KAAKyB,SAAS/P,KAAKsO,KAAKyB,QAAO,CAC7EyhB,GAAc,EACd,QASH,GALIxxB,KAAKoY,OAAOiX,WAGXmC,GAAgBxxB,KAAKoY,OAAOkX,YAAW,GAFxCkC,GAAgBxxB,KAAKoY,OAAOkX,YAAW,IAIvCkC,EAAgB,OAEpB,MAAMG,EAAa50B,KAAKsI,IAAI,EAAErF,KAAKotB,UAAU,SAAS,IAChDrhB,EAAahP,KAAKuI,IAAItF,KAAKW,EAAIX,KAAK1C,WAAYq0B,GAChDC,EAAiB5xB,KAAKgrB,UAAW,GAAKhe,iBAAiBjB,WAAa,GAAKD,YACzE+lB,EAAiB90B,KAAKuI,IAAI,EAAE,EAAEvI,KAAK0T,IAAI1E,GAAY6lB,GACzD5xB,KAAKoY,OAAOzX,GAAKoL,EACjB,MAAMF,EAAc7L,KAAKgrB,UAAW,GAAKhe,iBAAiBnB,YAAc7L,KAAKotB,UAAU,cAAc,GAAKxhB,cAC1G5L,KAAKoY,OAAOmN,QAAQuM,OAAOjmB,EAAYgmB,GACnC7xB,KAAKoY,OAAO2Z,eACf/xB,KAAKoY,OAAO4Z,WAAWH,EAAe,GAAI7xB,KAAKmY,MAIjD,WAAWgD,GACV0H,MAAMsB,WAAWhJ,UACVnb,KAAKsO,KAAK0B,aAInB,IAAK,MAAMiiB,IAAc,CACxB,kBAAkB,kBAAkB,oBACpC,iBAAiB,eAAe,gBAChC,kBAAkB,eAElB,qBAAUv4B,UAAUu4B,GAAYvpB,iBAAiBhP,UAAUu4B,GCzoB5Dz5B,OAAOmR,OAAO,GAAK,CAClB+mB,kBAAiB,CAAC9gB,KAAWuL,IACrBuV,GAAkB/uB,MAAMiO,EAAQuL,KAIzC,MAAM+W,GAAyBC,mBAAmBz4B,UAAU04B,QA6B5D,SAASC,GAAqBzyB,EAAGC,EAAGyyB,GAAO,GAC1C,KAAKtyB,gBAAgB8e,cAAgB,KAAM,wBAC3C,IAAI9e,KAAKgQ,YAAc,OAAO,EAC9B,IAAIhQ,KAAKwwB,SAAW,OAAO,EAC3B,GAAGrqB,YAAYosB,iBAAmB,OAAO,EACzC,MAAMvH,EAAUhrB,KAAKgrB,YACfqC,EAAW,GAAK,GAAGrtB,KAAKstB,MAAMrxB,0BAC9BgS,EAAM,GAAK1I,SAAU,GAAGvF,KAAKstB,YAAaD,EAASpf,KACzD,IAAIukB,EAAW,GACZxH,EACFwH,EAAW,GAAKjtB,SAAS,iBAAiB,GAAKyH,iBAAiBlS,QAEhE03B,GAAY,GAAKjC,eAAe3wB,EAAEC,GAEnC,MAAMvC,EAAa,GAAKuyB,cAAcjwB,EAAEC,GACxC,IAAI4yB,EAAOzyB,KAAKgQ,YAAYrP,EAI5B,GAHG,SAAU0sB,IACZoF,GAAMpF,EAASrf,MAEb1Q,EAAWm1B,EAAO,OAAO,EAC5B,IAAIxkB,EAAM,OAAO,EACjB,IAAK,IAAItH,GAAI,EAAEA,GAAI,IAAIA,EACvB,IAAK,IAAII,GAAI,EAAEA,GAAI,IAAIA,EAAG,CACzB,GAAQ,IAALJ,GAAa,IAALI,IAAWurB,GAAQ3rB,GAAII,EAAK,SACvC,MAAM2rB,EAAc,GAAK7C,cAAcjwB,EAAE+G,EAAG9G,EAAEkH,GAC9C,GAAG2rB,EAAYp1B,EAAWk1B,GAAUF,IAASA,GAAQI,EAAYD,GAChE,OAAO,EAGT,OAAO,EAER,SAAS/B,KACR,OAAQ2B,GAAqB1wB,MAAM3B,KAAK4B,WA5DzCuwB,mBAAmBz4B,UAAU04B,QAAU,SAASxyB,EAAGC,EAAGzH,GACrD,IAAI85B,GAAuBvwB,MAAM3B,KAAK4B,WACrC,OAAO,EAER,MAAM+wB,EAAKnsB,SAASosB,oBAAoBhzB,EAAGxH,GACrCy6B,EAAKrsB,SAASssB,oBAAoBjzB,EAAGzH,GAC3C,GAAG4H,OAAOmG,YAAY,CACrB,MAAMyJ,EAAU5P,KAAK4P,UACrB,GAAGA,EAAQ,CACV,MAAMmjB,EAAarC,GAAkBz4B,KAAK2X,EAAQ+iB,EAAGE,GAAG,GACxD,GAAGjjB,EAAQob,YACV,OAAQ+H,EACH,GAAGA,EACR,OAAO,GAIV,GAAI/yB,KAAKgzB,aAAehzB,KAAKuyB,iBAC5B,OAAO,EAER,MAAMU,EAAc,GAAKpD,cAAcjwB,EAAEC,GACnC6yB,EAAc,GAAK7C,cAAc8C,EAAGE,GAC1C,OAAGI,IAAcP,GAyClB,MAAMQ,GAAmB71B,SAAS3D,UAAUy5B,gBAC5C91B,SAAS3D,UAAUy5B,gBAAkB,SAASvzB,EAAGC,GAChD,OAAG6wB,GAAkBz4B,KAAK+H,KAAKozB,UAAUxzB,EAAEC,GAAE,KAC1C,GAAKmN,iBAAiBkB,YACjBlO,KAAKqzB,aAAazzB,EAAGC,EAAG,IAExBqzB,GAAiBvxB,MAAM3B,KAAK4B,aAKrC,MAAM0xB,GAA6BvqB,YAAYrP,UAAU65B,mBACzDxqB,YAAYrP,UAAU65B,mBAAqB,WAC1C,MAAM3jB,EAAU5P,KAAK4P,UACfS,EAAQ,GAAK9K,SAAS,GAAGqK,EAAQ0d,cAAc1d,EAAQ4jB,YAC7DxzB,KAAK4P,UAAU6jB,aAAapjB,GAC5BijB,GAA2B3xB,MAAM3B,KAAK4B,YAKvC,MAAM8xB,GAAiBvB,mBAAmBz4B,UAAUi6B,KACpDxB,mBAAmBz4B,UAAUi6B,KAAO,SAASC,EAAOC,GACnD7zB,KAAKqxB,qBAAuB,GAAKxB,cAAc7vB,KAAKJ,EAAEI,KAAKH,GAC3DG,KAAKoxB,mBAAqB,GAAKvB,cAAc7vB,KAAKJ,EAAEg0B,EAAM5zB,KAAKH,EAAEg0B,GACjEH,GAAe/xB,MAAM3B,KAAK4B,YC/F3B,MAAMkyB,GAAqBz2B,SAAS3D,UAAUq6B,WAC9C12B,SAAS3D,UAAUq6B,WAAa,WAC/B,IAAIptB,EAAKmtB,GAAmBnyB,MAAM3B,KAAK4B,WACvC,OAAG5B,KAAKg0B,eACArtB,EAAwC,IAAnC,GAAK7B,eAAeqC,eAAmB,GAE7CR,GAER,MAAMstB,GAAqB52B,SAAS3D,UAAUw6B,WAC9C72B,SAAS3D,UAAUw6B,WAAa,WAC/B,IAAIntB,EAAKktB,GAAmBtyB,MAAM3B,KAAK4B,WACvC,OAAG5B,KAAKm0B,eACAptB,EAA0C,IAArC,GAAK3B,iBAAiB+B,eAAmB,GAE5CJ,GAGX1J,SAAS3D,UAAU06B,cAAgB,aACnC/2B,SAAS3D,UAAU26B,SAAW,aAC9Bh3B,SAAS3D,UAAU46B,WAAa,aAChCj3B,SAAS3D,UAAU66B,WAAa,aAChCl3B,SAAS3D,UAAU86B,YAAc,aACjCn3B,SAAS3D,UAAU+6B,aAAe,WAC9Bz0B,KAAK00B,UAAgD,KAAnC,GAAK5vB,eAAeqC,eAAmB,KACzDnH,KAAK20B,UAAkD,KAArC,GAAKvvB,iBAAiB+B,eAAmB,MAG/DgrB,mBAAmBz4B,UAAUk7B,gBAAkB,WAC9C,OAAO73B,KAAK0T,IAAIzQ,KAAKJ,EAAI,GAAK8C,YAAYlC,SAASZ,IAAI,GAAK2D,aACzDxG,KAAK0T,KAAKzQ,KAAKH,EAAI,GAAK6C,YAAYlC,SAASX,IAAI,GAAK0D","file":"mv3d-babylon.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","\r\nconst {Vector2,Vector3,Color3,Color4} = window.BABYLON;\r\n\r\nexport const makeColor = color=>{\r\n\tif (typeof color === 'number'){\r\n\t\treturn {\r\n\t\t\tr: (color>>16)/255,\r\n\t\t\tg: (color>>8&255)/255,\r\n\t\t\tb: (color&255)/255,\r\n\t\t\ta: 1,\r\n\t\t};\r\n\t}else if(color instanceof Color3){\r\n\t\treturn color.toColor4();\r\n\t}else if(color instanceof Color4){\r\n\t\treturn color;\r\n\t}else{\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width=1; canvas.height=1;\r\n\t\tconst context = canvas.getContext('2d');\r\n\t\tcontext.fillStyle = color; context.fillRect(0,0,1,1);\r\n\t\tconst bytes = context.getImageData(0,0,1,1).data;\r\n\t\treturn new Color4(bytes[0]/255,bytes[1]/255,bytes[2]/255,bytes[3]/255);\r\n\t}\r\n}\r\n\r\n\r\nexport const hexNumber=n=>{\r\n\tn=String(n);\r\n\tif(n.startsWith('#')){\r\n\t\tn=n.substr(1);\r\n\t}\r\n\treturn Number.parseInt(n,16);\r\n};\r\n\r\nexport const relativeNumber=(current,n)=>{\r\n\tif(n===''){ return +current; }\r\n\tconst relative = /^[+]/.test(n);\r\n\tif(relative){n=n.substr(1);}\r\n\tn=Number(n);\r\n\tif(Number.isNaN(n)){ return +current; }\r\n\tif(relative){\r\n\t\treturn +current+n;\r\n\t}else{\r\n\t\treturn +n;\r\n\t}\r\n};\r\n\r\nexport const booleanString=s=>{\r\n\treturn Boolean(falseString(s));\r\n}\r\nexport const falseString=s=>{\r\n\tif(!s){ return false; }\r\n\tif(typeof s !=='string'){ s=String(s); }\r\n\tconst S=s.toUpperCase();\r\n\tif(falseString.values.includes(S)){\r\n\t\treturn false;\r\n\t}\r\n\treturn s;\r\n}\r\nfalseString.values=['OFF','FALSE','UNDEFINED','NULL','DISABLE','DISABLED'];\r\n\r\nlet lastSnooze=0;\r\nexport const snooze=async()=>{\r\n\tif(performance.now()-lastSnooze>16){\r\n\t\tawait sleep(0);\r\n\t\tlastSnooze=performance.now();\r\n\t}\r\n}\r\nexport const sleep=(ms=0)=>new Promise(resolve=>setTimeout(resolve,ms));\r\nexport const degtorad=deg=>deg*Math.PI/180;\r\nexport const radtodeg=rad=>rad*180/Math.PI;\r\n\r\nexport const tileSize=()=>tileWidth();\r\nexport const tileWidth=()=>Game_Map.prototype.tileWidth();\r\nexport const tileHeight=()=>Game_Map.prototype.tileHeight();\r\n\r\n// useful consts\r\nexport const XAxis = new Vector3(1,0,0);\r\nexport const YAxis = new Vector3(0,1,0);\r\nexport const ZAxis = new Vector3(0,0,1);\r\nexport const v2origin = new Vector2(0,0);\r\nexport const v3origin = new Vector3(0,0,0);","const BABYLON = window.BABYLON;\r\nexport const {\r\n\tScene,\r\n\tEngine,\r\n\tFreeCamera,\r\n\tHemisphericLight,\r\n\tDirectionalLight,\r\n\tSpotLight,\r\n\tPointLight,\r\n\tShadowGenerator,\r\n\tVector2,\r\n\tVector3,\r\n\tVector4,\r\n\tColor3,\r\n\tColor4,\r\n\tPlane,\r\n\tNode,\r\n\tTransformNode,\r\n\tTexture,\r\n\tStandardMaterial,\r\n\tMesh,\r\n\tMeshBuilder,\r\n} = BABYLON;\r\n\r\nexport const {\r\n\tFRONTSIDE,BACKSIDE,DOUBLESIDE,\r\n} = Mesh;\r\n\r\nexport const {\r\n\tPERSPECTIVE_CAMERA,\r\n\tORTHOGRAPHIC_CAMERA,\r\n} = BABYLON.Camera;\r\n\r\nexport const{\r\n\tFOGMODE_NONE,\r\n\tFOGMODE_EXP,\r\n\tFOGMODE_EXP2,\r\n\tFOGMODE_LINEAR,\r\n} = Scene;\r\n\r\nexport const WORLDSPACE = BABYLON.Space.WORLD,\r\n             LOCALSPACE = BABYLON.Space.LOCAL,\r\n              BONESPACE = BABYLON.Space.BONE;\r\n\r\nimport mv3d from './mv3d.js';\r\nimport { radtodeg, degtorad } from './util.js';\r\n\r\nTexture.prototype.crop=function(x=0,y=0,w=0,h=0){\r\n\tconst { width, height } = this.getBaseSize();\r\n\tif(!w)w=width-x;\r\n\tif(!h)h=height-y;\r\n\tif(mv3d.EDGE_FIX){ x+=mv3d.EDGE_FIX;y+=mv3d.EDGE_FIX;w-=mv3d.EDGE_FIX*2;h-=mv3d.EDGE_FIX*2; }\r\n\tthis.uScale=w/width;\r\n\tthis.vScale=h/height;\r\n\tthis.uOffset=x/width;\r\n\tthis.vOffset=1-y/height-this.vScale;\r\n}\r\n\r\nObject.defineProperties(Node.prototype,{\r\n\tx:{\r\n\t\tget(){ return this.position?this.position.x:undefined; },\r\n\t\tset(v){ if(this.position){ this.position.x=v; } },\r\n\t},\r\n\ty:{\r\n\t\tget(){ return this.position?-this.position.z:undefined; },\r\n\t\tset(v){ if(this.position){ this.position.z=-v; } },\r\n\t},\r\n\tz:{\r\n\t\tget(){ return this.position?this.position.y:undefined; },\r\n\t\tset(v){ if(this.position){ this.position.y=v; } },\r\n\t},\r\n\r\n\tpitch:{\r\n\t\tget(){ return this.rotation?-radtodeg(this.rotation.x):undefined; },\r\n\t\tset(v){ if(this.rotation){ this.rotation.x=-degtorad(v); } },\r\n\t},\r\n\tyaw:{\r\n\t\tget(){ return this.rotation?-radtodeg(this.rotation.y):undefined; },\r\n\t\tset(v){  if(this.rotation){ this.rotation.y=-degtorad(v); } },\r\n\t},\r\n\troll:{\r\n\t\tget(){ return this.rotation?-radtodeg(this.rotation.z):undefined; },\r\n\t\tset(v){  if(this.rotation){ this.rotation.z=-degtorad(v); } },\r\n\t},\r\n});\r\n\r\n// mesh sorting\r\n\r\nObject.defineProperty(Mesh.prototype,'order',{\r\n\tget(){ return this._order; },\r\n\tset(v){ this._order=v; this._scene.sortMeshes(); }\r\n});\r\nconst meshSorter=(m1,m2)=>(m1._order|0)-(m2._order|0);\r\nScene.prototype.sortMeshes=function(){\r\n\tthis.meshes.sort(meshSorter);\r\n}\r\nconst _addMesh = Scene.prototype.addMesh;\r\nScene.prototype.addMesh=function(mesh){\r\n\t_addMesh.apply(this,arguments);\r\n\tif(typeof mesh._order==='number'){\r\n\t\tthis.sortMeshes();\r\n\t}\r\n}\r\nconst _removeMesh = Scene.prototype.removeMesh;\r\nScene.prototype.removeMesh=function(mesh){\r\n\t_removeMesh.apply(this,arguments);\r\n\tthis.sortMeshes();\r\n}\r\n\r\n// color\r\nColor3.prototype.toNumber=Color4.prototype.toNumber=function(){return this.r*255<<16|this.g*255<<8|this.b*255;}","import { Engine, Scene, HemisphericLight, TransformNode, FreeCamera, Node, Vector2, Vector3, Color3, FOGMODE_LINEAR, DirectionalLight, ShadowGenerator, ORTHOGRAPHIC_CAMERA, PERSPECTIVE_CAMERA } from \"./mod_babylon.js\";\r\nimport { v3origin, degtorad, tileSize } from \"./util.js\";\r\n\r\n\r\nconst mv3d = {\r\n\r\n\tsetup(){\r\n\t\tthis.setupParameters();\r\n\r\n\t\tthis.canvas = document.createElement('canvas');\r\n\t\tthis.texture = PIXI.Texture.fromCanvas(this.canvas);\r\n\t\tthis.engine = new Engine(this.canvas,this.ANTIALIASING);\r\n\t\tthis.scene = new Scene(this.engine);\r\n\t\t//this.scene.clearColor.a=0;\r\n\t\tthis.scene.clearColor.set(0,0,0,0);\r\n\r\n\t\tthis.cameraStick = new TransformNode(\"cameraStick\",this.scene);\r\n\t\tthis.cameraNode = new TransformNode(\"cameraNode\",this.scene);\r\n\t\tthis.cameraNode.parent=this.cameraStick;\r\n\t\tthis.camera = new FreeCamera(\"camera\",new Vector3(0,0,0),this.scene);\r\n\t\tthis.camera.parent=this.cameraNode;\r\n\t\tthis.camera.fov=degtorad(mv3d.FOV);\r\n\t\tthis.camera.orthoLeft=-Graphics.width/2/tileSize();\r\n\t\tthis.camera.orthoRight=Graphics.width/2/tileSize();\r\n\t\tthis.camera.orthoTop=Graphics.height/2/tileSize();\r\n\t\tthis.camera.orthoBottom=-Graphics.height/2/tileSize();\r\n\t\tthis.camera.minZ=0.1;\r\n\t\tthis.camera.maxZ=this.RENDER_DIST;\r\n\r\n\t\t//this.sunlight = new DirectionalLight('sunlight', new Vector3(-1,-1,1), this.scene);\r\n\t\t//this.shadowGenerator = new ShadowGenerator(1024,this.sunlight);\r\n\r\n\t\tthis.scene.ambientColor = new Color3(1,1,1);\r\n\t\tthis.scene.fogMode=FOGMODE_LINEAR;\r\n\r\n\t\tthis.map = new Node(\"map\",this.scene);\r\n\t\tthis.cells={};\r\n\t\tthis.characters=[];\r\n\r\n\t\tthis.setupBlenders();\r\n\t\t//this.updateBlenders(true);\r\n\t\tthis.setupInput();\r\n\r\n\t\tthis.setupSpriteMeshes();\r\n\t},\r\n\r\n\tupdateCanvas(){\r\n\t\tthis.canvas.width = Graphics._width;\r\n\t\tthis.canvas.height = Graphics._height;\r\n\t},\r\n\r\n\trender(){\r\n\t\tthis.scene.render();\r\n\t\tthis.texture.update();\r\n\t},\r\n\r\n\tlastMapUpdate:0,\r\n\tupdate(){\r\n\t\tif( performance.now()-this.lastMapUpdate > 1000 && !this.mapUpdating ){\r\n\t\t\tthis.updateMap();\r\n\t\t\tthis.lastMapUpdate=performance.now();\r\n\t\t}\r\n\r\n\t\tthis.updateAnimations();\r\n\r\n\t\tthis.updateBlenders();\r\n\r\n\t\tthis.updateCharacters();\r\n\r\n\t\t// input\r\n\t\tif( mv3d.KEYBOARD_TURN || this.is1stPerson() ){\r\n\t\t\tif(Input.isTriggered('rotleft')){\r\n\t\t\t\tthis.blendCameraYaw.setValue(this.blendCameraYaw.targetValue()+90,0.5);\r\n\t\t\t}else if(Input.isTriggered('rotright')){\r\n\t\t\t\tthis.blendCameraYaw.setValue(this.blendCameraYaw.targetValue()-90,0.5);\r\n\t\t\t}\r\n\t\t\tif(this.is1stPerson()&&(Input.isTriggered('rotleft')||Input.isTriggered('rotright'))){\r\n\t\t\t\tthis.playerFaceYaw();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif( mv3d.KEYBOARD_PITCH ){\r\n\t\t\tif(Input.isPressed('pageup')&&Input.isPressed('pagedown')){\r\n\t\t\t\t// do nothing\r\n\t\t\t}else if(Input.isPressed('pageup')){\r\n\t\t\t\tthis.blendCameraPitch.setValue(Math.min(180,this.blendCameraPitch.targetValue()+1.5),0.1);\r\n\t\t\t}else if(Input.isPressed('pagedown')){\r\n\t\t\t\tthis.blendCameraPitch.setValue(Math.max(0,this.blendCameraPitch.targetValue()-1.5),0.1);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (const key in this.cells){\r\n\t\t\tthis.cells[key].update();\r\n\t\t}\r\n\t},\r\n\r\n\tloadData(key,dfault){\r\n\t\tif(!$gameVariables || !$gameVariables.mv3d || !(key in $gameVariables.mv3d)){ return dfault; }\r\n\t\treturn $gameVariables.mv3d[key];\r\n\t},\r\n\tsaveData(key,value){\r\n\t\tif(!$gameVariables){ return console.warn(`MV3D: Couldn't save data ${key}:${value}`); }\r\n\t\tif(!$gameVariables.mv3d){ $gameVariables.mv3d={}; }\r\n\t\t$gameVariables.mv3d[key]=value;\r\n\t},\r\n\r\n\tupdateCameraMode(){\r\n\t\tconst mode = this.cameraMode;\r\n\t\tif(mode.startsWith('O')){\r\n\t\t\tif(this.camera.mode!==ORTHOGRAPHIC_CAMERA){ this.camera.mode=ORTHOGRAPHIC_CAMERA; }\r\n\t\t}else{\r\n\t\t\tif(this.camera.mode!==PERSPECTIVE_CAMERA){ this.camera.mode=PERSPECTIVE_CAMERA; }\r\n\t\t}\r\n\t},\r\n\tget cameraMode(){\r\n\t\treturn this.loadData('cameraMode',this.CAMERA_MODE).toUpperCase();\r\n\t},\r\n\tset cameraMode(v){\r\n\t\tv = String(v).toUpperCase().startsWith('O') ? 'ORTHOGRAPHIC' : 'PERSPECTIVE' ;\r\n\t\tthis.saveData('cameraMode',v);\r\n\t\tthis.updateBlenders(true);\r\n\t},\r\n\r\n\tis1stPerson(useCurrent){\r\n\t\tconst k = useCurrent?'currentValue':'targetValue';\r\n\t\treturn this.getCameraTarget()===$gamePlayer && this.blendCameraTransition[k]()<=0\r\n\t\t&& this.blendCameraDist[k]()<=0 && this.blendPanX[k]()===0 && this.blendPanY[k]()===0;\r\n\t},\r\n\r\n\tloopCoords(x,y){\r\n\t\tif($gameMap.isLoopHorizontal()){\r\n\t\t\tconst mapWidth=$gameMap.width();\r\n\t\t\tconst ox = this.cameraStick.x - mapWidth/2;\r\n\t\t\tx=(x-ox).mod(mapWidth)+ox;\r\n\t\t}\r\n\t\tif($gameMap.isLoopVertical()){\r\n\t\t\tconst mapHeight=$gameMap.height();\r\n\t\t\tconst oy = this.cameraStick.y - mapHeight/2;\r\n\t\t\ty=(y-oy).mod(mapHeight)+oy;\r\n\t\t}\r\n\t\treturn new Vector2(x,y);\r\n\t},\r\n\t\r\n\tplayerFaceYaw(){\r\n\t\tlet dir = Math.floor((-mv3d.blendCameraYaw.targetValue()+45)/90).mod(4);\r\n\t\tif(dir>1){ dir+=(dir+1)%2*2-1; }\r\n\t\tdir=10-(dir*2+2);\r\n\t\t$gamePlayer.setDirection(dir);\r\n\t},\r\n\r\n\tdirToYaw(dir){\r\n\t\tlet yaw = dir/2-1;\r\n\t\tif(yaw>1){ yaw+=(yaw+1)%2*2-1; }\r\n\t\tyaw=yaw*-90+180;\r\n\t\treturn yaw;\r\n\t},\r\n\t\r\n\ttransformDirectionYaw(dir,yaw=this.blendCameraYaw.currentValue(),reverse=false){\r\n\t\tif(dir==0){ return 0; }\r\n\t\tdir = dir/2-1;\r\n\t\tif(dir>1){ dir+=(dir+1)%2*2-1; }\r\n\t\tconst c = Math.floor((yaw+45)/90);\r\n\t\tif(reverse){\r\n\t\t\tdir=(dir-c).mod(4);\r\n\t\t}else{\r\n\t\t\tdir=(dir+c).mod(4);\r\n\t\t}\r\n\t\tif(dir>1){ dir+=(dir+1)%2*2-1; }\r\n\t\treturn dir*2+2;\r\n\t},\r\n\r\n}\r\nwindow.mv3d=mv3d;\r\nexport default mv3d;","import mv3d from './mv3d.js';\r\n\r\nconst _graphics_createCanvas=Graphics._createCanvas;\r\nGraphics._createCanvas = function() {\r\n\tmv3d.setup();\r\n\tmv3d.updateCanvas();\r\n\t_graphics_createCanvas.apply(this,arguments);\r\n};\r\n\r\nconst _graphics_updateAllElements=Graphics._updateAllElements;\r\nGraphics._updateAllElements = function() {\r\n\t_graphics_updateAllElements.apply(this,arguments);\r\n\tmv3d.updateCanvas();\r\n};\r\n\r\nconst _graphics_render=Graphics.render;\r\nGraphics.render=function(){\r\n\tmv3d.render();\r\n\t_graphics_render.apply(this,arguments);\r\n};\r\n\r\nconst _sceneMap_update=Scene_Map.prototype.update;\r\nScene_Map.prototype.update = function(){\r\n\t_sceneMap_update.apply(this,arguments);\r\n\tmv3d.update();\r\n}\r\n\r\nShaderTilemap.prototype.renderWebGL = function(renderer) {};\r\n\r\nconst _createTilemap=Spriteset_Map.prototype.createTilemap;\r\nSpriteset_Map.prototype.createTilemap=function(){\r\n\t_createTilemap.apply(this,arguments);\r\n\tthis._tilemap.visible=false;\r\n\tthis._baseSprite.addChild( new PIXI.Sprite(mv3d.texture) );\r\n};\r\n\r\nconst _sprite_char_setchar = Sprite_Character.prototype.setCharacter;\r\nSprite_Character.prototype.setCharacter = function(character) {\r\n\t_sprite_char_setchar.apply(this,arguments);\r\n\tObject.defineProperty(character,'mv_sprite',{\r\n\t\tvalue:this,\r\n\t\tconfigurable:true,\r\n\t});\r\n};\r\n\r\n// Player Transfer\r\n\r\nconst _performTransfer=Game_Player.prototype.performTransfer;\r\nGame_Player.prototype.performTransfer = function() {\r\n\tconst newmap = this._newMapId !== $gameMap.mapId();\r\n\tif(newmap){\r\n\t\tmv3d.clearMap();\r\n\t}\r\n\t_performTransfer.apply(this,arguments);\r\n};\r\n\r\n// On Map Load\r\n\r\nconst _onMapLoaded=Scene_Map.prototype.onMapLoaded;\r\nScene_Map.prototype.onMapLoaded=function(){\r\n\t_onMapLoaded.apply(this,arguments);\r\n\tif(!mv3d.mapLoaded){\r\n\t\tmv3d.loadMap();\r\n\t}\r\n\tmv3d.updateBlenders(true);\r\n};","import mv3d from './mv3d.js';\r\nimport { hexNumber,booleanString,falseString, makeColor } from './util.js';\r\nimport { Vector2 } from './mod_babylon.js';\r\n\r\nconst parameters = PluginManager.parameters('mv3d-babylon');\r\nexport default parameters;\r\n\r\nObject.assign(mv3d,{\r\n\tCAMERA_MODE:\"PERSPECTIVE\",\r\n\tORTHOGRAPHIC_DIST:100,\r\n\r\n\tANIM_DELAY:Number(parameters.animDelay),\r\n\tALPHA_CUTOFF:Math.max(0.01,parameters.alphatest),\r\n\r\n\tEDGE_FIX: Number(parameters.edgefix),\r\n\tANTIALIASING: booleanString(parameters.antialiasing),\r\n\tFOV:Number(parameters.fov),\r\n\r\n\tWALL_HEIGHT:Number(parameters.wallHeight),\r\n\tTABLE_HEIGHT:Number(parameters.tableHeight),\r\n\tFRINGE_HEIGHT:Number(parameters.fringeHeight),\r\n\tCEILING_HEIGHT:Number(parameters.ceilingHeight),\r\n\tLAYER_DIST:Number(parameters.layerDist),\r\n\r\n\tCELL_SIZE:10,\r\n\tRENDER_DIST: Number(parameters.renderDist),\r\n\r\n\tFOG_COLOR: makeColor(parameters.fogColor).toNumber(),\r\n\tFOG_NEAR: Number(parameters.fogNear),\r\n\tFOG_FAR: Number(parameters.fogFar), \r\n\tAMBIENT_COLOR: makeColor(parameters.ambientColor).toNumber(),\r\n\r\n\r\n\tLIGHT_HEIGHT: 0.5,\r\n\tLIGHT_DECAY: 1,\r\n\tLIGHT_DIST: 3,\r\n\tLIGHT_ANGLE: 45,\r\n\r\n\tCHARACTER_SHADOWS:booleanString(parameters.characterShadows),\r\n\tSHADOW_SCALE:Number(parameters.shadowScale),\r\n\tSHADOW_DIST:Number(parameters.shadowDist),\r\n\r\n\tKEYBOARD_PITCH: booleanString(parameters.keyboardPitch),\r\n\tKEYBOARD_TURN: booleanString(parameters.keyboardTurn),\r\n\tKEYBOARD_STRAFE: booleanString(parameters.keyboardStrafe),\r\n\r\n\tREGION_DATA:{},\r\n\tTTAG_DATA:{},\r\n\r\n\tEVENT_HEIGHT:Number(parameters.eventHeight),\r\n\tVEHICLE_BUSH:booleanString(parameters.vehicleBush),\r\n\tBOAT_SETTINGS:JSON.parse(parameters.boatSettings),\r\n\tSHIP_SETTINGS:JSON.parse(parameters.shipSettings),\r\n\tAIRSHIP_SETTINGS:JSON.parse(parameters.airshipSettings),\r\n\r\n\r\n\tsetupParameters(){\r\n\t\tfor (let entry of JSON.parse(parameters.regions)){\r\n\t\t\tentry=JSON.parse(entry);\r\n\t\t\tthis.REGION_DATA[entry.regionId]={\r\n\t\t\t\theight: Number(entry.height),\r\n\t\t\t};\r\n\t\t}\r\n\t\tfor (let entry of JSON.parse(parameters.ttags)){\r\n\t\t\tentry=JSON.parse(entry);\r\n\t\t\tthis.TTAG_DATA[entry.terrainTag]={\r\n\t\t\t\theight: Number(entry.height),\r\n\t\t\t\toffsetTop: new Vector2(Number(entry.topOffsetX),Number(entry.topOffsetY)),\r\n\t\t\t\toffsetSide: new Vector2(Number(entry.sideOffsetX),Number(entry.sideOffsetY)),\r\n\t\t\t\tshape: this.configurationShapes[entry.shape.toUpperCase()],\r\n\t\t\t};\r\n\t\t}\r\n\r\n\t\tthis.BOAT_SETTINGS.scale=Number(this.BOAT_SETTINGS.scale);\r\n\t\tthis.BOAT_SETTINGS.zoff=Number(this.BOAT_SETTINGS.zoff);\r\n\t\tthis.BOAT_SETTINGS.big=booleanString(this.BOAT_SETTINGS.big);\r\n\t\tthis.SHIP_SETTINGS.scale=Number(this.SHIP_SETTINGS.scale);\r\n\t\tthis.SHIP_SETTINGS.zoff=Number(this.SHIP_SETTINGS.zoff);\r\n\t\tthis.SHIP_SETTINGS.big=booleanString(this.SHIP_SETTINGS.big);\r\n\t\tthis.AIRSHIP_SETTINGS.scale=Number(this.AIRSHIP_SETTINGS.scale);\r\n\t\tthis.AIRSHIP_SETTINGS.height=Number(this.AIRSHIP_SETTINGS.height);\r\n\t\tthis.AIRSHIP_SETTINGS.shadowScale=Number(this.AIRSHIP_SETTINGS.shadowScale);\r\n\t\tthis.AIRSHIP_SETTINGS.shadowDist=Number(this.AIRSHIP_SETTINGS.shadowDist);\r\n\t\tthis.AIRSHIP_SETTINGS.big=booleanString(this.AIRSHIP_SETTINGS.big);\r\n\t\tthis.AIRSHIP_SETTINGS.bushLanding=booleanString(this.AIRSHIP_SETTINGS.bushLanding);\r\n\r\n\r\n\t\tthis.EVENT_SHAPE=this.configurationShapes[parameters.eventShape.toUpperCase()];\r\n\t},\r\n});","import mv3d from './mv3d.js';\r\nimport { hexNumber, ZAxis } from \"./util.js\";\r\nimport parameters from './parameters.js';\r\nimport { ORTHOGRAPHIC_CAMERA, LOCALSPACE } from './mod_babylon.js';\r\n\r\nObject.assign(mv3d,{\r\n\r\n\tcameraTargets:[],\r\n\tgetCameraTarget(){\r\n\t\treturn this.cameraTargets[0];\r\n\t},\r\n\tsetCameraTarget(char,time){\r\n\t\tif(!char){ this.cameraTargets.length=0; return; }\r\n\t\tthis.cameraTargets.unshift(char);\r\n\t\tif(this.cameraTargets.length>2){ this.cameraTargets.length=2; }\r\n\t\tthis.saveData('cameraTarget',this.getTargetString(char));\r\n\t\tthis.blendCameraTransition.value=1;\r\n\t\tthis.blendCameraTransition.setValue(0,time);\r\n\t},\r\n\tclearCameraTarget(){\r\n\t\tthis.cameraTargets.length=0;\r\n\t},\r\n\tresetCameraTarget(){\r\n\t\tthis.clearCameraTarget();\r\n\t\tthis.setCameraTarget($gamePlayer,0);\r\n\t},\r\n\trememberCameraTarget(){\r\n\t\tconst target = this.loadData('cameraTarget');\r\n\t\tif(target){\r\n\t\t\tthis.setCameraTarget(this.targetChar(target),0);\r\n\t\t}\r\n\t},\r\n\r\n\tsetupBlenders(){\r\n\t\tthis.blendFogColor = new ColorBlender('fogColor',this.FOG_COLOR);\r\n\t\tthis.blendFogNear = new Blender('fogNear',this.FOG_NEAR);\r\n\t\tthis.blendFogFar = new Blender('fogFar',this.FOG_FAR);\r\n\t\tthis.blendCameraYaw = new Blender('cameraYaw',0);\r\n\t\tthis.blendCameraYaw.cycle=360;\r\n\t\tthis.blendCameraPitch = new Blender('cameraPitch',60);\r\n\t\tthis.blendCameraPitch.min=0;\r\n\t\tthis.blendCameraPitch.max=180;\r\n\t\tthis.blendCameraDist = new Blender('cameraDist',10);\r\n\t\tthis.blendCameraHeight = new Blender('cameraHeight',0.7);\r\n\t\tthis.blendAmbientColor = new ColorBlender('ambientColor',this.AMBIENT_COLOR);\r\n\t\tthis.blendSunlightColor = new ColorBlender('light_color',0xffffff);\r\n\t\tthis.blendSunlightIntensity = new Blender('light_intensity',1);\r\n\t\tthis.blendPanX = new Blender('panX',0);\r\n\t\tthis.blendPanY = new Blender('panY',0);\r\n\t\tthis.blendCameraTransition = new Blender('cameraTransition',0);\r\n\t},\r\n\r\n    updateBlenders(reorient){\r\n\t\tthis.updateCameraMode();\r\n\t\t// camera target & pan\r\n\t\tif(!this.cameraTargets.length){\r\n\t\t\tif($gamePlayer){\r\n\t\t\t\tthis.cameraTargets[0]=$gamePlayer;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(this.blendCameraTransition.update() && this.cameraTargets.length>=2){\r\n\t\t\tconst t = this.blendCameraTransition.currentValue();\r\n\t\t\tlet char1=this.cameraTargets[0];\r\n\t\t\tif(char1===$gamePlayer&&$gamePlayer.isInVehicle()){ char1=$gamePlayer.vehicle(); }\r\n\t\t\tlet char2=this.cameraTargets[1];\r\n\t\t\tif(char2===$gamePlayer&&$gamePlayer.isInVehicle()){ char2=$gamePlayer.vehicle(); }\r\n\t\t\tthis.cameraStick.x = char1._realX*(1-t) + char2._realX*t;\r\n\t\t\tthis.cameraStick.y = char1._realY*(1-t) + char2._realY*t;\r\n\t\t\tif(char1.mv3d_sprite&&char2.mv3d_sprite){\r\n\t\t\t\tthis.cameraStick.z = char1.mv3d_sprite.z*(1-t) + char2.mv3d_sprite.z*t;\r\n\t\t\t}else if(char1.mv3d_sprite){\r\n\t\t\t\tthis.cameraStick.z=char1.mv3d_sprite.z;\r\n\t\t\t}\r\n\t\t}else if(this.cameraTargets.length){\r\n\t\t\tlet char = this.getCameraTarget();\r\n\t\t\tif(char===$gamePlayer&&$gamePlayer.isInVehicle()){ char=$gamePlayer.vehicle(); }\r\n\t\t\tthis.cameraStick.x=char._realX;\r\n\t\t\tthis.cameraStick.y=char._realY;\r\n\t\t\tif(char.mv3d_sprite){\r\n\t\t\t\tthis.cameraStick.z=char.mv3d_sprite.z;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.blendPanX.update();\r\n\t\tthis.blendPanY.update();\r\n\t\tthis.cameraStick.x+=this.blendPanX.currentValue();\r\n\t\tthis.cameraStick.y+=this.blendPanY.currentValue();\r\n\r\n\t\t// camera yaw, pitch, dist & height\r\n\t\tif(reorient|this.blendCameraPitch.update()|this.blendCameraYaw.update()\r\n\t\t|this.blendCameraDist.update()|this.blendCameraHeight.update()){\r\n\t\t\tthis.cameraNode.pitch = this.blendCameraPitch.currentValue()-90;\r\n\t\t\tthis.cameraNode.yaw = this.blendCameraYaw.currentValue();\r\n\t\t\tthis.cameraNode.position.set(0,0,0);\r\n\t\t\tthis.cameraNode.translate(ZAxis,-this.blendCameraDist.currentValue(),LOCALSPACE);\r\n\t\t\tif(this.camera.mode===ORTHOGRAPHIC_CAMERA){\r\n\t\t\t\t//this.camera.zoom=10/this.blendCameraDist.currentValue();\r\n\t\t\t\t//this.camera.updateProjectionMatrix();\r\n\t\t\t\tthis.camera.maxZ=this.RENDER_DIST;\r\n\t\t\t\tthis.camera.minZ=-this.RENDER_DIST;\r\n\t\t\t}else{\r\n\t\t\t\t\r\n\t\t\t\tif(this.cameraNode.z<0){ this.cameraNode.z=0; }\r\n\t\t\t\tthis.camera.maxZ=this.RENDER_DIST;\r\n\t\t\t\tthis.camera.minZ=0.1;\r\n\t\t\t}\r\n\t\t\tthis.cameraNode.z += this.blendCameraHeight.currentValue();\r\n\t\t}\r\n\r\n\t\t//fog\r\n\t\tif(reorient|this.blendFogColor.update()|this.blendFogNear.update()|this.blendFogFar.update()){\r\n\t\t\tthis.scene.fogStart=this.blendFogNear.currentValue();\r\n\t\t\tthis.scene.fogEnd=this.blendFogFar.currentValue();\r\n\t\t\tthis.scene.fogColor.copyFromFloats(\r\n\t\t\t\tthis.blendFogColor.r.currentValue()/255,\r\n\t\t\t\tthis.blendFogColor.g.currentValue()/255,\r\n\t\t\t\tthis.blendFogColor.b.currentValue()/255,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\t//light\r\n\t\tif(reorient|this.blendAmbientColor.update()){\r\n\t\t\tthis.scene.ambientColor.copyFromFloats(\r\n\t\t\t\tthis.blendAmbientColor.r.currentValue()/255,\r\n\t\t\t\tthis.blendAmbientColor.g.currentValue()/255,\r\n\t\t\t\tthis.blendAmbientColor.b.currentValue()/255,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t},\r\n\r\n});\r\n\r\n\r\nexport class Blender{\r\n\tconstructor(key,dfault){\r\n\t\tthis.key=key;\r\n\t\tthis.dfault=mv3d.loadData(key,dfault);\r\n\t\tthis.value=dfault;\r\n\t\tthis.speed=1;\r\n\t\tthis.max=Infinity;\r\n\t\tthis.min=-Infinity;\r\n\t\tthis.cycle=false;\r\n\t}\r\n\tsetValue(target,time=0){\r\n\t\ttarget = Math.min(this.max,Math.max(this.min,target));\r\n\t\tlet diff = target - this.value;\r\n\t\tif(!diff){ return; }\r\n\t\tthis.saveValue(this.key,target);\r\n\t\tif(this.cycle){\r\n\t\t\twhile ( Math.abs(diff)>this.cycle/2 ){\r\n\t\t\t\tthis.value += Math.sign(diff)*this.cycle;\r\n\t\t\t\tdiff = target - this.value;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.speed = Math.abs(diff)/(60*time);\r\n\t}\r\n\tcurrentValue(){ return this.value; }\r\n\ttargetValue(){ return this.loadValue(this.key); }\r\n\tdefaultValue(){ return this.dfault; }\r\n\tupdate(){\r\n\t\tconst target = this.targetValue();\r\n\t\tif(this.value===target){ return false; }\r\n\t\tconst diff = target - this.value;\r\n\t\tif(this.speed > Math.abs(diff)){\r\n\t\t\tthis.value=target;\r\n\t\t}else{\r\n\t\t\tthis.value+=this.speed*Math.sign(diff);\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\tstorageLocation(){\r\n\t\tif(!$gameVariables){\r\n\t\t\tconsole.warn(`MV3D: Couldn't get Blend storage location.`);\r\n\t\t\treturn {};\r\n\t\t}\r\n\t\tif(!$gameVariables.mv3d){ $gameVariables.mv3d = {}; }\r\n\t\treturn $gameVariables.mv3d;\r\n\t}\r\n\tloadValue(key){\r\n\t\tconst storage = this.storageLocation();\r\n\t\tif(!(key in storage)){ return this.dfault; }\r\n\t\treturn storage[key];\r\n\t}\r\n\tsaveValue(key,value){\r\n\t\tconst storage = this.storageLocation();\r\n\t\tstorage[key]=value;\r\n\t}\r\n}\r\n\r\nexport class ColorBlender{\r\n\tconstructor(key,dfault){\r\n\t\tthis.dfault=dfault;\r\n\t\tthis.r=new Blender(`${key}_r`,dfault>>16);\r\n\t\tthis.g=new Blender(`${key}_g`,dfault>>8&0xff);\r\n\t\tthis.b=new Blender(`${key}_b`,dfault&0xff);\r\n\t}\r\n\tsetValue(color,time){\r\n\t\tthis.r.setValue(color>>16,time);\r\n\t\tthis.g.setValue(color>>8&0xff,time);\r\n\t\tthis.b.setValue(color&0xff,time);\r\n\t}\r\n\tcurrentValue(){\r\n\t\treturn this.r.value<<16|this.g.value<<8|this.b.value;\r\n\t}\r\n\ttargetValue(){\r\n\t\treturn this.r.targetValue()<<16|this.g.targetValue()<<8|this.b.targetValue();\r\n\t}\r\n\tdefaultValue(){ return this.dfault; }\r\n\tupdate(){\r\n\t\tlet ret=0;\r\n\t\tret|=this.r.update();\r\n\t\tret|=this.g.update();\r\n\t\tret|=this.b.update();\r\n\t\treturn Boolean(ret);\r\n\t}\r\n\tget storageLocation(){ return this.r.storageLocation; }\r\n\tset storageLocation(v){\r\n\t\tthis.r.storageLocation=v;\r\n\t\tthis.g.storageLocation=v;\r\n\t\tthis.b.storageLocation=v;\r\n\t}\r\n\tcurrentComponents(){\r\n\t\treturn [this.r.currentValue()/255,this.g.currentValue()/255,this.b.currentValue()/255];\r\n\t}\r\n\ttargetComponents(){\r\n\t\treturn [this.r.targetValue()/255,this.g.targetValue()/255,this.b.targetValue()/255];\r\n\t}\r\n}","import mv3d from './mv3d.js';\r\n\r\nObject.assign(Input.keyMapper,{\r\n\t81:'rotleft',  // Q\r\n\t69:'rotright', // E\r\n\t87:'up',       // W\r\n\t65:'left',     // A\r\n\t83:'down',     // S\r\n\t68:'right',    // D\r\n});\r\n\r\nmv3d.setupInput=function(){\r\n\tconst descriptors={\r\n\t\tleft:getInputDescriptor('left','left','rotleft'),\r\n\t\trotleft:getInputDescriptor('pageup','rotleft', mv3d.KEYBOARD_STRAFE?'left':undefined),\r\n\t\tright:getInputDescriptor('right','right','rotright'),\r\n\t\trotright:getInputDescriptor('pagedown','rotright', mv3d.KEYBOARD_STRAFE?'right':undefined),\r\n\t}\r\n\tObject.defineProperties(Input.keyMapper,{\r\n\t\t37:descriptors.left, // left arrow\r\n\t\t39:descriptors.right,// right arrow\r\n\t\t81:descriptors.rotleft, //Q\r\n\t\t69:descriptors.rotright,//E\r\n\t\t65:descriptors.left, //A\r\n\t\t68:descriptors.right,//D\r\n\t});\r\n}\r\n\r\nfunction getInputDescriptor(menumode,p3mode,p1mode){\r\n\tlet assignedValue=undefined;\r\n\treturn {\r\n\t\tconfigurable:true,\r\n\t\tget(){\r\n\t\t\tif(assignedValue!=undefined){ return assignedValue; }\r\n\t\t\tif(!(SceneManager._scene instanceof Scene_Map)){ return menumode; }\r\n\t\t\tif(mv3d.is1stPerson()){ return p1mode; }\r\n\t\t\treturn p3mode;\r\n\t\t},\r\n\t\tset(v){ assignedValue=v; },\r\n\t};\r\n}\r\n\r\nGame_Player.prototype.getInputDirection = function() {\r\n\tlet dir = Input.dir4;\r\n\treturn mv3d.transformDirectionYaw(dir,mv3d.blendCameraYaw.currentValue(),true);\r\n};\r\n\r\nconst _player_updateMove = Game_Player.prototype.updateMove;\r\nGame_Player.prototype.updateMove = function() {\r\n\t_player_updateMove.apply(this,arguments);\r\n\tif ( !this.isMoving() && mv3d.is1stPerson() ) {\r\n\t\tmv3d.playerFaceYaw();\r\n\t}\r\n};\r\nconst _player_move_straight=Game_Player.prototype.moveStraight;\r\nGame_Player.prototype.moveStraight = function(d) {\r\n\t_player_move_straight.apply(this,arguments);\r\n\tif(!this.isMovementSucceeded()&&mv3d.is1stPerson()){\r\n\t\tmv3d.playerFaceYaw();\r\n\t}\r\n};\r\n\r\nconst raycastPredicate=mesh=>{\r\n\tif(!mesh.isEnabled() || !mesh.isVisible || !mesh.isPickable){ return false; }\r\n\tif(mesh.character){\r\n\t\tif(mesh.character.isFollower||mesh.character.isPlayer){ return false; }\r\n\t}\r\n\treturn true;\r\n}\r\n\r\nScene_Map.prototype.processMapTouch = function() {\r\n\tif (TouchInput.isTriggered() || this._touchCount > 0) {\r\n\t\tif (TouchInput.isPressed()) {\r\n\t\t\tif (this._touchCount === 0 || this._touchCount >= 15) {\r\n\t\t\t\t\r\n\t\t\t\tconst intersection = mv3d.scene.pick(TouchInput.x,TouchInput.y,raycastPredicate);\r\n\t\t\t\tif(intersection.hit){\r\n\t\t\t\t\tconst point = {x:intersection.pickedPoint.x, y:-intersection.pickedPoint.z};\r\n\t\t\t\t\tconst mesh = intersection.pickedMesh;\r\n\t\t\t\t\tif(mesh.character){\r\n\t\t\t\t\t\tpoint.x=mesh.character.x;\r\n\t\t\t\t\t\tpoint.y=mesh.character.y;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t$gameTemp.setDestination(Math.round(point.x), Math.round(point.y));\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\t\t\tthis._touchCount++;\r\n\t\t} else {\r\n\t\t\tthis._touchCount = 0;\r\n\t\t}\r\n\t}\r\n};\r\n\r\nconst _player_findDirectionTo=Game_Player.prototype.findDirectionTo;\r\nGame_Player.prototype.findDirectionTo=function(){\r\n\tconst dir = _player_findDirectionTo.apply(this,arguments);\r\n\tif(mv3d.is1stPerson() && dir){\r\n\t\tlet yaw = mv3d.dirToYaw(dir);\r\n\r\n\t\tmv3d.blendCameraYaw.setValue(yaw,0.25);\r\n\t}\r\n\treturn dir;\r\n}","import mv3d from './mv3d.js';\r\nimport { FRONTSIDE, BACKSIDE, DOUBLESIDE, Vector2 } from './mod_babylon.js';\r\nimport { makeColor, relativeNumber, booleanString } from './util.js';\r\n\r\nObject.assign(mv3d,{\r\n\ttilesetConfigurations:{},\r\n\tmapConfigurations:{},\r\n\tloadMapSettings(){\r\n\t\t//tileset\r\n\t\tthis.tilesetConfigurations={};\r\n\t\tconst lines = this.readConfigurationBlocks($gameMap.tileset().note);\r\n\t\tconst readLines = /^\\s*([abcde]\\d?\\s*,\\s*\\d+\\s*,\\s*\\d+)\\s*:(.*)$/gmi;\r\n\t\tlet match;\r\n\t\twhile(match = readLines.exec(lines)){\r\n\t\t\tconst key = match[1];\r\n\t\t\tconst conf = this.readConfigurationFunctions(match[2],this.tilesetConfigurationFunctions);\r\n\t\t\tconst tileId=this.constructTileId(...key.split(','));\r\n\t\t\tif(tileId in this.tilesetConfigurations){\r\n\t\t\t\tObject.assign(this.tilesetConfigurations[tileId],conf);\r\n\t\t\t}else{\r\n\t\t\t\tthis.tilesetConfigurations[tileId]=conf;\r\n\t\t\t}\r\n\t\t}\r\n\t\t//map\r\n\t\tconst mapconf=this.mapConfigurations={};\r\n\t\tthis.readConfigurationFunctions(\r\n\t\t\tthis.readConfigurationBlocks($dataMap.note),\r\n\t\t\tthis.mapConfigurationFunctions,\r\n\t\t\tmapconf,\r\n        );\r\n        \r\n\t\tif('fog' in mapconf){\r\n\t\t\tconst fog = mapconf.fog;\r\n\t\t\tif('color' in fog){ this.blendFogColor.setValue(fog.color,0); }\r\n\t\t\tif('near' in fog){ this.blendFogNear.setValue(fog.near,0); }\r\n\t\t\tif('far' in fog){ this.blendFogFar.setValue(fog.far,0); }\r\n\t\t}\r\n\t\tif('light' in mapconf){\r\n\t\t\tthis.blendAmbientColor.setValue(mapconf.light.color,0);\r\n\t\t\t//this.blendLightIntensity.setValue(mapconf.light.intensity,0);\r\n\t\t}\r\n\t\tif('cameraDist' in mapconf){\r\n\t\t\tthis.blendCameraDist.setValue(mapconf.cameraDist,0);\r\n\t\t}\r\n\t\tif ('cameraHeight' in mapconf){\r\n\t\t\tthis.blendCameraHeight.setValue(mapconf.cameraHeight,0);\r\n\t\t}\r\n\t\tif('cameraMode' in mapconf){\r\n\t\t\tthis.cameraMode=mapconf.cameraMode;\r\n\t\t}\r\n\t\tif('cameraPitch' in mapconf){\r\n\t\t\tthis.blendCameraPitch.setValue(mapconf.cameraPitch,0);\r\n\t\t}\r\n\t\tif('cameraYaw' in mapconf){\r\n\t\t\tthis.blendCameraYaw.setValue(mapconf.cameraYaw,0);\r\n\t\t}\r\n    },\r\n    \r\n\r\n\tgetMapConfig(key,dfault){\r\n\t\tif(key in this.mapConfigurations){\r\n\t\t\treturn this.mapConfigurations[key];\r\n\t\t}\r\n\t\treturn dfault;\r\n\t},\r\n\r\n\treadConfigurationBlocks(note){\r\n\t\tconst findBlocks = /<MV3D>([\\s\\S]*?)<\\/MV3D>/gi;\r\n\t\tlet contents = '';\r\n\t\tlet match;\r\n\t\twhile(match = findBlocks.exec(note)){\r\n\t\t\tcontents += match[1]+'\\n';\r\n\t\t}\r\n\t\treturn contents;\r\n\t},\r\n\r\n\treadConfigurationTags(note){\r\n\t\tconst findTags = /<MV3D:([\\s\\S]*?)>/gi;\r\n\t\tlet contents='';\r\n\t\tlet match;\r\n\t\twhile(match = findTags.exec(note)){\r\n\t\t\tcontents+=match[1]+'\\n';\r\n\t\t}\r\n\t\treturn contents;\r\n\t},\r\n\r\n\treadConfigurationFunctions(line,functionset=mv3d.configurationFunctions,conf={}){\r\n\t\tconst readConfigurations = /(\\w+)\\((.*?)\\)/g\r\n\t\tlet match;\r\n\t\twhile(match = readConfigurations.exec(line)){\r\n\t\t\tconst key = match[1].toLowerCase();\r\n\t\t\tif(key in functionset){\r\n\t\t\t\tfunctionset[key](conf,...match[2].split(','));\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn conf;\r\n\t},\r\n\r\n\tconfigurationSides:{\r\n\t\tfront:FRONTSIDE,\r\n\t\tback:BACKSIDE,\r\n\t\tdouble:DOUBLESIDE,\r\n\t},\r\n\tconfigurationShapes:{\r\n\t\tFLAT:1,\r\n\t\tTREE:2,\r\n\t\tSPRITE:3,\r\n\t\tFENCE:4,\r\n\t\tCROSS:5,\r\n\t\tXCROSS:6,\r\n    },\r\n    \r\n\r\n\ttilesetConfigurationFunctions:{\r\n\t\theight(conf,n){ conf.height=Number(n); },\r\n\t\tfringe(conf,n){ conf.fringe=Number(n); },\r\n\t\tfloat(conf,n){ conf.float=Number(n); },\r\n\t\ttexture(conf,img,x,y){\r\n\t\t\tconst tileId = mv3d.constructTileId(img,x,y)\r\n\t\t\tconf.sideId = conf.topId = tileId;\r\n\t\t},\r\n\t\ttop(conf,img,x,y){ conf.topId=mv3d.constructTileId(img,x,y); },\r\n\t\tside(conf,img,x,y){ conf.sideId=mv3d.constructTileId(img,x,y); },\r\n\t\tinside(conf,img,x,y){ conf.insideId=mv3d.constructTileId(img,x,y); },\r\n\t\toffset(conf,x,y){\r\n\t\t\tconf.offsetSide = conf.offsetTop = new Vector2(Number(x),Number(y));\r\n\t\t},\r\n\t\toffsettop(conf,x,y){\r\n\t\t\tconf.offsetTop = new Vector2(Number(x),Number(y));\r\n\t\t},\r\n\t\toffsetside(conf,x,y){\r\n\t\t\tconf.offsetSide = new Vector2(Number(x),Number(y));\r\n\t\t},\r\n\t\toffsetinside(conf,x,y){\r\n\t\t\tconf.offsetInside = new Vector2(Number(x),Number(y));\r\n\t\t},\r\n\t\trect(conf,img,x,y,w,h){\r\n\t\t\tthis.recttop(conf,img,x,y,w,h);\r\n\t\t\tthis.rectside(conf,img,x,y,w,h);\r\n\t\t},\r\n\t\trecttop(conf,img,x,y,w,h){\r\n\t\t\tconf.topId = mv3d.constructTileId(img,0,0);\r\n\t\t\tconf.rectTop = new PIXI.Rectangle(x,y,w,h);\r\n\t\t\tconf.rectTop.setN = mv3d.getSetNumber(conf.topId);\r\n\t\t},\r\n\t\trectside(conf,img,x,y,w,h){\r\n\t\t\tconf.sideId = mv3d.constructTileId(img,0,0);\r\n\t\t\tconf.rectSide = new PIXI.Rectangle(x,y,w,h);\r\n\t\t\tconf.rectSide.setN = mv3d.getSetNumber(conf.sideId);\r\n\t\t},\r\n\t\trectinside(conf,img,x,y,w,h){\r\n\t\t\tconf.insideId = mv3d.constructTileId(img,0,0);\r\n\t\t\tconf.rectInside = new PIXI.Rectangle(x,y,w,h);\r\n\t\t\tconf.rectInside.setN = mv3d.getSetNumber(conf.insideId);\r\n\t\t},\r\n\t\tshape(conf,name){\r\n\t\t\tconf.shape=mv3d.configurationShapes[name.toUpperCase()];\r\n\t\t},\r\n\t\talpha(conf,n){\r\n\t\t\tconf.transparent=true;\r\n\t\t\tconf.alpha=Number(n);\r\n\t\t},\r\n\t\tglow(conf,n){ conf.glow=Number(n); },\r\n\t},\r\n\teventConfigurationFunctions:{\r\n\t\theight(conf,n){\r\n\t\t\tconf.height=Number(n);\r\n\t\t},\r\n\t\tz(conf,n){ conf.z=Number(n); },\r\n\t\tx(conf,n){ conf.x=Number(n); },\r\n\t\ty(conf,n){ conf.y=Number(n); },\r\n\t\tside(conf,name){ conf.side=mv3d.configurationSides[name.toLowerCase()]; },\r\n\t\tscale(conf,x,y){ conf.scale = new Vector2(Number(x),Number(y)); },\r\n\t\trot(conf,n){ conf.rot=Number(n); },\r\n\t\tbush(conf,bool){ conf.bush = bool.toLowerCase()=='true'; },\r\n\t\tshadow(conf,bool){ conf.shadow = bool.toLowerCase()=='true'; },\r\n\t\tshadowscale(conf,n){ conf.shadowScale = Number(n); },\r\n\t\tshape(conf,name){\r\n\t\t\tconf.shape=mv3d.configurationShapes[name.toUpperCase()];\r\n\t\t},\r\n\t\tpos(conf,x,y){\r\n\t\t\tconf.pos={x:x,y:y};\r\n\t\t},\r\n\t\tlight(){ this.lamp(...arguments); },\r\n\t\tlamp(conf,color='ffffff',intensity=1,distance=mv3d.LIGHT_DIST){\r\n\t\t\tconf.lamp={color:makeColor(color).toNumber(),intensity:Number(intensity),distance:Number(distance)};\r\n\t\t},\r\n\t\tflashlight(conf,color='ffffff',intensity=1,distance=mv3d.LIGHT_DIST,angle=mv3d.LIGHT_ANGLE){\r\n\t\t\tconf.flashlight={color:makeColor(color).toNumber(),intensity:Number(intensity),distance:Number(distance),angle:Number(angle)};\r\n\t\t},\r\n\t\tflashlightpitch(conf,deg='90'){ conf.flashlightPitch=Number(deg); },\r\n\t\tflashlightyaw(conf,deg='+0'){ conf.flashlightYaw=deg; },\r\n\t\tlightheight(conf,n=1){ conf.lightHeight = Number(n); },\r\n\t\tlightoffset(conf,x=0,y=0){ conf.lightOffset = {x:+x,y:+y}; },\r\n\t\talphatest(conf,n=1){ conf.alphaTest = Number(n); }\r\n\t},\r\n\tmapConfigurationFunctions:{\r\n\t\tlight(conf,color){\r\n\t\t\tconf.light={color:makeColor(color).toNumber()};\r\n\t\t},\r\n\t\tfog(conf,color,near,far){\r\n\t\t\tif(!conf.fog){ conf.fog={}; }\r\n\t\t\tcolor=makeColor(color).toNumber(); near=Number(near); far=Number(far);\r\n\t\t\tif(!Number.isNaN(color)){ conf.fog.color=color; }\r\n\t\t\tif(!Number.isNaN(near)){ conf.fog.near=near; }\r\n\t\t\tif(!Number.isNaN(far)){ conf.fog.far=far; }\r\n\t\t},\r\n\t\tyaw(conf,n){this.camerayaw(conf,n);},\r\n\t\tpitch(conf,n){this.camerapitch(conf,n);},\r\n\t\tcamerayaw(conf,n){ conf.cameraYaw=Number(n); },\r\n\t\tcamerapitch(conf,n){ conf.cameraPitch=Number(n); },\r\n\t\tdist(conf,n){ this.cameradist(conf,n); },\r\n\t\tcameradist(conf,n){ conf.cameraDist=Number(n); },\r\n\t\theight(conf,n){ this.cameraheight(conf,n); },\r\n\t\tcameraheight(conf,n){ conf.cameraHeight=Number(n); },\r\n\t\tmode(conf,mode){ this.cameramode(conf,mode); },\r\n\t\tcameramode(conf,mode){ conf.cameraMode=mode; },\r\n\t\tedge(conf,bool){ conf.edge = booleanString(bool); },\r\n\t\tceiling(conf,img,x,y,height=mv3d.CEILING_HEIGHT){\r\n\t\t\tconf.ceiling = mv3d.constructTileId(img,x,y);\r\n\t\t\tconf.ceilingHeight = height;\r\n\t\t},\r\n\t},\r\n\r\n});\r\n\r\n// event config\r\nconst _event_setupPage = Game_Event.prototype.setupPage;\r\nGame_Event.prototype.setupPage = function() {\r\n\t_event_setupPage.apply(this,arguments);\r\n\tif(this.mv3d_sprite){\r\n\t\tthis.mv3d_needsConfigure=true;\r\n\t\tthis.mv3d_sprite.eventConfigure();\r\n\t}\r\n};\r\n\r\nconst _event_init = Game_Event.prototype.initialize;\r\nGame_Event.prototype.initialize = function() {\r\n\t_event_init.apply(this,arguments);\r\n\tif(mv3d.mapLoaded){\r\n\t\tmv3d.createCharacterFor(this);\r\n\t}\r\n\tconst event = this.event();\r\n\tlet config = {};\r\n\tmv3d.readConfigurationFunctions(\r\n\t\tmv3d.readConfigurationTags(event.note),\r\n\t\tmv3d.eventConfigurationFunctions,\r\n\t\tconfig,\r\n\t);\r\n\tif('pos' in config){\r\n\t\tthis.locate(\r\n\t\t\trelativeNumber(event.x,config.pos.x),\r\n\t\t\trelativeNumber(event.y,config.pos.y),\r\n\t\t);\r\n\t}\r\n\tif(!this.mv3d_blenders){\r\n\t\tthis.mv3d_blenders={};\r\n\t}\r\n\tif('lamp' in config){\r\n\t\tthis.mv3d_blenders.lampColor_r=config.lamp.color>>16;\r\n\t\tthis.mv3d_blenders.lampColor_g=config.lamp.color>>8&0xff;\r\n\t\tthis.mv3d_blenders.lampColor_b=config.lamp.color&0xff;\r\n\t\tthis.mv3d_blenders.lampIntensity=config.lamp.intensity;\r\n\t\tthis.mv3d_blenders.lampDistance=config.lamp.distance\r\n\t}\r\n\tif('flashlight' in config){\r\n\t\tthis.mv3d_blenders.flashlightColor_r=config.flashlight.color>>16;\r\n\t\tthis.mv3d_blenders.flashlightColor_g=config.flashlight.color>>8&0xff;\r\n\t\tthis.mv3d_blenders.flashlightColor_b=config.flashlight.color&0xff;\r\n\t\tthis.mv3d_blenders.flashlightIntensity=config.flashlight.intensity;\r\n\t\tthis.mv3d_blenders.flashlightDistance=config.flashlight.distance;\r\n\t\tthis.mv3d_blenders.flashlightAngle=config.flashlight.angle;\r\n\t}\r\n\tif('flashlightPitch' in config){\r\n\t\tthis.mv3d_blenders.flashlightPitch=Number(config.flashlightPitch);\r\n\t}\r\n\tif('flashlightYaw' in config){\r\n\t\tthis.mv3d_blenders.flashlightYaw=config.flashlightYaw;\r\n\t}\r\n\tthis.mv3d_needsConfigure=true;\r\n};","import mv3d from './mv3d.js';\r\nimport { makeColor, relativeNumber } from './util.js';\r\n\r\nconst _pluginCommand = Game_Interpreter.prototype.pluginCommand;\r\nGame_Interpreter.prototype.pluginCommand = function(command, args) {\r\n\tif(command.toLowerCase() !== 'mv3d'){\r\n\t\treturn _pluginCommand.apply(this,arguments);\r\n\t}\r\n\tconst pc = new mv3d.PluginCommand();\r\n\tpc.INTERPRETER=this;\r\n\tpc.FULL_COMMAND=[command,...args].join(' ');\r\n\targs=args.filter(v=>v);\r\n\tpc.CHAR=$gameMap.event(this._eventId);\r\n\tif(args[0]){\r\n\t\tconst firstChar = args[0][0];\r\n\t\tif(firstChar==='@'||firstChar===''){\r\n\t\t\tpc.CHAR = pc.TARGET_CHAR(args.shift());\r\n\t\t}\r\n\t}\r\n\r\n\tconst com = args.shift().toLowerCase();\r\n\tif(com in pc){\r\n\t\tpc[com](...args);\r\n\t}\r\n};\r\n\r\n\r\nmv3d.PluginCommand=class{\r\n\tasync camera(...a){\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'pitch'    : this.pitch (a[1],time); return;\r\n\t\t\tcase 'yaw'      : this.yaw   (a[1],time); return;\r\n\t\t\tcase 'dist'     :\r\n\t\t\tcase 'distance' : this.dist  (a[1],time); return;\r\n\t\t\tcase 'height'   : this.height(a[1],time); return;\r\n\t\t\tcase 'mode'     : this.cameramode(a[1]); return;\r\n\t\t\tcase 'target': this._cameraTarget(a[1],time); return;\r\n\t\t\tcase 'pan': this.pan(a[1],a[2],a[3]); return;\r\n\t\t}\r\n\t}\r\n\tyaw(deg,time=1){\r\n\t\tthis._RELATIVE_BLEND(mv3d.blendCameraYaw,deg,time);\r\n\t\tif ( mv3d.is1stPerson() ) { mv3d.playerFaceYaw(); }\r\n\t}\r\n\tpitch(deg,time=1){ this._RELATIVE_BLEND(mv3d.blendCameraPitch,deg,time); }\r\n\tdist(n,time=1){ this._RELATIVE_BLEND(mv3d.blendCameraDist,n,time); }\r\n\theight(n,time=1){ this._RELATIVE_BLEND(mv3d.blendCameraHeight,n,time); }\r\n\t_cameraTarget(target,time){\r\n\t\tmv3d.setCameraTarget(this.TARGET_CHAR(target), time);\r\n\t}\r\n\tpan(x,y,time=1){\r\n\t\tconsole.log(x,y,time);\r\n\t\ttime=this._TIME(time);\r\n\t\tthis._RELATIVE_BLEND(mv3d.blendPanX,x,time);\r\n\t\tthis._RELATIVE_BLEND(mv3d.blendPanY,y,time);\r\n\t}\r\n\r\n\trotationmode(mode){ mv3d.rotationMode=mode; }\r\n\tpitchmode(mode){ mv3d.pitchMode=mode; }\r\n\r\n\t_VEHICLE(vehicle,data,value){\r\n\t\tdata=data.toLowerCase();\r\n\t\tconst key = `${Vehicle}_${data}`;\r\n\t\tif(data==='big'){ value=booleanString(value); }\r\n\t\telse{ value=relativeNumber(mv3d.loadData(key,0),value); }\r\n\t\tmv3d.saveData(key,value);\r\n\t}\r\n\tboat(d,v){ this._VEHICLE('boat',d,v); }\r\n\tship(d,v){ this._VEHICLE('ship',d,v); }\r\n\tairship(d,v){ this._VEHICLE('airship',d,v); }\r\n\tcameramode(mode){ mv3d.cameraMode=mode; }\r\n\tfog(...a){\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'color': this._fogColor(a[1],time); return;\r\n\t\t\tcase 'near': this._fogNear(a[1],time); return;\r\n\t\t\tcase 'far': this._fogFar(a[1],time); return;\r\n\t\t\tcase 'dist': case 'distance':\r\n\t\t\t\ttime=this._TIME(a[3]);\r\n\t\t\t\tthis._fogNear(a[1],time);\r\n\t\t\t\tthis._fogFar(a[2],time);\r\n\t\t\t\treturn;\r\n\t\t}\r\n\t\ttime=this._TIME(a[3]);\r\n\t\tthis._fogColor(a[0],time);\r\n\t\tthis._fogNear(a[1],time);\r\n\t\tthis._fogFar(a[2],time);\r\n\t}\r\n\t_fogColor(color,time){ mv3d.blendFogColor.setValue(makeColor(color).toNumber(),time); }\r\n\t_fogNear(n,time){ this._RELATIVE_BLEND(mv3d.blendFogNear,n,time); }\r\n\t_fogFar(n,time){ this._RELATIVE_BLEND(mv3d.blendFogFar,n,time); }\r\n\tlight(...a){\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'color'    : this._lightColor    (a[1],time); return;\r\n\t\t\t//case 'intensity': this._lightIntensity(a[1],time); return;\r\n\t\t}\r\n\t\ttime=this._TIME(a[1]);\r\n\t\tthis._lightColor(a[0],time);\r\n\t\t//this._lightintensity(a[0],time);\r\n\t}\r\n\t_lightColor(color,time=1){ mv3d.blendAmbientColor.setValue(makeColor(color).toNumber(),time); }\r\n\t//_lightIntensity(n,time=1){ this._RELATIVE_BLEND(mv3d.blendLightIntensity,n,time); }\r\n\tasync lamp(...a){\r\n\t\tconst char = await this.AWAIT_CHAR(this.CHAR);\r\n\t\tchar.setupLamp();\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'color'    : this._lampColor    (char,a[1],time); return;\r\n\t\t\tcase 'intensity': this._lampIntensity(char,a[1],time); return;\r\n\t\t\tcase 'dist'     :\r\n\t\t\tcase 'distance' : this._lampDistance (char,a[1],time); return;\r\n\t\t}\r\n\t\ttime=this._TIME(a[3]);\r\n\t\tthis._lampColor(char,a[0],time);\r\n\t\tthis._lampIntensity(char,a[1],time);\r\n\t\tthis._lampDistance(char,a[2],time);\r\n\t}\r\n\t_lampColor(char,color,time=1){ char.blendLampColor.setValue(makeColor(color).toNumber(),time); }\r\n\t_lampIntensity(char,n,time=1){ this._RELATIVE_BLEND(char.blendLampIntensity,n,time); }\r\n\t_lampDistance(char,n,time=1){ this._RELATIVE_BLEND(char.blendLampDistance,n,time); }\r\n\tasync flashlight(...a){\r\n\t\tconst char = await this.AWAIT_CHAR(this.CHAR);\r\n\t\tchar.setupFlashlight();\r\n\t\tvar time=this._TIME(a[2]);\r\n\t\tswitch(a[0].toLowerCase()){\r\n\t\t\tcase 'color'    : this._flashlightColor    (char,a[1],time); return;\r\n\t\t\tcase 'intensity': this._flashlightIntensity(char,a[1],time); return;\r\n\t\t\tcase 'dist'     :\r\n\t\t\tcase 'distance' : this._flashlightDistance (char,a[1],time); return;\r\n\t\t\tcase 'angle'    : this._flashlightAngle    (char,a[1],time); return;\r\n\t\t\tcase 'yaw'      : this._flashlightYaw      (char,a[1],time); return;\r\n\t\t\tcase 'pitch'    : this._flashlightPitch    (char,a[1],time); return;\r\n\t\t}\r\n\t\ttime=this._TIME(a[4]);\r\n\t\tthis._flashlightColor(char,a[0],time);\r\n\t\tthis._flashlightIntensity(char,a[1],time);\r\n\t\tthis._flashlightDistance(char,a[2],time);\r\n\t\tthis._flashlightAngle(char,a[3],time);\r\n\t}\r\n\t_flashlightColor(char,color,time){ char.blendFlashlightColor.setValue(makeColor(color).toNumber(),time); }\r\n\t_flashlightIntensity(char,n,time){ this._RELATIVE_BLEND(char.blendFlashlightIntensity,n,time); }\r\n\t_flashlightDistance(char,n,time){ this._RELATIVE_BLEND(char.blendFlashlightDistance,n,time); }\r\n\t_flashlightAngle(char,n,time){ this._RELATIVE_BLEND(char.blendFlashlightAngle,n,time); }\r\n\t_flashlightPitch(char,n,time){ this._RELATIVE_BLEND(char.blendFlashlightPitch,n,time); }\r\n\t_flashlightYaw(char,yaw,time){ char.flashlightTargetYaw=yaw; }\r\n\t_RELATIVE_BLEND(blender,n,time){ blender.setValue(relativeNumber(blender.targetValue(),n),Number(time)); }\r\n\t_TIME(time){\r\n\t\tif(typeof time==='number'){ return time; }\r\n\t\ttime=Number(time);\r\n\t\tif(Number.isNaN(time)){ return 1; }\r\n\t\treturn time;\r\n\t}\r\n\tERROR_CHAR(){\r\n\t\tconsole.warn(`MV3D: Plugin command \\`${this.FULL_COMMAND}\\` failed because target character was invalid.`);\r\n\t\t//console.log(this.CHAR);\r\n\t}\r\n\tasync AWAIT_CHAR(char){\r\n\t\tif(!char){ return this.ERROR_CHAR(); }\r\n\t\tlet w=0;\r\n\t\twhile(!char.mv3d_sprite){\r\n\t\t\tawait sleep(100);\r\n\t\t\tif(++w>10){ return this.ERROR_CHAR(); }\r\n\t\t}\r\n\t\treturn char.mv3d_sprite;\r\n\t}\r\n\tTARGET_CHAR(target){\r\n\t\treturn mv3d.targetChar(target,$gameMap.event(this.INTERPRETER._eventId),this.CHAR);\r\n\t}\r\n};\r\n\r\nmv3d.targetChar=function(target,self=null,dfault=null){\r\n\tif(!target){ return dfault; }\r\n\tlet m=target.toLowerCase().match(/[a-z]+/);\r\n\tconst mode=m?m[0]:'e';\r\n\tm=target.match(/\\d+/);\r\n\tconst id=m?Number(m[0]):0;\r\n\tswitch(mode[0]){\r\n\t\tcase 's': return self;\r\n\t\tcase 'p': return $gamePlayer;\r\n\t\tcase 'e':\r\n\t\t\tif(!id){ return self; }\r\n\t\t\treturn $gameMap.event(id);\r\n\t\tcase 'v':\r\n\t\t\treturn $gameMap.vehicle(id);\r\n\t\tcase 'f':\r\n\t\t\treturn $gamePlayer.followers()._data[id];\r\n\t}\r\n\treturn char;\r\n}\r\nmv3d.getTargetString=function(char){\r\n\tif( char instanceof Game_Player){\r\n\t\treturn `@p`;\r\n\t}\r\n\tif( char instanceof Game_Event ){\r\n\t\treturn `@e${char._eventId}`;\r\n\t}\r\n\tif( char instanceof Game_Follower){\r\n\t\treturn `@f${$gamePlayer._followers._data.indexOf(char)}`;\r\n\t}\r\n\tif( char instanceof Game_Vehicle){\r\n\t\treturn `@v${$gameMap._vehicles.indexOf(char)}`;\r\n\t}\r\n}","import mv3d from './mv3d.js';\r\nimport { v2origin, tileSize } from './util.js';\r\n\r\nObject.assign(mv3d,{\r\n\r\n\t_tilemap:null,\r\n\tgetTilemap(){\r\n\t\tif(SceneManager._scene&&SceneManager._scene._spriteset){\r\n\t\t\tthis._tilemap = SceneManager._scene._spriteset._tilemap;\r\n\t\t}\r\n\t\treturn this._tilemap;\r\n\t},\r\n\r\n\tgetSetNumber(id){\r\n\t\tif(Tilemap.isAutotile(id)){\r\n\t\t\treturn Tilemap.isTileA1(id)?0\r\n\t\t\t\t: Tilemap.isTileA2(id)?1 : Tilemap.isTileA3(id)?2 : 3;\r\n\t\t}else{\r\n\t\t\treturn Tilemap.isTileA5(id)?4:5+Math.floor(id/256);\r\n\t\t}\r\n\t},\r\n\r\n\tgetTerrainTag(tileId){\r\n\t\treturn $gameMap.tilesetFlags()[tileId]>>12;\r\n\t},\r\n\r\n\tgetMaterialOptions(tileId){\r\n\t\tconst options={};\r\n\t\t/*\r\n\t\tconst ttag = this.getTerrainTag(tileId);\r\n\t\tif(ttag && ttag in this.TTAG_DATA){\r\n\t\t\tconst tagdata = this.TTAG_DATA[ttag];\r\n\t\t}\r\n\t\t*/\r\n\t\tconst conf = this.tilesetConfigurations[this.normalizeAutotileId(tileId)];\r\n\t\tif(conf){\r\n\t\t\tif ('alpha' in conf){ options.alpha=conf.alpha; }\r\n\t\t\tif ('transparent' in conf){ options.transparent=conf.transparent; }\r\n\t\t\tif ('glow' in conf){ options.glow=conf.glow; }\r\n\t\t}\r\n\t\treturn options;\r\n\t},\r\n\r\n\tgetTileConfig(tileId){\r\n\t\t//offsets can come either from terrain tag or tileset notes\r\n\t\tlet offsetTop = v2origin;\r\n\t\tlet offsetSide = v2origin;\r\n\t\tlet offsetInside = null;\r\n\t\tlet offsetBottom = null;\r\n\t\tconst tilemap=this.getTilemap();\r\n\t\tconst ret = {\r\n\t\t\ttopId:null,\r\n\t\t\tsideId:null,\r\n\t\t\tinsideId:null,\r\n\t\t\tbottomId:null,\r\n\t\t\tfringe:tilemap&&tilemap._isHigherTile(tileId)?this.FRINGE_HEIGHT:0,\r\n\t\t\tfringeHeight:0,\r\n\t\t}\r\n\t\tconst ttag = this.getTerrainTag(tileId);\r\n\t\tif(ttag && ttag in this.TTAG_DATA){\r\n\t\t\tconst tagdata = this.TTAG_DATA[ttag];\r\n\t\t\toffsetTop = tagdata.offsetTop;\r\n\t\t\toffsetSide = tagdata.offsetSide;\r\n\t\t\tret.height=tagdata.height; \r\n\t\t\tret.fringeHeight=tagdata.height;\r\n\t\t\tret.shape=tagdata.shape;\r\n\t\t}\r\n\t\tconst conf = this.tilesetConfigurations[this.normalizeAutotileId(tileId)];\r\n\t\tif(conf){\r\n\t\t\tif(conf.offsetTop){ offsetTop=conf.offsetTop; }\r\n\t\t\tif(conf.offsetSide){ offsetSide=conf.offsetSide; }\r\n\t\t\tif(conf.offsetInside){ offsetInside=conf.offsetInside; }\r\n\t\t\tif(conf.offsetBottom){ offsetBottom=conf.offsetBottom; }\r\n\t\t\tif('topId' in conf){ ret.topId=conf.topId; }\r\n\t\t\tif('sideId' in conf){ ret.sideId=conf.sideId; }\r\n\t\t\tif('insideId' in conf){ ret.insideId=conf.insideId; }\r\n\t\t\tif('bottomId' in conf){ ret.bottomId=conf.bottomId; }\r\n\t\t\tif(conf.rectTop){ ret.rectTop=conf.rectTop; }\r\n\t\t\tif(conf.rectSide){ ret.rectSide=conf.rectSide; }\r\n\t\t\tif(conf.rectInside){ ret.rectInside=conf.rectInside; }\r\n\t\t\tif(conf.rectBottom){ ret.rectBottom=conf.rectBottom; }\r\n\t\t\tif('shape' in conf){ ret.shape=conf.shape; }\r\n\t\t\tif('fringe' in conf){ ret.fringe=conf.fringe; }\r\n\t\t\tif('height' in conf){\r\n\t\t\t\tret.height=conf.height;\r\n\t\t\t\tret.fringeHeight = conf.height;\r\n\t\t\t}\r\n\r\n\t\t\tret.hasInsideConf=Boolean(conf.offsetInside||conf.rectInside||('insideId' in conf));\r\n\t\t\tret.hasBottomConf=Boolean(conf.offsetBottom||conf.rectBottom||('bottomId' in conf));\r\n\t\t}\r\n\t\tconst tileRange = Tilemap.isAutotile(tileId)?48:1;\r\n\t\tif(ret.topId==null){ ret.topId = tileId+offsetTop.x*tileRange+offsetTop.y*tileRange*8; }\r\n\t\tif(ret.sideId==null){ ret.sideId = tileId+offsetSide.x*tileRange+offsetSide.y*tileRange*8; }\r\n\t\tif(ret.insideId==null){ \r\n\t\t\tret.insideId=ret.sideId;\r\n\t\t\tif(offsetInside){\r\n\t\t\t\tret.insideId=tileId+offsetInside.x*tileRange+offsetInside.y*tileRange*8;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(ret.bottomId==null){\r\n\t\t\tret.bottomId=ret.topId;\r\n\t\t\tif(offsetBottom){\r\n\t\t\t\tret.bottomId=tileId+offsetBottom.x*tileRange+offsetBottom.y*tileRange*8;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn ret;\r\n\t},\r\n\r\n\tgetTileData(x,y){\r\n\t\tif(!$dataMap || !$dataMap.data){ return [0,0,0,0]; }\r\n\t\tconst data = $dataMap.data;\r\n\t\tconst width = $dataMap.width;\r\n\t\tconst height = $dataMap.height;\r\n\t\tif($gameMap.isLoopHorizontal()){\r\n\t\t\tx=x.mod(width);\r\n\t\t}\r\n\t\tif($gameMap.isLoopVertical()){\r\n\t\t\ty=y.mod(height);\r\n\t\t}\r\n\t\tif(x<0||x>=width||y<0||y>=height){ return [0,0,0,0]; }\r\n\t\tconst tileData=[];\r\n\t\tfor (let z=0;z<4;++z){//4 tile layers. Ignore shadow bits.\r\n\t\t\ttileData[z] = data[(z * height + y) * width + x] || 0;\r\n\t\t}\r\n\t\treturn tileData;\r\n\t},\r\n\r\n\r\n\tgetTileHeight(x,y,l=0){\r\n\t\tif(!$dataMap){ return 0; }\r\n\r\n\t\tif($gameMap.isLoopHorizontal()){ x=x.mod($dataMap.width); }\r\n\t\tif($gameMap.isLoopVertical()){ y=y.mod($dataMap.height); }\r\n\r\n\t\tconst tileId=this.getTileData(x,y)[l];\r\n\t\tif(this.isTileEmpty(tileId)){ return 0; }\r\n\t\t// finge tiles don't stack normally. fringeHeight property should be used when drawing them.\r\n\t\tconst tilemap=this.getTilemap();\r\n\t\tif(tilemap&&tilemap._isHigherTile(tileId)){ return 0; }\r\n\r\n\t\tlet defaultHeight = 0;\r\n\r\n\t\tconst conf = this.tilesetConfigurations[this.normalizeAutotileId(tileId)];\r\n\t\tconst region = $gameMap.regionId(x,y);\r\n\t\tif(l===0 && region && region in mv3d.REGION_DATA){\r\n\t\t\tlet height = this.REGION_DATA[region].height;\r\n\t\t\tif(conf&&'height' in conf&&conf.height<0){\r\n\t\t\t\theight+=conf.height;\r\n\t\t\t}\r\n\t\t\treturn height;\r\n\t\t}\r\n\t\tif(conf){\r\n\t\t\tif('height' in conf){\r\n\t\t\t\treturn conf.height;\r\n\t\t\t}\r\n\t\t\tif(this.isSpecialShape(conf.shape)){\r\n\t\t\t\tdefaultHeight=1;\r\n\t\t\t}\r\n\t\t}\r\n\t\tconst ttag=this.getTerrainTag(tileId);\r\n\t\tif(ttag && ttag in this.TTAG_DATA){\r\n\t\t\treturn this.TTAG_DATA[ttag].height;\r\n\t\t}\r\n\t\tif(this.isWallTile(tileId)){\r\n\t\t\treturn this.WALL_HEIGHT;\r\n\t\t}\r\n\t\tif(tilemap&&tilemap._isTableTile(tileId)){\r\n\t\t\treturn this.TABLE_HEIGHT;\r\n\t\t}\r\n\t\treturn defaultHeight;\r\n\t},\r\n\r\n\tgetStackHeight(x,y,layerId=3){\r\n\t\tlet height=0;\r\n\t\tfor(let l=0; l<=layerId; ++l){\r\n\t\t\theight+=this.getTileHeight(x,y,l);\r\n\t\t}\r\n\t\treturn height;\r\n\t},\r\n\r\n\tgetWalkHeight(x,y){\r\n\t\t// get the height of characters for given x,y coord. Uses float coords. Should support ramps.\r\n\t\tconst tileData=this.getTileData(Math.round(x),Math.round(y));\r\n\t\tlet height=0;\r\n\t\tlet tileHeight=0;\r\n\t\tfor(let l=0; l<=3; ++l){\r\n\t\t\tconst tileId=tileData[l];\r\n\t\t\tif(this.isTileEmpty(tileId)){ continue; }\r\n\t\t\theight += tileHeight;\r\n\t\t\ttileHeight = this.getTileHeight(Math.round(x),Math.round(y),l);\r\n\t\t\tconst data = this.getTileConfig(tileId);\r\n\t\t\tconst shape = data.shape;\r\n\t\t\tif(!this.isSpecialShape(shape)){\r\n\t\t\t\theight+=tileHeight;\r\n\t\t\t\ttileHeight=0;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn height;\r\n\t\t\r\n\t},\r\n\r\n\tgetFloatHeight(x,y){\r\n\t\tconst tileData=this.getTileData(x,y);\r\n\t\tlet float=0;\r\n\t\tfor(let l=0; l<=3; ++l){\r\n\t\t\tconst tileId=tileData[l];\r\n\t\t\tif(this.isTileEmpty(tileId)){ continue; }\r\n\t\t\tconst conf = this.tilesetConfigurations[this.normalizeAutotileId(tileId)];\r\n\t\t\tif(conf && 'float' in conf){\r\n\t\t\t\tfloat += conf.float;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn float;\r\n\t},\r\n\r\n\tgetFringeHeight(x,y,layerId=3){\r\n\t\tlet height = this.getStackHeight(x,y,layerId-1);\r\n\t\tconst tileId=this.getTileData(x,y)[layerId];\r\n\t\tconst conf = this.tilesetConfigurations[this.normalizeAutotileId(tileId)];\r\n\t\tif(conf && this.getTilemap()._isHigherTile(tileId)){\r\n\t\t\treturn height + (conf.fringe||this.FRINGE_HEIGHT) + (conf.height||0);\r\n\t\t}\r\n\t\treturn 0;\r\n\t},\r\n\r\n\tgetCullingHeight(x,y,layerId=3,ignorePits=false){\r\n\t\tconst tileData=this.getTileData(x,y);\r\n\t\tlet height=0;\r\n\t\tfor(let l=0; l<=layerId; ++l){\r\n\t\t\tconst tileId=tileData[l];\r\n\t\t\tconst data = this.getTileConfig(tileId);\r\n\t\t\tconst shape = data.shape;\r\n\t\t\tif(this.isSpecialShape(shape)){\r\n\t\t\t\treturn height;\r\n\t\t\t}\r\n\t\t\tif(ignorePits&&data.height<0){\r\n\t\t\t\theight-=data.height;\r\n\t\t\t}\r\n\t\t\theight+=this.getTileHeight(x,y,l);\r\n\t\t}\r\n\t\treturn height;\r\n\t},\r\n\r\n\tgetTileRects(tileId){\r\n\t\tconst rects = [];\r\n\t\tconst tilemap=this.getTilemap();\r\n\t\tconst isTable=tilemap._isTableTile(tileId);\r\n\t\ttilemap._drawTile({addRect:(sheetId,sx,sy,dx,dy,width,height,animX,animY)=>{\r\n\t\t\trects.push({setN:sheetId,x:sx,y:sy,width:width,height:height,ox:dx,oy:dy});\r\n\t\t}}, tileId, 0,0);\r\n\t\tif (isTable) for (let i=rects.length-1;i>=0;--i){\r\n\t\t\tif(rects[i].oy>tileSize()/2){\r\n\t\t\t\trects[i-1].y+=tileSize()*2/3;\r\n\t\t\t\trects.splice(i,1);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn rects;\r\n\t},\r\n\r\n\tisTileEmpty(tileId){\r\n\t\treturn !tileId||tileId===1544;\r\n\t},\r\n\r\n\tisWallTile(tileId){\r\n\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\tconst ty = Math.floor(kind / 8);\r\n\t\tconst isWall = Tilemap.isTileA3(tileId) || Tilemap.isTileA4(tileId);\r\n\t\tif (isWall && ty%2){ return 2; }\r\n\t\treturn isWall;\r\n\t},\r\n\r\n\tisTableTile(tileId){\r\n\t\treturn Boolean(this.getTilemap()._isTableTile(tileId));\r\n\t},\r\n\r\n\tisFringeTile(tileId){\r\n\t\treturn Boolean(this.getTilemap()._isHigherTile(tileId));\r\n\t},\r\n\r\n\tisWaterfallTile(tileId){\r\n\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\treturn Tilemap.isTileA1(tileId)&&kind>=4&&kind%2;\r\n\t},\r\n\r\n\tisSpecialShape(shape){\r\n\t\tconst shapes = mv3d.configurationShapes;\r\n\t\treturn shape===shapes.FENCE||shape===shapes.CROSS||shape===shapes.XCROSS;\r\n\t},\r\n\r\n\tconstructTileId(img,x,y){\r\n\t\tconst key = `TILE_ID_${img.toUpperCase()}`\r\n\t\tlet tileId = key in Tilemap ? Tilemap[key] : 0;\r\n\t\tconst tileRange = Tilemap.isAutotile(tileId) ? 48 : 1;\r\n\t\ttileId += Number(x)*tileRange + Number(y)*tileRange*8;\r\n\t\treturn tileId;\r\n\t},\r\n\tnormalizeAutotileId(tileId){\r\n\t\tif(!Tilemap.isAutotile(tileId)){ return tileId; }\r\n\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\treturn Tilemap.TILE_ID_A1 + kind*48;\r\n\t},\r\n\r\n});","import mv3d from './mv3d.js';\r\nimport { TransformNode, Mesh, MeshBuilder, Vector3, Vector2, FRONTSIDE, BACKSIDE, WORLDSPACE, LOCALSPACE, DOUBLESIDE, Plane } from \"./mod_babylon.js\";\r\nimport { tileSize, XAxis, YAxis, tileWidth, tileHeight, sleep, snooze } from './util.js';\r\n\r\nconst SOURCEPLANE_GROUND = new Plane(0, 1, -Math.pow(0.1,100), 0);\r\nconst SOURCEPLANE_WALL = new Plane(0,0,-1,0);\r\n\r\nexport class MapCell extends TransformNode{\r\n\tconstructor(cx,cy){\r\n\t\tconst key = [cx,cy].toString();\r\n\t\tsuper(`MapCell[${key}]`,mv3d.scene);\r\n\t\tthis.parent=mv3d.map;\r\n\t\t//mv3d.cells[key]=this;\r\n\t\tthis.cx=cx; this.cy=cy;\r\n\t\tthis.ox=cx*mv3d.CELL_SIZE; this.oy=cy*mv3d.CELL_SIZE;\r\n\t\tthis.x=this.ox; this.y=this.oy;\r\n\t\tthis.key=key;\r\n\r\n\t\t//this.load();\r\n\t}\r\n\tupdate(){\r\n\t\tconst loopPos = mv3d.loopCoords((this.cx+0.5)*mv3d.CELL_SIZE,(this.cy+0.5)*mv3d.CELL_SIZE);\r\n\t\tthis.x=loopPos.x-mv3d.CELL_SIZE/2;\r\n\t\tthis.y=loopPos.y-mv3d.CELL_SIZE/2;\r\n\t}\r\n\tgetCachedMesh(width=1,height=1,side=FRONTSIDE,isWall=false){\r\n\t\tconst key = `${width},${height}|${side}|${+isWall}`;\r\n\t\tlet mesh;\r\n\t\tif(key in MapCell.meshCache){\r\n\t\t\tmesh=MapCell.meshCache[key].clone();\r\n\t\t}else{\r\n\t\t\tmesh = MeshBuilder.CreatePlane('tile',{\r\n\t\t\t\tsideOrientation: side,\r\n\t\t\t\twidth:width, height:height,\r\n\t\t\t\t//subdivisions:1,\r\n\t\t\t\tsourcePlane: isWall ? SOURCEPLANE_WALL : SOURCEPLANE_GROUND,\r\n\t\t\t},mv3d.scene);\r\n\t\t\tMapCell.meshCache[key]=mesh;\r\n\t\t\tmv3d.scene.removeMesh(mesh);\r\n\t\t\tmesh=mesh.clone();\r\n\t\t}\r\n\t\tthis.submeshes.push(mesh);\r\n\t\tmesh.parent=this;\r\n\t\treturn mesh;\r\n\t}\r\n\tcreateMesh(width=1,height=1,side=FRONTSIDE, isWall=false){\r\n\t\tconst mesh = MeshBuilder.CreatePlane('tile',{\r\n\t\t\tsideOrientation: side,\r\n\t\t\twidth:width, height:height,\r\n\t\t\t//subdivisions:1,\r\n\t\t\tsourcePlane: isWall ? SOURCEPLANE_WALL : SOURCEPLANE_GROUND,\r\n\t\t},mv3d.scene);\r\n\t\tthis.submeshes.push(mesh);\r\n\t\tmesh.parent=this;\r\n\t\treturn mesh;\r\n\t}\r\n\tasync load(){\r\n\t\tconst shapes = mv3d.configurationShapes;\r\n\t\tthis.submeshes=[];\r\n\t\t// load all tiles in mesh\r\n\t\tconst cellWidth = Math.min(mv3d.CELL_SIZE,$gameMap.width()-this.cx*mv3d.CELL_SIZE);\r\n\t\tconst cellHeight = Math.min(mv3d.CELL_SIZE,$gameMap.height()-this.cy*mv3d.CELL_SIZE);\r\n\t\tfor (let y=0; y<cellHeight; ++y)\r\n\t\tfor (let x=0; x<cellWidth; ++x){\r\n\t\t\tlet nlnowall = 0; // the number of layers in a row that haven't had walls.\r\n\t\t\tconst tileData = mv3d.getTileData(this.ox+x,this.oy+y);\r\n\t\t\tfor (let l=0; l<4; ++l){\r\n\t\t\t\tlet z = mv3d.getStackHeight(this.ox+x,this.oy+y,l);\r\n\t\t\t\tconst tileConf = mv3d.getTileConfig(tileData[l]);\r\n\t\t\t\tconst shape = tileConf.shape;\r\n\t\t\t\ttileConf.realId = tileData[l];\r\n\t\t\t\t//tileConf.isAutotile = Tilemap.isAutotile(tileData[l]);\r\n\t\t\t\t//tileConf.isFringe = mv3d.isFringeTile(tileData[l]);\r\n\t\t\t\t//tileConf.isTable = mv3d.isTableTile(tileData[l]);\r\n\t\t\t\tconst wallHeight = mv3d.getTileHeight(this.ox+x,this.oy+y,l)||tileConf.height||0;\r\n\t\t\t\tz+=tileConf.fringe;\r\n\t\t\t\tif(mv3d.isFringeTile(tileData[l])){ z+=tileConf.fringeHeight; }\r\n\t\t\t\tif(!shape||shape===shapes.FLAT){\r\n\t\t\t\t\tthis.loadTile(tileConf,x,y,z,l);\r\n\t\t\t\t\t//decide if we need to draw bottom of tile\r\n\t\t\t\t\tif(tileConf.hasBottomConf||tileConf.height>0&&(l>0||tileConf.fringe>0)){\r\n\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//decide whether to draw walls\r\n\t\t\t\t\tif(wallHeight){\r\n\t\t\t\t\t\tthis.loadWalls(tileConf,x,y,z,l,wallHeight + nlnowall*mv3d.LAYER_DIST);\r\n\t\t\t\t\t\tnlnowall=0;\r\n\t\t\t\t\t}else{\r\n\t\t\t\t\t\t++nlnowall;\r\n\t\t\t\t\t}\r\n\t\t\t\t}else{ nlnowall=0; }\r\n\t\t\t\tif(shape===shapes.FENCE){\r\n\t\t\t\t\tthis.loadFence(tileConf,x,y,z,l,wallHeight);\r\n\t\t\t\t}else if(shape===shapes.CROSS||shape===shapes.XCROSS){\r\n\t\t\t\t\tthis.loadCross(tileConf,x,y,z,l,wallHeight);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tawait snooze();\r\n\t\t\tif(!mv3d.mapLoaded){ this.earlyExit(); return; }\r\n\t\t}\r\n\t\t// merge meshes\r\n\t\tif(this.submeshes.length){\r\n\t\t\tthis.submeshes.forEach(mesh=>mesh.parent=null);\r\n\t\t\tthis.mesh=Mesh.MergeMeshes(this.submeshes,true,undefined,undefined,false,true);\r\n\t\t}else{\r\n\t\t\tconsole.warn(\"MV3D: Created empty map cell!\");\r\n\t\t\tthis.mesh = new Mesh(\"empty mesh\",mv3d.scene);\r\n\t\t}\r\n\t\tthis.mesh.parent=this;\r\n\t\tdelete this.submeshes;\r\n\t}\r\n\tearlyExit(){\r\n\t\tconsole.warn(`MV3D: Map cleared before cell[${this.cx},${this.cy}] finished loading.`)\r\n\t\tif(this.submeshes){\r\n\t\t\tfor (const mesh of this.submeshes){\r\n\t\t\t\tmesh.dispose();\r\n\t\t\t}\r\n\t\t\tthis.submeshes.length=0;\r\n\t\t}\r\n\r\n\t}\r\n\tloadTile(tileConf,x,y,z,l,ceiling=false){\r\n\t\tconst tileId = ceiling?tileConf.bottomId:tileConf.topId;\r\n\t\tconst configRect = ceiling?tileConf.rectTop:tileConf.rectBottom;\r\n\t\tconst isAutotile = Tilemap.isAutotile(tileId);\r\n\t\tconst setN = mv3d.getSetNumber(tileId);\r\n\t\tlet rects;\r\n\t\tif(configRect){\r\n\t\t\trects=[configRect];\r\n\t\t}else{\r\n\t\t\trects = mv3d.getTileRects(tileId);\r\n\t\t}\r\n\t\tfor (const rect of rects){\r\n\t\t\tconst mesh = this.getCachedMesh(1-isAutotile/2,1-isAutotile/2,ceiling?BACKSIDE:FRONTSIDE);\r\n\t\t\tmesh.material = mv3d.getCachedTileMaterial(setN,rect.x,rect.y,rect.width,rect.height, mv3d.getMaterialOptions(tileId));\r\n\t\t\tmesh.x = x + (rect.ox|0)/tileSize() - 0.25*isAutotile;\r\n\t\t\tmesh.y = y + (rect.oy|0)/tileSize() - 0.25*isAutotile;\r\n\t\t\tmesh.z = z + l*mv3d.LAYER_DIST;\r\n\t\t}\r\n\t}\r\n\tloadWalls(tileConf,x,y,z,l,wallHeight){\r\n\t\tconst realWallHeight = wallHeight;\r\n\t\tconst isFringe = mv3d.isFringeTile(tileConf.realId);\r\n\t\tfor (let ni=0; ni<MapCell.neighborPositions.length; ++ni){\r\n\t\t\tconst np = MapCell.neighborPositions[ni];\r\n\t\t\t// don't render walls on edge of map (unless it loops)\r\n\t\t\tif( !mv3d.getMapConfig('edge',true) )\r\n\t\t\tif((this.ox+x+np.x>=$dataMap.width||this.ox+x+np.x<0)&&!$gameMap.isLoopHorizontal()\r\n\t\t\t||(this.oy+y+np.y>=$dataMap.height||this.oy+y+np.y<0)&&!$gameMap.isLoopVertical()){\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tif(tileConf.height<0 && z<mv3d.getStackHeight(this.ox+x+np.x,this.oy+y+np.y,l)){\r\n\t\t\t\twallHeight=tileConf.height;\r\n\t\t\t}else{\r\n\t\t\t\twallHeight=realWallHeight;\r\n\t\t\t}\r\n\t\t\tlet tileId=tileConf.sideId;\r\n\t\t\tlet configRect;\r\n\t\t\tif(wallHeight<0 && tileConf.hasInsideConf){\r\n\t\t\t\ttileId=tileConf.insideId;\r\n\t\t\t\tif(tileConf.rectInside){ configRect = tileConf.rectInside; }\r\n\t\t\t}else{\r\n\t\t\t\tif(tileConf.rectSide){ configRect = tileConf.rectSide; }\r\n\t\t\t}\r\n\t\t\tconst setN = mv3d.getSetNumber(tileId);\r\n\r\n\t\t\tlet neededHeight=wallHeight;\r\n\t\t\tif(isFringe){\r\n\t\t\t\tconst neighborHeight = mv3d.getFringeHeight(this.ox+x+np.x,this.oy+y+np.y,l);\r\n\t\t\t\tif(neighborHeight===z){ continue; }\r\n\t\t\t}else{\r\n\t\t\t\tconst neighborHeight = mv3d.getCullingHeight(this.ox+x+np.x,this.oy+y+np.y,l,!(tileConf.height<0));\r\n\t\t\t\tif(wallHeight>0&&neighborHeight>=z\r\n\t\t\t\t||wallHeight<0&&neighborHeight<=z){ continue; }\r\n\t\t\t\tneededHeight = Math.min(Math.abs(wallHeight), Math.abs(z-neighborHeight))*Math.sign(wallHeight);\r\n\t\t\t}\r\n\t\t\tconst wallPos = new Vector3( x+np.x/2, y+np.y/2, z );\r\n\t\t\tconst rot = Math.atan2(np.x, np.y);\r\n\t\t\tif(configRect || !Tilemap.isAutotile(tileId)){\r\n\t\t\t\tconst rect = configRect ? configRect : mv3d.getTileRects(tileId)[0];\r\n\t\t\t\tconst mesh = this.getCachedMesh(1,neededHeight,FRONTSIDE,true);\r\n\t\t\t\tif(neededHeight<0){ mesh.scaling.y*=-1; }\r\n\t\t\t\tmesh.material = mv3d.getCachedTileMaterial(setN,rect.x,rect.y,rect.width,rect.height, mv3d.getMaterialOptions(tileId));\r\n\t\t\t\t//mesh.rotate(XAxis,-Math.PI/2,WORLDSPACE);\r\n\t\t\t\tmesh.rotate(YAxis,-rot,WORLDSPACE);\r\n\t\t\t\tmesh.x=wallPos.x;\r\n\t\t\t\tmesh.y=wallPos.y;\r\n\t\t\t\tmesh.z= z - neededHeight/2;\r\n\t\t\t}else{ // Autotile\r\n\t\t\t\tconst npl=MapCell.neighborPositions[(+ni-1).mod(4)];\r\n\t\t\t\tconst npr=MapCell.neighborPositions[(+ni+1).mod(4)];\r\n\t\t\t\tconst leftHeight = mv3d.getStackHeight(this.ox+x+npl.x,this.oy+y+npl.y,l);\r\n\t\t\t\tconst rightHeight = mv3d.getStackHeight(this.ox+x+npr.x,this.oy+y+npr.y,l);\r\n\t\t\t\tconst {x:bx,y:by} = this.getAutotileCorner(tileId,tileConf.realId);\r\n\t\t\t\tlet wallParts=Math.abs(Math.round(neededHeight*2));\r\n\t\t\t\tlet partHeight=Math.abs(neededHeight/wallParts);\r\n\t\t\t\tlet sw = tileSize()/2;\r\n\t\t\t\tlet sh = tileSize()/2;\r\n\t\t\t\tif(mv3d.isTableTile(tileConf.realId)){\r\n\t\t\t\t\tsh=tileSize()/3;\r\n\t\t\t\t\twallParts=1;\r\n\t\t\t\t\tpartHeight=wallHeight;\r\n\t\t\t\t\t//partHeight=neededHeight;\r\n\t\t\t\t}\r\n\t\t\t\tfor (let ax=-1; ax<=1; ax+=2){\r\n\t\t\t\t\tfor(let az=0;az<wallParts;++az){\r\n\t\t\t\t\t\tlet hasLeftEdge,hasRightEdge;\r\n\t\t\t\t\t\tif(mv3d.isTableTile(tileConf.realId)){\r\n\t\t\t\t\t\t\thasLeftEdge = leftHeight!=z;\r\n\t\t\t\t\t\t\thasRightEdge = rightHeight!=z;\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\thasLeftEdge = leftHeight<z-az*partHeight;\r\n\t\t\t\t\t\t\thasRightEdge = rightHeight<z-az*partHeight;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tlet sx,sy;\r\n\t\t\t\t\t\tsx=bx*tileSize();\r\n\t\t\t\t\t\tsy=by*tileSize();\r\n\t\t\t\t\t\tsx=(bx+(ax>0?0.5+hasRightEdge:1-hasLeftEdge))*tileSize();\r\n\t\t\t\t\t\tif(neededHeight<0){\r\n\t\t\t\t\t\t\tsx=(bx+(ax>0?0+hasLeftEdge:1.5-hasRightEdge))*tileSize();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif(mv3d.isWaterfallTile(tileId)){\r\n\t\t\t\t\t\t\tsy=(by+az%2/2)*tileSize();\r\n\t\t\t\t\t\t}else if(mv3d.isTableTile(tileId)){\r\n\t\t\t\t\t\t\tsy=(by+5/3)*tileSize();\r\n\t\t\t\t\t\t}else{\r\n\t\t\t\t\t\t\tsy=(by+(az===0?0:az===wallParts-1?1.5:1-az%2*0.5))*tileSize();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst mesh = this.getCachedMesh(0.5,partHeight,FRONTSIDE,true);\r\n\t\t\t\t\t\t//mesh.rotate(XAxis,-Math.PI/2,WORLDSPACE);\r\n\t\t\t\t\t\tmesh.rotate(YAxis,-rot,WORLDSPACE);\r\n\t\t\t\t\t\tmesh.x=wallPos.x;\r\n\t\t\t\t\t\tmesh.y=wallPos.y;\r\n\t\t\t\t\t\tmesh.z= z - partHeight/2 - partHeight*az + l*mv3d.LAYER_DIST;\r\n\t\t\t\t\t\tmesh.translate(XAxis,0.25*ax,LOCALSPACE);\r\n\t\t\t\t\t\tmesh.material = mv3d.getCachedTileMaterial(setN,sx,sy,sw,sh, mv3d.getMaterialOptions(tileId));\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tloadFence(tileConf,x,y,z,l,wallHeight){\r\n\t\tconst tileId = tileConf.sideId;\r\n\t\tconst configRect = tileConf.rectSide;\r\n\t\tconst setN = mv3d.getSetNumber(tileId);\r\n\t\tconst isAutotile = Tilemap.isAutotile(tileId);\r\n\t\tconst edges = [];\r\n\t\tfor (let ni=0; ni<MapCell.neighborPositions.length; ++ni){\r\n\t\t\tconst np = MapCell.neighborPositions[ni];\r\n\t\t\tconst neighborHeight = mv3d.getTileHeight(this.ox+x+np.x,this.oy+y+np.y,l);\r\n\t\t\tif(neighborHeight!==wallHeight){ edges.push(ni); }\r\n\t\t}\r\n\t\tfor (let ni=0; ni<MapCell.neighborPositions.length; ++ni){\r\n\t\t\tconst np = MapCell.neighborPositions[ni];\r\n\r\n\t\t\tconst edge = edges.includes(ni);\r\n\t\t\tif(edge&&edges.length<4&&!isAutotile){ continue; }\r\n\r\n\t\t\tconst rightSide = np.x>0||np.y>0;\r\n\t\t\tlet rot = Math.atan2(np.x, np.y)+Math.PI/2;\r\n\t\t\tif(rightSide){\r\n\t\t\t\trot-=Math.PI;\r\n\t\t\t}\r\n\r\n\t\t\tif(isAutotile&&!configRect){\r\n\t\t\t\tconst {x:bx,y:by} = this.getAutotileCorner(tileId,tileConf.realId);\r\n\t\t\t\tfor (let az=0;az<=1;++az){\r\n\t\t\t\t\tconst mesh = this.getCachedMesh(0.5,wallHeight/2,DOUBLESIDE,true);\r\n\t\t\t\t\t//mesh.rotate(XAxis,-Math.PI/2,WORLDSPACE);\r\n\t\t\t\t\tmesh.rotate(YAxis,-rot,WORLDSPACE);\r\n\t\t\t\t\tmesh.material = mv3d.getCachedTileMaterial(setN,\r\n\t\t\t\t\t\t(edge ? (bx+rightSide*1.5) : (bx+1-rightSide*0.5) )*tileWidth(),\r\n\t\t\t\t\t\t(by+az*1.5)*tileHeight(),\r\n\t\t\t\t\t\ttileWidth()/2,\r\n\t\t\t\t\t\ttileHeight()/2,\r\n\t\t\t\t\t\tmv3d.getMaterialOptions(tileId));\r\n\t\t\t\t\tmesh.x=x+np.x/4;\r\n\t\t\t\t\tmesh.y=y+np.y/4;\r\n\t\t\t\t\tmesh.z=z-wallHeight/4-az*wallHeight/2;\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\tconst rect = configRect ? configRect : mv3d.getTileRects(tileId)[0];\r\n\t\t\t\tconst mesh = this.getCachedMesh(0.5,wallHeight,DOUBLESIDE,true);\r\n\t\t\t\t//mesh.rotate(XAxis,-Math.PI/2,WORLDSPACE);\r\n\t\t\t\tmesh.rotate(YAxis,-rot,WORLDSPACE);\r\n\t\t\t\tmesh.material = mv3d.getCachedTileMaterial(setN,\r\n\t\t\t\t\trect.x+rect.width/2*rightSide,\r\n\t\t\t\t\trect.y,\r\n\t\t\t\t\trect.width/2,\r\n\t\t\t\t\trect.height,\r\n\t\t\t\t\tmv3d.getMaterialOptions(tileId));\r\n\t\t\t\t\tmesh.x=x+np.x/4;\r\n\t\t\t\t\tmesh.y=y+np.y/4;\r\n\t\t\t\t\tmesh.z=z-wallHeight/2;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tloadCross(tileConf,x,y,z,l,wallHeight){\r\n\t\tconst tileId = tileConf.sideId;\r\n\t\tconst configRect = tileConf.rectSide;\r\n\t\tconst setN = mv3d.getSetNumber(tileId);\r\n\t\tconst isAutotile = Tilemap.isAutotile(tileId);\r\n\t\tlet rects;\r\n\t\tif(configRect){\r\n\t\t\trects=[configRect];\r\n\t\t}else{\r\n\t\t\trects = mv3d.getTileRects(tileId);\r\n\t\t}\r\n\t\tconst rot = tileConf.shape===mv3d.configurationShapes.XCROSS ? Math.PI/4 : 0;\r\n\t\tconst partHeight = isAutotile ? wallHeight/2 : wallHeight;\r\n\t\tfor (let i=0; i<=1; ++i){\r\n\t\t\tfor (const rect of rects){\r\n\t\t\t\tconst mesh = this.getCachedMesh(1-isAutotile/2,partHeight,DOUBLESIDE,true);\r\n\t\t\t\tmesh.x = x;\r\n\t\t\t\tmesh.y = y;\r\n\t\t\t\tmesh.z = z - (rect.oy|0)/tileHeight()*wallHeight - partHeight/2;\r\n\t\t\t\tmesh.rotate(YAxis,-Math.PI/2*i+rot,WORLDSPACE);\r\n\t\t\t\tmesh.translate(XAxis,-0.25*isAutotile+(rect.ox|0)/tileWidth(),LOCALSPACE);\r\n\t\t\t\tmesh.material = mv3d.getCachedTileMaterial(setN,rect.x,rect.y,rect.width,rect.height, mv3d.getMaterialOptions(tileId));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tgetAutotileCorner(tileId,realId=tileId){\r\n\t\tconst kind = Tilemap.getAutotileKind(tileId);\r\n\t\tlet tx = kind%8;\r\n\t\tlet ty = Math.floor(kind / 8);\r\n\t\tif(tileId===realId && mv3d.isWallTile(tileId)==1){ ++ty; }\r\n\t\tvar bx,by;\r\n\t\tbx=tx*2;\r\n\t\tby=ty;\r\n\t\tif(Tilemap.isTileA1(tileId)){\r\n\t\t\tif(kind<4){\r\n\t\t\t\tby=3*(kind%2)+1;\r\n\t\t\t\tbx=6*Math.floor(kind/2);\r\n\t\t\t}else{\r\n\t\t\t\tbx=8*Math.floor(tx/4) + (kind%2)*6;\r\n\t\t\t\tby=ty*6 + Math.floor(tx%4/2)*3 + 1-(tx%2);\r\n\t\t\t}\r\n\t\t}else if(Tilemap.isTileA2(tileId)){\r\n\t\t\tby=(ty-2)*3+1;\r\n\t\t}else if (Tilemap.isTileA3(tileId)){\r\n\t\t\tby=(ty-6)*2;\r\n\t\t}else if (Tilemap.isTileA4(tileId)){\r\n\t\t\tby=(ty-10)*2.5+(ty%2?0.5:0);\r\n\t\t}\r\n\t\treturn {x:bx,y:by};\r\n\t}\r\n}\r\nMapCell.neighborPositions = [\r\n\tnew Vector2( 0, 1),\r\n\tnew Vector2( 1, 0),\r\n\tnew Vector2( 0,-1),\r\n\tnew Vector2(-1, 0),\r\n];\r\nMapCell.meshCache={};","import mv3d from './mv3d.js';\r\nimport { MapCell } from './mapCell.js';\r\nimport { sleep, snooze } from './util.js';\r\nimport { Vector2 } from './mod_babylon.js';\r\n\r\nObject.assign(mv3d,{\r\n\r\n    mapLoaded: false,\r\n\tclearMap(){\r\n\t\tthis.mapLoaded=false;\r\n\t\t// clear materials and textures\r\n\t\tfor (const key in this.textureCache){\r\n\t\t\tthis.textureCache[key].dispose();\r\n\t\t}\r\n\t\tfor (const key in this.materialCache){\r\n\t\t\tthis.materialCache[key].dispose();\r\n\t\t}\r\n\t\tthis.animatedTextures.length=0;\r\n\t\tthis.textureCache={};\r\n\t\tthis.materialCache={};\r\n\t\t// clear map cells\r\n\t\tfor (const key in this.cells){\r\n\t\t\tthis.cells[key].dispose(false,true);\r\n\t\t}\r\n\t\tthis.cells={};\r\n\t\tfor (const char of this.characters){\r\n\t\t\tchar.dispose(false,true);\r\n\t\t}\r\n\t\tthis.characters.length=0;\r\n\t},\r\n\r\n\tloadMap(){\r\n\t\tthis.loadMapSettings();\r\n\t\t//this.cameraStick.x=$gamePlayer._realX;\r\n\t\t//this.cameraStick.y=$gamePlayer._realY;\r\n\t\tthis.updateBlenders();\r\n\t\tthis.updateMap();\r\n\t\tthis.createCharacters();\r\n\t},\r\n\r\n\tasync updateMap(){\r\n\t\tif(this.mapUpdating){ return; }\r\n\t\tthis.mapLoaded=true;\r\n\t\tthis.mapUpdating=true;\r\n\t\t// unload Far cells? implement if needed.\r\n\t\t// get range of cells based on render distance\r\n\t\tconst bounds = {\r\n\t\t\tleft:Math.floor((this.cameraStick.x-this.RENDER_DIST)/this.CELL_SIZE),\r\n\t\t\tright:Math.floor((this.cameraStick.x+this.RENDER_DIST)/this.CELL_SIZE),\r\n\t\t\ttop:Math.floor((this.cameraStick.y-this.RENDER_DIST)/this.CELL_SIZE),\r\n\t\t\tbottom:Math.floor((this.cameraStick.y+this.RENDER_DIST)/this.CELL_SIZE),\r\n\t\t}\r\n\t\t//clamp cell range to map\r\n\t\tif(!$gameMap.isLoopHorizontal()){\r\n\t\t\tbounds.left=Math.max(0,bounds.left);\r\n\t\t\tbounds.right=Math.min(bounds.right,Math.floor($gameMap.width()/mv3d.CELL_SIZE));\r\n\t\t}\r\n\t\tif(!$gameMap.isLoopVertical()){\r\n\t\t\tbounds.top=Math.max(0,bounds.top);\r\n\t\t\tbounds.bottom=Math.min(bounds.bottom,Math.floor($gameMap.height()/mv3d.CELL_SIZE));\r\n\t\t}\r\n\t\tconst cellsToLoad=[];\r\n\t\tfor (let ix=bounds.left;ix<=bounds.right;++ix)\r\n\t\tfor (let iy=bounds.top;iy<=bounds.bottom;++iy){\r\n\t\t\tlet cx=ix, cy=iy;\r\n\t\t\tif($gameMap.isLoopHorizontal()){ cx = cx.mod(Math.ceil($gameMap.width()/mv3d.CELL_SIZE)); }\r\n\t\t\tif($gameMap.isLoopVertical()){ cy = cy.mod(Math.ceil($gameMap.height()/mv3d.CELL_SIZE)); }\r\n\t\t\tcellsToLoad.push(new Vector2(cx,cy));\r\n\t\t}\r\n\t\tconst cameraCellPos = new Vector2(Math.round(this.cameraStick.x/this.CELL_SIZE-0.5),Math.round(this.cameraStick.y/this.CELL_SIZE-0.5));\r\n\t\tcellsToLoad.sort((a,b)=>Vector2.DistanceSquared(a,cameraCellPos)-Vector2.DistanceSquared(b,cameraCellPos));\r\n\t\tfor (const cellpos of cellsToLoad){\r\n\t\t\tlet {x:cx,y:cy} = cellpos;\r\n\t\t\tawait this.loadMapCell(cx,cy);\r\n\t\t\tawait snooze();\r\n\t\t\tif(!this.mapLoaded){ this.mapUpdating=false; return; }\r\n\t\t}\r\n\t\tthis.mapUpdating=false;\r\n\t},\r\n\r\n\tasync loadMapCell(cx,cy){\r\n\t\tconst key = [cx,cy].toString();\r\n\t\tif(key in this.cells){ return; }\r\n\t\tconst cell = new MapCell(cx,cy);\r\n\t\tthis.cells[key]=cell;\r\n\t\tawait cell.load();\r\n\t},\r\n\r\n});","import mv3d from './mv3d.js';\r\nimport { Texture, StandardMaterial, Color3 } from './mod_babylon.js';\r\nimport { tileWidth, tileHeight } from './util.js';\r\n\r\nObject.assign(mv3d,{\r\n\r\n\tanimatedTextures:[],\r\n\ttextureCache:{},\r\n\tmaterialCache:{},\r\n\r\n\tgetCachedTileTexture(setN,x,y,w,h){\r\n\t\tconst key = `${setN}|${x},${y}|${w},${h}`;\r\n\t\tif(key in this.textureCache){\r\n\t\t\treturn this.textureCache[key];\r\n\t\t}\r\n\t\tconst tsName = $gameMap.tileset().tilesetNames[setN];\r\n\t\tif(!tsName){\r\n\t\t\treturn this.getErrorTexture();\r\n\t\t}\r\n\t\tconst textureSrc=`img/tilesets/${tsName}.png`;\r\n\t\tconst texture = new Texture(textureSrc,this.scene);\r\n\t\ttexture.hasAlpha=true;\r\n\t\ttexture.onLoadObservable.addOnce(()=>{\r\n\t\t\tif(this.textureCache[key]!==texture){ return; }\r\n\t\t\ttexture.crop(x,y,w,h);\r\n\t\t\ttexture.updateSamplingMode(1);\r\n\t\t\t//texture.anisotropicFilteringLevel=4;\r\n\t\t\t//texture.noMipmap=false;\r\n\t\t\tif(setN===0){\r\n\t\t\t\tconst tx = x/tileWidth();\r\n\t\t\t\tconst ty = y/tileHeight();\r\n\t\t\t\tif(tx<6||tx>=8||ty>=6){\r\n\t\t\t\t\tconst isWaterfall = tx>=6&&tx<8||tx>=14;\r\n\t\t\t\t\ttexture.animX = isWaterfall ? 0 : 2;\r\n\t\t\t\t\ttexture.animY = isWaterfall ? 1 : 0;\r\n\t\t\t\t\ttexture.frameData={x:x,y:y,w:w,h:h};\r\n\t\t\t\t\tthis.animatedTextures.push(texture);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.textureCache[key]=texture;\r\n\t\treturn texture;\r\n\t},\r\n\r\n\tgetErrorTexture(){\r\n\t\tif(this.errorTexture){ return this.errorTexture; }\r\n\t\tthis.errorTexture = new Texture(\"MV3D/errorTexture.png\",this.scene);\r\n\t\treturn this.errorTexture;\r\n\t},\r\n\r\n\tgetBushAlphaTexture(){\r\n\t\tif(this.bushAlphaTexture){ return this.bushAlphaTexture; }\r\n\t\tthis.bushAlphaTexture = new Texture(\"MV3D/bushAlpha.png\",this.scene);\r\n\t\tthis.bushAlphaTexture.getAlphaFromRGB=true;\r\n\t\treturn this.bushAlphaTexture;\r\n\t},\r\n\r\n\tgetCachedTileMaterial(setN,x,y,w,h,options={}){\r\n\t\tthis.processMaterialOptions(options);\r\n\t\tconst key = `${setN}|${x},${y}|${w},${h}|${this.getExtraBit(options)}`;\r\n\t\tif(key in this.materialCache){\r\n\t\t\treturn this.materialCache[key];\r\n\t\t}\r\n\t\tconst texture = this.getCachedTileTexture(setN,x,y,w,h);\r\n\t\tconst material = new StandardMaterial(key, this.scene);\r\n\t\tmaterial.diffuseTexture=texture;\r\n\t\tif(options.transparent){ // alpha blending\r\n\t\t\t// materials with alpha blending don't cast shadows.\r\n\t\t\tmaterial.opacityTexture=texture;\r\n\t\t\tmaterial.alpha=options.alpha;\r\n\t\t}\r\n\t\tmaterial.alphaCutOff = mv3d.ALPHA_CUTOFF;\r\n\t\tmaterial.ambientColor.set(1,1,1);\r\n\t\tmaterial.emissiveColor.set(options.glow,options.glow,options.glow);\r\n\t\tmaterial.specularColor.set(0,0,0);\r\n\t\tthis.materialCache[key]=material;\r\n\t\treturn material;\r\n\t},\r\n\r\n\tprocessMaterialOptions(options){\r\n\t\tif('alpha' in options){\r\n\t\t\toptions.alpha = Math.round(options.alpha*7)/7;\r\n\t\t\tif(options.alph<1){\r\n\t\t\t\toptions.transparent=true;\r\n\t\t\t}\r\n\t\t}else{ options.alpha=1; }\r\n\t\tif('glow' in options){\r\n\t\t\toptions.glow = Math.round(options.glow*7)/7;\r\n\t\t}else{ options.glow=0; }\r\n\t},\r\n\r\n\tgetExtraBit(options){\r\n\t\tlet extra = 0;\r\n\t\textra|=Boolean(options.transparent)<<0;\r\n\t\textra|=7-options.alpha*7<<1;\r\n\t\textra|=options.glow*7<<1;\r\n\t\treturn extra.toString(36);\r\n\t},\r\n\r\n\t// animations\r\n\r\n\tlastAnimUpdate:0,\r\n\tanimXFrame:0,\r\n\tanimYFrame:0,\r\n\tanimDirection:1,\r\n\tupdateAnimations(){\r\n\t\tif( performance.now()-this.lastAnimUpdate <= this.ANIM_DELAY){ return; }\r\n\t\tthis.lastAnimUpdate=performance.now();\r\n\r\n\t\tif(this.animXFrame<=0){\r\n\t\t\tthis.animDirection=1;\r\n\t\t}else if(this.animXFrame>=2){\r\n\t\t\tthis.animDirection=-1;\r\n\t\t}\r\n\t\tthis.animXFrame += this.animDirection;\r\n\t\tthis.animYFrame=(this.animYFrame+1)%3;\r\n\t\tfor (const texture of this.animatedTextures){\r\n\t\t\ttexture.crop(\r\n\t\t\t\ttexture.frameData.x+texture.animX*this.animXFrame*tileWidth(),\r\n\t\t\t\ttexture.frameData.y+texture.animY*this.animYFrame*tileHeight(),\r\n\t\t\t\ttexture.frameData.w,\r\n\t\t\t\ttexture.frameData.h,\r\n\t\t\t);\r\n\t\t}\r\n\t},\r\n\r\n});","import mv3d from './mv3d.js';\r\nimport { TransformNode, MeshBuilder, FRONTSIDE, Texture, StandardMaterial, Color3, Mesh, WORLDSPACE, Vector2, SpotLight, Vector3, PointLight, LOCALSPACE, DOUBLESIDE, Plane } from \"./mod_babylon.js\";\r\nimport { relativeNumber, ZAxis, YAxis, tileSize, degtorad, XAxis } from './util.js';\r\nimport { ColorBlender, Blender } from './blenders.js';\r\n\r\nObject.assign(mv3d,{\r\n\tcreateCharacters(){\r\n\t\tconst events = $gameMap.events();\r\n\t\tfor (const event of events){\r\n\t\t\tthis.createCharacterFor(event,0);\r\n\t\t}\r\n\t\tconst vehicles = $gameMap.vehicles();\r\n\t\tfor (const vehicle of vehicles){\r\n\t\t\tthis.createCharacterFor(vehicle,1);\r\n\t\t}\r\n\t\tconst followers = $gamePlayer.followers()._data;\r\n\t\tfor (let f=followers.length-1; f>=0; --f){\r\n\t\t\tthis.createCharacterFor(followers[f],29-f);\r\n\t\t}\r\n\t\tthis.createCharacterFor($gamePlayer,30);\r\n\t},\r\n\r\n\tcreateCharacterFor(char,order){\r\n\t\tif(!char.mv3d_sprite){\r\n\t\t\tconst sprite = new Character(char,order);\r\n\t\t\tObject.defineProperty(char,'mv3d_sprite',{\r\n\t\t\t\tvalue:sprite,\r\n\t\t\t\tconfigurable:true,\r\n\t\t\t});\r\n\t\t\tthis.characters.push(sprite);\r\n\t\t\treturn sprite;\r\n\t\t}\r\n\t\treturn char.mv3d_sprite;\r\n\t},\r\n\r\n\tupdateCharacters(){\r\n\t\tfor(const char of this.characters){\r\n\t\t\tchar.update();\r\n\t\t}\r\n\t},\r\n\r\n\tsetupSpriteMeshes(){\r\n\t\tSprite.Meshes = {};\r\n\t\tSprite.Meshes.FLAT=Mesh.MergeMeshes([MeshBuilder.CreatePlane('sprite mesh',{ sideOrientation: DOUBLESIDE},mv3d.scene).rotate(XAxis,Math.PI/2,WORLDSPACE)]);\r\n\t\tSprite.Meshes.SPRITE=Mesh.MergeMeshes([MeshBuilder.CreatePlane('sprite mesh',{sideOrientation: DOUBLESIDE},mv3d.scene).translate(YAxis,0.5,WORLDSPACE)]);\r\n\t\tSprite.Meshes.CROSS=Mesh.MergeMeshes([\r\n\t\t\tSprite.Meshes.SPRITE.clone(),\r\n\t\t\tSprite.Meshes.SPRITE.clone().rotate(YAxis,Math.PI/2,WORLDSPACE),\r\n\t\t]);\r\n\r\n\t\tSprite.Meshes.SHADOW=Sprite.Meshes.FLAT.clone('shadow mesh');\r\n\t\tconst shadowTexture = new Texture(\"MV3D/shadow.png\");\r\n\t\tconst shadowMaterial = new StandardMaterial('shadow material', mv3d.scene);\r\n\t\tshadowMaterial.diffuseTexture=shadowTexture;\r\n\t\tshadowMaterial.opacityTexture=shadowTexture;\r\n\t\tSprite.Meshes.SHADOW.material=shadowMaterial;\r\n\t\t\r\n\t\tfor (const key in Sprite.Meshes){\r\n\t\t\tmv3d.scene.removeMesh(Sprite.Meshes[key]);\r\n\t\t}\r\n\t},\r\n});\r\n\r\n\r\nclass Sprite extends TransformNode{\r\n\tconstructor(){\r\n\t\tsuper('sprite',mv3d.scene);\r\n\t\tthis.spriteOrigin = new TransformNode('sprite origin',mv3d.scene);\r\n\t\tthis.spriteOrigin.parent=this;\r\n\t\tthis.mesh = Sprite.Meshes.FLAT.clone();\r\n\t\tthis.mesh.parent = this.spriteOrigin;\r\n\t}\r\n\tsetMaterial(src){\r\n\t\tthis.disposeMaterial();\r\n\t\tthis.texture = new Texture(src,mv3d.scene);\r\n\t\tthis.bitmap = this.texture._texture;\r\n\t\tthis.texture.hasAlpha=true;\r\n\t\tthis.texture.onLoadObservable.addOnce(()=>this.onTextureLoaded());\r\n\t\tthis.material = new StandardMaterial('sprite material',mv3d.scene);\r\n\t\tthis.material.diffuseTexture=this.texture;\r\n\t\tthis.material.alphaCutOff = mv3d.ALPHA_CUTOFF;\r\n\t\tthis.material.ambientColor.set(1,1,1);\r\n\t\tthis.material.specularColor.set(0,0,0);\r\n\t\tthis.mesh.material=this.material;\r\n\t}\r\n\tonTextureLoaded(){\r\n\t\tthis.texture.updateSamplingMode(1);\r\n\t}\r\n\tdisposeMaterial(){\r\n\t\tif(this.material){\r\n\t\t\tthis.material.dispose(true,true);\r\n\t\t\tthis.material=null;\r\n\t\t\tthis.texture=null;\r\n\t\t\tthis.bitmap=null;\r\n\t\t}\r\n\t}\r\n\tdispose(...args){\r\n\t\tthis.disposeMaterial();\r\n\t\tsuper.dispose(...args);\r\n\t}\r\n}\r\n\r\nclass Character extends Sprite{\r\n\tconstructor(char,order){\r\n\t\tsuper();\r\n\t\tthis.order=order;\r\n\t\tthis.mesh.order=this.order;\r\n\t\tthis.mesh.character=this;\r\n\t\tthis._character=this.char=char;\r\n\t\tthis.charName='';\r\n\t\tthis.charIndex=0;\r\n\r\n\t\tthis.updateCharacter();\r\n\t\tthis.updateShape();\r\n\r\n\t\tthis.isVehicle = this.char instanceof Game_Vehicle;\r\n\t\tthis.isBoat = this.isVehicle && this.char.isBoat();\r\n\t\tthis.isShip = this.isVehicle && this.char.isShip();\r\n\t\tthis.isAirship = this.isVehicle && this.char.isAirship();\r\n\t\tthis.isEvent = this.char instanceof Game_Event;\r\n\t\tthis.isPlayer = this.char instanceof Game_Player;\r\n\t\tthis.isFollower = this.char instanceof Game_Follower;\r\n\r\n\t\tif(this.isEvent){\r\n\t\t\tthis.eventConfigure();\r\n\t\t}\r\n\r\n\t\tthis.elevation = 0;\r\n\r\n\t\tif(!this.char.mv3d_blenders){ this.char.mv3d_blenders={}; }\r\n\r\n\t\tif(mv3d.CHARACTER_SHADOWS){\r\n\t\t\t//this.shadow = Sprite.Meshes.SHADOW.createInstance();\r\n\t\t\tthis.shadow = Sprite.Meshes.SHADOW.clone();\r\n\t\t\tthis.shadow.parent=this.spriteOrigin;\r\n\t\t}\r\n\r\n\t\tthis.lightOrigin = new TransformNode('light origin',mv3d.scene);\r\n\t\tthis.lightOrigin.parent=this;\r\n\t\tthis.setupLights();\r\n\t}\r\n\r\n\tisTextureReady(){\r\n\t\treturn Boolean(this.texture && this.texture.isReady());\r\n\t}\r\n\r\n\tsetTileMaterial(){\r\n\t\tconst setN = mv3d.getSetNumber(this._tileId);\r\n\t\tconst tsName = $gameMap.tileset().tilesetNames[setN];\r\n\t\tif(tsName){\r\n\t\t\tconst textureSrc=`img/tilesets/${tsName}.png`;\r\n\t\t\tthis.setMaterial(textureSrc);\r\n\t\t}else{\r\n\t\t\tthis.setMaterial(\"MV3D/errorTexture.png\");\r\n\t\t}\r\n\t}\r\n\r\n\tonTextureLoaded(){\r\n\t\tsuper.onTextureLoaded();\r\n\t\tthis.updateFrame();\r\n\t\tthis.updateScale();\r\n\t}\r\n\r\n\tupdateCharacter(){\r\n\t\tthis._tilesetId = $gameMap.tilesetId();\r\n\t\tthis._tileId = this._character.tileId();\r\n\t\tthis._characterName = this._character.characterName();\r\n\t\tthis._characterIndex = this._character.characterIndex();\r\n\t\tthis._isBigCharacter = ImageManager.isBigCharacter(this._characterName);\r\n\t\tif(this._tileId>0){\r\n\t\t\tthis.setTileMaterial(this._tileId);\r\n\t\t}else if(this._characterName){\r\n\t\t\tthis.setMaterial(`img/characters/${this._characterName}.png`);\r\n\t\t}\r\n\t}\r\n\tupdateCharacterFrame(){\r\n\t\tthis.px=this.characterPatternX();\r\n\t\tthis.py=this.characterPatternY();\r\n\t\tif(!this.isTextureReady()){ return; }\r\n\t\tconst pw = this.patternWidth();\r\n\t\tconst ph = this.patternHeight();\r\n\t\tconst sx = (this.characterBlockX() + this.px) * pw;\r\n\t\tconst sy = (this.characterBlockY() + this.py) * ph;\r\n\t\tthis.setFrame(sx,sy,pw,ph);\r\n\t}\r\n\tpatternChanged(){\r\n\t\treturn this.px!==this.characterPatternX() || this.py!==this.characterPatternY();\r\n\t}\r\n\tcharacterPatternY(){\r\n\t\tif(this.isEvent && this.char.isObjectCharacter()){\r\n\t\t\treturn this.char.direction()/2-1;\r\n\t\t}\r\n\t\tlet dir = mv3d.transformDirectionYaw(this.char.direction());\r\n\t\treturn dir/2-1;\r\n\t}\r\n\r\n\tsetFrame(x,y,w,h){\r\n\t\tif(!this.isTextureReady()){ return; }\r\n\t\tthis.texture.crop(x,y,w,h);\r\n\t}\r\n\r\n\tupdateScale(){\r\n\t\tif(!this.isTextureReady()){ return; }\r\n\t\tconst configScale = this.getConfig('scale',new Vector2(1,1));\r\n\t\tlet scale = 1;\r\n\t\tif(this.isVehicle){\r\n\t\t\tconst settings = mv3d[`${this.char._type.toUpperCase()}_SETTINGS`];\r\n\t\t\tscale = mv3d.loadData( `${this.char._type}_scale`, settings.scale );\r\n\t\t}\r\n\t\tconst xscale = this.patternWidth()/tileSize() * configScale.x * scale;\r\n\t\tconst yscale = this.patternHeight()/tileSize() * configScale.y * scale;\r\n\t\tthis.mesh.scaling.set(xscale,yscale,yscale);\r\n\t}\r\n\r\n\tgetConfig(key,dfault=undefined){\r\n\t\tif(!this.settings_event){ return dfault; }\r\n\t\tif(key in this.settings_event_page){\r\n\t\t\treturn this.settings_event_page[key];\r\n\t\t}else if(key in this.settings_event){\r\n\t\t\treturn this.settings_event[key];\r\n\t\t}\r\n\t\treturn dfault;\r\n\t}\r\n\thasConfig(key){\r\n\t\tif(!this.settings_event){ return false; }\r\n\t\treturn key in this.settings_event_page || key in this.settings_event;\r\n\t}\r\n\r\n\teventConfigure(){\r\n\t\tif(!this.settings_event){\r\n\t\t\tthis.settings_event={};\r\n\t\t\tconst note = this.char.event().note;\r\n\t\t\tmv3d.readConfigurationFunctions(\r\n\t\t\t\tmv3d.readConfigurationTags(note),\r\n\t\t\t\tmv3d.eventConfigurationFunctions,\r\n\t\t\t\tthis.settings_event,\r\n\t\t\t);\r\n\t\t}\r\n\t\tthis.settings_event_page={};\r\n\t\tconst page = this.char.page();\r\n\t\tif(!page){ return; }\r\n\t\tlet comments = '';\r\n\t\tfor (const command of page.list){\r\n\t\t\tif(command.code===108||command.code===408){\r\n\t\t\t\tcomments+=command.parameters[0];\r\n\t\t\t}\r\n\t\t}\r\n\t\tmv3d.readConfigurationFunctions(\r\n\t\t\tmv3d.readConfigurationTags(comments),\r\n\t\t\tmv3d.eventConfigurationFunctions,\r\n\t\t\tthis.settings_event_page,\r\n\t\t);\r\n\t\tthis.updateScale();\r\n\t\tthis.updateShape();\r\n\r\n\t\tif(this.char.mv3d_needsConfigure){\r\n\t\t\tthis.char.mv3d_needsConfigure=false;\r\n\t\t}else{ return; }\r\n\r\n\t\tif('pos' in this.settings_event_page){\r\n\t\t\tconst event=this.char.event();\r\n\t\t\tconst pos = this.settings_event_page.pos;\r\n\t\t\tthis.char.locate(\r\n\t\t\t\trelativeNumber(event.x,pos.x),\r\n\t\t\t\trelativeNumber(event.y,pos.y),\r\n\t\t\t);\r\n\t\t}\r\n\t\t/*\r\n\t\tthis.setupEventLights();\r\n\r\n\t\tif('lamp' in this.settings_event_page){\r\n\t\t\tconst lampConfig = this.getConfig('lamp');\r\n\t\t\tthis.blendLampColor.setValue(lampConfig.color,0.5);\r\n\t\t\tthis.blendLampIntensity.setValue(lampConfig.intensity,0.5);\r\n\t\t\tthis.blendLampDistance.setValue(lampConfig.distance,0.5);\r\n\t\t}\r\n\t\tif('flashlight' in this.settings_event_page){\r\n\t\t\tconst flashlightConfig = this.getConfig('flashlight');\r\n\t\t\tthis.blendFlashlightColor.setValue(flashlightConfig.color,0.5);\r\n\t\t\tthis.blendFlashlightIntensity.setValue(flashlightConfig.intensity,0.5);\r\n\t\t\tthis.blendFlashlightDistance.setValue(flashlightConfig.distance,0.5);\r\n\t\t\tthis.blendFlashlightAngle.setValue(flashlightConfig.angle,0.5);\r\n\t\t\tthis.blendFlashlightPitch.setValue(this.getConfig('flashlightPitch',90),0.25);\r\n\t\t\tthis.flashlightTargetYaw=this.getConfig('flashlightYaw','+0');\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tsetupMesh(){\r\n\t\tthis.mesh.parent = this.spriteOrigin;\r\n\t\tthis.mesh.character=this;\r\n\t\tthis.mesh.order=this.order;\r\n\t\tif(this.material){\r\n\t\t\tthis.mesh.material=this.material;\r\n\t\t}\r\n\t\tif(this.flashlight){\r\n\t\t\tthis.flashlight.excludedMeshes.splice(0,Infinity);\r\n\t\t\tthis.flashlight.excludedMeshes.push(this.mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tsetupLights(){\r\n\t\tif('flashlightColor' in this.char.mv3d_blenders){\r\n\t\t\tthis.setupFlashlight();\r\n\t\t}\r\n\t\tif('lampColor' in this.char.mv3d_blenders){\r\n\t\t\tthis.setupLamp();\r\n\t\t}\r\n\t}\r\n\r\n\tsetupFlashlight(){\r\n\t\tif(this.flashlight){ return; }\r\n\t\tconst config = this.getConfig('flashlight',{\r\n\t\t\tcolor:0xffffff,\r\n\t\t\tintensity:1,\r\n\t\t\tdistance:mv3d.LIGHT_DIST,\r\n\t\t\tangle:mv3d.LIGHT_ANGLE,\r\n\t\t});\r\n\t\tthis.blendFlashlightColor = this.makeColorBlender('flashlightColor',config.color);\r\n\t\tthis.blendFlashlightIntensity = this.makeBlender('flashlightIntensity',config.intensity);\r\n\t\tthis.blendFlashlightDistance = this.makeBlender('flashlightDistance',config.distance);\r\n\t\tthis.blendFlashlightAngle = this.makeBlender('flashlightAngle',config.angle);\r\n\t\tthis.flashlight = new SpotLight('flashlight',Vector3.Zero(),Vector3.Zero(),\r\n\t\t\tdegtorad(this.blendFlashlightAngle.targetValue()),0,mv3d.scene);\r\n\t\tthis.flashlight.exponent = 64800*Math.pow(this.blendFlashlightAngle.targetValue(),-2);\r\n\t\tthis.flashlight.range = this.blendFlashlightDistance.targetValue();\r\n\t\tthis.flashlight.intensity=this.blendFlashlightIntensity.targetValue();\r\n\t\tthis.flashlight.diffuse.set(...this.blendFlashlightColor.targetComponents());\r\n\t\t//this.flashlight.projectionTexture = mv3d.getFlashlightTexture();\r\n\t\tthis.flashlight.direction.y=-1;\r\n\t\tthis.flashlightOrigin=new TransformNode('flashlight origin',mv3d.scene);\r\n\t\tthis.flashlightOrigin.parent=this.lightOrigin;\r\n\t\tthis.flashlight.parent=this.flashlightOrigin;\r\n\t\tthis.blendFlashlightPitch = this.makeBlender('flashlightPitch',70);\r\n\t\tthis.blendFlashlightYaw = this.makeBlender('flashlightYaw', 0);\r\n\t\tthis.blendFlashlightYaw.cycle=360;\r\n\t\tthis.flashlightTargetYaw=this.getConfig('flashlightYaw','+0');\r\n\t\tthis.updateFlashlightDirection();\r\n\t\tthis.setupMesh();\r\n\t}\r\n\r\n\tsetupLamp(){\r\n\t\tif(this.lamp){ return; }\r\n\t\tconst config = this.getConfig('lamp',{\r\n\t\t\tcolor:0xffffff,\r\n\t\t\tintensity:1,\r\n\t\t\tdistance:mv3d.LIGHT_DIST,\r\n\t\t});\r\n\t\tthis.blendLampColor = this.makeColorBlender('lampColor',config.color);\r\n\t\tthis.blendLampIntensity = this.makeBlender('lampIntensity',config.intensity);\r\n\t\tthis.blendLampDistance = this.makeBlender('lampDistance',config.distance);\r\n\t\tthis.lamp = new PointLight('lamp',Vector3.Zero(),mv3d.scene);\r\n\t\tthis.lamp.diffuse.set(...this.blendLampColor.targetComponents());\r\n\t\tthis.lamp.intensity=this.blendLampIntensity.targetValue();\r\n\t\tthis.lamp.range=this.blendLampDistance.targetValue();\r\n\t\tthis.lamp.parent=this.lightOrigin;\r\n\t}\r\n\r\n\tupdateFlashlightDirection(){\r\n\t\t/*\r\n\t\tconst yaw = degtorad(this.blendFlashlightYaw.currentValue());\r\n\t\tconst pitch = degtorad(this.blendFlashlightPitch.currentValue());\r\n\t\tthis.flashlight.direction.x=Math.sin(yaw)*Math.sin(pitch);\r\n\t\tthis.flashlight.direction.z=-Math.cos(yaw)*Math.sin(pitch);\r\n\t\tthis.flashlight.direction.y=-Math.cos(pitch);\r\n\t\t*/\r\n\t\tthis.flashlightOrigin.yaw=this.blendFlashlightYaw.currentValue();\r\n\t\tthis.flashlightOrigin.pitch=-this.blendFlashlightPitch.currentValue();\r\n\t\tthis.flashlightOrigin.position.set(0,0,0);\r\n\t\tlet flashlightOffset = Math.tan(degtorad(90-this.blendFlashlightAngle.currentValue()-Math.max(90,this.blendFlashlightPitch.currentValue())+90))*mv3d.LIGHT_HEIGHT;\r\n\t\tflashlightOffset = Math.max(0,Math.min(1,flashlightOffset));\r\n\t\tthis.flashlight.range+=flashlightOffset;\r\n\t\tthis.flashlightOrigin.translate(YAxis,flashlightOffset,LOCALSPACE);\r\n\t}\r\n\r\n\tupdateLights(){\r\n\t\tif(this.flashlight){\r\n\t\t\tconst flashlightYaw = 180+relativeNumber( mv3d.dirToYaw( this.char.direction() ), this.flashlightTargetYaw);\r\n\t\t\tif(flashlightYaw !== this.blendFlashlightYaw.targetValue()){\r\n\t\t\t\tthis.blendFlashlightYaw.setValue(flashlightYaw,0.25);\r\n\t\t\t}\r\n\t\t\tif(this.blendFlashlightColor.update()|this.blendFlashlightIntensity.update()\r\n\t\t\t|this.blendFlashlightDistance.update()|this.blendFlashlightAngle.update()\r\n\t\t\t|this.blendFlashlightYaw.update()|this.blendFlashlightPitch.update()){\r\n\t\t\t\tthis.flashlight.diffuse.set(...this.blendFlashlightColor.currentComponents());\r\n\t\t\t\tthis.flashlight.intensity=this.blendFlashlightIntensity.currentValue();\r\n\t\t\t\tthis.flashlight.range=this.blendFlashlightDistance.currentValue();\r\n\t\t\t\tthis.flashlight.angle=degtorad(this.blendFlashlightAngle.currentValue());\r\n\t\t\t\tthis.flashlight.exponent = 64800*Math.pow(this.blendFlashlightAngle.targetValue(),-2);\r\n\t\t\t\tthis.updateFlashlightDirection();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(this.lamp){\r\n\t\t\tif(this.blendLampColor.update()|this.blendLampIntensity.update()|this.blendLampDistance.update()){\r\n\t\t\t\tthis.lamp.diffuse.set(...this.blendLampColor.currentComponents());\r\n\t\t\t\tthis.lamp.intensity=this.blendLampIntensity.currentValue();\r\n\t\t\t\tthis.lamp.range=this.blendLampDistance.currentValue();\r\n\t\t\t}\r\n\t\t}\r\n\t\t/*\r\n\t\tif(this.flashlight&&this.lamp){\r\n\t\t\tconst flashlightComponents = this.blendFlashlightColor.currentComponents().map(c=>c*this.flashlight.intensity/4);\r\n\t\t\tconst lampComponents = this.blendLampColor.currentComponents().map(c=>c*this.lamp.intensity/4);\r\n\t\t\tthis.material.emissiveColor.set(...flashlightComponents.map((c,i)=>(c+lampComponents[i])/2));\r\n\r\n\t\t}else if(this.flashlight){\r\n\t\t\tthis.material.emissiveColor.set(...this.blendFlashlightColor.currentComponents().map(c=>c*this.flashlight.intensity/4));\r\n\t\t}else if(this.lamp){\r\n\t\t\tthis.material.emissiveColor.set(...this.blendLampColor.currentComponents().map(c=>c*this.lamp.intensity/4));\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tmakeBlender(key,dfault,clazz=Blender){\r\n\t\tif(key in this.char.mv3d_blenders){\r\n\t\t\tdfault = this.char.mv3d_blenders[key];\r\n\t\t}else{\r\n\t\t\tthis.char.mv3d_blenders[key]=dfault;\r\n\t\t}\r\n\t\tconst blender=new clazz(key,dfault);\r\n\t\tblender.storageLocation=()=>this.char.mv3d_blenders;\r\n\t\treturn blender;\r\n\t}\r\n\tmakeColorBlender(key,dfault){\r\n\t\treturn this.makeBlender(key,dfault,ColorBlender);\r\n\t}\r\n\r\n\thasBush(){\r\n\t\tif(this.isEvent){\r\n\t\t\treturn this.getConfig('bush',!this._tileId);\r\n\t\t}\r\n\t\tif(this.isVehicle){\r\n\t\t\treturn mv3d.VEHICLE_BUSH;\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\r\n\tgetShape(){\r\n\t\treturn this.getConfig('shape',\r\n\t\t\tthis.char.isTile() ? mv3d.configurationShapes.FLAT : mv3d.EVENT_SHAPE\r\n\t\t);\r\n\t}\r\n\tupdateShape(){\r\n\t\tconst newshape = this.getShape();\r\n\t\tif(this.shape === newshape){ return; }\r\n\t\tthis.shape=newshape;\r\n\t\t//let backfaceCulling=true;\r\n\t\tlet geometry = Sprite.Meshes.SPRITE;\r\n\t\tconst shapes = mv3d.configurationShapes;\r\n\t\tswitch(this.shape){\r\n\t\tcase shapes.FLAT:\r\n\t\t\tgeometry = Sprite.Meshes.FLAT;\r\n\t\t\t//if(this.char._priorityType===2||this.hasConfig('height')||this.hasConfig('z')){\r\n\t\t\t//\tbackfaceCulling=false;\r\n\t\t\t//}\r\n\t\t\tbreak;\r\n\t\tcase shapes.CROSS:\r\n\t\t\tgeometry = Sprite.Meshes.CROSS;\r\n\t\t\t//backfaceCulling=false;\r\n\t\t\tbreak;\r\n\t\tcase shapes.FENCE:\r\n\t\t\t//backfaceCulling=false;\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\tthis.mesh.dispose();\r\n\t\tthis.mesh=geometry.clone();\r\n\t\t//this.material.backfaceCulling=backfaceCulling;\r\n\t\tthis.setupMesh();\r\n\t}\r\n\r\n\tupdate(){\r\n\t\tif(this.char._erased){\r\n\t\t\tthis.dispose();\r\n\t\t}\r\n\r\n\t\tthis.visible=this.char.mv_sprite.visible;\r\n\t\tif(typeof this.char.isVisible === 'function'){\r\n\t\t\tthis.visible=this.visible&&this.char.isVisible();\r\n\t\t}\r\n\t\tif(!this.material){\r\n\t\t\tthis.visible=false;\r\n\t\t}\r\n\t\tif(!this._isEnabled){\r\n\t\t\tif(this.visible){ this.setEnabled(true); }\r\n\t\t}else{\r\n\t\t\tif(!this.visible){ this.setEnabled(false); }\r\n\t\t}\r\n\t\tif(!this._isEnabled){ return; }\r\n\r\n\t\tif(this.isImageChanged()){\r\n\t\t\tthis.updateCharacter();\r\n\t\t}\r\n\t\tif(this.patternChanged()){\r\n\t\t\tthis.updateFrame();\r\n\t\t}\r\n\r\n\t\tif(this.shape===mv3d.configurationShapes.SPRITE){\r\n\t\t\tthis.mesh.pitch = mv3d.blendCameraPitch.currentValue()-90;\r\n\t\t\tthis.mesh.yaw = mv3d.blendCameraYaw.currentValue();\r\n\t\t}else if(this.shape===mv3d.configurationShapes.TREE){\r\n\t\t\tthis.mesh.pitch=0;\r\n\t\t\tthis.mesh.yaw = mv3d.blendCameraYaw.currentValue();\r\n\t\t}else{\r\n\t\t\tthis.mesh.pitch=0;\r\n\t\t\tthis.mesh.yaw=this.getConfig('rot',0);\r\n\t\t}\r\n\t\t//this.mesh.renderOutline=true;\r\n\t\t//this.mesh.outlineWidth=1;\r\n\r\n\t\tthis.bush = Boolean(this.char.bushDepth());\r\n\t\tif(this.bush && this.hasBush()){\r\n\t\t\tif(!this.material.opacityTexture){\r\n\t\t\t\tthis.material.opacityTexture=mv3d.getBushAlphaTexture();\r\n\t\t\t\tthis.material.useAlphaFromDiffuseTexture=true;\r\n\t\t\t}\r\n\t\t}else{\r\n\t\t\tif(this.material.opacityTexture){\r\n\t\t\t\tthis.material.opacityTexture=null;\r\n\t\t\t\tthis.material.useAlphaFromDiffuseTexture=false;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.tileHeight = mv3d.getWalkHeight(this.char._realX,this.char._realY);\r\n\r\n\t\tthis.updatePosition();\r\n\t\tthis.updateElevation();\r\n\t\tif(this.shadow){ this.updateShadow(); }\r\n\t\tthis.updateLights();\r\n\r\n\t}\r\n\r\n\tupdatePosition(){\r\n\t\tconst loopPos = mv3d.loopCoords(this.char._realX,this.char._realY);\r\n\t\tthis.x = loopPos.x;\r\n\t\tthis.y = loopPos.y;\r\n\r\n\t\tthis.spriteOrigin.position.set(0,0,0);\r\n\t\tthis.lightOrigin.position.set(0,0,0);\r\n\t\tthis.spriteOrigin.z = mv3d.LAYER_DIST*4;\r\n\t\tthis.lightOrigin.z = this.getConfig('lightHeight',mv3d.LIGHT_HEIGHT);\r\n\r\n\t\tconst billboardOffset = new Vector2(Math.sin(-mv3d.cameraNode.rotation.y),Math.cos(mv3d.cameraNode.rotation.y)).multiplyByFloats(0.45,0.45);\r\n\t\tconst lightOffset = this.getConfig('lightOffset',null);\r\n\t\tif(this.shape===mv3d.configurationShapes.SPRITE){\r\n\t\t\tthis.spriteOrigin.x=billboardOffset.x;\r\n\t\t\tthis.spriteOrigin.y=billboardOffset.y;\r\n\t\t\tthis.lightOrigin.x=billboardOffset.x;\r\n\t\t\tthis.lightOrigin.y=billboardOffset.y;\r\n\t\t}else if(!lightOffset){\r\n\t\t\tthis.lightOrigin.x=billboardOffset.x/2;\r\n\t\t\tthis.lightOrigin.y=billboardOffset.y/2;\r\n\t\t}\r\n\t\tif(lightOffset){\r\n\t\t\tthis.lightOrigin.x+=lightOffset.x;\r\n\t\t\tthis.lightOrigin.y+=lightOffset.y;\r\n\t\t}\r\n\r\n\t\tthis.spriteOrigin.x += this.getConfig('x',0);\r\n\t\tthis.spriteOrigin.y += this.getConfig('y',0);\r\n\t}\r\n\r\n\tupdateElevation(){\r\n\t\tlet newElevation = this.tileHeight;\r\n\t\tif(this.isVehicle || (this.isPlayer||this.isFollower)&&$gamePlayer.vehicle()){\r\n\t\t\tnewElevation += mv3d.getFloatHeight(Math.round(this.char._realX),Math.round(this.char._realY));\r\n\t\t\tif(this.char===$gameMap.vehicle('boat')){\r\n\t\t\t\tnewElevation += mv3d.BOAT_SETTINGS.zoff;\r\n\t\t\t}else if(this.char===$gameMap.vehicle('ship')){\r\n\t\t\t\tnewElevation += mv3d.SHIP_SETTINGS.zoff;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif(this.isAirship && $gamePlayer.vehicle()===this.char){\r\n\t\t\tif(!this.char._driving){\r\n\t\t\t\tthis.elevation += (newElevation-this.elevation)/10;\r\n\t\t\t}if(newElevation>=this.elevation){\r\n\t\t\t\tconst ascentSpeed = 100/Math.pow(1.5,mv3d.loadData('airship_ascentspeed',4));\r\n\t\t\t\tthis.elevation += (newElevation-this.elevation)/ascentSpeed;\r\n\t\t\t}else{\r\n\t\t\t\tif(!mv3d.vehicleObstructed(this.char,this.char.x,this.char.y,true)){\r\n\t\t\t\t\tconst descentSpeed = 100/Math.pow(1.5,mv3d.loadData('airship_descentspeed',2));\r\n\t\t\t\t\tthis.elevation += (newElevation-this.elevation)/descentSpeed;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.z = this.elevation;\r\n\t\t\tthis.z += mv3d.loadData('airship_height',mv3d.AIRSHIP_SETTINGS.height)*this.char._altitude/this.char.maxAltitude();\r\n\t\t}else if(this.char.isJumping()){\r\n\t\t\tlet jumpProgress = 1-(this.char._jumpCount/(this.char._jumpPeak*2));\r\n\t\t\tlet jumpHeight = Math.pow(jumpProgress-0.5,2)*-4+1;\r\n\t\t\tlet jumpDiff = Math.abs(this.char.mv3d_jumpHeightEnd - this.char.mv3d_jumpHeightStart);\r\n\t\t\tthis.z = this.char.mv3d_jumpHeightStart*(1-jumpProgress)\r\n\t\t\t+ this.char.mv3d_jumpHeightEnd*jumpProgress + jumpHeight*jumpDiff/2\r\n\t\t\t+this.char.jumpHeight()/tileSize();\r\n\t\t}else{\r\n\t\t\tthis.elevation=newElevation;\r\n\t\t\tthis.z=this.elevation;\r\n\t\t}\r\n\r\n\t\tif(this.isEvent){\r\n\t\t\tthis.z += this.getConfig('height',this.char._priorityType===2?mv3d.EVENT_HEIGHT:0);\r\n\t\t\tif(this.hasConfig('z')){\r\n\t\t\t\tthis.z=this.getConfig('z',0);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tupdateShadow(){\r\n\t\tlet shadowVisible = this.getConfig('shadow', this.shape!=mv3d.configurationShapes.FLAT );\r\n\r\n\t\tif(shadowVisible&&(this.isPlayer||this.isFollower)){\r\n\t\t\tconst myIndex = mv3d.characters.indexOf(this);\r\n\t\t\tif(myIndex>=0)\r\n\t\t\tfor (let i=myIndex+1; i<mv3d.characters.length; ++i){\r\n\t\t\t\tconst other = mv3d.characters[i];\r\n\t\t\t\tif(!other.shadow||!other.visible){ continue; }\r\n\t\t\t\tif(other.char._realX===this.char._realX&&other.char._realY===this.char._realY){\r\n\t\t\t\t\tshadowVisible=false;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(!this.shadow._isEnabled){\r\n\t\t\tif(shadowVisible){ this.shadow.setEnabled(true); }\r\n\t\t}else{\r\n\t\t\tif(!shadowVisible){ this.shadow.setEnabled(false); }\r\n\t\t}\r\n\t\tif(!shadowVisible){ return; }\r\n\r\n\t\tconst shadowBase = Math.min(0,this.getConfig('height',0));\r\n\t\tconst shadowDist = Math.max(this.z - this.tileHeight, shadowBase);\r\n\t\tconst shadowFadeDist = this.isAirship? mv3d.AIRSHIP_SETTINGS.shadowDist : mv3d.SHADOW_DIST;\r\n\t\tconst shadowStrength = Math.max(0,1-Math.abs(shadowDist)/shadowFadeDist);\r\n\t\tthis.shadow.z = -shadowDist;\r\n\t\tconst shadowScale = this.isAirship? mv3d.AIRSHIP_SETTINGS.shadowScale : this.getConfig('shadowScale',mv3d.SHADOW_SCALE);\r\n\t\tthis.shadow.scaling.setAll(shadowScale*shadowStrength);\r\n\t\tif(!this.shadow.isAnInstance){\r\n\t\t\tthis.shadow.visibility=shadowStrength-0.5*this.bush;//visibility doesn't work with instancing\r\n\t\t}\r\n\t}\r\n\r\n\tdispose(...args){\r\n\t\tsuper.dispose(...args);\r\n\t\tdelete this.char.mv3d_sprite;\r\n\t}\r\n}\r\n\r\nfor (const methodName of [\r\n\t'characterBlockX','characterBlockY','characterPatternX',\r\n\t'isImageChanged','patternWidth','patternHeight',\r\n\t'updateTileFrame','updateFrame',\r\n]){\r\n\tCharacter.prototype[methodName]=Sprite_Character.prototype[methodName];\r\n}","import mv3d from './mv3d.js';\r\n\r\nObject.assign(mv3d,{\r\n\tvehicleObstructed(vehicle,...args){\r\n\t\treturn vehicleObstructed.apply(vehicle,args);\r\n\t}\r\n});\r\n\r\nconst _characterBase_canPass = Game_CharacterBase.prototype.canPass\r\nGame_CharacterBase.prototype.canPass = function(x, y, d) {\r\n\tif(!_characterBase_canPass.apply(this,arguments)){\r\n\t\treturn false;\r\n\t}\r\n\tconst x2 = $gameMap.roundXWithDirection(x, d);\r\n\tconst y2 = $gameMap.roundYWithDirection(y, d);\r\n\tif(this===$gamePlayer){\r\n\t\tconst vehicle = this.vehicle();\r\n\t\tif(vehicle){\r\n\t\t\tconst obstructed = vehicleObstructed.call(vehicle,x2,y2,false);\r\n\t\t\tif(vehicle.isAirship()){\r\n\t\t\t\treturn !obstructed;\r\n\t\t\t}else if(obstructed){\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tif (this.isThrough() || this.isDebugThrough()) {\r\n\t\treturn true;\r\n\t}\r\n\tconst tileHeight1 = mv3d.getWalkHeight(x,y);\r\n\tconst tileHeight2 = mv3d.getWalkHeight(x2,y2);\r\n\tif(tileHeight1!==tileHeight2){ return false; }\r\n\treturn true;\r\n};\r\n\r\n// vehicles\r\n\r\nfunction vehicleNotObstructed(x, y, strict=true){\r\n\tif(!(this instanceof Game_Vehicle)){ throw \"This isn't a vehicle.\"; }\r\n\tif(!this.mv3d_sprite){ return true; }\r\n\tif(!this._driving){ return true; }\r\n\tif($gamePlayer.isDebugThrough()){ return true; }\r\n\tconst isAirship=this.isAirship();\r\n\tconst settings = mv3d[`${this._type.toUpperCase()}_SETTINGS`];\r\n\tconst big = mv3d.loadData( `${this._type}_big`, settings.big );\r\n\tlet altitude = 0.5;\r\n\tif(isAirship){\r\n\t\taltitude = mv3d.loadData('airship_height',mv3d.AIRSHIP_SETTINGS.height);\r\n\t}else{\r\n\t\taltitude += mv3d.getFloatHeight(x,y);\r\n\t}\r\n\tconst tileHeight = mv3d.getWalkHeight(x,y);\r\n\tlet posZ = this.mv3d_sprite.z;\r\n\tif('zoff' in settings){\r\n\t\tposZ-=settings.zoff;\r\n\t}\r\n\tif(tileHeight>posZ){ return false; }\r\n\tif(!big){ return true; }\r\n\tfor (let ox=-1;ox<=1;++ox)\r\n\tfor (let oy=-1;oy<=1;++oy){\r\n\t\tif(ox===0&&oy===0 || !strict&&ox&&oy){ continue; }\r\n\t\tconst tileHeight2 = mv3d.getWalkHeight(x+ox,y+oy);\r\n\t\tif(tileHeight2>tileHeight+altitude*!strict&&(strict||tileHeight2>posZ)){\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\treturn true;\r\n}\r\nfunction vehicleObstructed(){\r\n\treturn !vehicleNotObstructed.apply(this,arguments);\r\n}\r\n\r\nconst _airship_land_ok = Game_Map.prototype.isAirshipLandOk;\r\nGame_Map.prototype.isAirshipLandOk = function(x, y) {\r\n\tif(vehicleObstructed.call(this.airship(),x,y,true)){ return false; }\r\n\tif(mv3d.AIRSHIP_SETTINGS.bushLanding){\r\n\t\treturn this.checkPassage(x, y, 0x0f);\r\n\t}else{\r\n\t\treturn _airship_land_ok.apply(this,arguments);\r\n\t}\r\n\r\n};\r\n\r\nconst _player_updateVehicleGetOn = Game_Player.prototype.updateVehicleGetOn;\r\nGame_Player.prototype.updateVehicleGetOn = function() {\r\n\tconst vehicle = this.vehicle();\r\n\tconst speed = mv3d.loadData(`${vehicle._type}_speed`,vehicle._moveSpeed);\r\n\tthis.vehicle().setMoveSpeed(speed);\r\n\t_player_updateVehicleGetOn.apply(this,arguments);\r\n};\r\n\r\n// jump\r\n\r\nconst _charBase_jump = Game_CharacterBase.prototype.jump;\r\nGame_CharacterBase.prototype.jump = function(xPlus, yPlus) {\r\n\tthis.mv3d_jumpHeightStart = mv3d.getWalkHeight(this.x,this.y);\r\n\tthis.mv3d_jumpHeightEnd = mv3d.getWalkHeight(this.x+xPlus,this.y+yPlus);\r\n\t_charBase_jump.apply(this,arguments);\r\n};","import mv3d from './mv3d.js';\r\n\r\nconst gameMap_parallaxOx = Game_Map.prototype.parallaxOx;\r\nGame_Map.prototype.parallaxOx = function() {\r\n\tlet ox = gameMap_parallaxOx.apply(this,arguments);\r\n\tif(this._parallaxLoopX){\r\n\t\treturn ox - mv3d.blendCameraYaw.currentValue()*816/90;\r\n\t}\r\n\treturn ox;\r\n};\r\nconst gameMap_parallaxOy = Game_Map.prototype.parallaxOy;\r\nGame_Map.prototype.parallaxOy = function() {\r\n\tlet oy = gameMap_parallaxOy.apply(this,arguments);\r\n\tif(this._parallaxLoopY){\r\n\t\treturn oy - mv3d.blendCameraPitch.currentValue()*816/90;\r\n\t}\r\n    return oy;\r\n};\r\n\r\nGame_Map.prototype.setDisplayPos = function() { };\r\nGame_Map.prototype.scrollUp = function() { };\r\nGame_Map.prototype.scrollDown = function() { };\r\nGame_Map.prototype.scrollLeft = function() { };\r\nGame_Map.prototype.scrollRight = function() { };\r\nGame_Map.prototype.updateScroll = function() {\r\n    this._displayX = -mv3d.blendCameraYaw.currentValue()*816/3600;\r\n    this._displayY = -mv3d.blendCameraPitch.currentValue()*816/3600;\r\n};\r\n\r\nGame_CharacterBase.prototype.isNearTheScreen = function() {\r\n\treturn Math.abs(this.x - mv3d.cameraStick.position.x)<=mv3d.RENDER_DIST\r\n\t&& Math.abs(-this.y - mv3d.cameraStick.position.y)<=mv3d.RENDER_DIST;\r\n};\r\n"],"sourceRoot":""}